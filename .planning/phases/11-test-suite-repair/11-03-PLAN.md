---
phase: 11-test-suite-repair
plan: 03
type: execute
wave: 2
depends_on: ["11-01", "11-02"]
files_modified:
  - .github/workflows/ci.yml
  - .github/workflows/publish.yml
autonomous: true

must_haves:
  truths:
    - "CI workflow runs upstream gsd-tools tests in addition to fork vitest tests"
    - "CI workflow runs fork-specific gsd-tools tests"
    - "Publish workflow runs upstream tests before npm publish"
    - "All test suites pass locally: vitest, upstream gsd-tools, fork gsd-tools"
  artifacts:
    - path: ".github/workflows/ci.yml"
      provides: "CI pipeline with upstream + fork test steps"
      contains: "test:upstream"
    - path: ".github/workflows/publish.yml"
      provides: "Publish pipeline with upstream test gate"
      contains: "test:upstream"
  key_links:
    - from: ".github/workflows/ci.yml"
      to: "package.json"
      via: "npm run test:upstream and npm run test:upstream:fork scripts"
      pattern: "npm run test:upstream"
    - from: ".github/workflows/publish.yml"
      to: "package.json"
      via: "npm run test:upstream script"
      pattern: "npm run test:upstream"
---

<objective>
Update CI/CD workflows to run upstream gsd-tools tests and fork-specific tests alongside existing fork vitest tests. Then run the complete test battery locally to confirm all suites pass and the sync branch is CI-ready.

Purpose: The CI currently only runs fork vitest tests (`npm test`) but not the 75 upstream gsd-tools tests or the new fork config tests. Without these in CI, regressions in upstream compatibility or fork config handling would go undetected.
Output: Updated ci.yml and publish.yml with upstream test steps, confirmed all-green test battery.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-test-suite-repair/11-RESEARCH.md

# Prior plan summaries needed for test file locations
@.planning/phases/11-test-suite-repair/11-01-SUMMARY.md
@.planning/phases/11-test-suite-repair/11-02-SUMMARY.md

# Key source files
@.github/workflows/ci.yml
@.github/workflows/publish.yml
@package.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add upstream and fork test steps to CI and publish workflows</name>
  <files>.github/workflows/ci.yml, .github/workflows/publish.yml</files>
  <action>
**Update .github/workflows/ci.yml:**

Add two new steps after the existing "Run infrastructure tests" step and before the "Verify install script" step:

```yaml
      - name: Run upstream gsd-tools tests
        run: npm run test:upstream

      - name: Run fork gsd-tools tests
        run: npm run test:upstream:fork
```

Keep all existing steps unchanged. The step order becomes:
1. Checkout
2. Setup Node.js (20.x)
3. Install dependencies
4. Build hooks
5. Run tests (vitest)
6. Run infrastructure tests
7. **Run upstream gsd-tools tests** (NEW)
8. **Run fork gsd-tools tests** (NEW)
9. Verify install script
10. Run tests with coverage (PR only)

**Update .github/workflows/publish.yml:**

Add upstream test steps before the "Publish to npm" step, after the existing "Run tests before publish" step:

```yaml
      - name: Run upstream tests before publish
        run: npm run test:upstream

      - name: Run fork tests before publish
        run: npm run test:upstream:fork
```

The step order becomes:
1. ... (existing steps through build:hooks)
2. Verify version matches release tag
3. Extract release notes
4. Update release notes
5. Run tests before publish (vitest)
6. **Run upstream tests before publish** (NEW)
7. **Run fork tests before publish** (NEW)
8. Publish to npm

Do NOT modify:
- The trigger branches (keep `branches: [main]` -- CI validation on sync branch will be done via PR to main)
- The Node.js version (keep 20.x)
- The smoke-test.yml (manual dispatch, unrelated to this change)
- Any existing step content
  </action>
  <verify>Read back both workflow files and verify the new steps exist in the correct positions</verify>
  <done>ci.yml has "Run upstream gsd-tools tests" and "Run fork gsd-tools tests" steps. publish.yml has "Run upstream tests before publish" and "Run fork tests before publish" steps. All existing steps unchanged.</done>
</task>

<task type="auto">
  <name>Task 2: Run complete test battery locally and verify all-green</name>
  <files></files>
  <action>
Execute the full test battery that CI will run, in order:

1. `npm run build:hooks` -- verify hook build succeeds (CI prerequisite)
2. `npx vitest run` -- verify all fork tests pass (should be 42+ including new wiring validation tests from Plan 01)
3. `npm run test:infra` -- verify infrastructure tests pass
4. `npm run test:upstream` -- verify all 75 upstream gsd-tools tests pass
5. `npm run test:upstream:fork` -- verify all fork config tests pass (from Plan 02)

Report results for each step:
- Pass/fail status
- Test count
- Duration
- Any warnings

If any step fails:
- `build:hooks` failure: Check if hook source files exist (`hooks/gsd-statusline.js`, `hooks/gsd-check-update.js`). The esbuild config may need path updates.
- vitest failure: If new wiring validation tests from Plan 01 fail, report the specific failure. If pre-existing tests fail, this is a regression to investigate.
- test:upstream failure: Should not fail -- these passed before Plans 01-02 (separate files). If they do, check for environment issues.
- test:upstream:fork failure: If fork config tests fail, check config-set/config-get behavior. May need assertion adjustments based on actual gsd-tools.js output format.

Also run the CI install verification step locally to verify it works:
```bash
INSTALL_DIR=$(mktemp -d)
HOME="$INSTALL_DIR" node bin/install.js --claude 2>&1 || true
ls -la "$INSTALL_DIR/.claude/commands/gsd" 2>/dev/null && echo "PASS: commands dir" || echo "FAIL: commands dir"
ls -la "$INSTALL_DIR/.claude/get-shit-done" 2>/dev/null && echo "PASS: gsd dir" || echo "FAIL: gsd dir"
rm -rf "$INSTALL_DIR"
```

This validates TEST-04 (install test works with merged installer).
  </action>
  <verify>All 5 test commands pass. Install verification passes. Report total test counts across all suites.</verify>
  <done>Complete test battery passes locally: vitest (42+ tests), upstream gsd-tools (75 tests), fork gsd-tools (7+ tests), build:hooks succeeds, install verification passes. The sync branch is CI-ready.</done>
</task>

</tasks>

<verification>
1. `.github/workflows/ci.yml` contains `npm run test:upstream` and `npm run test:upstream:fork` steps
2. `.github/workflows/publish.yml` contains upstream and fork test steps before publish
3. `npm run build:hooks` succeeds
4. `npx vitest run` passes all tests (42+)
5. `npm run test:upstream` passes all 75 tests
6. `npm run test:upstream:fork` passes all fork config tests
7. CI install verification step passes locally
</verification>

<success_criteria>
- CI workflow runs all three test suites: vitest, upstream gsd-tools, fork gsd-tools (TEST-05)
- Publish workflow gates on upstream tests before npm publish (TEST-05)
- All test suites pass locally on the sync branch (TEST-01, TEST-02)
- Install verification passes with merged installer (TEST-04)
- Sync branch is ready for CI validation via PR to main
</success_criteria>

<output>
After completion, create `.planning/phases/11-test-suite-repair/11-03-SUMMARY.md`
</output>
