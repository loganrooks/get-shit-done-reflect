---
phase: 11-test-suite-repair
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - tests/integration/wiring-validation.test.js
autonomous: true

must_haves:
  truths:
    - "Wiring validation test confirms every command with execution_context references an existing workflow file"
    - "Wiring validation test detects commands that have execution_context but no workflow @-reference"
    - "All existing wiring validation tests still pass after extension"
  artifacts:
    - path: "tests/integration/wiring-validation.test.js"
      provides: "Thin orchestrator delegation validation"
      contains: "thin orchestrator"
  key_links:
    - from: "tests/integration/wiring-validation.test.js"
      to: "commands/gsd/*.md"
      via: "dynamic directory scan for execution_context and workflow references"
      pattern: "execution_context"
    - from: "tests/integration/wiring-validation.test.js"
      to: "get-shit-done/workflows/*.md"
      via: "resolved @-reference path existence check"
      pattern: "pathExists"
---

<objective>
Extend the wiring validation test suite with thin orchestrator delegation tests that verify every command's execution_context references resolve to actual workflow files. This is the core requirement for TEST-03: validating the thin orchestrator pattern (commands delegate to workflows) that replaced old inline-logic commands during Phases 8-9.

Purpose: The thin orchestrator pattern is the architectural foundation adopted from upstream. Without wiring validation, broken command->workflow references would silently fail at runtime.
Output: Updated wiring-validation.test.js with new "thin orchestrator delegation" describe block containing structural validation tests.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-test-suite-repair/11-RESEARCH.md

# Key source files
@tests/integration/wiring-validation.test.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add thin orchestrator delegation tests to wiring-validation.test.js</name>
  <files>tests/integration/wiring-validation.test.js</files>
  <action>
Add a new `describe('thin orchestrator delegation', ...)` block to the existing wiring-validation.test.js file. Use the existing helper functions (`readMdFiles`, `pathExists`, `refToRepoPath`) already defined in the file -- do NOT duplicate them.

Add these test cases:

1. **"every command with execution_context references an existing workflow"** -- For each .md file in `commands/gsd/`, extract `<execution_context>` sections, find workflow @-references matching `@~/.claude/get-shit-done/workflows/*.md`, resolve to repo-relative paths using `refToRepoPath()`, and verify each exists via `pathExists()`. Collect all broken references and fail with descriptive message listing command->workflow pairs that don't resolve.

2. **"commands with execution_context have workflow @-references"** -- For each command file that contains `<execution_context>`, verify it also contains at least one reference to `get-shit-done/workflows/`. Commands without execution_context are legitimately self-contained (like community.md) and should be skipped. Fail listing any commands that have execution_context but no workflow reference.

3. **"workflow files referenced by commands exist in workflows directory"** -- Cross-validate: collect all unique workflow filenames referenced from commands, then verify each exists in `get-shit-done/workflows/`. This catches stale references where command references a workflow that was renamed or removed.

Use the exact same error reporting pattern as existing tests (collect broken items into array, fail with formatted details). Use dynamic discovery (scan directory) not hardcoded file lists. Do NOT add command count assertions (brittle per Research pitfall 6).

Also add a smaller `describe('fork-specific files', ...)` block that validates key fork files exist:
- `get-shit-done/bin/fork-tools.js` exists
- `.claude/agents/kb-templates/signal.md` exists (already tested for content, but existence check is structural)
- `get-shit-done/references/knowledge-surfacing.md` exists
- `commands/gsd/community.md` exists (fork replacement for join-discord)
  </action>
  <verify>Run `npx vitest run tests/integration/wiring-validation.test.js` -- all tests pass (existing 13 + new thin orchestrator + fork file tests)</verify>
  <done>Wiring validation test has a "thin orchestrator delegation" describe block with 3 tests that dynamically discover commands, extract execution_context workflow references, and verify they resolve to existing workflow files. A "fork-specific files" describe block verifies 4 key fork files exist. All existing tests continue to pass.</done>
</task>

<task type="auto">
  <name>Task 2: Run full vitest suite and verify all tests pass</name>
  <files>tests/integration/wiring-validation.test.js</files>
  <action>
Run the full vitest suite (`npx vitest run`) to confirm:
1. All new thin orchestrator delegation tests pass
2. All new fork-specific file tests pass
3. All pre-existing 42 tests still pass
4. No regressions introduced

If any new tests fail, diagnose and fix:
- Broken workflow references: Check if the command truly references a workflow that exists. If the workflow is missing, the test is correctly catching a real bug -- fix the source file, not the test.
- Self-contained commands: If a command legitimately has no workflow (like community.md which is inline), ensure the test properly skips it (only checks commands that have execution_context).
- Path resolution: If @-reference resolution fails, check the `refToRepoPath` function handles the specific path format.

Report the final test count and any issues found.
  </action>
  <verify>Run `npx vitest run` -- all tests pass with 0 failures. Test count should be 42+ existing + new tests added in Task 1.</verify>
  <done>Full vitest suite passes. Wiring validation correctly identifies thin orchestrator delegation pattern across all commands. No false positives from self-contained commands. Test count is reported.</done>
</task>

</tasks>

<verification>
1. `npx vitest run tests/integration/wiring-validation.test.js` passes all tests
2. `npx vitest run` passes the full suite with no failures
3. New "thin orchestrator delegation" describe block has 3 test cases
4. New "fork-specific files" describe block has 4 file existence checks
5. No hardcoded command counts in the new tests
</verification>

<success_criteria>
- Wiring validation test validates thin orchestrator delegation (TEST-03 core requirement)
- Every command with execution_context is verified to reference existing workflow files
- Fork-specific structural files are validated for existence
- Full vitest suite passes with no regressions
</success_criteria>

<output>
After completion, create `.planning/phases/11-test-suite-repair/11-01-SUMMARY.md`
</output>
