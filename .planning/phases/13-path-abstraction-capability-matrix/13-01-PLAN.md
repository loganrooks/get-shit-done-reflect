---
phase: 13-path-abstraction-capability-matrix
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - bin/install.js
  - tests/unit/install.test.js
autonomous: true

must_haves:
  truths:
    - "Non-Claude runtime installs transform KB paths to ~/.gsd/knowledge/ (shared), not to runtime-specific paths"
    - "Non-Claude runtime installs correctly transform runtime-specific paths (get-shit-done, commands, agents) to target runtime locations"
    - "$HOME/.claude/ variants in bash code blocks are handled identically to tilde variants"
    - "convertClaudeToOpencodeFrontmatter no longer performs its own path replacement (no double-replacement)"
  artifacts:
    - path: "bin/install.js"
      provides: "replacePathsInContent() centralized two-pass function and refactored call sites"
      contains: "replacePathsInContent"
    - path: "tests/unit/install.test.js"
      provides: "Two-pass path replacement test coverage for both KB and runtime-specific paths"
      contains: "gsd-knowledge"
  key_links:
    - from: "bin/install.js:copyWithPathReplacement"
      to: "bin/install.js:replacePathsInContent"
      via: "function call replacing inline regex"
      pattern: "replacePathsInContent\\(content"
    - from: "bin/install.js:copyFlattenedCommands"
      to: "bin/install.js:replacePathsInContent"
      via: "function call replacing inline regex"
      pattern: "replacePathsInContent\\(content"
    - from: "bin/install.js:agent copy loop"
      to: "bin/install.js:replacePathsInContent"
      via: "function call replacing inline regex"
      pattern: "replacePathsInContent\\(content"
---

<objective>
Refactor the installer's path replacement system from a single blind regex into a centralized two-pass function that distinguishes shared paths (knowledge base) from runtime-specific paths. All 4 existing replacement code paths in install.js must use the new centralized function, and the convertClaudeToOpencodeFrontmatter overlap must be eliminated.

Purpose: ABST-01 -- the installer must correctly categorize all 313+ ~/.claude/ path references into runtime-specific vs shared buckets. Currently, installing for OpenCode or Gemini transforms KB paths to runtime-specific locations (e.g., ~/.config/opencode/gsd-knowledge/), breaking KB access. The two-pass system fixes this by replacing KB paths with the shared ~/.gsd/knowledge/ location and remaining paths with the runtime-specific prefix.

Output: Updated bin/install.js with replacePathsInContent() function, refactored call sites, and comprehensive tests.
</objective>

<execution_context>
@/Users/rookslog/.claude/get-shit-done/workflows/execute-plan.md
@/Users/rookslog/.claude/get-shit-done/templates/summary-standard.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/13-path-abstraction-capability-matrix/13-RESEARCH.md
@bin/install.js
@tests/unit/install.test.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create replacePathsInContent() and refactor all 4 replacement points</name>
  <files>bin/install.js</files>
  <action>
Create a centralized `replacePathsInContent(content, runtimePathPrefix)` function in bin/install.js that implements the two-pass replacement per the locked decision:

**Pass 1 -- Shared paths (KB):**
Replace `~/.claude/gsd-knowledge` with `~/.gsd/knowledge` (both with and without trailing slash). Also handle the `$HOME/.claude/gsd-knowledge` variant used in bash code blocks (3 files use this pattern: reflect.md line 116, health-check.md line 47, reflection-patterns.md line 327). Replace `$HOME/.claude/gsd-knowledge` with `$HOME/.gsd/knowledge`.

**Pass 2 -- Runtime-specific paths:**
Replace remaining `~/.claude/` references with `runtimePathPrefix`. Use negative lookahead `(?!gsd-knowledge)` should NOT be needed after Pass 1 has already transformed KB paths, but add it as a safety guard. Also handle remaining `$HOME/.claude/` references (2 files use `$HOME/.claude/get-shit-done/`): replace with `$HOME/` + the suffix portion of runtimePathPrefix (strip the `~/` prefix).

For Claude runtime (runtimePathPrefix is `~/.claude/`), the function can short-circuit and return content unchanged since source files already use Claude paths. The KB paths still need transformation to `~/.gsd/knowledge/` even for Claude installs -- so only short-circuit if runtimePathPrefix starts with the Claude path AND KB paths are already at the shared location (they won't be until Phase 14 updates source files). Actually, for Phase 13 correctness: always run both passes regardless of runtime, since Pass 1 transforms KB paths even for Claude installs.

**Refactor call sites (all 4):**

1. **copyWithPathReplacement() (~line 676):** Replace `content = content.replace(claudeDirRegex, pathPrefix)` with `content = replacePathsInContent(content, pathPrefix)`.

2. **copyFlattenedCommands() (~line 634-638):** Replace the two-line replacement block (`content.replace(claudeDirRegex, pathPrefix)` and `content.replace(opencodeDirRegex, pathPrefix)`) with `content = replacePathsInContent(content, pathPrefix)`. Keep the opencodeDirRegex replacement AFTER the centralized call, since that handles the `~/.opencode/` -> `~/.config/opencode/` migration case (unrelated to the two-pass KB/runtime split).

3. **convertClaudeToOpencodeFrontmatter() (~line 456):** REMOVE the line `convertedContent = convertedContent.replace(/~\/\.claude\b/g, '~/.config/opencode')`. This function should NOT do path replacement -- it should only handle frontmatter structure conversion and tool name mapping. Path replacement is now handled by the centralized function at the call site (before convertClaudeToOpencodeFrontmatter is invoked). This eliminates the double-replacement bug documented in research Pitfall 3.

4. **Agent copy loop (~line 1374):** Replace `content = content.replace(dirRegex, pathPrefix)` with `content = replacePathsInContent(content, pathPrefix)`.

**Important edge case:** In copyWithPathReplacement (point 1), the path replacement happens BEFORE convertClaudeToOpencodeFrontmatter is called. So after removing path replacement from convertClaudeToOpencodeFrontmatter, the flow is: replacePathsInContent -> processAttribution -> convertClaudeToOpencodeFrontmatter. This is correct.

In copyFlattenedCommands (point 2), same ordering applies -- replacePathsInContent runs first, then processAttribution, then convertClaudeToOpencodeFrontmatter.

Place the `replacePathsInContent` function definition near the other path utility functions (around line 600, before copyFlattenedCommands).
  </action>
  <verify>
Run the existing test suite: `cd /Users/rookslog/Development/get-shit-done-reflect && npx vitest run tests/unit/install.test.js`

Verify no regressions. Grep for old inline regex patterns to confirm they've been replaced:
- `grep -n "claudeDirRegex" bin/install.js` should show only the definition inside replacePathsInContent, not at call sites
- `grep -n "~\/\.claude\\\\b" bin/install.js` should return zero matches (the \b pattern from convertClaudeToOpencodeFrontmatter is removed)
- `grep -c "replacePathsInContent" bin/install.js` should show 4+ matches (1 definition + 3-4 call sites)
  </verify>
  <done>
bin/install.js contains a replacePathsInContent() function that performs two-pass path replacement (KB to ~/.gsd/knowledge/, remaining to runtime path), all 4 original replacement points call this centralized function, and convertClaudeToOpencodeFrontmatter no longer contains inline path replacement. Existing tests pass.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add two-pass path replacement tests</name>
  <files>tests/unit/install.test.js</files>
  <action>
Add a new `describe('two-pass path replacement')` test group in tests/unit/install.test.js. Use the existing `tmpdirTest` and `createMockHome` fixtures from `tests/helpers/tmpdir.js` (already imported/used in the test file).

**Unit tests for replacePathsInContent() function directly:**

First, export `replacePathsInContent` from install.js for direct testing. Add it to the exports at the bottom of install.js (the file already has a module.exports section -- find it and add replacePathsInContent to it). If no exports exist, the function can be tested via integration tests instead.

If direct testing is feasible, add these unit tests:

1. **"replaces KB tilde paths with shared location"** -- Input containing `~/.claude/gsd-knowledge/signals/` should become `~/.gsd/knowledge/signals/`. Verify for OpenCode pathPrefix `~/.config/opencode/`.

2. **"replaces KB $HOME paths with shared location"** -- Input containing `$HOME/.claude/gsd-knowledge` should become `$HOME/.gsd/knowledge`. Verify for OpenCode pathPrefix.

3. **"replaces runtime-specific tilde paths with runtime prefix"** -- Input containing `~/.claude/get-shit-done/workflows/signal.md` should become `~/.config/opencode/get-shit-done/workflows/signal.md` for OpenCode.

4. **"replaces runtime-specific $HOME paths with runtime prefix"** -- Input containing `$HOME/.claude/get-shit-done/` should become `$HOME/.config/opencode/get-shit-done/` for OpenCode.

5. **"handles mixed KB and runtime-specific paths in same content"** -- Input containing BOTH `~/.claude/gsd-knowledge/` AND `~/.claude/get-shit-done/` should transform each correctly (KB to shared, runtime to runtime-specific).

6. **"handles Gemini runtime paths"** -- Verify transformation works for Gemini pathPrefix `~/.gemini/` as well.

7. **"leaves Claude paths unchanged for Claude runtime"** -- For Claude pathPrefix `~/.claude/`, KB paths still transform to `~/.gsd/knowledge/` but runtime-specific paths remain `~/.claude/`.

**Integration test (full installer run):**

8. **"OpenCode install protects KB paths from runtime transformation"** -- Run the full installer with `--opencode --global`, then read an installed workflow file that contains both KB and runtime paths (e.g., signal.md). Verify KB paths are `~/.gsd/knowledge/` (NOT `~/.config/opencode/gsd-knowledge/`) and runtime-specific paths are `~/.config/opencode/...`.

9. **"OpenCode install handles $HOME variant correctly"** -- After the same install, read reflect.md and verify `$HOME/.claude/gsd-knowledge` became `$HOME/.gsd/knowledge` and NOT `$HOME/.config/opencode/gsd-knowledge`.

Use the same test patterns already in the file (execSync with HOME override, reading installed files, expect assertions).
  </action>
  <verify>
Run the full test suite: `cd /Users/rookslog/Development/get-shit-done-reflect && npx vitest run tests/unit/install.test.js`

All new tests pass. No existing tests broken.
  </verify>
  <done>
tests/unit/install.test.js contains a "two-pass path replacement" test group with unit tests for replacePathsInContent() covering KB paths (tilde + $HOME), runtime-specific paths, mixed content, and integration tests verifying full installer behavior for OpenCode. All tests pass.
  </done>
</task>

</tasks>

<verification>
1. Run full test suite: `npx vitest run tests/unit/install.test.js` -- all pass
2. Grep verification: `grep -c "replacePathsInContent" bin/install.js` shows 4+ matches
3. Grep verification: `grep -n "~\/\.claude\\\\b" bin/install.js` returns 0 matches (old pattern removed from convertClaudeToOpencodeFrontmatter)
4. Manual spot check: Read the 4 call sites in install.js and confirm each uses replacePathsInContent()
</verification>

<success_criteria>
- replacePathsInContent() function exists in bin/install.js and is called from all 4 replacement points
- convertClaudeToOpencodeFrontmatter() no longer contains inline path replacement
- Two-pass replacement correctly transforms KB paths to ~/.gsd/knowledge/ and runtime-specific paths to target runtime
- Both tilde (~/) and $HOME/ path variants are handled
- All existing tests pass, new tests cover the two-pass behavior
</success_criteria>

<output>
After completion, create `.planning/phases/13-path-abstraction-capability-matrix/13-01-SUMMARY.md`
</output>
