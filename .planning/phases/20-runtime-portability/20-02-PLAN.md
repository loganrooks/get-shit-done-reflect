---
phase: 20-runtime-portability
plan: 02
type: execute
wave: 2
depends_on: ["20-01"]
files_modified:
  - bin/install.js
  - tests/unit/install.test.js
  - tests/integration/multi-runtime.test.js
autonomous: true

must_haves:
  truths:
    - "Codex CLI installation generates config.toml with MCP server entries when GSD uses MCP tools"
    - "Existing user config.toml content is preserved when GSD adds MCP config"
    - "Re-running the installer updates (not duplicates) the GSD MCP section in config.toml"
    - "Uninstalling Codex removes the GSD MCP section from config.toml without touching user config"
  artifacts:
    - path: "bin/install.js"
      provides: "generateCodexMcpConfig() function with marker-based TOML section management"
      contains: "generateCodexMcpConfig"
    - path: "bin/install.js"
      provides: "Uninstall cleanup for config.toml GSD section"
      contains: "config.toml"
    - path: "tests/unit/install.test.js"
      provides: "Unit tests for Codex MCP config generation"
      contains: "generateCodexMcpConfig"
    - path: "tests/integration/multi-runtime.test.js"
      provides: "Integration test for Codex config.toml after install"
      contains: "config.toml"
  key_links:
    - from: "bin/install.js Codex install path"
      to: "generateCodexMcpConfig()"
      via: "called after generateCodexAgentsMd() in the isCodex block"
      pattern: "generateCodexMcpConfig"
    - from: "bin/install.js uninstall()"
      to: "config.toml GSD section removal"
      via: "marker-based section removal in isCodex uninstall block"
      pattern: "GSD:BEGIN.*config\\.toml|config\\.toml.*GSD:BEGIN"
    - from: "bin/install.js module.exports"
      to: "generateCodexMcpConfig"
      via: "added to exports for testing"
      pattern: "generateCodexMcpConfig"
---

<objective>
Add a Codex MCP config.toml generator that creates `[mcp_servers.context7]` TOML configuration in `~/.codex/config.toml` during Codex installation, with marker-based section management for idempotent updates and uninstall cleanup.

Purpose: Closes Gap 9 (Codex MCP config generation) from post-v1.14 analysis. Without this, MCP tools referenced in GSD agent specs (like context7) are not configured for the Codex runtime, so MCP-dependent features don't work.
Output: New generateCodexMcpConfig() function, integrated into install and uninstall paths, with unit and integration tests.
</objective>

<execution_context>
@/Users/rookslog/.claude/get-shit-done/workflows/execute-plan.md
@/Users/rookslog/.claude/get-shit-done/templates/summary-standard.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/20-runtime-portability/20-RESEARCH.md
@.planning/phases/20-runtime-portability/20-01-SUMMARY.md
@bin/install.js
@tests/unit/install.test.js
@tests/integration/multi-runtime.test.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement generateCodexMcpConfig() with install and uninstall integration</name>
  <files>bin/install.js</files>
  <action>
Add three things to `bin/install.js`:

**1. Known MCP servers constant and generateCodexMcpConfig() function** -- Add near the other Codex functions (after `generateCodexAgentsMd()` which ends around line 990). Follow the marker-based pattern from `generateCodexAgentsMd()` (uses `<!-- GSD:BEGIN -->` / `<!-- GSD:END -->`), but use TOML comment markers (`# GSD:BEGIN` / `# GSD:END`):

```javascript
// Known MCP servers used by GSD
const gsdMcpServers = {
  context7: {
    command: 'npx',
    args: ['-y', '@upstash/context7-mcp']
  }
};

/**
 * Generate MCP server configuration for Codex CLI config.toml.
 * Uses marker-based section management (# GSD:BEGIN / # GSD:END) for idempotent updates.
 * Creates config.toml if it doesn't exist, merges with existing if it does.
 * @param {string} targetDir - Codex config directory (e.g., ~/.codex)
 */
function generateCodexMcpConfig(targetDir) {
  const configPath = path.join(targetDir, 'config.toml');
  const GSD_BEGIN = '# GSD:BEGIN (get-shit-done-reflect-cc)';
  const GSD_END = '# GSD:END (get-shit-done-reflect-cc)';

  // Build TOML section for all known MCP servers
  const serverEntries = Object.entries(gsdMcpServers).map(([name, server]) => {
    const argsStr = server.args.map(a => JSON.stringify(a)).join(', ');
    return `[mcp_servers.${name}]\ncommand = ${JSON.stringify(server.command)}\nargs = [${argsStr}]`;
  }).join('\n\n');

  const tomlSection = `${GSD_BEGIN}\n${serverEntries}\n${GSD_END}`;

  if (fs.existsSync(configPath)) {
    let existing = fs.readFileSync(configPath, 'utf8');
    const beginIdx = existing.indexOf(GSD_BEGIN);
    const endIdx = existing.indexOf(GSD_END);

    if (beginIdx !== -1 && endIdx !== -1) {
      // Replace existing GSD section
      existing = existing.substring(0, beginIdx) + tomlSection + existing.substring(endIdx + GSD_END.length);
    } else {
      // Append GSD section
      existing = existing.trimEnd() + '\n\n' + tomlSection + '\n';
    }
    fs.writeFileSync(configPath, existing);
  } else {
    fs.writeFileSync(configPath, tomlSection + '\n');
  }
}
```

**2. Call generateCodexMcpConfig() in the Codex install path** -- Add after the `generateCodexAgentsMd()` call (around line 1888):
```javascript
// Generate MCP config.toml for Codex
if (isCodex) {
  generateCodexMcpConfig(targetDir);
  console.log(`  ${green}+${reset} Generated MCP config in config.toml`);
}
```
Note: The existing `if (isCodex)` block at line 1886 generates AGENTS.md. Add the MCP config call right after that block (or inside it, as a second operation).

**3. Add config.toml cleanup to uninstall()** -- In the `uninstall()` function, after the existing Codex AGENTS.md cleanup (around line 1331), add config.toml GSD section removal:
```javascript
// 3c. Remove GSD section from config.toml (Codex only)
if (isCodex) {
  const configTomlPath = path.join(targetDir, 'config.toml');
  if (fs.existsSync(configTomlPath)) {
    let content = fs.readFileSync(configTomlPath, 'utf8');
    const GSD_BEGIN = '# GSD:BEGIN (get-shit-done-reflect-cc)';
    const GSD_END = '# GSD:END (get-shit-done-reflect-cc)';
    const beginIdx = content.indexOf(GSD_BEGIN);
    const endIdx = content.indexOf(GSD_END);
    if (beginIdx !== -1 && endIdx !== -1) {
      content = content.substring(0, beginIdx) + content.substring(endIdx + GSD_END.length);
      content = content.trim();
      if (content.length === 0) {
        fs.unlinkSync(configTomlPath);
      } else {
        fs.writeFileSync(configTomlPath, content + '\n');
      }
      console.log(`  ${green}âœ“${reset} Removed GSD section from config.toml`);
      removedCount++;
    }
  }
}
```

**4. Add generateCodexMcpConfig to module.exports** -- Update the exports at line 2296 to include `generateCodexMcpConfig`.

Do NOT:
- Add a TOML parser dependency (string templates are sufficient for this simple config)
- Set `required = true` in generated TOML (would block Codex startup if MCP server unavailable)
- Overwrite user's existing config.toml (merge with markers)
- Auto-discover MCP server commands from tool names (use the static gsdMcpServers mapping)
  </action>
  <verify>Run `node -e "const {generateCodexMcpConfig} = require('./bin/install.js'); const fs = require('fs'); const os = require('os'); const p = require('path').join(os.tmpdir(), 'gsd-test-' + Date.now()); fs.mkdirSync(p); generateCodexMcpConfig(p); const c = fs.readFileSync(require('path').join(p, 'config.toml'), 'utf8'); console.log(c.includes('[mcp_servers.context7]')); console.log(c.includes('GSD:BEGIN')); fs.rmSync(p, {recursive:true})"` and confirm both lines print `true`.</verify>
  <done>generateCodexMcpConfig() creates/updates config.toml with MCP server entries using marker-based sections, is called during Codex install, cleanup is added to uninstall, and function is exported for testing.</done>
</task>

<task type="auto">
  <name>Task 2: Add unit and integration tests for Codex MCP config generation</name>
  <files>tests/unit/install.test.js, tests/integration/multi-runtime.test.js</files>
  <action>
Add tests following established patterns. Import `generateCodexMcpConfig` alongside the other imports at line 13 of `tests/unit/install.test.js`.

**Unit tests** -- Add a new `describe('Codex MCP config.toml generation')` block in `tests/unit/install.test.js`:

1. **Creates config.toml with MCP entries** -- Call `generateCodexMcpConfig(tmpdir)` on empty directory. Verify config.toml exists, contains `[mcp_servers.context7]`, contains `command = "npx"`, contains `args = ["-y", "@upstash/context7-mcp"]`, contains `# GSD:BEGIN` and `# GSD:END` markers.

2. **Merges with existing config.toml** -- Write a config.toml with user content (`model = "o3-mini"\n\n[mcp_servers.my-server]\ncommand = "my-server"\n`). Call `generateCodexMcpConfig(tmpdir)`. Verify user content is preserved AND GSD MCP section is appended.

3. **Idempotent update replaces existing GSD section** -- Call `generateCodexMcpConfig(tmpdir)` twice. Verify config.toml contains exactly ONE `[mcp_servers.context7]` entry (not duplicated). Check that `# GSD:BEGIN` appears exactly once.

4. **Does not include required = true** -- Call `generateCodexMcpConfig(tmpdir)`. Verify config.toml does NOT contain `required`.

Use `tmpdirTest()` for temp directory management and `fsSync` for file operations (following the pattern in existing Codex tests).

**Integration test** -- Add to `tests/integration/multi-runtime.test.js`:

5. **Codex install generates config.toml with MCP servers** -- After running `node bin/install.js --codex -g` in a mock home, verify `~/.codex/config.toml` exists and contains `[mcp_servers.context7]` with correct command/args.

Run all tests to confirm zero regressions.
  </action>
  <verify>Run `npx vitest run tests/unit/install.test.js tests/integration/multi-runtime.test.js` and confirm all tests pass including the new ones. Report the total test count.</verify>
  <done>At least 4 new unit tests and 1 new integration test pass, proving Codex MCP config.toml generation works for create, merge, and idempotent update scenarios.</done>
</task>

</tasks>

<verification>
1. `npx vitest run` -- All tests pass (no regressions)
2. Manual verification: Create a temp dir, run `generateCodexMcpConfig()`, inspect the generated TOML
3. Idempotency check: Run `generateCodexMcpConfig()` twice on same dir, verify no duplicate entries
4. Merge check: Pre-populate config.toml with user content, verify it's preserved after generator runs
</verification>

<success_criteria>
- generateCodexMcpConfig() creates valid TOML with [mcp_servers.context7] section
- Existing user config.toml content is preserved when merging
- Marker-based sections enable idempotent updates (no duplicates)
- Uninstall removes GSD section from config.toml
- generateCodexMcpConfig is exported in module.exports
- At least 4 new unit tests and 1 new integration test pass
- All pre-existing tests still pass (zero regressions)
</success_criteria>

<output>
After completion, create `.planning/phases/20-runtime-portability/20-02-SUMMARY.md`
</output>
