---
phase: 20-runtime-portability
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - bin/install.js
  - tests/unit/install.test.js
  - tests/integration/multi-runtime.test.js
autonomous: true

must_haves:
  truths:
    - "Gemini agent body text uses Gemini-native tool names (read_file, write_file, run_shell_command) instead of Claude names (Read, Write, Bash)"
    - "MCP tool references in Gemini agent body text are NOT modified by tool name replacement"
    - "Gemini agent frontmatter tools: mapping is complete for all GSD agent specs"
  artifacts:
    - path: "bin/install.js"
      provides: "Body text tool name replacement in convertClaudeToGeminiAgent()"
      contains: "claudeToGeminiTools"
    - path: "tests/unit/install.test.js"
      provides: "Unit tests for Gemini body text tool name replacement"
      contains: "body text"
    - path: "tests/integration/multi-runtime.test.js"
      provides: "Integration test for Gemini agent body content after install"
      contains: "body.*tool.*name"
  key_links:
    - from: "bin/install.js convertClaudeToGeminiAgent()"
      to: "claudeToGeminiTools mapping"
      via: "word-boundary regex replacement on body text"
      pattern: "\\bclaudeTool\\b.*replace"
    - from: "bin/install.js agent copy loop"
      to: "convertClaudeToGeminiAgent()"
      via: "called at line 1873 for isGemini"
      pattern: "convertClaudeToGeminiAgent"
---

<objective>
Add body text tool name replacement to the Gemini agent converter so that Claude Code tool names (Read, Write, Bash, Glob, Grep) in agent spec body content are converted to Gemini-native names (read_file, write_file, run_shell_command, glob, search_file_content). Also verify the frontmatter tools: mapping is complete for all GSD agent specs.

Purpose: Closes Gap 7 (agent spec body content accessibility) and Gap 8 (Gemini tools mapping verification) from post-v1.14 analysis. Without this, Gemini agents reference tool names that don't exist in Gemini CLI.
Output: Updated convertClaudeToGeminiAgent() with body text replacement, plus unit and integration tests.
</objective>

<execution_context>
@/Users/rookslog/.claude/get-shit-done/workflows/execute-plan.md
@/Users/rookslog/.claude/get-shit-done/templates/summary-standard.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/20-runtime-portability/20-RESEARCH.md
@bin/install.js
@tests/unit/install.test.js
@tests/integration/multi-runtime.test.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add body text tool name replacement to convertClaudeToGeminiAgent()</name>
  <files>bin/install.js</files>
  <action>
Modify `convertClaudeToGeminiAgent()` (starts at line 565) to apply tool name replacement to the body text, following the established pattern from `convertClaudeToCodexSkill()` (lines 792-797).

Specifically, change the return statement at line 632 from:
```javascript
return `---\n${newFrontmatter}\n---${stripSubTags(body)}`;
```
to apply tool name replacement to the body text before returning:
```javascript
// Apply tool name replacement to body text (same pattern as Codex converter)
let processedBody = stripSubTags(body);
for (const [claudeTool, geminiTool] of Object.entries(claudeToGeminiTools)) {
  processedBody = processedBody.replace(new RegExp(`\\b${claudeTool}\\b`, 'g'), geminiTool);
}
return `---\n${newFrontmatter}\n---${processedBody}`;
```

This uses the existing `claudeToGeminiTools` mapping (lines 475-486) which covers: Read->read_file, Write->write_file, Edit->replace, Bash->run_shell_command, Glob->glob, Grep->search_file_content, WebSearch->google_web_search, WebFetch->web_fetch, TodoWrite->write_todos, AskUserQuestion->ask_user.

The word-boundary regex (`\b`) ensures MCP tool references like `mcp__context7__resolve-library-id` are NOT modified (underscores are word characters, so `\bRead\b` won't match inside MCP strings). This is the same approach used by the Codex converter and has been shipping since Phase 15 without issues.

Do NOT:
- Add tools.core/tools.exclude to settings.json (that's session-level, not per-agent)
- Modify convertClaudeToGeminiToml() (TOML commands use prompt strings where tool names don't need conversion)
- Add any new dependencies
  </action>
  <verify>Run `node -e "const {convertClaudeToGeminiAgent} = require('./bin/install.js'); const r = convertClaudeToGeminiAgent('---\ntools: Read, Write\n---\nUse the Read tool to read files. Run Bash for commands.'); console.log(r.includes('read_file tool')); console.log(!r.match(/\bRead\b/)); console.log(r.includes('run_shell_command'))"` and confirm all three lines print `true`.</verify>
  <done>convertClaudeToGeminiAgent() replaces Claude tool names in body text with Gemini-native names using word-boundary regex, while preserving MCP tool references.</done>
</task>

<task type="auto">
  <name>Task 2: Add unit and integration tests for Gemini body text tool name replacement</name>
  <files>tests/unit/install.test.js, tests/integration/multi-runtime.test.js</files>
  <action>
Add tests to the existing test files following the established patterns.

**Unit tests** -- Add to `tests/unit/install.test.js` inside the existing `describe('Gemini CLI MCP tool preservation')` block (after line 1188), or create a new `describe('Gemini agent body text tool name replacement')` block:

1. **Basic body text replacement** -- Input agent with body containing "Use the Read tool to read files. Run Bash for commands. Use Grep for searching." Verify output contains `read_file`, `run_shell_command`, `search_file_content` and does NOT contain `\bRead\b`, `\bBash\b`, `\bGrep\b`.

2. **MCP references preserved in body text** -- Input agent with body containing "Use mcp__context7__resolve-library-id to find libraries. Also use the Read tool." Verify MCP reference is unchanged AND `Read` is replaced with `read_file`.

3. **All mapped tools replaced** -- Input agent with body referencing ALL tools in claudeToGeminiTools (Read, Write, Edit, Bash, Glob, Grep, WebSearch, WebFetch, TodoWrite, AskUserQuestion). Verify each is replaced with its Gemini equivalent.

4. **Frontmatter and body both converted** -- Input agent with `tools: Read, Write, Bash` in frontmatter AND body text referencing those tools. Verify frontmatter has `tools:` YAML array with Gemini names AND body has Gemini names.

**Integration test** -- Add to `tests/integration/multi-runtime.test.js` near the existing Gemini MCP test (around line 309):

5. **Gemini installed agents have Gemini tool names in body text** -- After Gemini install, read an installed agent file and verify its body contains Gemini-native tool names (not Claude names). Pick an agent that references tool names in its body (e.g., gsd-planner.md which references Read, Write, Bash, Glob, Grep).

Use the existing test patterns: `tmpdirTest()` for temp directories, direct function imports for unit tests, `execSync` with `node bin/install.js --gemini` for integration tests.
  </action>
  <verify>Run `npx vitest run tests/unit/install.test.js tests/integration/multi-runtime.test.js` and confirm all tests pass including the new ones. Report the total test count.</verify>
  <done>At least 4 new unit tests and 1 new integration test pass, proving Gemini body text tool name replacement works correctly including MCP preservation.</done>
</task>

</tasks>

<verification>
1. `npx vitest run` -- All existing tests still pass (no regressions)
2. `node -e "const {convertClaudeToGeminiAgent} = require('./bin/install.js'); ..."` -- Quick smoke test confirming body text replacement works
3. Grep installed Gemini agent files for Claude tool names to confirm none remain in body text
</verification>

<success_criteria>
- convertClaudeToGeminiAgent() replaces all claudeToGeminiTools entries in body text using word-boundary regex
- MCP tool references (mcp__*) are not modified by body text replacement
- At least 4 new unit tests and 1 new integration test pass
- All pre-existing tests still pass (zero regressions)
- Total test count increases by at least 5
</success_criteria>

<output>
After completion, create `.planning/phases/20-runtime-portability/20-01-SUMMARY.md`
</output>
