---
phase: 24-manifest-driven-config-migration
plan: 03
type: execute
wave: 3
depends_on: ["24-01", "24-02"]
files_modified:
  - get-shit-done/workflows/upgrade-project.md
  - get-shit-done/workflows/new-project.md
  - get-shit-done/workflows/update.md
  - get-shit-done/references/version-migration.md
autonomous: true

must_haves:
  truths:
    - "upgrade-project.md Step 5 calls manifest apply-migration instead of hardcoded health_check/devops patches"
    - "upgrade-project.md Step 6 calls manifest log-migration instead of manual log append"
    - "new-project.md Step 5 config template no longer contains hardcoded health_check or devops sections"
    - "new-project.md has a manifest-driven feature configuration step after core preferences"
    - "new-project.md Step 5.7 no longer contains hardcoded bash devops detection scripts"
    - "update.md has a post-install step that calls manifest diff-config to detect config gaps"
    - "update.md YOLO mode displays count of features added ('{N} new feature(s) configured with defaults')"
    - "update.md interactive mode offers /gsd:upgrade-project when gaps are found"
    - "version-migration.md no longer contains hardcoded 'Current Migration Actions (v1.12.0)' with JSON templates"
  artifacts:
    - path: "get-shit-done/workflows/upgrade-project.md"
      provides: "Manifest-driven upgrade flow"
      contains: "manifest apply-migration"
    - path: "get-shit-done/workflows/new-project.md"
      provides: "Manifest-driven feature initialization"
      contains: "manifest apply-migration"
    - path: "get-shit-done/workflows/update.md"
      provides: "Post-install config gap detection"
      contains: "manifest diff-config"
    - path: "get-shit-done/references/version-migration.md"
      provides: "Simplified migration reference (no hardcoded actions)"
  key_links:
    - from: "get-shit-done/workflows/upgrade-project.md"
      to: "manifest apply-migration"
      via: "Step 5 gsd-tools.js invocation"
      pattern: "manifest apply-migration"
    - from: "get-shit-done/workflows/new-project.md"
      to: "manifest auto-detect"
      via: "Step 5.5 feature configuration"
      pattern: "manifest auto-detect"
    - from: "get-shit-done/workflows/update.md"
      to: "manifest diff-config"
      via: "Post-install gap check step"
      pattern: "manifest diff-config"
    - from: "get-shit-done/workflows/new-project.md"
      to: "manifest log-migration"
      via: "Step 5.5 initial config logging"
      pattern: "manifest log-migration"
---

<objective>
Modify the three workflow instruction files (upgrade-project.md, new-project.md, update.md) to consume manifest commands instead of hardcoded config logic. Simplify version-migration.md by removing hardcoded migration actions.

Purpose: This is the integration layer that connects the write-side tooling (Plans 01-02) to the user-facing workflows. After this plan, adding a new feature to GSD only requires adding it to feature-manifest.json -- zero workflow changes needed.

Output: Three modified workflow files using manifest commands, one simplified reference document.
</objective>

<execution_context>
@/Users/rookslog/.claude/get-shit-done/workflows/execute-plan.md
@/Users/rookslog/.claude/get-shit-done/templates/summary-standard.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/24-manifest-driven-config-migration/24-RESEARCH.md
@.planning/phases/24-manifest-driven-config-migration/24-01-SUMMARY.md
@.planning/phases/24-manifest-driven-config-migration/24-02-SUMMARY.md
@get-shit-done/workflows/upgrade-project.md
@get-shit-done/workflows/new-project.md
@get-shit-done/workflows/update.md
@get-shit-done/references/version-migration.md
@get-shit-done/feature-manifest.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Modify upgrade-project.md to use manifest commands + simplify version-migration.md</name>
  <files>
    get-shit-done/workflows/upgrade-project.md
    get-shit-done/references/version-migration.md
  </files>
  <action>
**Part A: Replace upgrade-project.md Step 5 (Apply Additive Config Patches)**

Replace the current Step 5 content (which references hardcoded health_check/devops patches from version-migration.md) with manifest-driven logic:

```markdown
## 5. Apply Additive Config Patches

Run manifest diff to detect config gaps:
```bash
DIFF=$(node ~/.claude/get-shit-done/bin/gsd-tools.js manifest diff-config --raw)
```

Parse the JSON result. Extract `missing_features`, `missing_fields`, and `type_mismatches`.

**If no gaps found** (all arrays empty and `manifest_version` matches `config_manifest_version`):
Report "Config is up to date" and skip to Step 6.

**In YOLO/auto mode:** Apply all defaults without prompting:
```bash
RESULT=$(node ~/.claude/get-shit-done/bin/gsd-tools.js manifest apply-migration --raw)
```

**In interactive mode:** For each missing feature:
1. Get prompts: `node ~/.claude/get-shit-done/bin/gsd-tools.js manifest get-prompts <feature> --raw`
2. Check for `_gate` prompt (field === "_gate"):
   - If present: ask the gate question first via AskUserQuestion
   - If user selects `skip_value`: skip remaining prompts, feature gets all defaults
   - If user selects other value: continue with remaining prompts
3. For each non-gate prompt: present question and options via AskUserQuestion
4. Write user choices: `node ~/.claude/get-shit-done/bin/gsd-tools.js config-set <config_key>.<field> <value>`
5. After all user choices, fill remaining defaults and coerce types:
   ```bash
   node ~/.claude/get-shit-done/bin/gsd-tools.js manifest apply-migration --raw
   ```

Update version stamps LAST (only after all changes succeed):
```bash
node ~/.claude/get-shit-done/bin/gsd-tools.js config-set gsd_reflect_version "<installed_version>"
```

This ensures partial migrations are retried on next run.
```

Preserve the `<core_principle>` about additive-only upgrades. Preserve Steps 1-4 and Step 7 unchanged.

**Part B: Replace upgrade-project.md Step 6 (Log Migration)**

Replace the current Step 6 content with:

```markdown
## 6. Log Migration

Log the migration using the changes from Step 5:
```bash
node ~/.claude/get-shit-done/bin/gsd-tools.js manifest log-migration --from "<old_version>" --to "<new_version>" --changes '<changes_json_from_step_5>' --raw
```

The `--changes` argument is the `changes` array from the `manifest apply-migration` output in Step 5. If interactive mode added user choices via `config-set`, include those as additional `field_added` entries in the changes array.
```

**Part C: Update required_reading**

In the `<required_reading>` section, change "Read version-migration.md for migration actions and mini-onboarding questions" to:
"Read version-migration.md for migration principles and log format. Feature-specific migration actions come from the manifest via `manifest apply-migration`."

**Part D: Simplify version-migration.md**

In version-migration.md, replace the "### Current Migration Actions (v1.12.0)" section (which lists hardcoded JSON for health_check and devops) with:

```markdown
### Migration Actions

Migration actions are now manifest-driven. Running `manifest apply-migration` reads `feature-manifest.json`, detects config gaps, fills missing features/fields with schema defaults, and coerces mismatched types.

**To see what would change:** `node ~/.claude/get-shit-done/bin/gsd-tools.js manifest diff-config --raw`
**To apply changes:** `node ~/.claude/get-shit-done/bin/gsd-tools.js manifest apply-migration --raw`

Adding a new feature requires only adding it to `feature-manifest.json`. The migration commands automatically handle existing projects.
```

Remove the hardcoded JSON blocks for health_check and devops sections. Keep the "### Future Migrations" note but update it to say: "Adding new features follows the same pattern: add the feature schema to feature-manifest.json. The apply-migration command automatically detects and fills gaps."

Preserve ALL other sections of version-migration.md unchanged (Version Detection, Migration Rules table, Mini-Onboarding, Migration Log, Auto-Detect Mechanism, Error Handling).

Update the Mini-Onboarding section to reference the manifest: change "Current Onboarding Questions (v1.12.0)" to "Onboarding Questions" and add a note: "Questions and options for each feature are declared in feature-manifest.json via `init_prompts`. Use `manifest get-prompts <feature>` to retrieve them."
  </action>
  <verify>
1. Read upgrade-project.md -- Step 5 contains `manifest apply-migration` and `manifest diff-config`, NOT hardcoded health_check/devops JSON
2. Read upgrade-project.md -- Step 6 contains `manifest log-migration`, NOT manual markdown append logic
3. Read version-migration.md -- no hardcoded JSON blocks with `"health_check"` or `"devops"` keys
4. Read version-migration.md -- Migration Actions section references `manifest apply-migration`
5. `grep -c "manifest apply-migration" get-shit-done/workflows/upgrade-project.md` returns 1+
6. `grep -c '"health_check"' get-shit-done/references/version-migration.md` returns 0
  </verify>
  <done>
upgrade-project.md uses manifest commands for gap detection (diff-config), filling defaults (apply-migration), interactive prompts (get-prompts), and logging (log-migration). version-migration.md no longer contains hardcoded migration actions -- it references the manifest system instead.
  </done>
</task>

<task type="auto">
  <name>Task 2: Modify new-project.md to use manifest-driven feature configuration</name>
  <files>
    get-shit-done/workflows/new-project.md
  </files>
  <action>
**Part A: Replace the hardcoded config template in Step 5**

Find the config.json template in Step 5 (around lines 318-345) that contains hardcoded `health_check` and `devops` sections. Replace it with a template that only contains core workflow fields:

```json
{
  "mode": "yolo|interactive",
  "depth": "quick|standard|comprehensive",
  "parallelization": true|false,
  "commit_docs": true|false,
  "model_profile": "quality|balanced|budget",
  "workflow": {
    "research": true|false,
    "plan_check": true|false,
    "verifier": true|false
  },
  "gsd_reflect_version": "<installed_version>",
  "manifest_version": <manifest_version>
}
```

Remove `health_check` and `devops` sections from this template. These are now handled by the manifest in Step 5.5.

Add `manifest_version` to the template -- read from `feature-manifest.json` during project setup.

**Part B: Add Step 5.5 -- Manifest-Driven Feature Configuration**

Insert a new step between Step 5 (core preferences) and Step 5.7 (or Step 6 if 5.7 is removed). This step uses manifest commands to gather feature config:

```markdown
## 5.5. Feature Configuration (Manifest-Driven)

After creating the initial config.json with core preferences, configure manifest-declared features.

For each feature in the manifest:

1. **Auto-detect:** Run `node ~/.claude/get-shit-done/bin/gsd-tools.js manifest auto-detect <feature> --raw` to detect values from the project filesystem
2. **Get prompts:** Run `node ~/.claude/get-shit-done/bin/gsd-tools.js manifest get-prompts <feature> --raw`
3. **Handle _gate prompts:** If the feature has a prompt with `field: "_gate"`:
   - Ask the gate question via AskUserQuestion
   - If user selects `skip_value`: apply all defaults for this feature (skip remaining prompts)
   - If user selects configure: continue with remaining prompts
4. **Interactive mode:** For each non-gate prompt:
   - Present question and options via AskUserQuestion
   - Use auto-detected values as pre-selected defaults where available
   - Write user choice: `node ~/.claude/get-shit-done/bin/gsd-tools.js config-set <config_key>.<field> <value>`
5. **Auto/YOLO mode:** Use auto-detected values where available, manifest defaults for the rest

After all features processed, fill any remaining gaps:
```bash
node ~/.claude/get-shit-done/bin/gsd-tools.js manifest apply-migration --raw
```

Log the initial configuration:
```bash
node ~/.claude/get-shit-done/bin/gsd-tools.js manifest log-migration --from "0.0.0" --to "<installed_version>" --changes '<changes_from_apply_migration>' --raw
```
```

**Part C: Remove Step 5.7 hardcoded DevOps detection**

Remove or replace the entire Step 5.7 section that contains hardcoded bash scripts for CI/CD detection, deployment detection, and commit convention detection (the bash block with `[ -d ".github/workflows" ]` checks and the `DEVOPS_CI`, `DEVOPS_DEPLOY`, `DEVOPS_COMMITS` variables around lines 367-445).

Replace with a brief note:

```markdown
## 5.7. DevOps Context

DevOps detection is now handled by Step 5.5 via `manifest auto-detect devops`. The manifest's auto_detect rules check for CI/CD directories, deployment config files, and commit conventions automatically. No separate DevOps step is needed.

**Skip condition logic from Step 5.7 is preserved:** If greenfield project AND no DevOps signals during questioning, the _gate prompt in the devops feature handles this -- the user can select "Skip (use defaults)" to apply all defaults without further questions.
```

**Important:** The skip condition logic (greenfield check, DevOps signals check) should be preserved in the _gate prompt handling in Step 5.5, not removed entirely. The manifest's devops `_gate` prompt with `skip_value: "skip"` serves the same purpose.

**Part D: Preserve all other steps unchanged**

Steps 1-4 (setup, brownfield detection, questioning, PROJECT.md creation), Step 5 Round 1+2 (core preference questions), Step 5.5 (model profile resolution), and Steps 6-9 (research, requirements, roadmap, done) should NOT be modified.
  </action>
  <verify>
1. `grep -c '"health_check"' get-shit-done/workflows/new-project.md` returns 0 (no hardcoded health_check JSON template)
2. `grep -c '"devops"' get-shit-done/workflows/new-project.md` -- should be minimal (only in Step 5.7 note referencing the feature, not in a JSON template)
3. `grep -c 'DEVOPS_CI=' get-shit-done/workflows/new-project.md` returns 0 (no hardcoded bash detection scripts)
4. `grep -c 'manifest apply-migration' get-shit-done/workflows/new-project.md` returns 1+ (new Step 5.5)
5. `grep -c 'manifest auto-detect' get-shit-done/workflows/new-project.md` returns 1+ (new Step 5.5)
6. `grep -c 'manifest_version' get-shit-done/workflows/new-project.md` returns 1+ (in config template)
  </verify>
  <done>
new-project.md config template contains only core workflow fields (no hardcoded health_check/devops). Step 5.5 uses manifest auto-detect + get-prompts + apply-migration for feature initialization. Step 5.7 no longer contains hardcoded bash detection scripts. Adding a new feature to the manifest automatically makes it available during new project setup.
  </done>
</task>

<task type="auto">
  <name>Task 3: Add post-install config gap check to update.md</name>
  <files>
    get-shit-done/workflows/update.md
  </files>
  <action>
**Add a new step between "run_update" and "display_result"**

Insert a new step called "check_config_gaps" after the `run_update` step (which does the actual npm install) and before `display_result` (which shows the completion message):

```markdown
<step name="check_config_gaps">
## Post-Install Config Check

After installation completes, check if the updated version introduces new features:

```bash
DIFF=$(node ~/.claude/get-shit-done/bin/gsd-tools.js manifest diff-config --raw 2>/dev/null)
```

**If command fails** (no config.json, no manifest, or any error): Skip this step silently. The user may not have an initialized project.

**If command succeeds**, parse the JSON and count gaps:
- Count `missing_features` and `missing_fields` arrays
- Check if `manifest_version` > `config_manifest_version`

**If no gaps found:** Skip silently (config is already up to date).

**If gaps found:**

Read mode from `.planning/config.json`:

**YOLO mode:** Auto-apply the migration:
```bash
RESULT=$(node ~/.claude/get-shit-done/bin/gsd-tools.js manifest apply-migration --raw)
```

Then log the migration:
```bash
node ~/.claude/get-shit-done/bin/gsd-tools.js manifest log-migration --from "<old_version>" --to "<new_version>" --changes '<changes_from_result>' --raw
```

Update version stamp:
```bash
node ~/.claude/get-shit-done/bin/gsd-tools.js config-set gsd_reflect_version "<new_version>"
```

Display:
```
Config updated automatically: {N} new feature(s) configured with defaults.
```

**Interactive mode:** Display an informational message:
```
New features available after update:
- {feature_name}: {feature description from manifest}
  (missing {N} field(s))

Run `/gsd:upgrade-project` to configure these features.
```

Do NOT auto-apply in interactive mode -- the user may want to choose non-default values via the upgrade-project flow.
</step>
```

**Update success_criteria** at the bottom of update.md to add:
```markdown
- [ ] Post-install config gaps checked
- [ ] YOLO mode auto-applies config migration
- [ ] Interactive mode offers /gsd:upgrade-project
```

**Preserve all existing steps unchanged.** The new step is purely additive -- it does not modify any existing step behavior.
  </action>
  <verify>
1. `grep -c 'check_config_gaps' get-shit-done/workflows/update.md` returns 1 (new step exists)
2. `grep -c 'manifest diff-config' get-shit-done/workflows/update.md` returns 1+ (gap detection)
3. `grep -c 'manifest apply-migration' get-shit-done/workflows/update.md` returns 1+ (YOLO auto-apply)
4. `grep -c 'upgrade-project' get-shit-done/workflows/update.md` returns 1+ (interactive mode offer)
5. Read update.md structure -- check_config_gaps appears between run_update and display_result steps
  </verify>
  <done>
update.md has a post-install step that detects config gaps via manifest diff-config, auto-applies in YOLO mode via apply-migration with logging, and offers /gsd:upgrade-project in interactive mode. All existing steps are preserved unchanged.
  </done>
</task>

</tasks>

<verification>
1. No hardcoded feature config in workflow files:
   - `grep '"health_check"' get-shit-done/workflows/upgrade-project.md` returns nothing
   - `grep '"health_check"' get-shit-done/workflows/new-project.md` returns nothing (not in a JSON template)
   - `grep 'DEVOPS_CI=' get-shit-done/workflows/new-project.md` returns nothing
   - `grep '"health_check"' get-shit-done/references/version-migration.md` returns nothing
2. All three workflows reference manifest commands:
   - upgrade-project.md: manifest apply-migration, manifest diff-config, manifest log-migration, manifest get-prompts
   - new-project.md: manifest apply-migration, manifest auto-detect, manifest get-prompts, manifest log-migration
   - update.md: manifest diff-config, manifest apply-migration, manifest log-migration
3. version-migration.md references manifest system instead of hardcoded actions
</verification>

<success_criteria>
- upgrade-project.md Step 5 is fully manifest-driven (no hardcoded feature patches)
- new-project.md config template has NO feature sections (only core workflow fields)
- new-project.md Step 5.7 has NO hardcoded bash detection scripts
- update.md has post-install config gap check that works in both YOLO and interactive modes
- version-migration.md has NO hardcoded migration action JSON blocks
- Adding a new feature to feature-manifest.json requires ZERO workflow file changes
</success_criteria>

<output>
After completion, create `.planning/phases/24-manifest-driven-config-migration/24-03-SUMMARY.md`
</output>
