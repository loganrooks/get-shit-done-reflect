---
phase: 27-workflow-dx-reliability
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - scripts/dev-setup.sh
  - scripts/dev-teardown.sh
  - tests/smoke/run-smoke.sh
  - .claude/agents/kb-rebuild-index.sh
  - .claude/agents/kb-create-dirs.sh
autonomous: true

must_haves:
  truths:
    - "dev-setup.sh uses #!/usr/bin/env bash shebang and set -eo pipefail"
    - "dev-teardown.sh uses #!/usr/bin/env bash shebang and set -eo pipefail"
    - "run-smoke.sh uses ${GSD_HOME:-$HOME/.gsd} for KB_DIR instead of hardcoded $HOME/.gsd"
    - "run-smoke.sh uses portable mktemp (no -t flag)"
    - "kb-rebuild-index.sh uses set -o pipefail without breaking on empty knowledge base"
    - "kb-create-dirs.sh uses set -o pipefail"
  artifacts:
    - path: "scripts/dev-setup.sh"
      provides: "Portable shebang and pipefail error propagation"
      contains: "#!/usr/bin/env bash"
    - path: "scripts/dev-teardown.sh"
      provides: "Portable shebang and pipefail error propagation"
      contains: "#!/usr/bin/env bash"
    - path: "tests/smoke/run-smoke.sh"
      provides: "GSD_HOME-aware KB path and portable mktemp"
      contains: "GSD_HOME:-"
    - path: ".claude/agents/kb-rebuild-index.sh"
      provides: "Pipeline error propagation"
      contains: "set -o pipefail"
    - path: ".claude/agents/kb-create-dirs.sh"
      provides: "Pipeline error propagation"
      contains: "set -o pipefail"
  key_links:
    - from: "kb-rebuild-index.sh pipefail"
      to: "get_field() and get_tags() grep pipelines"
      via: "grep returns exit 1 on no match; existing 2>/dev/null handles this"
      pattern: "grep.*2>/dev/null"
---

<objective>
Fix shell script portability issues across 5 scripts: add `set -o pipefail` for error propagation, use portable `#!/usr/bin/env bash` shebangs, replace hardcoded `$HOME/.gsd` with `${GSD_HOME:-$HOME/.gsd}`, and use portable `mktemp`.

Purpose: DX-04 -- shell scripts should work across environments (macOS, Linux, custom GSD_HOME) without surprises. Pipeline errors should not be silently swallowed, and home directory paths should respect the GSD_HOME override.

Output: 5 updated shell scripts with portable constructs.
</objective>

<execution_context>
@/Users/rookslog/.claude/get-shit-done/workflows/execute-plan.md
@/Users/rookslog/.claude/get-shit-done/templates/summary-standard.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/27-workflow-dx-reliability/27-RESEARCH.md
@scripts/dev-setup.sh
@scripts/dev-teardown.sh
@tests/smoke/run-smoke.sh
@.claude/agents/kb-rebuild-index.sh
@.claude/agents/kb-create-dirs.sh
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix shebangs and add pipefail to dev scripts</name>
  <files>scripts/dev-setup.sh, scripts/dev-teardown.sh</files>
  <action>
    **In scripts/dev-setup.sh:**
    1. Change line 1 from `#!/bin/bash` to `#!/usr/bin/env bash`
    2. Change `set -e` to `set -eo pipefail` (add pipefail alongside existing errexit)
    3. No other changes -- the script's logic is correct

    **In scripts/dev-teardown.sh:**
    1. Change line 1 from `#!/bin/bash` to `#!/usr/bin/env bash`
    2. Change `set -e` to `set -eo pipefail` (add pipefail alongside existing errexit)
    3. No other changes -- the script's logic is correct

    These are minimal, targeted changes. The `-o pipefail` flag ensures that if any command in a pipeline fails, the pipeline returns the failing command's exit status instead of the last command's status. While neither dev script currently uses pipelines, adding pipefail proactively prevents future regressions if pipelines are added.
  </action>
  <verify>
    ```bash
    head -3 /Users/rookslog/Development/get-shit-done-reflect/scripts/dev-setup.sh
    head -3 /Users/rookslog/Development/get-shit-done-reflect/scripts/dev-teardown.sh
    ```
    Both show `#!/usr/bin/env bash` and `set -eo pipefail`.

    ```bash
    bash -n /Users/rookslog/Development/get-shit-done-reflect/scripts/dev-setup.sh && echo "syntax ok"
    bash -n /Users/rookslog/Development/get-shit-done-reflect/scripts/dev-teardown.sh && echo "syntax ok"
    ```
    Both pass syntax check.
  </verify>
  <done>dev-setup.sh and dev-teardown.sh use portable #!/usr/bin/env bash shebang and set -eo pipefail</done>
</task>

<task type="auto">
  <name>Task 2: Fix GSD_HOME, mktemp, and pipefail in smoke and KB scripts</name>
  <files>tests/smoke/run-smoke.sh, .claude/agents/kb-rebuild-index.sh, .claude/agents/kb-create-dirs.sh</files>
  <action>
    **In tests/smoke/run-smoke.sh:**

    1. Fix KB_DIR (line 31): Change `KB_DIR="$HOME/.gsd/knowledge"` to `KB_DIR="${GSD_HOME:-$HOME/.gsd}/knowledge"`
       This respects the GSD_HOME override used in testing and custom installations.

    2. Fix mktemp (line 65): Change `WORK_DIR=$(mktemp -d -t gsd-smoke-XXXXXX)` to `WORK_DIR=$(mktemp -d "${TMPDIR:-/tmp}/gsd-smoke-XXXXXX")`
       The `-t` flag is a BSD/macOS extension. Using `${TMPDIR:-/tmp}` with a positional template argument is portable across both GNU coreutils and BSD mktemp.

    3. Do NOT change the `set -uo pipefail` line -- it already has pipefail. The intentional omission of `-e` is documented in a comment.

    **In .claude/agents/kb-rebuild-index.sh:**

    1. Add `set -o pipefail` as line 6 (after the header comment block, before `KB_DIR=...`).

    2. CRITICAL: Audit all pipelines for grep exit-code safety. The `get_field()` and `get_tags()` functions use `grep ... 2>/dev/null | head -1 | sed ...`. When grep finds no match, it returns exit code 1. With pipefail, this would fail the pipeline.

       However, these functions are called via command substitution (`status=$(get_field "$file" "status")`) which captures the value. The calling code always checks the result with `[ -z "$status" ]` or `[ "$status" = "archived" ]`. The exit code is not checked.

       BUT: inside the `while IFS= read -r` loops, a failing `get_field` could cause issues with `set -o pipefail` if the loops are in a pipeline context. Check carefully.

       Resolution: The `collect_entries()` function is called via process substitution (`< <(collect_entries ... | sort ...)`), not a pipeline in the main script body. The `get_field` calls happen inside functions where local exit codes don't propagate to the caller due to command substitution. This is safe.

       To be extra safe, add `|| true` to the `grep` calls in `get_field()` and `get_tags()`:
       - `grep "^${field}:" "$file" 2>/dev/null || true | head -1 | ...`

       Wait -- that would change the logic. Instead, use the grouping approach:
       - `{ grep "^${field}:" "$file" 2>/dev/null || true; } | head -1 | sed ...`

       Actually, the simplest and safest approach: since `get_field` and `get_tags` are helper functions called via command substitution, their exit codes are captured by the variable assignment, not by the shell's error handling. The `2>/dev/null` on grep already suppresses stderr. With pipefail, if grep returns 1 (no match), the pipeline returns 1, but since the function output is captured in `$()`, this only affects the $? of the assignment. The calling code never checks `$?` -- it only checks the string value. So this is safe AS-IS.

       However, the `collect_entries ... | sort` pipeline in the process substitutions COULD be affected if `collect_entries` returns non-zero. But `collect_entries` ends with `done` (end of while loop), which returns the exit status of the last `echo` command (always 0 if there are entries). For empty directories, the function returns early with `return` (implicit 0). This is safe.

       Conclusion: Adding `set -o pipefail` is safe for kb-rebuild-index.sh without any other changes.

    **In .claude/agents/kb-create-dirs.sh:**

    1. Add `set -o pipefail` as line 5 (after the header comment, before `KB_DIR=...`).
       This script has no pipelines, but adding pipefail is good hygiene for consistency and future-proofing.
  </action>
  <verify>
    ```bash
    # Verify GSD_HOME fix in run-smoke.sh
    grep 'GSD_HOME' /Users/rookslog/Development/get-shit-done-reflect/tests/smoke/run-smoke.sh | head -3

    # Verify mktemp fix
    grep 'mktemp' /Users/rookslog/Development/get-shit-done-reflect/tests/smoke/run-smoke.sh

    # Verify pipefail in kb scripts
    grep 'pipefail' /Users/rookslog/Development/get-shit-done-reflect/.claude/agents/kb-rebuild-index.sh
    grep 'pipefail' /Users/rookslog/Development/get-shit-done-reflect/.claude/agents/kb-create-dirs.sh

    # Syntax check all modified scripts
    bash -n /Users/rookslog/Development/get-shit-done-reflect/tests/smoke/run-smoke.sh && echo "smoke ok"
    bash -n /Users/rookslog/Development/get-shit-done-reflect/.claude/agents/kb-rebuild-index.sh && echo "kb-rebuild ok"
    bash -n /Users/rookslog/Development/get-shit-done-reflect/.claude/agents/kb-create-dirs.sh && echo "kb-create ok"
    ```
    All scripts pass syntax check and contain the expected portable constructs.
  </verify>
  <done>run-smoke.sh uses ${GSD_HOME:-$HOME/.gsd} for KB_DIR and portable mktemp; kb-rebuild-index.sh and kb-create-dirs.sh have set -o pipefail; all scripts pass bash syntax check</done>
</task>

</tasks>

<verification>
```bash
# Verify all 5 scripts have portable constructs
echo "=== Shebangs ==="
head -1 scripts/dev-setup.sh scripts/dev-teardown.sh .claude/agents/kb-rebuild-index.sh .claude/agents/kb-create-dirs.sh tests/smoke/run-smoke.sh

echo "=== Pipefail ==="
grep -l "pipefail" scripts/dev-setup.sh scripts/dev-teardown.sh .claude/agents/kb-rebuild-index.sh .claude/agents/kb-create-dirs.sh tests/smoke/run-smoke.sh

echo "=== GSD_HOME in smoke ==="
grep "GSD_HOME" tests/smoke/run-smoke.sh | head -3

echo "=== Portable mktemp ==="
grep "mktemp" tests/smoke/run-smoke.sh

echo "=== Syntax checks ==="
for f in scripts/dev-setup.sh scripts/dev-teardown.sh .claude/agents/kb-rebuild-index.sh .claude/agents/kb-create-dirs.sh tests/smoke/run-smoke.sh; do
  bash -n "$f" && echo "$f: ok" || echo "$f: FAIL"
done
```
</verification>

<success_criteria>
- dev-setup.sh: #!/usr/bin/env bash shebang, set -eo pipefail
- dev-teardown.sh: #!/usr/bin/env bash shebang, set -eo pipefail
- run-smoke.sh: KB_DIR uses ${GSD_HOME:-$HOME/.gsd}, mktemp uses portable form (no -t flag)
- kb-rebuild-index.sh: set -o pipefail added, empty KB does not cause errors
- kb-create-dirs.sh: set -o pipefail added
- All 5 scripts pass bash -n syntax check
- No behavioral changes to any script (only error handling and portability improvements)
</success_criteria>

<output>
After completion, create `.planning/phases/27-workflow-dx-reliability/27-03-SUMMARY.md`
</output>
