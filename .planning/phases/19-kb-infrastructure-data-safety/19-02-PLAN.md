---
phase: 19-kb-infrastructure-data-safety
plan: 02
type: execute
wave: 2
depends_on: ["19-01"]
files_modified:
  - bin/install.js
  - .claude/agents/kb-templates/signal.md
  - .claude/agents/kb-templates/spike.md
  - .claude/agents/kb-templates/lesson.md
  - .claude/agents/knowledge-store.md
  - .claude/agents/gsd-signal-collector.md
  - .claude/agents/gsd-spike-runner.md
  - .claude/agents/gsd-reflector.md
  - tests/integration/kb-infrastructure.test.js
autonomous: true

must_haves:
  truths:
    - "KB migration creates a timestamped backup BEFORE any data operations, preventing data loss"
    - "Backup integrity is verified by comparing entry counts before and after backup"
    - "All KB entry types (signal, spike, lesson) include a gsd_version field in their templates"
    - "Spike and lesson templates include runtime and model provenance fields matching signals"
  artifacts:
    - path: "bin/install.js"
      provides: "Pre-migration backup with verification in migrateKB()"
      contains: "backup-"
    - path: ".claude/agents/kb-templates/signal.md"
      provides: "Signal template with gsd_version field"
      contains: "gsd_version"
    - path: ".claude/agents/kb-templates/spike.md"
      provides: "Spike template with runtime, model, gsd_version fields"
      contains: "gsd_version"
    - path: ".claude/agents/kb-templates/lesson.md"
      provides: "Lesson template with runtime, model, gsd_version fields"
      contains: "gsd_version"
    - path: ".claude/agents/knowledge-store.md"
      provides: "Schema documentation for gsd_version and provenance fields on all types"
      contains: "gsd_version"
    - path: "tests/integration/kb-infrastructure.test.js"
      provides: "Tests for backup and provenance"
      contains: "backup"
  key_links:
    - from: "bin/install.js migrateKB()"
      to: "~/.gsd/knowledge.backup-*"
      via: "fs.cpSync before migration operations"
      pattern: "backup.*timestamp"
    - from: ".claude/agents/kb-templates/spike.md"
      to: ".claude/agents/knowledge-store.md"
      via: "schema consistency"
      pattern: "runtime.*model.*gsd_version"
    - from: ".claude/agents/gsd-signal-collector.md"
      to: "gsd_version"
      via: "version detection instructions"
      pattern: "gsd_version|VERSION"
---

<objective>
Add pre-migration backup to migrateKB(), add gsd_version provenance field to all KB templates, and add runtime/model fields to spike and lesson templates.

Purpose: The v1.13 migration caused data loss (13 signals + 3 lessons) because there was no pre-migration backup. Spike and lesson entries lack the runtime/model provenance fields that signals already have. No entry type carries gsd_version for version tracking. This plan closes all three gaps.

Output: Pre-migration backup in migrateKB(), updated templates with provenance fields, updated schema docs, version detection instructions in agent specs, tests for all additions.
</objective>

<execution_context>
@/Users/rookslog/.claude/get-shit-done/workflows/execute-plan.md
@/Users/rookslog/.claude/get-shit-done/templates/summary-standard.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/19-kb-infrastructure-data-safety/19-RESEARCH.md
@.planning/phases/19-kb-infrastructure-data-safety/19-01-SUMMARY.md
@bin/install.js
@.claude/agents/knowledge-store.md
@.claude/agents/kb-templates/signal.md
@.claude/agents/kb-templates/spike.md
@.claude/agents/kb-templates/lesson.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add pre-migration backup with verification to migrateKB()</name>
  <files>bin/install.js</files>
  <action>
Modify the existing `migrateKB(gsdHome, runtimes)` function in `bin/install.js` (starting at line 233) to add a pre-migration backup BEFORE any data operations.

**Insert the backup logic at the very beginning of the function, right after `const newKBDir = path.join(gsdHome, 'knowledge');` (line 235) and BEFORE the Step 1 comment (line 237).**

The backup logic:

```javascript
// PRE-MIGRATION BACKUP: Safety net before any KB operations
if (fs.existsSync(newKBDir)) {
  const existingEntries = countKBEntries(newKBDir);
  if (existingEntries > 0) {
    const timestamp = new Date().toISOString().replace(/[:.]/g, '-').slice(0, 19);
    const backupDir = newKBDir + '.backup-' + timestamp;
    fs.cpSync(newKBDir, backupDir, { recursive: true });

    // Verify backup integrity
    const backupEntries = countKBEntries(backupDir);
    if (backupEntries < existingEntries) {
      console.error(`  ${yellow}!${reset} Backup verification failed: ${existingEntries} entries in source, ${backupEntries} in backup`);
      console.error(`    Aborting migration. Manual intervention required.`);
      return;
    }
    console.log(`  ${green}+${reset} Backed up ${existingEntries} KB entries to ${path.basename(backupDir)}`);
  }
}
```

**Key design decisions:**
- Use `newKBDir` (the `~/.gsd/knowledge/` location) for backup, NOT the old `~/.claude/gsd-knowledge/` path. The backup protects the current KB data wherever it lives.
- Timestamped backup name: `knowledge.backup-YYYY-MM-DDTHHMMSS` (ISO timestamp with colons/periods replaced by hyphens)
- Verify backup by comparing entry counts. Abort migration if backup is incomplete.
- Do NOT auto-clean old backups. Let them accumulate. Users clean up manually.
- The backup ONLY runs when there are existing entries (skip for empty/new KBs).
- The backup runs on every migration call. Since `migrateKB()` early-returns if the old KB is already a symlink (line 254-258), the backup will only actually be followed by migration work on the first migration. But backing up before any operation is the safety principle.

**Also backup the old KB location if it exists and is not a symlink.** Add a second backup block after the existing `if (fs.existsSync(oldKBDir))` check (line 245) and before the migration copy (line 263). This backs up the OLD location before copying it to the new location:

```javascript
if (!isSymlink) {
  // Back up old KB before migration
  const oldEntries = countKBEntries(oldKBDir);
  if (oldEntries > 0) {
    const timestamp = new Date().toISOString().replace(/[:.]/g, '-').slice(0, 19);
    const oldBackupDir = oldKBDir + '.backup-' + timestamp;
    fs.cpSync(oldKBDir, oldBackupDir, { recursive: true });
    console.log(`  ${green}+${reset} Backed up old KB (${oldEntries} entries) to ${path.basename(oldBackupDir)}`);
  }
  // ... existing migration logic continues ...
}
```

Wait -- the existing code already does `fs.renameSync(oldKBDir, backupDir)` at line 275 which renames old to `*.migration-backup`. This is the post-migration backup that already exists. The PRE-migration backup of the NEW location (the first block above) is the important addition. For the old KB backup, the existing rename-to-backup is sufficient. Do NOT add a second old-KB backup -- the existing `renameSync` to `*.migration-backup` already preserves it.

So the net change is: Add ONLY the pre-migration backup of `newKBDir` (the first code block above) at the top of migrateKB(), before any `mkdirSync` or `cpSync` calls.

**Export `migrateKB` if not already exported** for testing (check the module.exports at the bottom of install.js and ensure it's included -- it likely already is from Phase 14 tests).
  </action>
  <verify>
1. `grep -n 'backup-' bin/install.js` shows the timestamped backup pattern in migrateKB()
2. `grep -n 'Backup verification failed' bin/install.js` shows the integrity check
3. `grep -n 'Backed up.*KB entries' bin/install.js` shows the success log
4. `node -e "require('./bin/install.js')"` does not throw
  </verify>
  <done>
migrateKB() creates a timestamped pre-migration backup of ~/.gsd/knowledge/ before any operations. Backup integrity is verified by entry count comparison. Migration aborts if backup is incomplete.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add gsd_version and provenance fields to KB templates, schema, and agent specs</name>
  <files>
    .claude/agents/kb-templates/signal.md
    .claude/agents/kb-templates/spike.md
    .claude/agents/kb-templates/lesson.md
    .claude/agents/knowledge-store.md
    .claude/agents/gsd-signal-collector.md
    .claude/agents/gsd-spike-runner.md
    .claude/agents/gsd-reflector.md
  </files>
  <action>
**Part A: Add gsd_version to signal template**

In `.claude/agents/kb-templates/signal.md`, add `gsd_version: {version-string}` as the last frontmatter field, after `model:`. The signal template already has `runtime:` and `model:` (added in Phase 16). Only `gsd_version` is missing.

Result:
```yaml
runtime: {claude-code|opencode|gemini-cli|codex-cli}
model: {model-identifier}
gsd_version: {version-string}
```

**Part B: Add runtime, model, and gsd_version to spike template**

In `.claude/agents/kb-templates/spike.md`, add three new fields after `rounds:` and before the closing `---`:

```yaml
rounds: {number}
runtime: {claude-code|opencode|gemini-cli|codex-cli}
model: {model-identifier}
gsd_version: {version-string}
```

**Part C: Add runtime, model, and gsd_version to lesson template**

In `.claude/agents/kb-templates/lesson.md`, add three new fields after `evidence:` and before the closing `---`:

```yaml
evidence: [{entry-id-1}, {entry-id-2}]
runtime: {claude-code|opencode|gemini-cli|codex-cli}
model: {model-identifier}
gsd_version: {version-string}
```

**Part D: Update knowledge-store.md schema documentation**

In `.claude/agents/knowledge-store.md`:

1. **Common Base Schema (Section 3):** Add `gsd_version` as an optional field to the common base schema table (around line 79, after the "Optional freshness fields" section). Add a new section:

```markdown
**Optional provenance fields:**

| Field | Type | Description |
|-------|------|-------------|
| `runtime` | enum | Runtime that created this entry: `claude-code`, `opencode`, `gemini-cli`, or `codex-cli` |
| `model` | string | LLM model identifier (e.g., `claude-opus-4-6`, `o3`) |
| `gsd_version` | string | GSD version that created this entry (e.g., `1.14.0`). Read from VERSION file or config.json |

These fields are optional for backward compatibility. Existing entries without them remain valid. New entries SHOULD include all three when available.
```

2. **Signal Extensions (Section 4):** The `runtime` and `model` fields are currently listed under Signal Extensions (lines 108-109). MOVE them to the common base schema provenance section (Part D.1 above) and REMOVE them from Signal Extensions. This reflects the new reality that ALL types have these fields, not just signals. Update the Signal Extensions table to remove the `runtime` and `model` rows.

3. **Spike Extensions (Section 4):** Do NOT add runtime/model/gsd_version here since they are now in the common base schema.

4. **Lesson Extensions (Section 4):** Same -- do NOT add here; they're in common base schema.

**Part E: Add version detection instructions to agent specs**

Add a brief "Version Detection" note to each of the three KB-writing agent specs. Insert it near the KB write step in each agent:

For `.claude/agents/gsd-signal-collector.md`, `.claude/agents/gsd-spike-runner.md`, and `.claude/agents/gsd-reflector.md`:

Find the section where KB entries are written/created. Add this instruction nearby (adapt wording to fit context):

```markdown
**Provenance fields:** When creating KB entries, populate:
- `runtime`: Detect from installed path prefix (~/.claude/ = claude-code, ~/.config/opencode/ = opencode, ~/.gemini/ = gemini-cli, ~/.codex/ = codex-cli)
- `model`: Use the current model identifier (available from session context)
- `gsd_version`: Read from VERSION file at the current runtime's install directory (e.g., ~/.claude/get-shit-done/VERSION). Fallback: read `gsd_reflect_version` from `.planning/config.json`. If neither available, use "unknown".
```

These are INSTRUCTIONS for the LLM agents that populate these fields at entry-creation time. The fields are NOT auto-populated by code -- the LLM reads the VERSION file and fills in the value.

**Important:** All new fields (runtime, model, gsd_version) are OPTIONAL. Existing KB entries without them remain valid. Do NOT modify any existing KB entries.
  </action>
  <verify>
1. `grep 'gsd_version' .claude/agents/kb-templates/signal.md` shows the field
2. `grep 'gsd_version' .claude/agents/kb-templates/spike.md` shows the field
3. `grep 'gsd_version' .claude/agents/kb-templates/lesson.md` shows the field
4. `grep 'runtime' .claude/agents/kb-templates/spike.md` shows the field
5. `grep 'model' .claude/agents/kb-templates/lesson.md` shows the field
6. `grep 'gsd_version' .claude/agents/knowledge-store.md` shows schema documentation
7. `grep -c 'runtime.*model.*gsd_version\|gsd_version.*runtime\|Provenance fields' .claude/agents/gsd-signal-collector.md .claude/agents/gsd-spike-runner.md .claude/agents/gsd-reflector.md` shows 3 files with provenance instructions
  </verify>
  <done>
All three KB templates include gsd_version field. Spike and lesson templates include runtime and model fields (matching signals). knowledge-store.md schema documents provenance fields in common base schema. All three KB-writing agent specs include version detection instructions.
  </done>
</task>

<task type="auto">
  <name>Task 3: Add tests for pre-migration backup and provenance fields</name>
  <files>tests/integration/kb-infrastructure.test.js</files>
  <action>
Add new test blocks to `tests/integration/kb-infrastructure.test.js`:

**Block 1: `describe('migrateKB pre-migration backup')`**

1. **"creates timestamped backup when KB has existing entries"**
   - Create a temp gsdHome with `knowledge/signals/test-project/` containing a test signal file
   - Call `migrateKB(tmpGsdHome, ['claude'])`
   - Verify a `knowledge.backup-*` directory exists in tmpGsdHome (use `fs.readdirSync` and filter for `knowledge.backup-`)
   - Verify the backup directory contains the test signal file

2. **"backup preserves all entry files"**
   - Create 3 test entries across signals/, spikes/, lessons/ subdirectories
   - Call `migrateKB(tmpGsdHome, ['claude'])`
   - Find the backup directory
   - Verify `countKBEntries(backupDir)` equals 3

3. **"skips backup when KB is empty"**
   - Create tmpGsdHome with empty `knowledge/` directory (no entries)
   - Call `migrateKB(tmpGsdHome, ['claude'])`
   - Verify NO `knowledge.backup-*` directories exist

4. **"skips backup when KB directory does not exist"**
   - Create tmpGsdHome with NO `knowledge/` directory
   - Call `migrateKB(tmpGsdHome, ['claude'])`
   - Verify NO `knowledge.backup-*` directories exist (and no errors thrown)

**Block 2: `describe('KB template provenance fields')`**

5. **"signal template includes gsd_version field"**
   - Read `.claude/agents/kb-templates/signal.md`
   - Assert content includes `gsd_version:`

6. **"spike template includes runtime, model, and gsd_version fields"**
   - Read `.claude/agents/kb-templates/spike.md`
   - Assert content includes `runtime:`, `model:`, and `gsd_version:`

7. **"lesson template includes runtime, model, and gsd_version fields"**
   - Read `.claude/agents/kb-templates/lesson.md`
   - Assert content includes `runtime:`, `model:`, and `gsd_version:`

8. **"knowledge-store.md documents gsd_version in common schema"**
   - Read `.claude/agents/knowledge-store.md`
   - Assert content includes `gsd_version` in a section about common/provenance fields

Follow existing test patterns. Use `path.join(__dirname, '..', '..')` to resolve paths to source files for template tests. For migrateKB tests, use the temp directory patterns already established in the file.
  </action>
  <verify>
1. `npx vitest run tests/integration/kb-infrastructure.test.js` passes ALL tests (existing + new)
2. `grep -c 'backup' tests/integration/kb-infrastructure.test.js` shows 4+ test references
3. `grep -c 'gsd_version' tests/integration/kb-infrastructure.test.js` shows 3+ test references
  </verify>
  <done>
8 new tests cover pre-migration backup (creation, preservation, skip-when-empty, skip-when-missing) and provenance fields (signal gsd_version, spike provenance, lesson provenance, schema documentation). All tests pass alongside existing tests.
  </done>
</task>

</tasks>

<verification>
1. `npx vitest run tests/integration/kb-infrastructure.test.js` -- all tests pass (existing + ~13 new)
2. `grep 'gsd_version' .claude/agents/kb-templates/*.md` -- all 3 templates have the field
3. `grep 'runtime:' .claude/agents/kb-templates/spike.md .claude/agents/kb-templates/lesson.md` -- spike and lesson have runtime
4. `grep 'backup-' bin/install.js` -- migrateKB has timestamped backup
5. `grep 'gsd_version' .claude/agents/knowledge-store.md` -- schema documents the field
</verification>

<success_criteria>
- migrateKB() creates a timestamped pre-migration backup before any data operations
- Backup integrity is verified by entry count comparison; migration aborts if backup fails
- All 3 KB templates (signal, spike, lesson) include gsd_version field
- Spike and lesson templates include runtime and model fields (matching signals)
- knowledge-store.md common base schema documents provenance fields (runtime, model, gsd_version)
- runtime and model moved from signal-only extensions to common base schema in knowledge-store.md
- All 3 KB-writing agent specs include version detection instructions
- 8+ new tests pass for backup and provenance
</success_criteria>

<output>
After completion, create `.planning/phases/19-kb-infrastructure-data-safety/19-02-SUMMARY.md`
</output>
