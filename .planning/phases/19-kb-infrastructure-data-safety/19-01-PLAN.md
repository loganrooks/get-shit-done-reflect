---
phase: 19-kb-infrastructure-data-safety
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - bin/install.js
  - get-shit-done/workflows/signal.md
  - get-shit-done/workflows/reflect.md
  - get-shit-done/workflows/health-check.md
  - get-shit-done/references/spike-execution.md
  - get-shit-done/references/reflection-patterns.md
  - .claude/agents/gsd-signal-collector.md
  - .claude/agents/gsd-spike-runner.md
  - .claude/agents/gsd-reflector.md
  - .claude/get-shit-done/workflows/reflect.md
  - .claude/get-shit-done/workflows/health-check.md
  - .claude/get-shit-done/references/spike-execution.md
  - .claude/get-shit-done/references/reflection-patterns.md
  - .claude/commands/gsd/signal.md
  - tests/integration/kb-infrastructure.test.js
autonomous: true

must_haves:
  truths:
    - "KB scripts are installed to ~/.gsd/bin/ during installation and are executable"
    - "All workflow and agent files reference ~/.gsd/bin/ for KB scripts (zero old-path references remain)"
    - "The installer copies KB scripts to ~/.gsd/bin/ on every install/reinstall"
  artifacts:
    - path: "bin/install.js"
      provides: "installKBScripts() function and integration into installAllRuntimes()"
      contains: "function installKBScripts"
    - path: "get-shit-done/workflows/signal.md"
      provides: "Updated KB script path reference"
      contains: "~/.gsd/bin/kb-rebuild-index.sh"
    - path: "tests/integration/kb-infrastructure.test.js"
      provides: "Tests for KB script installation"
      contains: "installKBScripts"
  key_links:
    - from: "bin/install.js installAllRuntimes()"
      to: "bin/install.js installKBScripts()"
      via: "function call after migrateKB()"
      pattern: "installKBScripts\\(gsdHome\\)"
    - from: "get-shit-done/workflows/signal.md"
      to: "~/.gsd/bin/kb-rebuild-index.sh"
      via: "bash command in workflow"
      pattern: "~/.gsd/bin/kb-rebuild-index.sh"
    - from: ".claude/agents/gsd-signal-collector.md"
      to: "~/.gsd/bin/kb-rebuild-index.sh"
      via: "bash command in agent spec"
      pattern: "~/.gsd/bin/kb-rebuild-index.sh"
---

<objective>
Relocate KB management scripts to ~/.gsd/bin/ and update all path references across source files, local-install copies, and agent specs.

Purpose: KB scripts (kb-rebuild-index.sh, kb-create-dirs.sh) currently live only in .claude/agents/ in the source repo and are never installed to a runtime-agnostic location. Workflows reference them at ~/.claude/agents/ which breaks for non-Claude runtimes. This plan makes them installable and universally accessible.

Output: installKBScripts() function in install.js, all 14 path references updated to ~/.gsd/bin/, tests for script installation.
</objective>

<execution_context>
@/Users/rookslog/.claude/get-shit-done/workflows/execute-plan.md
@/Users/rookslog/.claude/get-shit-done/templates/summary-standard.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/19-kb-infrastructure-data-safety/19-RESEARCH.md
@bin/install.js
@.claude/agents/kb-rebuild-index.sh
@.claude/agents/kb-create-dirs.sh
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add installKBScripts() to installer and update all path references</name>
  <files>
    bin/install.js
    get-shit-done/workflows/signal.md
    get-shit-done/workflows/reflect.md
    get-shit-done/workflows/health-check.md
    get-shit-done/references/spike-execution.md
    get-shit-done/references/reflection-patterns.md
    .claude/agents/gsd-signal-collector.md
    .claude/agents/gsd-spike-runner.md
    .claude/agents/gsd-reflector.md
    .claude/get-shit-done/workflows/reflect.md
    .claude/get-shit-done/workflows/health-check.md
    .claude/get-shit-done/references/spike-execution.md
    .claude/get-shit-done/references/reflection-patterns.md
    .claude/commands/gsd/signal.md
  </files>
  <action>
**Part A: Add installKBScripts() function to bin/install.js**

Create a new function `installKBScripts(gsdHome)` that:
1. Creates `~/.gsd/bin/` directory via `fs.mkdirSync(binDir, { recursive: true })`
2. Copies `kb-rebuild-index.sh` and `kb-create-dirs.sh` from source repo `.claude/agents/` to `~/.gsd/bin/`
3. Sets executable permissions via `fs.chmodSync(dest, 0o755)` after each copy
4. Logs success: `console.log('  ${green}+${reset} Installed KB scripts to ${binDir}')`

The script source path should be resolved relative to `__dirname`: `path.join(__dirname, '..', '.claude', 'agents')`. Check that each source file exists before copying (skip with warning if not found -- handles partial installs).

Place the function near `migrateKB()` (around line 295) since they are related KB infrastructure.

**Part B: Wire installKBScripts() into installAllRuntimes()**

In `installAllRuntimes()` (line 2154), add `installKBScripts(gsdHome)` call immediately after `migrateKB(gsdHome, runtimes)` on line 2157. This runs once globally before the per-runtime loop, matching the pattern of migrateKB(). The call should be:

```javascript
migrateKB(gsdHome, runtimes);
installKBScripts(gsdHome);  // <-- ADD THIS LINE
```

**Part C: Update all path references in source files (get-shit-done/)**

Update these EXACT references from old path to `~/.gsd/bin/`:

1. `get-shit-done/workflows/signal.md` line 207: `bash ~/.claude/agents/kb-rebuild-index.sh` -> `bash ~/.gsd/bin/kb-rebuild-index.sh`
2. `get-shit-done/workflows/reflect.md` line 350: `bash ~/.claude/agents/kb-rebuild-index.sh` -> `bash ~/.gsd/bin/kb-rebuild-index.sh`
3. `get-shit-done/workflows/health-check.md` line 184: `~/.claude/agents/kb-rebuild-index.sh` -> `~/.gsd/bin/kb-rebuild-index.sh`
4. `get-shit-done/workflows/health-check.md` line 215: `~/.claude/agents/kb-rebuild-index.sh` -> `~/.gsd/bin/kb-rebuild-index.sh`
5. `get-shit-done/references/spike-execution.md` line 275: `~/.claude/agents/kb-rebuild-index.sh` -> `~/.gsd/bin/kb-rebuild-index.sh`
6. `get-shit-done/references/reflection-patterns.md` line 579: `~/.claude/agents/kb-rebuild-index.sh` -> `~/.gsd/bin/kb-rebuild-index.sh`

**Part D: Update agent spec references (.claude/agents/)**

7. `.claude/agents/gsd-signal-collector.md` line 151: `~/.claude/agents/kb-rebuild-index.sh` -> `~/.gsd/bin/kb-rebuild-index.sh`
8. `.claude/agents/gsd-spike-runner.md` line 276: `~/.claude/agents/kb-rebuild-index.sh` -> `~/.gsd/bin/kb-rebuild-index.sh`
9. `.claude/agents/gsd-reflector.md` line 151: `~/.claude/agents/kb-rebuild-index.sh` -> `~/.gsd/bin/kb-rebuild-index.sh`

**Part E: Update local-install copies (.claude/get-shit-done/ and .claude/commands/)**

These use relative `./.claude/agents/` paths. Update them ALL to `~/.gsd/bin/`:

10. `.claude/get-shit-done/workflows/reflect.md` line 350: `./.claude/agents/kb-rebuild-index.sh` -> `~/.gsd/bin/kb-rebuild-index.sh`
11. `.claude/get-shit-done/workflows/health-check.md` line 184: `./.claude/agents/kb-rebuild-index.sh` -> `~/.gsd/bin/kb-rebuild-index.sh`
12. `.claude/get-shit-done/workflows/health-check.md` line 215: `./.claude/agents/kb-rebuild-index.sh` -> `~/.gsd/bin/kb-rebuild-index.sh`
13. `.claude/get-shit-done/references/spike-execution.md` line 275: `./.claude/agents/kb-rebuild-index.sh` -> `~/.gsd/bin/kb-rebuild-index.sh`
14. `.claude/get-shit-done/references/reflection-patterns.md` line 579: `./.claude/agents/kb-rebuild-index.sh` -> `~/.gsd/bin/kb-rebuild-index.sh`
15. `.claude/commands/gsd/signal.md` line 191: `./.claude/agents/kb-rebuild-index.sh` -> `~/.gsd/bin/kb-rebuild-index.sh`

**Important:** Do NOT move or delete the scripts from `.claude/agents/` in the source repo. They remain there as the source of truth. The installer COPIES them to `~/.gsd/bin/`. Do NOT update bare-name references (e.g., "Run kb-rebuild-index.sh" without a path) -- those are documentation, not executable references. Specifically leave `get-shit-done/references/health-check.md` line 328 and `get-shit-done/references/reflection-patterns.md` line 240 alone -- they use bare names.

**Post-change verification grep:** After all changes, run `grep -r '~/.claude/agents/kb-' get-shit-done/ .claude/agents/ .claude/get-shit-done/ .claude/commands/` and confirm ZERO matches for full-path old references. Also run `grep -r '.claude/agents/kb-' .claude/get-shit-done/ .claude/commands/` to catch relative path references.
  </action>
  <verify>
1. `grep -rn 'function installKBScripts' bin/install.js` shows the new function
2. `grep -rn 'installKBScripts(gsdHome)' bin/install.js` shows the call in installAllRuntimes()
3. `grep -rn '~/.claude/agents/kb-' get-shit-done/ .claude/agents/gsd-*.md` returns ZERO matches
4. `grep -rn './.claude/agents/kb-' .claude/get-shit-done/ .claude/commands/` returns ZERO matches
5. `grep -rn '~/.gsd/bin/kb-' get-shit-done/ .claude/agents/gsd-*.md .claude/get-shit-done/ .claude/commands/` returns 15 matches (all the updated references)
6. `node -e "require('./bin/install.js')"` does not throw (syntax check with require.main guard)
  </verify>
  <done>
installKBScripts() function exists in install.js and is called from installAllRuntimes(). All 15 full-path references to KB scripts across source files, agent specs, local-install copies, and commands point to ~/.gsd/bin/. Zero old-path references remain. Source scripts in .claude/agents/ are preserved unchanged.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add tests for KB script installation</name>
  <files>tests/integration/kb-infrastructure.test.js</files>
  <action>
Add a new `describe('installKBScripts')` block to `tests/integration/kb-infrastructure.test.js` with these tests:

1. **"creates ~/.gsd/bin/ directory"** -- Call `installKBScripts(tmpGsdHome)` and verify `fs.existsSync(path.join(tmpGsdHome, 'bin'))` is true.

2. **"copies kb-rebuild-index.sh to ~/.gsd/bin/"** -- Call `installKBScripts(tmpGsdHome)` and verify `fs.existsSync(path.join(tmpGsdHome, 'bin', 'kb-rebuild-index.sh'))` is true.

3. **"copies kb-create-dirs.sh to ~/.gsd/bin/"** -- Call `installKBScripts(tmpGsdHome)` and verify `fs.existsSync(path.join(tmpGsdHome, 'bin', 'kb-create-dirs.sh'))` is true.

4. **"sets executable permissions on copied scripts"** -- Call `installKBScripts(tmpGsdHome)`, then `fs.statSync(path.join(tmpGsdHome, 'bin', 'kb-rebuild-index.sh')).mode & 0o755` should equal `0o755` (or at minimum the user-execute bit `0o100` should be set).

5. **"is idempotent (safe to run twice)"** -- Call `installKBScripts(tmpGsdHome)` twice. No errors. Files still exist with correct permissions.

Follow the existing test patterns in the file -- use the `tmpdirTest` helper or `beforeEach`/`afterEach` with `fs.mkdtempSync` as done by existing tests. The `installKBScripts` function needs to be exported from `bin/install.js` for testing. Add it to the existing exports at the bottom of install.js (there should be a `module.exports` or the tests import using a pattern -- check the existing test file to see how it imports `migrateKB` and `countKBEntries` and follow the same pattern).

Also add one integration-style test:

6. **"installAllRuntimes calls installKBScripts"** -- This is harder to test directly. Instead, verify the code path exists by grepping for `installKBScripts(gsdHome)` in the installAllRuntimes function body (already covered by Task 1 verify, so this test is optional -- only add if straightforward).
  </action>
  <verify>
1. `npx vitest run tests/integration/kb-infrastructure.test.js` passes all tests including the new ones
2. `grep -c 'installKBScripts' tests/integration/kb-infrastructure.test.js` shows 5+ occurrences
  </verify>
  <done>
At least 5 new tests cover installKBScripts() functionality: directory creation, file copying for both scripts, executable permissions, and idempotency. All tests pass.
  </done>
</task>

</tasks>

<verification>
1. `grep -rn '~/.claude/agents/kb-' get-shit-done/ .claude/agents/gsd-*.md .claude/get-shit-done/ .claude/commands/` returns zero matches (no old-path references)
2. `grep -rn '~/.gsd/bin/kb-' get-shit-done/ .claude/agents/gsd-*.md .claude/get-shit-done/ .claude/commands/` returns 15 matches (all updated)
3. `grep -n 'function installKBScripts' bin/install.js` shows the function exists
4. `npx vitest run tests/integration/kb-infrastructure.test.js` all tests pass
5. Scripts remain at `.claude/agents/kb-rebuild-index.sh` and `.claude/agents/kb-create-dirs.sh` in source (not deleted)
</verification>

<success_criteria>
- installKBScripts() function in bin/install.js copies scripts to ~/.gsd/bin/ with executable permissions
- installAllRuntimes() calls installKBScripts() after migrateKB()
- All 15 path references across 14 files updated from old paths to ~/.gsd/bin/
- Zero old-path references remain in source, agent specs, local-install, and commands
- 5+ new tests pass for KB script installation
- Source scripts in .claude/agents/ remain unchanged (they are the source of truth)
</success_criteria>

<output>
After completion, create `.planning/phases/19-kb-infrastructure-data-safety/19-01-SUMMARY.md`
</output>
