---
phase: 32-multi-sensor-orchestrator
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - agents/gsd-git-sensor.md
autonomous: true

must_haves:
  truths:
    - "A git sensor agent can detect fix-fix-fix commit chains from git history"
    - "A git sensor agent can detect file churn hotspots excluding planning files"
    - "A git sensor agent can detect scope creep by comparing plan declarations to actual commits"
    - "The git sensor returns structured JSON signal candidates, not KB entries"
  artifacts:
    - path: "agents/gsd-git-sensor.md"
      provides: "Git pattern detection sensor agent spec"
      contains: "gsd-git-sensor"
      min_lines: 100
  key_links:
    - from: "agents/gsd-git-sensor.md"
      to: "git log"
      via: "bash commands for pattern detection"
      pattern: "git log"
    - from: "agents/gsd-git-sensor.md"
      to: "get-shit-done/references/signal-detection.md"
      via: "severity and tag classification"
      pattern: "signal-detection\\.md"
---

<objective>
Create the git sensor agent that analyzes commit history to detect fix-fix-fix chains, file churn hotspots, and scope creep patterns.

Purpose: Add a new signal source that detects structural development problems invisible to artifact-only analysis. Git patterns like repeated fix commits or unexpected file scope reveal plan quality issues that PLAN/SUMMARY comparison alone cannot surface.
Output: A git sensor agent spec file ready for the orchestrator to spawn.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary-standard.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/32-multi-sensor-orchestrator/32-RESEARCH.md
@get-shit-done/references/signal-detection.md
@agents/knowledge-store.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create git sensor agent spec with three detection patterns</name>
  <files>agents/gsd-git-sensor.md</files>
  <action>
Create `agents/gsd-git-sensor.md` as a new sensor agent.

**Frontmatter:**
```yaml
name: gsd-git-sensor
description: Analyzes git commit history to detect fix-fix-fix chains, file churn hotspots, and scope creep patterns, returning raw signal candidates as structured JSON
tools: Read, Bash, Glob, Grep
color: blue
```

**Role section:** "You are a git pattern sensor agent. You analyze a project's git commit history for a specified phase and detect structural development patterns. You return structured JSON signal candidates -- you do NOT write to the knowledge base."

**References section:** Reference signal-detection.md (for severity rules and tag taxonomy) and knowledge-store.md (for signal schema).

**Inputs section:** The sensor receives:
- Phase number (to scope analysis)
- Phase directory path (for scope creep comparison with PLAN.md files_modified)
- Project name (for signal context)

**Execution flow:**

**Step 1: Determine Phase Commit Range**

Use conventional commit format to find phase-scoped commits:
```bash
# Find commits matching phase number in conventional commit format
git log --oneline --format="%H %s" | grep -E "\(${PHASE}(-[0-9]+)?\)" | head -100
```

Also determine a broader window for cross-phase patterns:
```bash
# Last 100 commits for fix-chain detection (chains may cross phase boundaries)
git log --oneline --format="%H %s" -100
```

Store both scoped (phase-only) and broad (last 100) commit sets.

**Step 2: Detect Fix-Fix-Fix Chains (Pattern A)**

Analyze the broad commit window (last 100 commits) for consecutive fix commits:

```bash
git log --oneline --format="%s" -100
```

Parse output to find streaks of 3+ consecutive commits where the subject starts with `fix(` or `fix:`. A "streak" means consecutive commits in the log (no non-fix commits between them).

Detection rules:
- 3-4 consecutive fix commits: severity `notable`, signal_type `deviation`
- 5+ consecutive fix commits: severity `critical`, signal_type `deviation`
- Tags: `fix-chain`, `commit-patterns`, `plan-quality`
- Only count streaks that overlap with or are adjacent to the specified phase's commits
- Evidence: list the actual commit messages in the chain as `evidence.supporting`
- Counter-evidence: "Fix chains during gap closure or refactoring phases may be expected workflow behavior"

**Step 3: Detect File Churn (Pattern B)**

Analyze a broader window for file modification frequency:

```bash
# Files modified in 5+ of the last 50 commits, excluding planning files
git log --name-only --format="" -50 \
  | grep -v '^\\.planning/' \
  | grep -v '^$' \
  | sort | uniq -c | sort -rn \
  | awk '$1 >= 5 { print $1, $2 }'
```

Detection rules:
- Files modified in 5+ of last 50 commits (excluding .planning/ files): severity `notable`
- Tags: `file-churn`, `hotspot`, plus domain-relevant tags based on file path
- Exclude expected high-churn files: STATE.md, ROADMAP.md, config.json, package.json, lock files
- Evidence: the modification count and file path
- Counter-evidence: "High churn may indicate active development on a core component rather than instability"
- confidence: `medium` (churn is statistical, not causal)

**Step 4: Detect Scope Creep (Pattern C)**

For each PLAN.md in the phase directory, compare declared `files_modified` against actual files in commits:

```bash
# Extract files_modified from plan frontmatter
grep -A 50 'files_modified:' PLAN_FILE | grep '^\s*-' | sed 's/^\s*-\s*//' | head -20

# Extract actual files from commits matching that plan
git log --name-only --format="" --grep="(${PHASE}-${PLAN})" | sort -u
```

Detection rules:
- 1-2 extra files beyond plan declaration: severity `minor`
- 3+ extra files or unexpected directories: severity `notable`
- Tags: `scope-creep`, `plan-accuracy`
- ONLY count non-planning files (exclude .planning/ and SUMMARY.md additions)
- Evidence: list the unexpected files
- Counter-evidence: "Extra files may represent legitimate auto-fixes or necessary supporting changes"

**Step 5: Runtime/Model Detection**

Same pattern as artifact sensor (detect runtime from path prefix, model from self-knowledge). Include in each signal candidate.

**Step 6: Return Results**

Return structured JSON:
```json
{
  "sensor": "git",
  "phase": {N},
  "signals": [
    {
      "summary": "4 consecutive fix commits in phase 31 range",
      "signal_type": "deviation",
      "signal_category": "negative",
      "severity": "notable",
      "tags": ["fix-chain", "commit-patterns", "plan-quality"],
      "evidence": {
        "supporting": ["fix(31-03): ...", "fix(31-03): ...", "fix(31-04): ...", "fix(31-04): ..."],
        "counter": ["Fix chains during gap closure phases may be expected"]
      },
      "confidence": "medium",
      "confidence_basis": "Detected 4 consecutive fix-prefixed commits in git log",
      "context": {
        "phase": 31,
        "source": "git-history",
        "commit_range": "abc1234..def5678"
      }
    }
  ]
}
```

**Guidelines section:**
- Use ONLY `git log` commands with `--format` flags -- no external git tools or npm packages
- Scope primary analysis to phase commits; use broader window only for cross-phase patterns (churn, fix chains)
- Exclude .planning/ files from churn analysis (they are expected to change frequently)
- Use judgment for edge cases -- if a pattern seems like noise (e.g., churn on package-lock.json), skip it or lower confidence
- Never generate more than 5 signal candidates per detection pattern (cap at 15 total)
- All paths in agent spec use `~/` prefix (installer converts to `./` during install)
  </action>
  <verify>
```bash
# File exists with substantial content
test -f agents/gsd-git-sensor.md && wc -l agents/gsd-git-sensor.md
# Should be >100 lines

# Has all three detection patterns
grep -c "Fix-Fix-Fix\|fix.chain\|Pattern A" agents/gsd-git-sensor.md
grep -c "File Churn\|file.churn\|Pattern B" agents/gsd-git-sensor.md
grep -c "Scope Creep\|scope.creep\|Pattern C" agents/gsd-git-sensor.md
# Each should be >= 1

# Does NOT write to KB
grep -c "Write.*signal.*file\|kb-rebuild-index\|mkdir.*signals" agents/gsd-git-sensor.md
# Should be 0

# Returns JSON
grep -c '"sensor".*"git"\|Return.*JSON\|Return Results' agents/gsd-git-sensor.md
# Should be >= 1

# Has correct frontmatter
head -6 agents/gsd-git-sensor.md
```
  </verify>
  <done>
Git sensor agent spec exists with three detection patterns (fix-fix-fix chains, file churn, scope creep), returns structured JSON, and uses only git log commands for analysis.
  </done>
</task>

<task type="auto">
  <name>Task 2: Validate git sensor patterns against actual repo history</name>
  <files>agents/gsd-git-sensor.md</files>
  <action>
Run the git sensor's detection commands against this repo's actual git history to verify the patterns produce real results. The repo has 1302+ commits with verified instances of all three patterns.

**Validate fix-fix-fix detection:**
```bash
git log --oneline --format="%s" -100
```
Look for streaks of 3+ consecutive `fix(` commits. The research confirms 4 consecutive fix commits exist in recent history. If the pattern does NOT find any chains in 100 commits, expand to 200. Document what was found.

**Validate file churn detection:**
```bash
git log --name-only --format="" -50 | grep -v '^\\.planning/' | grep -v '^$' | sort | uniq -c | sort -rn | head -10
```
Research confirms `agents/knowledge-store.md` and `get-shit-done/bin/gsd-tools.js` show high churn in Phase 31. Verify the command output matches expectations. If the exclusion pattern for .planning/ isn't working correctly, fix it in the agent spec.

**Validate scope creep detection:**
```bash
# Pick a completed plan (e.g., 31-03-PLAN.md) and compare
grep -A 50 'files_modified:' .planning/phases/31-signal-schema-foundation/31-03-PLAN.md | grep '^\s*-' | sed 's/^\s*-\s*//' | head -20
git log --name-only --format="" --grep="(31-03)" | grep -v '^\\.planning/' | grep -v '^$' | sort -u
```
Compare the two lists. Any files in git log output that are NOT in files_modified represent scope creep candidates.

**If any pattern fails to produce expected results:**
Update the detection commands in `agents/gsd-git-sensor.md` to fix the issue. Common fixes:
- Adjust grep patterns for conventional commit format
- Fix path exclusions
- Adjust thresholds (e.g., churn threshold from 5 to 4)

Document what was validated and any adjustments made in a brief note at the bottom of the agent spec's guidelines section: "Validated against get-shit-done-reflect repo (1300+ commits, 2026-02-28)."
  </action>
  <verify>
```bash
# Run the actual detection commands and verify non-empty output
echo "=== Fix chains ==="
git log --oneline --format="%s" -100 | head -20

echo "=== File churn ==="
git log --name-only --format="" -50 | grep -v '^\\.planning/' | grep -v '^$' | sort | uniq -c | sort -rn | awk '$1 >= 5' | head -5

echo "=== Scope creep check ==="
git log --name-only --format="" --grep="(31-03)" | grep -v '^\\.planning/' | grep -v '^$' | sort -u | head -10
```
At least one pattern should produce non-empty results. The git sensor spec should reflect any command adjustments.
  </verify>
  <done>
All three git sensor detection patterns validated against real repo history. Detection commands in the agent spec produce actual results and have been adjusted if needed. The git sensor is ready for orchestrator integration.
  </done>
</task>

</tasks>

<verification>
1. `agents/gsd-git-sensor.md` exists with 100+ lines
2. Three detection patterns documented: fix-fix-fix chains, file churn, scope creep
3. All detection uses `git log` only (no external tools)
4. Returns structured JSON, does not write to KB
5. Detection patterns validated against actual repo history with non-empty results
</verification>

<success_criteria>
The git sensor agent spec is complete with three validated detection patterns that produce real signals from this repo's git history. The sensor returns structured JSON for the synthesizer to process and does not write directly to the KB.
</success_criteria>

<output>
After completion, create `.planning/phases/32-multi-sensor-orchestrator/32-02-SUMMARY.md`
</output>
