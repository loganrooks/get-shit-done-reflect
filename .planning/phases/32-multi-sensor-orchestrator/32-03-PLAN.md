---
phase: 32-multi-sensor-orchestrator
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - agents/gsd-signal-synthesizer.md
autonomous: true

must_haves:
  truths:
    - "A synthesizer agent exists that is the sole KB writer -- sensors never write to KB"
    - "The synthesizer deduplicates signals across sensors before writing"
    - "The synthesizer enforces epistemic rigor (critical requires counter-evidence) before writing"
    - "The synthesizer filters trace-severity signals and does NOT persist them to KB"
    - "The synthesizer enforces per-phase signal caps before writing"
  artifacts:
    - path: "agents/gsd-signal-synthesizer.md"
      provides: "Signal synthesizer agent spec with dedup, rigor, trace filter, and cap enforcement"
      contains: "gsd-signal-synthesizer"
      min_lines: 120
  key_links:
    - from: "agents/gsd-signal-synthesizer.md"
      to: "get-shit-done/references/signal-detection.md"
      via: "dedup rules (Section 9) and cap rules (Section 10)"
      pattern: "signal-detection\\.md"
    - from: "agents/gsd-signal-synthesizer.md"
      to: "agents/knowledge-store.md"
      via: "signal schema and lifecycle rules"
      pattern: "knowledge-store\\.md"
    - from: "agents/gsd-signal-synthesizer.md"
      to: "agents/kb-templates/signal.md"
      via: "signal file creation template"
      pattern: "kb-templates/signal\\.md"
    - from: "agents/gsd-signal-synthesizer.md"
      to: "gsd-tools.js frontmatter validate"
      via: "schema validation before write"
      pattern: "frontmatter validate.*--schema signal"
---

<objective>
Create the signal synthesizer agent -- the single KB writer that receives raw signal candidates from all sensors and applies cross-sensor deduplication, epistemic rigor enforcement, trace filtering, and per-phase cap management before writing qualifying signals to the knowledge base.

Purpose: The synthesizer is the enforcement boundary for signal quality. By centralizing all KB writes in one agent, the system guarantees that every persisted signal meets schema requirements, has no near-duplicates from other sensors, respects severity-tier rigor rules, and stays within per-phase caps. This closes the trace non-persistence gap documented in Phase 31 (signal-detection.md Section 6 note).
Output: A signal synthesizer agent spec file.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary-standard.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/32-multi-sensor-orchestrator/32-RESEARCH.md
@get-shit-done/references/signal-detection.md
@agents/knowledge-store.md
@agents/kb-templates/signal.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create signal synthesizer agent spec</name>
  <files>agents/gsd-signal-synthesizer.md</files>
  <action>
Create `agents/gsd-signal-synthesizer.md` as the single KB writer agent.

**Frontmatter:**
```yaml
name: gsd-signal-synthesizer
description: Single KB writer that receives raw signal candidates from all sensors, deduplicates across sources, enforces epistemic rigor and trace filtering, applies per-phase caps, and writes qualifying signals to the knowledge base
tools: Read, Write, Bash, Glob, Grep
color: green
```

**Role section:** "You are the signal synthesizer agent. You are the ONLY agent that writes signal files to the knowledge base. You receive raw signal candidates (as JSON) from multiple sensors, apply quality gates, and persist qualifying signals. Sensors detect -- you decide what gets written."

**References section:**
- signal-detection.md (dedup rules Section 9, cap rules Section 10, severity classification Section 6)
- knowledge-store.md (signal schema, lifecycle rules, mutability boundary)
- kb-templates/signal.md (signal file template for creation)

**Inputs section:** The synthesizer receives from the orchestrator:
- Merged raw signal candidates from ALL sensors (JSON arrays, one per sensor)
- Phase number
- Project name
- Existing KB index content (or path to read it)

**Execution flow:**

**Step 1: Parse Sensor Outputs**

Parse the merged JSON signal candidates from all sensors. Each sensor output has the format:
```json
{ "sensor": "artifact|git|log", "phase": N, "signals": [...] }
```
Flatten all signals into a single candidate list. Tag each signal with its source sensor for dedup tracking.

**Step 2: Filter Trace Signals**

Remove ALL signals with `severity: trace` from the candidate list. This is the enforcement point documented in signal-detection.md Section 6: "The signal synthesizer (Phase 32) is the enforcement point for trace non-persistence."

Log filtered traces: "Trace filtered: {summary} (from {sensor})" -- these appear in the final report but are NOT written to KB.

**Step 3: Cross-Sensor Deduplication**

Apply deduplication across sensors following signal-detection.md Section 9 rules, extended for cross-sensor context:

For each pair of signals from DIFFERENT sensors:
1. Check: same `signal_type` AND 2+ overlapping tags
2. Check: same phase + plan context (both about the same plan from different sensors)
3. If match found:
   - Keep the signal with higher confidence (if tied, keep the one with more evidence entries)
   - Merge `evidence.supporting` arrays from both signals (deduplicate identical strings)
   - Merge `evidence.counter` arrays from both signals
   - Use the higher severity
   - Add a `merged_from` note in context: "Merged with {sensor} signal: {summary}"
   - Remove the duplicate from the candidate list

Also check for intra-sensor duplicates (shouldn't happen but defensive).

**Step 4: Check Against Existing KB (Within-KB Dedup)**

Read the existing KB index:
```bash
cat ~/.gsd/knowledge/index.md
```

For each remaining candidate signal, check against existing active signals for the same project:
1. Same `signal_type` + 2+ overlapping tags = related signal
2. If related signals found:
   - Collect their IDs into the candidate's `related_signals` array
   - Set `occurrence_count` to highest existing occurrence_count + 1
3. Do NOT update existing signals (immutability constraint)

**Step 5: Enforce Epistemic Rigor**

For each remaining candidate, enforce Phase 31 tiered rigor (knowledge-store.md Section 4.3):

- **critical:** MUST have `evidence.counter` (non-empty array). If missing, REJECT the signal and log: "Rigor rejection: {summary} -- critical signals require counter-evidence"
- **notable:** SHOULD have `evidence` (supporting and/or counter). If missing, add a warning but PERSIST. Log: "Rigor warning: {summary} -- notable signals should include evidence"
- **minor:** No evidence requirement. Persist as-is.

Also validate each signal against the schema:
```bash
# Write temp file, validate, then decide
node ~/.claude/get-shit-done/bin/gsd-tools.js frontmatter validate /tmp/signal-candidate.md --schema signal
```
If validation fails, reject the signal and log: "Schema rejection: {summary} -- {validation error}"

**Step 6: Per-Phase Cap Enforcement**

Apply signal-detection.md Section 10 rules:

1. Count existing active signals for this phase and project in the KB index
2. Count new signals about to be written
3. If existing + new > 10 (per-phase cap):
   - Sort ALL signals (existing + new) by severity (critical > notable > minor)
   - Within same severity, prefer higher occurrence_count
   - Keep the top 10, archive the rest
   - For existing signals that need archiving: update their `status: archived` in frontmatter (this is the one permitted exception to immutability)
   - For new signals that don't fit: skip writing and log: "Capped: {summary} -- per-phase cap exceeded"

**Step 7: Write Qualifying Signals**

For each signal that passed all gates (trace filter, dedup, rigor, cap):

1. Generate signal ID: `sig-{YYYY-MM-DD}-{slug}` (derive slug from summary, kebab-case, max 50 chars)
2. Generate filename: `{YYYY-MM-DD}-{slug}.md`
3. Read `~/.claude/agents/kb-templates/signal.md` as the template
4. **YAML sanitization:** Before writing frontmatter, sanitize all string values from sensor JSON. Evidence strings may contain special YAML characters that break `extractFrontmatter()` parsing:
   - Strings containing `:` must be quoted (wrap in double quotes)
   - Strings containing `#` must be quoted (YAML comment character)
   - Strings starting with `- ` must be quoted (YAML array item prefix)
   - Strings containing `"` need escaping or use single-quote wrapping
   - Multi-line strings should use YAML `|` block scalar syntax
   This is critical because sensor-generated evidence text often contains code snippets, file paths with colons, and commit messages with special characters.
5. Fill ALL fields from the candidate data:
   - Base schema: id, type (signal), project, tags, created, updated, durability, status
   - Signal extension: severity, signal_type, phase, plan (from context)
   - Phase 2 extension: polarity (derive from signal_category), source (auto), occurrence_count, related_signals
   - Lifecycle fields: lifecycle_state (detected), evidence, confidence, confidence_basis, signal_category
   - Provenance: runtime, model (from sensor output if available), gsd_version (read from `~/.claude/get-shit-done/VERSION` or `.planning/config.json` `gsd_reflect_version` field, fallback "unknown")
6. Set `lifecycle_state: detected` (all new signals start as detected)
7. Write body sections: What Happened (from summary + evidence.supporting), Context (from context object), Potential Cause (synthesizer's assessment)
8. Ensure directory exists: `mkdir -p ~/.gsd/knowledge/signals/{project}/`
9. Write the file
10. Validate the written file: `node ~/.claude/get-shit-done/bin/gsd-tools.js frontmatter validate {written_file} --schema signal` — if validation fails on the written file, the YAML was malformed. Log error and delete the malformed file.

**Step 8: Rebuild Index**

After all signals are written:
```bash
bash ~/.gsd/bin/kb-rebuild-index.sh
```

**Step 9: Generate Report**

Return a structured report to the orchestrator:
```
## Synthesizer Report

**Phase:** {N}
**Project:** {project}
**Sensor inputs:** {N} candidates from {M} sensors
**Trace filtered:** {N}
**Duplicates merged:** {N}
**Rigor rejected:** {N}
**Cap limited:** {N}
**Signals written:** {N}

### Signals Persisted
| # | Source Sensor | Type | Severity | Category | Description | File |
|---|---------------|------|----------|----------|-------------|------|

### Trace Signals (not persisted)
| # | Source Sensor | Severity | Description | Reason |
|---|---------------|----------|-------------|--------|

### Rejected Signals
| # | Source Sensor | Description | Reason |
|---|---------------|-------------|--------|
```

**Guidelines section:**
- You are the ONLY writer to `~/.gsd/knowledge/signals/`. No other agent should write signal files.
- Trust sensor classifications (severity, signal_type, tags) -- your job is quality gating, not re-analyzing artifacts
- Validate with `gsd-tools.js frontmatter validate --schema signal` before writing (Phase 31 built this infrastructure -- use it, don't rebuild it)
- Use `kb-rebuild-index.sh` for index management -- don't hand-construct the index
- Detection payload fields are FROZEN after creation. Lifecycle fields are mutable. See knowledge-store.md Section 10.
- All paths use `~/` prefix in npm source (installer converts to `./`)
- The synthesizer is authorized to modify existing signal files ONLY for archival during cap enforcement (setting `status: archived`)
- **YAML sanitization is mandatory:** Evidence strings from sensors may contain colons, hashes, quotes, or leading dashes. Always quote string values in YAML frontmatter that contain special characters. Validate written files with `frontmatter validate` after writing.
- **Per-project cap awareness:** The per-phase cap is 10 (signal-detection.md Section 10). There is no per-project cap enforced by the synthesizer. If a project accumulates excessive signals across many phases, this should be flagged as a gap for future work. The previous signal-collector used a per-project cap of 100 which is not carried forward here — the per-phase cap of 10 is the primary constraint.
  </action>
  <verify>
```bash
# File exists with substantial content
test -f agents/gsd-signal-synthesizer.md && wc -l agents/gsd-signal-synthesizer.md
# Should be >120 lines

# Has all five enforcement gates
grep -c "Trace\|trace.*filter" agents/gsd-signal-synthesizer.md     # trace filtering
grep -c "Dedup\|dedup\|duplicate" agents/gsd-signal-synthesizer.md   # deduplication
grep -c "Rigor\|rigor\|epistemic" agents/gsd-signal-synthesizer.md   # rigor enforcement
grep -c "Cap\|cap\|per.phase" agents/gsd-signal-synthesizer.md       # cap enforcement
grep -c "frontmatter validate" agents/gsd-signal-synthesizer.md      # schema validation
# Each should be >= 1

# Has YAML sanitization guidance
grep -c "sanitiz\|YAML.*special\|quote.*string\|colon\|escape" agents/gsd-signal-synthesizer.md
# Should be >= 1

# Has post-write validation
grep -c "validate.*written\|validate.*after\|written.*file" agents/gsd-signal-synthesizer.md
# Should be >= 1

# Has gsd_version provenance
grep -c "gsd_version\|VERSION" agents/gsd-signal-synthesizer.md
# Should be >= 1

# References correct tools
grep -c "kb-rebuild-index" agents/gsd-signal-synthesizer.md
grep -c "kb-templates/signal" agents/gsd-signal-synthesizer.md
# Each >= 1

# Has Write tool (is the KB writer)
grep "tools:.*Write" agents/gsd-signal-synthesizer.md

# Has correct frontmatter
head -6 agents/gsd-signal-synthesizer.md
```
  </verify>
  <done>
Signal synthesizer agent spec exists with all five enforcement gates: trace filtering (closing Phase 31 enforcement gap), cross-sensor deduplication, within-KB deduplication, epistemic rigor enforcement (critical requires counter-evidence), and per-phase cap management. Uses Phase 31 validation infrastructure (frontmatter validate --schema signal) rather than hand-rolling.
  </done>
</task>

</tasks>

<verification>
1. `agents/gsd-signal-synthesizer.md` exists with 120+ lines
2. Trace filtering step removes trace-severity signals before KB write
3. Cross-sensor deduplication merges near-duplicate signals from different sensors
4. Epistemic rigor enforcement rejects critical signals without counter-evidence
5. Per-phase cap limits total signals to 10 per phase per project
6. Uses `gsd-tools.js frontmatter validate --schema signal` for schema validation
7. Uses `kb-rebuild-index.sh` for index rebuild
8. Returns structured report to orchestrator
9. YAML sanitization guidance included for special characters in evidence strings
10. Post-write validation step catches malformed YAML before index rebuild
11. gsd_version provenance field populated from VERSION file
12. Per-project cap gap documented (per-phase cap of 10 is primary constraint)
</verification>

<success_criteria>
The signal synthesizer agent spec is complete as the single KB writer with all five quality gates. It closes the trace non-persistence enforcement gap from Phase 31 and leverages the Phase 31 validation infrastructure instead of rebuilding it.
</success_criteria>

<output>
After completion, create `.planning/phases/32-multi-sensor-orchestrator/32-03-SUMMARY.md`
</output>
