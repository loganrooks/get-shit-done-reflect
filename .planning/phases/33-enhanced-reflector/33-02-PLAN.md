---
phase: 33-enhanced-reflector
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - agents/kb-templates/lesson.md
  - get-shit-done/workflows/reflect.md
autonomous: true

must_haves:
  truths:
    - "Lesson template includes evidence_snapshots field for self-contained evidence preservation"
    - "Reflect workflow outputs a lifecycle dashboard showing signal counts by state (detected/triaged/remediated/verified/invalidated)"
    - "Reflect workflow includes triage proposal presentation and approval UX for interactive and YOLO modes"
    - "Reflect workflow includes remediation suggestion output section for triaged signals"
  artifacts:
    - path: "agents/kb-templates/lesson.md"
      provides: "Lesson template with evidence_snapshots field"
      contains: "evidence_snapshots"
    - path: "get-shit-done/workflows/reflect.md"
      provides: "Lifecycle dashboard, triage proposal UX, remediation output"
      contains: "Lifecycle Dashboard"
  key_links:
    - from: "get-shit-done/workflows/reflect.md"
      to: "agents/gsd-reflector.md"
      via: "Workflow spawns reflector and presents its output"
      pattern: "gsd-reflector"
    - from: "agents/kb-templates/lesson.md"
      to: "agents/gsd-reflector.md"
      via: "Reflector uses lesson template when distilling lessons"
      pattern: "evidence_snapshots"
---

<objective>
Update the lesson template with evidence_snapshots field and enhance the reflect workflow with lifecycle dashboard, triage proposal UX, and remediation suggestion output.

Purpose: The lesson template needs an evidence_snapshots field so lessons are self-contained even if source signals are later archived (REFLECT-04). The reflect workflow needs lifecycle dashboard output (REFLECT-07), triage proposal interaction flow (REFLECT-05 UX), and remediation suggestion formatting (REFLECT-06 output). These are the output formatting and UX components that the reflector agent (Plan 03) will produce data for.

Output: Updated lesson.md template and reflect.md workflow with lifecycle-aware output sections.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary-standard.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/33-enhanced-reflector/33-RESEARCH.md
@agents/kb-templates/lesson.md
@get-shit-done/workflows/reflect.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add evidence_snapshots field to lesson template</name>
  <files>agents/kb-templates/lesson.md</files>
  <action>
Add the `evidence_snapshots` optional field to the lesson template frontmatter and body.

1. **In frontmatter**, add after the `evidence` field:
```yaml
evidence_snapshots:
  - id: {entry-id-1}
    snapshot: "{one-sentence observation from this signal}"
  - id: {entry-id-2}
    snapshot: "{one-sentence observation from this signal}"
```

Add a YAML comment above it: `# Optional: preserves key observations from evidence signals for self-contained lessons`

2. **Add a `confidence` field** after evidence_snapshots if not already present (it is NOT currently in the template but IS used by the reflector and shown in the research code example):
```yaml
confidence: {high|medium|low}
```

3. **In the Evidence section** of the body, add a note:
```markdown
## Evidence

{List of signals/spikes that led to this lesson, with brief descriptions}

<!-- If evidence_snapshots are provided in frontmatter, the key observation from each signal
     is preserved above, making this lesson self-contained even if evidence signals are archived -->
```

Keep the template concise. The evidence_snapshots field is optional -- lessons without it are still valid.
  </action>
  <verify>
Grep for "evidence_snapshots" in agents/kb-templates/lesson.md to confirm the field exists.
Grep for "confidence" in agents/kb-templates/lesson.md to confirm confidence field is present.
Verify the template is still valid YAML frontmatter (no syntax errors).
  </verify>
  <done>
Lesson template includes evidence_snapshots (optional) and confidence fields. Template remains backward-compatible -- existing lessons without these fields are still valid.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add lifecycle dashboard, triage proposal UX, and remediation output to reflect workflow</name>
  <files>get-shit-done/workflows/reflect.md</files>
  <action>
Enhance reflect.md with three new workflow components. These modify the existing workflow structure, not replace it.

**1. Lifecycle Dashboard (REFLECT-07)**

Add a new step `<step name="show_lifecycle_dashboard">` AFTER `verify_kb_exists` and BEFORE `prepare_context`. This step:

a. Reads the KB index and counts signals by lifecycle_state:
   - `detected` (or missing lifecycle_state for legacy signals) -> "Untriaged"
   - `triaged` -> "Triaged"
   - `remediated` -> "Remediated"
   - `verified` -> "Verified"
   - `invalidated` -> "Invalidated"

b. Also counts:
   - Legacy signals (SIG-format, identified by ID starting with `SIG-`)
   - Signals with evidence (has non-empty evidence field)
   - High-confidence signals (confidence: high)

c. Outputs the dashboard at the START of the reflection report:
```markdown
## Lifecycle Dashboard

| State | Count | Percentage |
|-------|-------|-----------|
| Untriaged (detected) | N | XX% |
| Triaged | N | XX% |
| Remediated | N | XX% |
| Verified | N | XX% |
| Invalidated | N | XX% |
| **Total** | **N** | **100%** |

Legacy signals (SIG-format): N (treated as detected)
Signals with evidence: N/N (XX%)
High-confidence signals: N (XX%)
```

The dashboard is informational -- it runs before analysis and gives the user immediate context about the KB state.

**2. Triage Proposal UX (REFLECT-05)**

Add a new step `<step name="handle_triage_proposals">` AFTER `receive_report` and BEFORE `present_results`. This step handles triage proposals from the reflector agent:

a. **Interactive mode:**
   - Present each triage proposal with cluster name, signal list, recommended decision, rationale, priority
   - User options: "approve" (apply triage to all signals in cluster), "reject" (skip), "modify" (change decision/priority)
   - Format:
```markdown
### Triage Proposal: {cluster-name}

**Signals:** {N} signals
**Recommended decision:** {address|dismiss|defer|investigate}
**Rationale:** {why}
**Priority:** {critical|high|medium|low}

Approve this triage? (approve / reject / modify)
```

b. **YOLO mode:**
   - Auto-approve `address` and `dismiss` decisions
   - Present `defer` decisions briefly (auto-approve with note)
   - Present `investigate` decisions for user confirmation (spike candidates need human judgment)
   - Report all auto-approved decisions in summary

c. **When triage is approved:** The workflow instructs the reflector agent to write triage fields to each signal in the cluster. The workflow itself does NOT write files -- the reflector does.

d. **Phase 33 triage constraint reminder:** Include a note that when triaging critical signals without lifecycle_state, evidence.supporting MUST be added first. Reference knowledge-store.md Section 4.2.

**3. Remediation Suggestions Output (REFLECT-06)**

Add a new section to the `present_results` step. After patterns and triage proposals, show remediation suggestions:

```markdown
### Remediation Suggestions

{For each triaged cluster with decision: address}

#### {cluster-name}

**Signals:** {signal IDs}
**Suggested approach:** {what to do}
**Suggested plan scope:** {which phase/plan could address this}
**Priority:** {from triage.priority}
```

Remediation suggestions are advisory -- they do NOT write to signal files. Phase 34 (Signal-Plan Linkage) handles `resolves_signals` mechanics.

**4. Update report_completion step** to include lifecycle dashboard summary, triage count, and remediation suggestion count in the final summary.

**5. Update the spawn_reflector step** to pass lifecycle-specific instructions to the reflector agent:
- Include lifecycle_state filtering instructions
- Include triage proposal generation request
- Include remediation suggestion request
- Include spike candidate identification request

Keep existing workflow structure intact. These are ADDITIONS to existing steps, not replacements.
  </action>
  <verify>
Grep for "Lifecycle Dashboard" in get-shit-done/workflows/reflect.md.
Grep for "handle_triage_proposals" in get-shit-done/workflows/reflect.md.
Grep for "Remediation Suggestions" in get-shit-done/workflows/reflect.md.
Grep for "triage constraint" to confirm the Phase 33 safety note is present.
Verify the step ordering makes sense: parse_arguments -> load_configuration -> verify_kb_exists -> show_lifecycle_dashboard -> prepare_context -> spawn_reflector -> receive_report -> handle_triage_proposals -> present_results -> handle_lesson_creation -> rebuild_index -> report_completion -> commit_lessons.
  </verify>
  <done>
reflect.md workflow includes lifecycle dashboard step (REFLECT-07), triage proposal UX for interactive and YOLO modes (REFLECT-05), remediation suggestion output (REFLECT-06), and updated spawner instructions. Step ordering is correct and existing workflow structure preserved.
  </done>
</task>

</tasks>

<verification>
1. `grep "evidence_snapshots" agents/kb-templates/lesson.md` returns match
2. `grep "Lifecycle Dashboard" get-shit-done/workflows/reflect.md` returns match
3. `grep "handle_triage_proposals" get-shit-done/workflows/reflect.md` returns match
4. `grep "Remediation Suggestion" get-shit-done/workflows/reflect.md` returns match
5. `grep "triage constraint" get-shit-done/workflows/reflect.md` returns match (safety note)
</verification>

<success_criteria>
Lesson template has evidence_snapshots field (REFLECT-04 template). Reflect workflow outputs lifecycle dashboard (REFLECT-07), presents triage proposals with interactive/YOLO handling (REFLECT-05 UX), and shows remediation suggestions (REFLECT-06 output). These provide the output infrastructure that the reflector agent (Plan 03) will produce data for.
</success_criteria>

<output>
After completion, create `.planning/phases/33-enhanced-reflector/33-02-SUMMARY.md`
</output>
