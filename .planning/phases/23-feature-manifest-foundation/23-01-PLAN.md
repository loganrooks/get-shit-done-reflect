---
phase: 23-feature-manifest-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - get-shit-done/feature-manifest.json
  - get-shit-done/bin/gsd-tools.js
autonomous: true

must_haves:
  truths:
    - "feature-manifest.json exists with typed schemas for health_check, devops, and release features"
    - "Running gsd-tools manifest diff-config produces a structured JSON diff between manifest and config"
    - "Running gsd-tools manifest validate returns valid:true for a config with unknown fields"
    - "Running gsd-tools manifest get-prompts <feature> returns init prompts and schema for that feature"
    - "Manifest defaults exactly match the existing loadConfig() defaults for health_check and devops"
  artifacts:
    - path: "get-shit-done/feature-manifest.json"
      provides: "Declarative feature config schema for 3 features"
      contains: "manifest_version"
    - path: "get-shit-done/bin/gsd-tools.js"
      provides: "manifest subcommand group with diff-config, validate, get-prompts"
      exports: ["loadManifest", "cmdManifestDiffConfig", "cmdManifestValidate", "cmdManifestGetPrompts"]
  key_links:
    - from: "get-shit-done/bin/gsd-tools.js"
      to: "manifest switch case"
      via: "case 'manifest' in main switch statement"
      pattern: "case 'manifest'"
    - from: "loadManifest()"
      to: "feature-manifest.json"
      via: "local-first then global path resolution"
      pattern: "feature-manifest\\.json"
---

<objective>
Create the feature-manifest.json data file declaring config schemas for all existing features (health_check, devops, release), and add the manifest subcommand group to gsd-tools.js with diff-config, validate, and get-prompts subcommands.

Purpose: Establish the foundation for data-driven config initialization and upgrade, replacing hardcoded migration logic in future phases.
Output: feature-manifest.json with 3 feature schemas; gsd-tools.js with 3 working manifest subcommands.
</objective>

<execution_context>
@/Users/rookslog/.claude/get-shit-done/workflows/execute-plan.md
@/Users/rookslog/.claude/get-shit-done/templates/summary-standard.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/23-feature-manifest-foundation/23-RESEARCH.md
@get-shit-done/bin/gsd-tools.js
@.planning/config.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create feature-manifest.json with health_check, devops, and release schemas</name>
  <files>get-shit-done/feature-manifest.json</files>
  <action>
Create `get-shit-done/feature-manifest.json` with the following structure. Use the complete schema from the research document (23-RESEARCH.md, "Manifest File" code example) as the authoritative source.

The file must contain:
- `manifest_version: 1` (integer, not string)
- `features` object with exactly 3 entries: `health_check`, `devops`, `release`

For each feature:
- `scope`: "project" (all 3 are project-scoped)
- `introduced`: version string ("1.12.0" for health_check and devops, "1.15.0" for release)
- `config_key`: the top-level key in config.json (matches the feature name)
- `schema`: object with field definitions, each having `type`, `default`, `description`, and optionally `enum`
- `init_prompts`: array of prompt objects for interactive initialization

**CRITICAL: Default alignment check.** After creating the file, verify these defaults match the project's config.json and the loadConfig() function in gsd-tools.js:
- `health_check.frequency` default: `"milestone-only"` (matches config.json line 13)
- `health_check.stale_threshold_days` default: `7` (matches config.json line 14)
- `health_check.blocking_checks` default: `false` (matches config.json line 15)
- `devops.ci_provider` default: `"none"` (note: this project's config has "github-actions" but the MANIFEST default for new projects is "none")
- `devops.deploy_target` default: `"none"`
- `devops.commit_convention` default: `"freeform"`
- `devops.environments` default: `[]`
- `release.version_file` default: `"none"`
- `release.changelog` default: `"CHANGELOG.md"`
- `release.changelog_format` default: `"keepachangelog"`
- `release.ci_trigger` default: `"none"`
- `release.registry` default: `"none"`
- `release.branch` default: `"main"`

The `release` feature also includes an `auto_detect` section for version_file (checks file_exists for package.json, Cargo.toml, pyproject.toml).

Use the name `feature-manifest.json` (NOT `manifest.json` or `gsd-manifest.json`) to avoid collision with the existing `gsd-file-manifest.json` which is a SHA-256 file integrity manifest.
  </action>
  <verify>
Run `node -e "const m = JSON.parse(require('fs').readFileSync('get-shit-done/feature-manifest.json','utf-8')); console.log('version:', m.manifest_version); console.log('features:', Object.keys(m.features).join(', ')); console.log('health_check fields:', Object.keys(m.features.health_check.schema).join(', ')); console.log('devops fields:', Object.keys(m.features.devops.schema).join(', ')); console.log('release fields:', Object.keys(m.features.release.schema).join(', '));"` succeeds and shows all 3 features with expected fields.
  </verify>
  <done>feature-manifest.json exists with manifest_version 1, contains health_check (3 fields), devops (4 fields), release (6 fields) schemas with typed defaults, enums, and init_prompts.</done>
</task>

<task type="auto">
  <name>Task 2: Add manifest subcommand group with diff-config, validate, and get-prompts to gsd-tools.js</name>
  <files>get-shit-done/bin/gsd-tools.js</files>
  <action>
Add manifest helpers and subcommands to gsd-tools.js following the existing subcommand group pattern (like `state`, `verify`, `phase`). Use the research document code examples as the implementation guide.

**Helper functions (add near other helpers, before the Commands section):**

1. `loadManifest(cwd)` - Resolve manifest path (local `.claude/get-shit-done/feature-manifest.json` first, then global `~/.claude/get-shit-done/feature-manifest.json`). Returns parsed JSON or null. Use `require('os').homedir()` for home directory.

2. `loadProjectConfig(cwd)` - Load `.planning/config.json` from cwd. Returns parsed JSON or null.

3. `validateFieldType(value, schema)` - Check value matches schema.type. Supports string, number, boolean, array, object. Returns true for undefined/null (missing is not a type error).

4. `validateFieldEnum(value, schema)` - Check value is in schema.enum if enum exists. Returns true if no enum or value is undefined.

**Command functions:**

5. `cmdManifestDiffConfig(cwd, raw)` - Compare manifest features against config.json. Produce structured result with:
   - `missing_features`: features declared in manifest but absent from config
   - `missing_fields`: fields declared in feature schema but absent from config section
   - `type_mismatches`: fields present but wrong type
   - `enum_mismatches`: fields present but value not in enum
   - `unknown_fields`: top-level config keys not in manifest and not in `knownTopLevel` set (informational warnings, NEVER errors)
   - `manifest_version`: from manifest
   - `config_manifest_version`: from config (or null)

   The `knownTopLevel` set must include: mode, depth, model_profile, commit_docs, search_gitignored, branching_strategy, phase_branch_template, milestone_branch_template, workflow, planning, parallelization, gates, safety, gsd_reflect_version, manifest_version, brave_search.

6. `cmdManifestValidate(cwd, raw)` - Validate config against manifest. Returns `{ valid, warnings, errors, features_checked, features_present, features_missing }`. Missing features are WARNINGS. Unknown fields are WARNINGS. Only type/enum mismatches are ERRORS. A config with unknown fields MUST return `valid: true`.

7. `cmdManifestGetPrompts(cwd, feature, raw)` - Return init prompts and schema for a named feature. Error if feature not found.

**Switch case (add before the `default:` case in the main switch statement):**

```javascript
case 'manifest': {
  const subcommand = args[1];
  if (subcommand === 'diff-config') {
    cmdManifestDiffConfig(cwd, raw);
  } else if (subcommand === 'validate') {
    cmdManifestValidate(cwd, raw);
  } else if (subcommand === 'get-prompts') {
    const feature = args[2];
    cmdManifestGetPrompts(cwd, feature, raw);
  } else {
    error('Unknown manifest subcommand. Available: diff-config, validate, get-prompts');
  }
  break;
}
```

Also update the usage string in the `if (!command)` error message near line 4224 to include `manifest` in the commands list.

**Implementation notes:**
- Only check features where `scope === 'project'` and `config_key` exists (skip any future user-scoped features)
- Use the existing `output()` and `error()` helpers for consistent output
- Do NOT modify loadConfig() -- that is Phase 24 territory
  </action>
  <verify>
Run all three commands against the project's own config:
1. `node get-shit-done/bin/gsd-tools.js manifest diff-config --raw` -- should return JSON with missing_features (release section), and known fields for health_check/devops
2. `node get-shit-done/bin/gsd-tools.js manifest validate --raw` -- should return JSON with `valid: true` or valid errors
3. `node get-shit-done/bin/gsd-tools.js manifest get-prompts health_check --raw` -- should return JSON with prompts array and schema
4. `node get-shit-done/bin/gsd-tools.js manifest get-prompts nonexistent --raw` -- should exit with error
  </verify>
  <done>Three manifest subcommands (diff-config, validate, get-prompts) are reachable via `gsd-tools manifest <sub>`, produce correct JSON output, and the additive-only principle holds (unknown fields never produce errors).</done>
</task>

</tasks>

<verification>
1. `node -e "JSON.parse(require('fs').readFileSync('get-shit-done/feature-manifest.json','utf-8'))"` exits 0 (valid JSON)
2. `node get-shit-done/bin/gsd-tools.js manifest diff-config --raw | node -e "const d=JSON.parse(require('fs').readFileSync('/dev/stdin','utf-8')); process.exit(d.manifest_version === 1 ? 0 : 1)"` exits 0
3. `node get-shit-done/bin/gsd-tools.js manifest validate --raw | node -e "const d=JSON.parse(require('fs').readFileSync('/dev/stdin','utf-8')); console.log('valid:', d.valid)"` shows valid status
4. `node get-shit-done/bin/gsd-tools.js manifest get-prompts release --raw` returns prompts for release feature
</verification>

<success_criteria>
- feature-manifest.json exists with 3 features, each with scope/introduced/config_key/schema/init_prompts
- All 3 manifest subcommands return well-formed JSON
- diff-config correctly identifies this project's missing release section
- validate returns valid:true for this project's config (unknown fields are warnings only)
- get-prompts returns feature-specific init prompts
</success_criteria>

<output>
After completion, create `.planning/phases/23-feature-manifest-foundation/23-01-SUMMARY.md`
</output>
