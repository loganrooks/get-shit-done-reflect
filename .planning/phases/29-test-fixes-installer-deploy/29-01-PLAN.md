---
phase: 29-test-fixes-installer-deploy
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - get-shit-done/bin/gsd-tools.test.js
autonomous: true

must_haves:
  truths:
    - "backlog stats tests pass without pollution from global ~/.gsd/backlog/items/"
    - "gsd-tools.test.js runs 163 tests with 0 failures"
    - "wiring-validation.test.js runs 20 tests with 0 failures"
    - "install.test.js runs 73 tests with 0 failures"
  artifacts:
    - path: "get-shit-done/bin/gsd-tools.test.js"
      provides: "GSD_HOME-isolated backlog stats tests"
      contains: "runGsdToolsWithEnv.*backlog stats.*GSD_HOME"
  key_links:
    - from: "get-shit-done/bin/gsd-tools.test.js"
      to: "get-shit-done/bin/gsd-tools.js:resolveBacklogDir"
      via: "GSD_HOME env override in runGsdToolsWithEnv"
      pattern: "GSD_HOME.*__nonexistent_gsd_home__"
---

<objective>
Fix 2 failing `backlog stats` tests by adding GSD_HOME environment isolation, then verify the full test suite passes across all three test runners.

Purpose: Eliminate global backlog item pollution that causes non-deterministic test failures on developer machines with real `~/.gsd/backlog/items/` content.
Output: Green test suite -- 163 node:test + 73 vitest (install) + 20 vitest (wiring) = 0 failures.
</objective>

<execution_context>
@/Users/rookslog/.claude/get-shit-done/workflows/execute-plan.md
@/Users/rookslog/.claude/get-shit-done/templates/summary-standard.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/29-test-fixes-installer-deploy/29-RESEARCH.md

@get-shit-done/bin/gsd-tools.test.js
</context>

<tasks>

<task type="auto">
  <name>Task 0: RED -- Confirm exactly 2 backlog stats test failures before fix</name>
  <files>get-shit-done/bin/gsd-tools.test.js</files>
  <action>
  Run the gsd-tools test suite BEFORE making any changes to establish the RED baseline:

  ```bash
  node --test get-shit-done/bin/gsd-tools.test.js 2>&1 | tail -20
  ```

  **Expected output:** Exactly 2 test failures:
  1. "returns counts by status and priority" -- expects `total: 3`, gets `total: 4` (global item pollution)
  2. "returns zero counts when no items" -- expects `total: 0`, gets `total: 1` (global item pollution)

  **If you see 0 failures:** STOP. The tests may already be fixed or the machine has no global backlog items. Check `ls ~/.gsd/backlog/items/` -- if empty, the tests pass trivially. Document this finding and proceed to Task 1 anyway (the fix is still correct for portability).

  **If you see more than 2 failures:** STOP. Investigate the additional failures before proceeding. Document them. Only proceed with Task 1 once you understand whether the extra failures are related to GSD_HOME isolation or a separate issue.

  Also audit all `runGsdTools('backlog` calls in the test file to check for other latent isolation gaps:

  ```bash
  grep -n "runGsdTools('backlog" get-shit-done/bin/gsd-tools.test.js
  ```

  For each match, verify it either:
  (a) already uses `runGsdToolsWithEnv` with GSD_HOME override, or
  (b) tests a command that does NOT aggregate global items (e.g., `backlog add`, `backlog list` with only local items, `backlog remove`).

  Document your findings: how many calls exist, which ones already use isolation, which ones don't need it, and whether any ADDITIONAL calls beyond the 2 known failures also need fixing.
  </action>
  <verify>
  Test suite output shows exactly 2 failures (or 0 if no global backlog items exist -- documented).
  Audit of all `runGsdTools('backlog` calls is complete with findings documented.
  </verify>
  <done>RED baseline established: the 2 backlog stats failures are confirmed (or their absence explained). Audit of all backlog test calls is complete.</done>
</task>

<task type="auto">
  <name>Task 1: GREEN -- Fix GSD_HOME isolation in backlog stats tests</name>
  <files>get-shit-done/bin/gsd-tools.test.js</files>
  <action>
  Change exactly 2 test calls from `runGsdTools` to `runGsdToolsWithEnv` with GSD_HOME isolation:

  **Fix 1 -- line 3280 (inside "returns counts by status and priority" test):**
  Change:
  ```javascript
  const result = runGsdTools('backlog stats', tmpDir);
  ```
  To:
  ```javascript
  const result = runGsdToolsWithEnv('backlog stats', tmpDir, {
    GSD_HOME: path.join(tmpDir, '__nonexistent_gsd_home__'),
  });
  ```

  **Fix 2 -- line 3292 (inside "returns zero counts when no items" test):**
  Change:
  ```javascript
  const result = runGsdTools('backlog stats', tmpDir);
  ```
  To:
  ```javascript
  const result = runGsdToolsWithEnv('backlog stats', tmpDir, {
    GSD_HOME: path.join(tmpDir, '__nonexistent_gsd_home__'),
  });
  ```

  This matches the exact pattern already used at line 4128-4131 of the same file. The `runGsdToolsWithEnv` helper is defined at lines 3372-3388. Setting GSD_HOME to a nonexistent path causes `resolveBacklogDir()` to return a path that doesn't exist, so `readBacklogItems()` catches the ENOENT and returns an empty array for global items.

  **If Task 0 audit found additional calls needing isolation:** Fix those too using the same pattern. Document each additional fix.

  Do NOT modify any tests that Task 0 audit confirmed are already isolated or don't need isolation. Do NOT refactor or rename anything.
  </action>
  <verify>
  Run the full gsd-tools test suite:
  ```bash
  node --test get-shit-done/bin/gsd-tools.test.js
  ```
  Expected: 163 tests, 0 failures. Specifically, the two previously-failing tests ("returns counts by status and priority" and "returns zero counts when no items") now pass.
  </verify>
  <done>Both backlog stats tests use GSD_HOME isolation and pass regardless of global backlog content. Any additional gaps found in Task 0 audit are also fixed.</done>
</task>

<task type="auto">
  <name>Task 2: Verify full test suite green across all runners</name>
  <files>get-shit-done/bin/gsd-tools.test.js</files>
  <action>
  Run all three test suites to confirm zero failures across the entire project:

  1. **gsd-tools.test.js** (node:test, 163 tests):
     ```bash
     node --test get-shit-done/bin/gsd-tools.test.js
     ```

  2. **install.test.js** (vitest, 73 tests):
     ```bash
     npx vitest run tests/unit/install.test.js
     ```

  3. **wiring-validation.test.js** (vitest, 20 tests):
     ```bash
     npx vitest run tests/integration/wiring-validation.test.js
     ```

  If any test fails that is NOT one of the 2 known failures already fixed in Task 1, investigate and fix. The goal is zero failures across all suites.

  Note: gsd-tools-fork.test.js (7 tests) was already green -- run it too if time permits but it is not a success criterion concern.
  </action>
  <verify>
  All three commands above exit with 0 status and report 0 failures:
  - gsd-tools.test.js: 163 pass, 0 fail
  - install.test.js: 73 pass, 0 fail
  - wiring-validation.test.js: 20 pass, 0 fail
  </verify>
  <done>Full test suite is green: 256+ tests across 3 runners with 0 failures.</done>
</task>

</tasks>

<verification>
Run all three test suites sequentially and confirm 0 failures:
```bash
node --test get-shit-done/bin/gsd-tools.test.js && \
npx vitest run tests/unit/install.test.js && \
npx vitest run tests/integration/wiring-validation.test.js
```
All must exit 0.
</verification>

<success_criteria>
1. The 2 backlog stats tests at lines 3275 and 3291 use `runGsdToolsWithEnv` with `GSD_HOME` isolation
2. gsd-tools.test.js: 163 pass, 0 fail
3. install.test.js: 73 pass, 0 fail
4. wiring-validation.test.js: 20 pass, 0 fail
</success_criteria>

<output>
After completion, create `.planning/phases/29-test-fixes-installer-deploy/29-01-SUMMARY.md`
</output>
