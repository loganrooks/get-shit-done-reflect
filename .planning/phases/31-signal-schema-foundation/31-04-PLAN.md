---
phase: 31-signal-schema-foundation
plan: 04
type: execute
wave: 1
depends_on: []
files_modified:
  - get-shit-done/bin/gsd-tools.js
  - get-shit-done/bin/gsd-tools.test.js
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "All 6 affected critical signals without evidence pass schema validation with valid: true when lifecycle_state is absent (backward compatibility mode)"
    - "New critical signals WITH lifecycle_state but WITHOUT evidence still fail validation with valid: false (strict enforcement preserved)"
    - "Backward compat evidence requirement appears in warnings array prefixed with backward_compat: rather than in missing array"
  artifacts:
    - path: "get-shit-done/bin/gsd-tools.js"
      provides: "backward_compat schema field and validation logic"
      contains: "backward_compat"
    - path: "get-shit-done/bin/gsd-tools.test.js"
      provides: "Tests for backward compatibility critical signal validation"
      contains: "backward_compat"
  key_links:
    - from: "get-shit-done/bin/gsd-tools.js"
      to: "FRONTMATTER_SCHEMAS.signal"
      via: "backward_compat field triggers lenient conditional validation"
      pattern: "backward_compat"
---

<objective>
Fix backward compatibility gap: 6 pre-existing critical signals fail schema validation because the conditional requirement `evidence REQUIRED for critical severity` does not distinguish pre-Phase 31 signals from new signals.

Purpose: The phase goal states "all 46 existing signals remain valid without migration." Currently 6 critical signals without evidence fail validation. Adding a backward_compat indicator keyed on lifecycle_state absence allows pre-existing signals to receive warnings instead of hard failures, while preserving strict enforcement for new signals.

Output: Modified validation logic in gsd-tools.js and updated/new tests confirming backward compatibility.
</objective>

<execution_context>
@/Users/rookslog/.claude/get-shit-done/workflows/execute-plan.md
@/Users/rookslog/.claude/get-shit-done/templates/summary-standard.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/ROADMAP.md
@.planning/phases/31-signal-schema-foundation/31-VERIFICATION.md
@.planning/phases/31-signal-schema-foundation/31-03-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add backward_compat schema field and validation logic to gsd-tools.js</name>
  <files>get-shit-done/bin/gsd-tools.js</files>
  <action>
Two changes to `get-shit-done/bin/gsd-tools.js`:

**1. Add backward_compat to FRONTMATTER_SCHEMAS.signal (line ~2231)**

Add a `backward_compat` field to the signal schema definition:

```javascript
signal: {
    required: ['id', 'type', 'project', 'tags', 'created', 'severity', 'signal_type'],
    conditional: [
      {
        when: { field: 'severity', value: 'critical' },
        require: ['evidence'],
        recommend: ['confidence', 'confidence_basis'],
      },
      {
        when: { field: 'severity', value: 'notable' },
        recommend: ['evidence', 'confidence'],
      },
    ],
    backward_compat: { field: 'lifecycle_state' },  // When absent, conditional require -> recommend
    recommended: ['lifecycle_state', 'signal_category', 'confidence', 'confidence_basis'],
    optional: ['triage', 'remediation', 'verification', 'lifecycle_log',
               'recurrence_of', 'phase', 'plan', 'polarity', 'source',
               'occurrence_count', 'related_signals', 'runtime', 'model',
               'gsd_version', 'durability', 'status'],
  },
```

**2. Update cmdFrontmatterValidate conditional loop (line ~2265-2283)**

After extracting frontmatter and before the conditional requirements loop, determine backward compatibility mode:

```javascript
// Determine backward compatibility mode: signals without lifecycle_state predate Phase 31
const backwardCompat = schema.backward_compat && fm[schema.backward_compat.field] === undefined;
```

Then modify the conditional require check to downgrade to warnings when in backward compat mode:

```javascript
if (cond.require) {
  for (const f of cond.require) {
    if (fm[f] === undefined) {
      if (backwardCompat) {
        conditionalWarnings.push(`backward_compat: ${f}`);
      } else {
        conditionalMissing.push(f);
      }
    }
  }
}
```

This ensures:
- Pre-existing signals (no lifecycle_state) get `backward_compat: evidence` as a warning, valid: true
- New signals (have lifecycle_state) get `evidence` in missing array, valid: false
- All other schemas (plan, summary, verification) are unaffected -- they have no backward_compat field
  </action>
  <verify>
Run: `npm test`
All 155+ tests pass. No regressions in existing schema validation (plan, summary, verification).
Verify manually: `node get-shit-done/bin/gsd-tools.js frontmatter validate ~/.gsd/knowledge/signals/get-shit-done-reflect/2026-02-11-kb-data-loss-migration-gap.md --schema signal` returns valid: true with backward_compat warning.
  </verify>
  <done>
cmdFrontmatterValidate recognizes backward_compat schema field and downgrades conditional require to recommend when the indicator field is absent. Existing schemas unaffected.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update and add tests for backward compatibility validation</name>
  <files>get-shit-done/bin/gsd-tools.test.js</files>
  <action>
Three changes to `get-shit-done/bin/gsd-tools.test.js` in the `signal frontmatter validation` describe block:

**1. Update existing "invalid critical signal without evidence" test (line ~4365)**

This test currently creates a critical signal WITHOUT lifecycle_state and WITHOUT evidence, asserting valid: false. After the backward compat change, this signal would be treated as pre-existing (no lifecycle_state) and pass. Update the test to simulate a NEW critical signal by adding `lifecycle_state: detected`:

```javascript
test('invalid critical signal without evidence', () => {
    const signalPath = path.join(tmpDir, 'critical-no-evidence.md');
    fs.writeFileSync(signalPath, `---
id: sig-2026-02-28-critical-no-ev
type: signal
project: test-project
tags: [critical]
created: 2026-02-28T10:00:00Z
severity: critical
signal_type: deviation
lifecycle_state: detected
---

# Critical without evidence
`);

    const result = runGsdTools(`frontmatter validate ${signalPath} --schema signal`, tmpDir);
    assert.ok(result.success, `Command failed: ${result.error}`);
    const output = JSON.parse(result.output);
    assert.strictEqual(output.valid, false, 'new critical signal without evidence should be invalid');
    assert.ok(output.missing.includes('evidence'), 'missing should include evidence');
  });
```

**2. Add new test: "backward compat: critical signal without lifecycle_state downgrades evidence to warning"**

Add after the existing backward compatibility test (line ~4415):

```javascript
test('backward compat: critical signal without lifecycle_state downgrades evidence to warning', () => {
    const signalPath = path.join(tmpDir, 'pre-existing-critical.md');
    fs.writeFileSync(signalPath, `---
id: sig-2026-02-11-kb-data-loss-migration-gap
type: signal
project: get-shit-done-reflect
tags: [knowledge-base, migration]
created: 2026-02-11T10:00:00Z
severity: critical
signal_type: deviation
phase: 25
polarity: negative
source: executor
---

# Pre-existing critical signal without evidence
`);

    const result = runGsdTools(`frontmatter validate ${signalPath} --schema signal`, tmpDir);
    assert.ok(result.success, `Command failed: ${result.error}`);
    const output = JSON.parse(result.output);
    assert.strictEqual(output.valid, true, 'pre-existing critical signal without lifecycle_state should be valid');
    assert.strictEqual(output.missing.length, 0, 'no missing fields in backward compat mode');
    const warningStr = output.warnings.join(',');
    assert.ok(warningStr.includes('backward_compat: evidence'), 'should include backward_compat warning for evidence');
  });
```

**3. Add new test: "new critical signal with lifecycle_state but no evidence fails"**

Add after the previous new test:

```javascript
test('new critical signal with lifecycle_state but no evidence fails', () => {
    const signalPath = path.join(tmpDir, 'new-critical-no-evidence.md');
    fs.writeFileSync(signalPath, `---
id: sig-2026-02-28-new-critical
type: signal
project: test-project
tags: [schema]
created: 2026-02-28T10:00:00Z
severity: critical
signal_type: deviation
lifecycle_state: detected
signal_category: negative
---

# New critical signal without evidence
`);

    const result = runGsdTools(`frontmatter validate ${signalPath} --schema signal`, tmpDir);
    assert.ok(result.success, `Command failed: ${result.error}`);
    const output = JSON.parse(result.output);
    assert.strictEqual(output.valid, false, 'new critical signal with lifecycle_state but no evidence should fail');
    assert.ok(output.missing.includes('evidence'), 'missing should include evidence');
  });
```

After all changes, run `npm test` to confirm all tests pass (expect 157+ tests, up from 155).
  </action>
  <verify>
Run: `npm test`
All tests pass. Specifically verify:
- "invalid critical signal without evidence" still asserts valid: false (now with lifecycle_state)
- "backward compat: critical signal without lifecycle_state downgrades evidence to warning" asserts valid: true
- "new critical signal with lifecycle_state but no evidence fails" asserts valid: false
- All other signal tests unchanged and passing
  </verify>
  <done>
9 signal validation tests (7 original + 2 new) all pass. Backward compatibility verified: pre-existing critical signals get warnings, new critical signals get hard failures. Test count is 157+.
  </done>
</task>

</tasks>

<verification>
1. `npm test` passes with all 157+ tests
2. Run validation against one of the 6 affected real signals:
   `node get-shit-done/bin/gsd-tools.js frontmatter validate ~/.gsd/knowledge/signals/get-shit-done-reflect/2026-02-11-kb-data-loss-migration-gap.md --schema signal`
   Expected: `valid: true`, warnings include `backward_compat: evidence`
3. Run validation against a new critical signal WITH lifecycle_state but WITHOUT evidence:
   Expected: `valid: false`, missing includes `evidence`
4. Run validation against all 6 affected signals and confirm all return valid: true
</verification>

<success_criteria>
- All 6 previously failing critical signals now pass validation with backward_compat warnings
- New critical signals still require evidence (hard fail without it)
- All 157+ tests pass including 2 new backward compatibility tests
- No regressions in plan/summary/verification schema validation
</success_criteria>

<output>
After completion, create `.planning/phases/31-signal-schema-foundation/31-04-SUMMARY.md`
</output>
