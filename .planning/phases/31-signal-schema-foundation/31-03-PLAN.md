---
phase: 31-signal-schema-foundation
plan: 03
type: execute
wave: 2
depends_on: ["31-01", "31-02"]
files_modified:
  - get-shit-done/bin/gsd-tools.js
  - get-shit-done/bin/gsd-tools.test.js
  - ~/.gsd/bin/kb-rebuild-index.sh
autonomous: true

must_haves:
  truths:
    - "FRONTMATTER_SCHEMAS in gsd-tools.js includes a signal schema with required, conditional, and recommended field validation"
    - "cmdFrontmatterValidate handles the signal schema including conditional requirements (evidence required when severity is critical)"
    - "All 46 existing signals pass validation without errors -- missing lifecycle fields do not cause validation failures"
    - "kb-rebuild-index.sh extracts lifecycle_state and displays it in the Lifecycle column of the signals table"
    - "Tests cover signal schema validation for all four severity tiers, backward compatibility with old signals, and conditional evidence requirements"
  artifacts:
    - path: "get-shit-done/bin/gsd-tools.js"
      provides: "Signal schema in FRONTMATTER_SCHEMAS with tiered validation"
      contains: "signal:"
    - path: "get-shit-done/bin/gsd-tools.test.js"
      provides: "Tests for signal frontmatter validation"
      contains: "signal"
    - path: "~/.gsd/bin/kb-rebuild-index.sh"
      provides: "Index with lifecycle_state column"
      contains: "Lifecycle"
  key_links:
    - from: "get-shit-done/bin/gsd-tools.js"
      to: "agents/knowledge-store.md"
      via: "FRONTMATTER_SCHEMAS.signal enforces the schema defined in knowledge-store.md"
      pattern: "signal.*required.*id.*type.*project"
    - from: "get-shit-done/bin/gsd-tools.test.js"
      to: "get-shit-done/bin/gsd-tools.js"
      via: "Tests exercise cmdFrontmatterValidate with signal schema"
      pattern: "frontmatter validate.*signal"
    - from: "~/.gsd/bin/kb-rebuild-index.sh"
      to: "~/.gsd/knowledge/index.md"
      via: "Script generates index with lifecycle_state column"
      pattern: "lifecycle_state\\|Lifecycle"
---

<objective>
Extend FRONTMATTER_SCHEMAS in gsd-tools.js with signal schema validation (including conditional requirements by severity), add comprehensive tests for backward compatibility and tiered validation, and update kb-rebuild-index.sh to extract the lifecycle_state column.

Purpose: This is the code implementation that makes the schema enforceable. Without it, the schema defined in knowledge-store.md is only documentation -- this plan makes it machine-validated. The index update makes lifecycle_state visible in the knowledge base index.

Output: Extended gsd-tools.js validation, test coverage, and updated index script.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary-standard.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/31-signal-schema-foundation/31-RESEARCH.md
@.planning/phases/31-signal-schema-foundation/31-CONTEXT.md
@.planning/phases/31-signal-schema-foundation/31-01-SUMMARY.md
@get-shit-done/bin/gsd-tools.js
@get-shit-done/bin/gsd-tools.test.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend FRONTMATTER_SCHEMAS and validation in gsd-tools.js</name>
  <files>get-shit-done/bin/gsd-tools.js</files>
  <action>
Modify get-shit-done/bin/gsd-tools.js (this is an upstream file but SCHEMA-08 explicitly requires this modification -- keep changes minimal and additive).

**Step 1: Extend FRONTMATTER_SCHEMAS (line ~2227).**

Add a `signal` entry to the FRONTMATTER_SCHEMAS object:

```javascript
signal: {
  required: ['id', 'type', 'project', 'tags', 'created', 'severity', 'signal_type'],
  conditional: [
    {
      when: { field: 'severity', value: 'critical' },
      require: ['evidence'],
      recommend: ['confidence', 'confidence_basis'],
    },
    {
      when: { field: 'severity', value: 'notable' },
      recommend: ['evidence', 'confidence'],
    },
  ],
  recommended: ['lifecycle_state', 'signal_category', 'confidence', 'confidence_basis'],
  optional: ['triage', 'remediation', 'verification', 'lifecycle_log',
             'recurrence_of', 'phase', 'plan', 'polarity', 'source',
             'occurrence_count', 'related_signals', 'runtime', 'model',
             'gsd_version', 'durability', 'status'],
},
```

**Step 2: Extend cmdFrontmatterValidate (line ~2233) to handle conditional and recommended fields.**

The current implementation only checks `schema.required`. Extend it to also check `schema.conditional` and `schema.recommended` when they exist:

```javascript
function cmdFrontmatterValidate(cwd, filePath, schemaName, raw) {
  if (!filePath || !schemaName) { error('file and schema required'); }
  const schema = FRONTMATTER_SCHEMAS[schemaName];
  if (!schema) { error(`Unknown schema: ${schemaName}. Available: ${Object.keys(FRONTMATTER_SCHEMAS).join(', ')}`); }
  const fullPath = path.isAbsolute(filePath) ? filePath : path.join(cwd, filePath);
  const content = safeReadFile(fullPath);
  if (!content) { output({ error: 'File not found', path: filePath }, raw); return; }
  const fm = extractFrontmatter(content);

  // Check required fields
  const missing = schema.required.filter(f => fm[f] === undefined);
  const present = schema.required.filter(f => fm[f] !== undefined);

  // Check conditional requirements
  const conditionalMissing = [];
  const conditionalWarnings = [];
  if (schema.conditional) {
    for (const cond of schema.conditional) {
      if (fm[cond.when.field] === cond.when.value) {
        if (cond.require) {
          for (const f of cond.require) {
            if (fm[f] === undefined) conditionalMissing.push(f);
          }
        }
        if (cond.recommend) {
          for (const f of cond.recommend) {
            if (fm[f] === undefined) conditionalWarnings.push(f);
          }
        }
      }
    }
  }

  // Check recommended fields (warnings only)
  const recommendedMissing = [];
  if (schema.recommended) {
    for (const f of schema.recommended) {
      if (fm[f] === undefined) recommendedMissing.push(f);
    }
  }

  const allMissing = [...missing, ...conditionalMissing];
  output({
    valid: allMissing.length === 0,
    missing: allMissing,
    present,
    warnings: [...conditionalWarnings, ...recommendedMissing.map(f => `recommended: ${f}`)],
    schema: schemaName,
  }, raw, allMissing.length === 0 ? 'valid' : 'invalid');
}
```

Key points:
- `required` fields cause validation failure (valid: false) if missing -- same as before
- `conditional.require` fields also cause validation failure when the condition matches (e.g., critical signals without evidence fail)
- `conditional.recommend` and `recommended` fields produce warnings but do NOT fail validation
- The `warnings` array is new output -- existing schemas (plan, summary, verification) have no conditional/recommended fields, so their output is unchanged (warnings will be an empty array or undefined)
- Backward compatible: schemas without conditional/recommended work exactly as before

Do NOT modify extractFrontmatter or reconstructFrontmatter. Do NOT modify any other commands. Keep the diff minimal.
  </action>
  <verify>
- `grep "signal:" get-shit-done/bin/gsd-tools.js` returns the schema entry
- `grep "conditional" get-shit-done/bin/gsd-tools.js` returns the conditional logic
- `grep "recommended" get-shit-done/bin/gsd-tools.js` returns the recommended logic
- `npm test` passes (existing tests still work with the extended validation function)
  </verify>
  <done>
FRONTMATTER_SCHEMAS includes signal schema with tiered validation. cmdFrontmatterValidate handles required, conditional, and recommended fields. Existing plan/summary/verification schemas are unaffected.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add signal validation tests and update kb-rebuild-index.sh</name>
  <files>get-shit-done/bin/gsd-tools.test.js, ~/.gsd/bin/kb-rebuild-index.sh</files>
  <action>
**Part A: Add tests to get-shit-done/bin/gsd-tools.test.js.**

Add a new `describe('signal frontmatter validation', ...)` block. Use the existing `runGsdTools`, `createTempProject`, and `cleanup` helpers. Tests should create temp signal files and run `frontmatter validate` against them.

Test cases (7-10 tests):

1. **Valid critical signal with all fields** -- Create a signal file with id, type, project, tags, created, severity: critical, signal_type: deviation, evidence: {supporting: [...], counter: [...]}, confidence, confidence_basis. Validate with `frontmatter validate <file> --schema signal`. Assert valid: true.

2. **Valid notable signal without evidence** -- severity: notable, no evidence field. Assert valid: true (evidence is recommended, not required for notable). Assert warnings include "recommended: evidence" or similar.

3. **Valid minor signal with minimal fields** -- severity: minor, only required fields. Assert valid: true.

4. **Invalid: missing required fields** -- Signal file missing `signal_type`. Assert valid: false, missing includes "signal_type".

5. **Invalid: critical signal without evidence** -- severity: critical, no evidence field. Assert valid: false, missing includes "evidence".

6. **Backward compatibility: existing signal format** -- Create a signal file matching the format of existing 46 signals (id, type, project, tags, created, severity: notable, signal_type: deviation, phase, plan, polarity, source, occurrence_count, related_signals, runtime, model -- NO lifecycle_state, NO evidence, NO confidence). Assert valid: true (lifecycle_state is recommended, not required).

7. **Warnings for missing recommended fields** -- Valid signal missing lifecycle_state and confidence. Assert valid: true but warnings array is non-empty.

Each test should:
- Create temp dir via `createTempProject()`
- Write a signal .md file with YAML frontmatter
- Run `runGsdTools('frontmatter validate <path> --schema signal', tmpDir)`
- Parse JSON output and assert
- Clean up

**Part B: Update ~/.gsd/bin/kb-rebuild-index.sh.**

In the `build_signal_rows` function, add extraction of `lifecycle_state` field and update the table format:

1. Add `lifecycle_state=$(get_field "$file" "lifecycle_state")` line after the severity extraction. If empty, default to "detected": `[ -z "$lifecycle_state" ] && lifecycle_state="detected"`

2. Update the signal table header (in the main output section, where it writes `## Signals`) to:
   `| ID | Project | Severity | Lifecycle | Tags | Date | Status |`
   with separator:
   `|----|---------|----------|-----------|------|------|--------|`

3. Update the row format string to include lifecycle_state between severity and tags:
   `rows="${rows}| ${id} | ${project} | ${severity} | ${lifecycle_state} | ${tags} | ${date_display} | ${status} |"`

This is the ONLY change to kb-rebuild-index.sh -- adding one field extraction and one column. The get_field helper already works for top-level fields like lifecycle_state.

After updating, run the index rebuild to verify: `bash ~/.gsd/bin/kb-rebuild-index.sh` and check the output has the Lifecycle column.
  </action>
  <verify>
- `npm test` passes (all existing tests + new signal validation tests)
- `grep "lifecycle_state" ~/.gsd/bin/kb-rebuild-index.sh` returns the extraction line
- `grep "Lifecycle" ~/.gsd/bin/kb-rebuild-index.sh` returns the column header
- Run `bash ~/.gsd/bin/kb-rebuild-index.sh` and verify `grep "Lifecycle" ~/.gsd/knowledge/index.md` shows the column
- Run the backward compatibility test: validate an existing signal file from ~/.gsd/knowledge/signals/get-shit-done-reflect/ using `node get-shit-done/bin/gsd-tools.js frontmatter validate <path> --schema signal` -- should return valid: true
  </verify>
  <done>
Signal validation tests cover all four severity tiers, backward compatibility with 46 existing signals, and conditional evidence requirements. kb-rebuild-index.sh extracts lifecycle_state into a Lifecycle column with "detected" default for existing signals.
  </done>
</task>

</tasks>

<verification>
- [ ] `npm test` passes with all existing tests plus new signal validation tests
- [ ] FRONTMATTER_SCHEMAS.signal exists in gsd-tools.js with required, conditional, and recommended arrays
- [ ] cmdFrontmatterValidate handles conditional requirements (critical without evidence fails)
- [ ] Existing plan/summary/verification validation is unchanged
- [ ] At least one existing signal file validates successfully with the new schema
- [ ] kb-rebuild-index.sh produces index with Lifecycle column
- [ ] Existing signals show "detected" in the Lifecycle column
- [ ] Run `node bin/install.js --local` to sync all source changes to .claude/ directory
</verification>

<success_criteria>
The signal schema is machine-enforceable: gsd-tools.js validates signal frontmatter with tiered rigor (critical signals require evidence), existing signals pass validation, and the knowledge base index includes lifecycle state. All tests pass.
</success_criteria>

<output>
After completion, create `.planning/phases/31-signal-schema-foundation/31-03-SUMMARY.md`
</output>
