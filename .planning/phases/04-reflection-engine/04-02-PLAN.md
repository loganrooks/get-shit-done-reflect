---
phase: 04-reflection-engine
plan: 02
type: execute
wave: 2
depends_on: [04-01]
files_modified:
  - ~/.claude/get-shit-done/workflows/reflect.md
  - ~/.claude/commands/gsd/reflect.md
  - ~/.claude/get-shit-done/references/milestone-reflection.md
autonomous: true

must_haves:
  truths:
    - "Running /gsd:reflect spawns the reflector agent and produces pattern summaries"
    - "Reflection workflow handles both project-scoped and cross-project (--all) reflection"
    - "Lessons are written to KB and index is rebuilt after reflection"
    - "Milestone completion can optionally trigger reflection on all milestone phases"
  artifacts:
    - path: "~/.claude/get-shit-done/workflows/reflect.md"
      provides: "Reflection workflow orchestration"
      contains: "gsd-reflector"
    - path: "~/.claude/commands/gsd/reflect.md"
      provides: "/gsd:reflect command entry point"
      contains: "reflect"
    - path: "~/.claude/get-shit-done/references/milestone-reflection.md"
      provides: "Milestone integration specification"
      contains: "complete-milestone"
  key_links:
    - from: "~/.claude/commands/gsd/reflect.md"
      to: "workflows/reflect.md"
      via: "command delegates to workflow"
      pattern: "workflows/reflect.md"
    - from: "~/.claude/get-shit-done/workflows/reflect.md"
      to: "gsd-reflector.md"
      via: "workflow spawns agent"
      pattern: "gsd-reflector"
    - from: "~/.claude/get-shit-done/workflows/reflect.md"
      to: "kb-rebuild-index.sh"
      via: "index rebuild after lesson writes"
      pattern: "kb-rebuild-index.sh"
---

<objective>
Create the reflection workflow, command, and milestone integration.

Purpose: Provide the orchestration layer that connects the user-facing /gsd:reflect command to the reflector agent, and document how milestone completion can optionally include reflection.

Output: reflect.md workflow, reflect.md command, and milestone-reflection.md integration reference.
</objective>

<execution_context>
@/Users/rookslog/.claude/get-shit-done/workflows/execute-plan.md
@/Users/rookslog/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-reflection-engine/04-CONTEXT.md
@.planning/phases/04-reflection-engine/04-RESEARCH.md
@.planning/phases/04-reflection-engine/04-01-SUMMARY.md

# Foundation from Plan 1
@.claude/get-shit-done/references/reflection-patterns.md
@.claude/agents/gsd-reflector.md

# Existing infrastructure
@.claude/agents/knowledge-store.md
@.claude/get-shit-done/workflows/complete-milestone.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create reflect.md workflow</name>
  <files>~/.claude/get-shit-done/workflows/reflect.md</files>
  <action>
Create reflection workflow following existing workflow patterns. Structure:

**Purpose section:**
Analyze accumulated signals from the knowledge base, detect recurring patterns using severity-weighted thresholds, distill qualifying patterns into actionable lessons, and optionally run phase-end or semantic drift analysis. This workflow closes the self-improvement loop: signals become patterns become lessons that prevent future mistakes.

**Required reading:**
- get-shit-done/references/reflection-patterns.md
- agents/knowledge-store.md
- agents/kb-templates/lesson.md

**Trigger modes:**
1. Explicit command: `/gsd:reflect` or `/gsd:reflect {phase}`
2. Phase-end: `/gsd:reflect --phase {N}` for specific phase reflection
3. Cross-project: `/gsd:reflect --all` for cross-project pattern detection
4. Milestone: Called from milestone completion workflow (optional)

**Process steps:**

1. **Parse Arguments**
   - Default scope: current project
   - `--all` flag: cross-project scope
   - `{phase}` argument: include phase-end reflection
   - `--patterns-only`: skip lesson distillation
   - `--drift-check`: include semantic drift analysis

2. **Load Configuration**
   ```bash
   cat .planning/config.json 2>/dev/null
   ```
   - Check autonomy mode (yolo vs interactive)
   - Check depth setting (affects thoroughness)

3. **Verify KB Exists**
   ```bash
   ls ~/.claude/gsd-knowledge/index.md 2>/dev/null
   ```
   - If no KB: report "No knowledge base found. Run /gsd:collect-signals first."

4. **Prepare Context for Agent**
   - Read index.md (pass as context)
   - If phase-end: read PLAN.md and SUMMARY.md for that phase
   - Inline artifact content (@ syntax doesn't cross Task boundaries)

5. **Spawn Reflector Agent**
   Use Task tool to spawn gsd-reflector with prepared context:
   - Pass scope, phase (if specified), flags
   - Agent returns: patterns detected, deviations (if phase-end), lesson candidates, drift report (if requested)

6. **Present Results**
   Format and display:
   - Pattern summary table (count, severity, confidence)
   - Phase deviations (if phase-end reflection)
   - Lesson candidates with evidence
   - Drift assessment (if checked)

7. **Handle Lesson Creation**
   <if mode="yolo">
   Auto-approve lessons with HIGH confidence (6+ evidence):
   - Write lesson files using kb-templates/lesson.md
   - Report: "Auto-approved N lessons (HIGH confidence)"
   Lessons with MEDIUM/LOW confidence: present for optional confirmation
   </if>

   <if mode="interactive">
   Present each lesson candidate:
   ```
   Lesson candidate: {title}
   Category: {category}
   Confidence: {level} ({count} supporting signals)
   Insight: {one-sentence lesson}

   Create this lesson? (yes / no / edit)
   ```
   - If yes: write lesson file
   - If no: skip
   - If edit: allow user to modify before writing
   </if>

8. **Rebuild Index**
   After any lesson writes:
   ```bash
   bash ~/.claude/agents/kb-rebuild-index.sh
   ```

9. **Report Completion**
   ```
   ## Reflection Complete

   **Scope:** {project / cross-project}
   **Signals analyzed:** {count}
   **Patterns detected:** {count}
   **Lessons created:** {count}

   {If phase-end: deviation summary}
   {If drift-check: drift assessment}

   ### Patterns Found
   {pattern table}

   ### Lessons Created
   {lesson list with file paths}
   ```

**Empty state handling:**
- No signals: "No signals found in knowledge base. Nothing to reflect on."
- No patterns: "Signals found but no recurring patterns detected. Consider lowering thresholds or accumulating more signals."
- No lesson candidates: "Patterns found but none meet distillation criteria. Patterns are logged for future reference."

**Config integration:**
- `depth: quick` - check only current project, skip drift check
- `depth: standard` - current project with drift check
- `depth: comprehensive` - cross-project with full drift analysis
  </action>
  <verify>
File exists at ~/.claude/get-shit-done/workflows/reflect.md with:
- Purpose section explaining self-improvement loop
- Process steps including agent spawn
- Mode handling (yolo vs interactive)
- Index rebuild step
  </verify>
  <done>Workflow orchestrates complete reflection process from signal analysis to lesson creation</done>
</task>

<task type="auto">
  <name>Task 2: Create reflect.md command</name>
  <files>~/.claude/commands/gsd/reflect.md</files>
  <action>
Create thin routing layer command following existing command patterns (model on collect-signals.md pattern). Structure:

```markdown
---
description: Analyze accumulated signals and distill patterns into lessons
---

<purpose>
Run reflection on accumulated signals to detect patterns and create actionable lessons.
</purpose>

<usage>
/gsd:reflect              # Reflect on current project
/gsd:reflect {phase}      # Include phase-end reflection for specific phase
/gsd:reflect --all        # Cross-project pattern detection
/gsd:reflect --drift      # Include semantic drift analysis
</usage>

<examples>
/gsd:reflect
/gsd:reflect 3
/gsd:reflect --all
/gsd:reflect 4 --drift
</examples>

<routing>
This command delegates entirely to the reflection workflow:
@get-shit-done/workflows/reflect.md
</routing>
```

The command is a thin routing layer. All logic lives in the workflow.
  </action>
  <verify>
File exists at ~/.claude/commands/gsd/reflect.md with:
- description in frontmatter
- usage section with all flags
- routing to workflows/reflect.md
  </verify>
  <done>/gsd:reflect command is available and routes to workflow</done>
</task>

<task type="auto">
  <name>Task 3: Create milestone-reflection.md integration reference</name>
  <files>~/.claude/get-shit-done/references/milestone-reflection.md</files>
  <action>
Create integration reference document specifying how complete-milestone workflow can optionally trigger reflection. Structure:

**Purpose:**
Document the optional reflection step that can be triggered as part of milestone completion. This integrates RFLC-04 without modifying the upstream complete-milestone.md workflow.

**Integration Point:**
The complete-milestone workflow can optionally call `/gsd:reflect` after gathering stats and before creating the milestone entry. This is not automatic -- it's a documented option.

**Default Behavior:**
- Reflection is OPTIONAL during milestone completion
- User can skip reflection to proceed faster
- Reflection does not block milestone completion

**How to Trigger:**
During milestone completion, after stats gathering:
```
Optional: Run reflection on milestone phases?

This will:
- Analyze signals from all phases in this milestone
- Detect patterns across the milestone
- Suggest lessons for the knowledge base

(yes / skip)
```

If yes: Run `/gsd:reflect` with milestone phase range scope.

**What Gets Reflected:**
- All phases included in the milestone (e.g., phases 1-4 for v1.0)
- Signals accumulated during milestone execution
- Phase-end comparisons for each plan

**Output Inclusion:**
If reflection runs during milestone completion:
- Pattern summary is appended to milestone archive
- Lessons created are listed in milestone entry
- Serves as milestone retrospective

**Configuration:**
Can be configured in `.planning/config.json`:
```json
{
  "milestone_reflection": "optional"  // optional | required | skip
}
```
- `optional` (default): Prompt user during milestone completion
- `required`: Must run reflection before milestone completes
- `skip`: Never prompt for reflection

**Depth for Milestone Reflection:**
- Uses summary depth by default
- Analyzes all phases but reports aggregate patterns only
- Top 3 lessons suggested (not all candidates)
- Full detail available via `/gsd:reflect --phase N` for specific phases

**Example Milestone Archive Addition:**
```markdown
## Reflection Summary

**Patterns detected:** 3
**Lessons created:** 2

### Top Patterns
1. {pattern-name} (4 occurrences, HIGH confidence)
2. {pattern-name} (2 occurrences, MEDIUM confidence)

### Lessons Added
- les-2026-02-05-{slug} (tooling/vitest)
- les-2026-02-05-{slug} (external/claude-api)
```

**Fork Constraint Compliance:**
This is a NEW reference file (additive). The complete-milestone.md workflow is NOT modified. Integration is documentation-based: users who want milestone reflection follow this reference.
  </action>
  <verify>
File exists at ~/.claude/get-shit-done/references/milestone-reflection.md with:
- Integration point section
- Default behavior (optional)
- Configuration options
- Output format for milestone archive
  </verify>
  <done>Milestone reflection integration is documented without modifying upstream workflow</done>
</task>

</tasks>

<verification>
1. Run: `cat ~/.claude/get-shit-done/workflows/reflect.md | head -30` - verify workflow structure
2. Run: `grep "gsd-reflector" ~/.claude/get-shit-done/workflows/reflect.md` - verify agent spawn
3. Run: `cat ~/.claude/commands/gsd/reflect.md` - verify command routing
4. Run: `cat ~/.claude/get-shit-done/references/milestone-reflection.md | head -30` - verify integration doc
</verification>

<success_criteria>
- reflect.md workflow exists with complete orchestration logic
- reflect.md command exists and routes to workflow
- milestone-reflection.md exists with integration specification
- Workflow handles both yolo and interactive modes
- Index is rebuilt after lesson creation
- All requirements covered: RFLC-03 (/gsd:reflect), RFLC-04 (milestone integration)
</success_criteria>

<output>
After completion, create `.planning/phases/04-reflection-engine/04-02-SUMMARY.md`
</output>
