---
phase: 04-reflection-engine
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - ~/.claude/get-shit-done/references/reflection-patterns.md
  - ~/.claude/agents/gsd-reflector.md
autonomous: true

must_haves:
  truths:
    - "Pattern detection rules exist for severity-weighted thresholds"
    - "Lesson distillation criteria and flow are documented"
    - "Phase-end reflection comparison points are specified"
    - "Cross-project and semantic drift detection rules are defined"
    - "A spawnable agent exists to perform reflection analysis"
  artifacts:
    - path: "~/.claude/get-shit-done/references/reflection-patterns.md"
      provides: "Pattern detection rules, thresholds, distillation flow"
      contains: "severity-weighted"
    - path: "~/.claude/agents/gsd-reflector.md"
      provides: "Reflection agent definition"
      contains: "gsd-reflector"
  key_links:
    - from: "~/.claude/agents/gsd-reflector.md"
      to: "reflection-patterns.md"
      via: "@reference in references section"
      pattern: "@get-shit-done/references/reflection-patterns.md"
    - from: "~/.claude/agents/gsd-reflector.md"
      to: "knowledge-store.md"
      via: "@reference for KB schema"
      pattern: "@.claude/agents/knowledge-store.md"
---

<objective>
Create the foundational reference specification and agent for the reflection engine.

Purpose: Establish the rules for pattern detection, lesson distillation, and phase-end reflection that the reflection workflow will use. Define the agent that performs the actual analysis.

Output: reflection-patterns.md reference doc and gsd-reflector.md agent definition.
</objective>

<execution_context>
@/Users/rookslog/.claude/get-shit-done/workflows/execute-plan.md
@/Users/rookslog/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-reflection-engine/04-CONTEXT.md
@.planning/phases/04-reflection-engine/04-RESEARCH.md

# Phase 1/2 infrastructure to build on
@.claude/agents/knowledge-store.md
@.claude/agents/kb-templates/lesson.md
@.claude/agents/gsd-signal-collector.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create reflection-patterns.md reference document</name>
  <files>~/.claude/get-shit-done/references/reflection-patterns.md</files>
  <action>
Create comprehensive reference document for pattern detection and lesson distillation. Structure as follows:

1. **Overview** - Purpose of the reflection engine in the self-improvement loop

2. **Pattern Detection Rules**
   - Severity-weighted thresholds (from CONTEXT.md):
     - Critical/high signals: 2 occurrences surfaces pattern
     - Medium signals: 4 occurrences
     - Low signals: 5+ occurrences
   - Signal clustering criteria:
     - Same signal_type + 2+ overlapping tags = strongest match
     - Same project + same signal_type + similar slug = project-specific recurrence
     - Cross-project: same tags + same signal_type = candidate global pattern
   - Pattern output format with: signal type, occurrences, severity, confidence, signals list, root cause hypothesis, recommended action

3. **Phase-End Reflection** (RFLC-01)
   - Comparison points: PLAN.md vs SUMMARY.md
     - Task count comparison (planned vs executed)
     - Files scope comparison (files_modified vs actual)
     - Auto-fix count tracking
     - Issues encountered analysis
     - must_haves vs VERIFICATION.md gaps
   - Reflection output format

4. **Lesson Distillation** (RFLC-02)
   - Distillation criteria: meets threshold + consistent root cause + actionable recommendation
   - Lesson creation flow:
     1. Identify qualifying pattern
     2. Draft lesson content (category, insight, evidence, confidence, durability)
     3. Determine scope (project vs global) using heuristics
     4. Write lesson file using kb-templates/lesson.md
     5. Rebuild index
   - Scope determination heuristics (from CONTEXT.md):
     - Global: references named library/framework, external root cause
     - Project: references specific file paths, local config, internal root cause
     - Default: project-scoped when uncertain

5. **Cross-Project Detection** (SGNL-07)
   - Scan index.md across all projects
   - Group by tag + signal_type ignoring project field
   - Check for `likely_scope: global` hints
   - Criteria for global lesson: pattern spans 2+ projects with same root cause

6. **Semantic Drift Detection** (RFLC-06)
   - Heuristic indicators (no ML):
     - Verification gap trend (gaps_found rate across phases)
     - Auto-fix frequency trend (per plan over time)
     - Signal severity trend (critical/high rate over time)
     - Deviation-to-plan ratio trend
   - Detection thresholds: flag if recent is 50%+ worse than baseline
   - Drift report format

7. **Workflow Improvement Suggestions** (RFLC-05)
   - Based on recurring signal patterns
   - Template for suggestions: pattern observed, impact, recommended workflow change

8. **Category Taxonomy** (from CONTEXT.md)
   - Top-level: tooling, architecture, testing, workflow, external, environment
   - Subcategories emerge as needed (e.g., tooling/vitest, external/claude-api)

9. **Confidence Expression**
   - Categorical: HIGH/MEDIUM/LOW with occurrence count
   - HIGH: 6+ occurrences, empirical evidence
   - MEDIUM: 3-5 occurrences, inference from patterns
   - LOW: 2-3 occurrences, educated guess

10. **Anti-Patterns to Avoid**
    - Time-based rolling windows (lose persistent issues)
    - Automatic global promotion in interactive mode (noise)
    - Pattern detection on every signal write (performance)
    - Circular evidence in lessons

Include bash pseudocode examples for pattern detection and drift detection from RESEARCH.md.
  </action>
  <verify>
File exists at ~/.claude/get-shit-done/references/reflection-patterns.md with:
- "severity-weighted" in content
- Pattern detection section
- Lesson distillation section
- Phase-end reflection section
- Semantic drift section
  </verify>
  <done>Reference document provides complete rules for pattern detection, lesson distillation, and all reflection operations</done>
</task>

<task type="auto">
  <name>Task 2: Create gsd-reflector.md agent</name>
  <files>~/.claude/agents/gsd-reflector.md</files>
  <action>
Create reflection agent following existing agent patterns (model on gsd-signal-collector.md). Structure:

**Frontmatter:**
```yaml
---
name: gsd-reflector
description: Analyzes accumulated signals, detects patterns, compares plan vs execution, distills lessons, and tracks semantic drift
tools: Read, Write, Bash, Glob, Grep
color: magenta
---
```

**Role section:**
- Spawned by `/gsd:reflect` command or reflection workflow
- Job: Turn signal noise into patterns into actionable knowledge
- Retrospective analyzer, not execution modifier

**References section:**
- @get-shit-done/references/reflection-patterns.md (detection rules and thresholds)
- @.claude/agents/knowledge-store.md (KB schema and directory layout)
- @.claude/agents/kb-templates/lesson.md (lesson entry template)

**Inputs section:**
- Scope: `project` (current project) or `all` (cross-project)
- Phase: optional phase number for phase-end reflection
- Flags: `--patterns-only` (skip lesson distillation), `--drift-check` (include semantic drift)

**Execution flow:**
1. Load Configuration - read config.json for autonomy mode
2. Load Signals - read index.md, filter by scope
3. Detect Patterns - apply severity-weighted thresholds from reference
4. (If phase specified) Phase-End Reflection - compare PLAN.md vs SUMMARY.md
5. (If patterns found) Distill Lessons - apply distillation criteria
6. (If drift-check) Semantic Drift Check - calculate trends
7. Report Results - output pattern summaries, deviations, lesson candidates

**Output format:**
Pattern summary table, deviation report (if phase-end), lesson candidates with confidence, drift assessment (if requested)

**Guidelines:**
- Read reflection-patterns.md before every reflection run
- Never modify signal files (immutable)
- Always rebuild index after writing lessons
- Use categorical confidence with evidence count
- Default to project scope; use `--all` for cross-project
- In YOLO mode: auto-approve high-confidence lessons
- In interactive mode: present lessons for confirmation
  </action>
  <verify>
File exists at ~/.claude/agents/gsd-reflector.md with:
- Frontmatter with name: gsd-reflector
- References section with reflection-patterns.md, knowledge-store.md, lesson template
- Execution flow with pattern detection and lesson distillation steps
- Output format section
  </verify>
  <done>Agent can be spawned to perform pattern detection, phase-end reflection, lesson distillation, and semantic drift analysis</done>
</task>

</tasks>

<verification>
1. Run: `cat ~/.claude/get-shit-done/references/reflection-patterns.md | head -50` - verify reference doc structure
2. Run: `grep -c "severity-weighted" ~/.claude/get-shit-done/references/reflection-patterns.md` - verify key concept present
3. Run: `cat ~/.claude/agents/gsd-reflector.md | head -30` - verify agent frontmatter
4. Run: `grep "reflection-patterns.md" ~/.claude/agents/gsd-reflector.md` - verify agent references the reference doc
</verification>

<success_criteria>
- reflection-patterns.md exists with complete pattern detection and lesson distillation rules
- gsd-reflector.md exists with proper agent structure and references
- Agent references reflection-patterns.md, knowledge-store.md, and lesson template
- All requirements covered: RFLC-01 (phase-end), RFLC-02 (distillation), RFLC-05 (suggestions), RFLC-06 (drift), SGNL-07 (cross-project rules)
</success_criteria>

<output>
After completion, create `.planning/phases/04-reflection-engine/04-01-SUMMARY.md`
</output>
