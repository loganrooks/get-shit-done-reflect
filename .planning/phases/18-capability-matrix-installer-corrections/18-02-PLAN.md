---
phase: 18-capability-matrix-installer-corrections
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - bin/install.js
  - tests/unit/install.test.js
  - tests/integration/multi-runtime.test.js
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Gemini CLI agent conversion preserves MCP tool references (mcp__*) in tools array"
    - "Gemini CLI agent conversion still excludes Task tool (agents auto-register in Gemini)"
    - "Gemini CLI agent conversion preserves tool_permissions by keeping allowed-tools content including MCP tools"
    - "Codex CLI skill conversion preserves MCP tool references in body text (not stripped by claudeToCodexTools mapping)"
    - "All existing 127 tests continue to pass after the fix"
    - "New tests specifically verify MCP tool preservation in both Gemini agent conversion and Codex skill conversion"
  artifacts:
    - path: "bin/install.js"
      provides: "Fixed convertGeminiToolName() that preserves MCP tools"
      contains: "return claudeTool"
    - path: "tests/unit/install.test.js"
      provides: "Unit tests for Gemini MCP tool preservation and Codex MCP body text preservation"
      contains: "mcp__context7"
    - path: "tests/integration/multi-runtime.test.js"
      provides: "Integration test for Gemini agent MCP tool retention"
      contains: "mcp__"
  key_links:
    - from: "bin/install.js convertGeminiToolName()"
      to: "convertClaudeToGeminiAgent()"
      via: "tool name mapping pipeline"
      pattern: "convertGeminiToolName"
    - from: "tests/unit/install.test.js"
      to: "bin/install.js convertClaudeToGeminiAgent"
      via: "direct function import"
      pattern: "convertClaudeToGeminiAgent"
    - from: "tests/unit/install.test.js"
      to: "bin/install.js convertClaudeToCodexSkill"
      via: "direct function import"
      pattern: "convertClaudeToCodexSkill"
---

<objective>
Fix the Gemini CLI installer to preserve MCP tool references and tool_permissions content instead of stripping them. The bug is in `convertGeminiToolName()` which returns `null` for `mcp__*` prefixed tools, causing them to be dropped during Gemini agent format conversion. Add `convertClaudeToGeminiAgent` to module exports and add unit + integration tests. Also add a test proving Codex skill conversion already preserves MCP body text references (Success Criterion #2).

Purpose: Gemini CLI now supports MCP servers (verified in prior research). The installer should not strip MCP tool references from agent frontmatter during conversion. This single fix also addresses tool_permissions preservation because the same code path handles allowed-tools arrays containing MCP tools. For Codex, MCP body text references already pass through `convertClaudeToCodexSkill()` unchanged (because `mcp__*` is not in the `claudeToCodexTools` mapping) -- but this needs a test to prove it.

Output: Fixed `bin/install.js` with passing tests covering the corrected behavior for both Gemini and Codex MCP preservation.
</objective>

<execution_context>
@/Users/rookslog/.claude/get-shit-done/workflows/execute-plan.md
@/Users/rookslog/.claude/get-shit-done/templates/summary-standard.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@bin/install.js
@tests/unit/install.test.js
@tests/integration/multi-runtime.test.js
@.planning/phases/18-capability-matrix-installer-corrections/18-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix convertGeminiToolName() and export convertClaudeToGeminiAgent()</name>
  <files>bin/install.js</files>
  <action>
Make three targeted changes in bin/install.js:

**Change 1 -- Fix the MCP stripping bug (line ~487):**
In `convertGeminiToolName()`, change the `mcp__*` branch from returning `null` to returning the tool name as-is:

BEFORE:
```javascript
  // MCP tools: exclude -- auto-discovered from mcpServers config at runtime
  if (claudeTool.startsWith('mcp__')) {
    return null;
  }
```

AFTER:
```javascript
  // MCP tools: preserve as-is -- Gemini CLI supports MCP servers
  if (claudeTool.startsWith('mcp__')) {
    return claudeTool;
  }
```

**Change 2 -- Update JSDoc comment (line ~518):**
In the `convertClaudeToGeminiAgent()` JSDoc block, change:
```
 * - mcp__* tools: must be excluded (auto-discovered at runtime)
```
to:
```
 * - mcp__* tools: preserved as-is (Gemini CLI supports MCP servers)
```

**Change 3 -- Add convertClaudeToGeminiAgent to module.exports (line ~2250):**
Add `convertClaudeToGeminiAgent` to the existing `module.exports` object. Current exports:
```javascript
module.exports = { replacePathsInContent, getGsdHome, migrateKB, countKBEntries, convertClaudeToCodexSkill, copyCodexSkills, generateCodexAgentsMd };
```
Updated:
```javascript
module.exports = { replacePathsInContent, getGsdHome, migrateKB, countKBEntries, convertClaudeToCodexSkill, copyCodexSkills, generateCodexAgentsMd, convertClaudeToGeminiAgent };
```

DO NOT change:
- The `Task` exclusion (returning null for `Task` is correct -- Gemini auto-registers agents)
- The `convertClaudeToGeminiToml()` function (TOML commands correctly strip frontmatter)
- The `convertClaudeToCodexSkill()` function (Codex correctly strips allowed-tools; MCP body text already passes through)
- Any other converter function
  </action>
  <verify>Run `node -e "const m = require('./bin/install.js'); console.log(typeof m.convertClaudeToGeminiAgent)"` from the project root -- should print "function". Then run `npx vitest run` to confirm all 127 existing tests still pass.</verify>
  <done>convertGeminiToolName() returns MCP tool names instead of null, JSDoc updated, convertClaudeToGeminiAgent exported, all existing tests pass</done>
</task>

<task type="auto">
  <name>Task 2: Add unit and integration tests for Gemini and Codex MCP tool preservation</name>
  <files>tests/unit/install.test.js, tests/integration/multi-runtime.test.js</files>
  <action>
**Unit tests -- Gemini MCP preservation (tests/unit/install.test.js):**

Add `convertClaudeToGeminiAgent` to the require/import statement at the top of the file (alongside the existing `convertClaudeToCodexSkill` import). Then add a new describe block for Gemini agent MCP tool conversion. Add these test cases:

1. **"preserves MCP tools in Gemini agent tools field"** -- Input: agent with `tools: Read, Write, Bash, mcp__context7__resolve-library-id` inline tools field. Assert: output contains `mcp__context7__resolve-library-id` in the tools array. Assert: output contains `read_file` (built-in tool converted). Assert: output does NOT contain `Read` (should be converted to `read_file`).

2. **"preserves MCP tools from allowed-tools YAML array in Gemini agent"** -- Input: agent with allowed-tools YAML array containing `- Read`, `- Write`, `- Task`, `- mcp__context7__*`. Assert: output contains `mcp__context7__*`. Assert: output does NOT contain `Task` (correctly excluded). Assert: output contains `read_file` (built-in converted).

3. **"preserves multiple MCP tools in Gemini agent"** -- Input: agent with multiple MCP tools like `mcp__context7__resolve-library-id`, `mcp__context7__query-docs`, `mcp__fetch__get`. Assert: all three MCP tool names appear in the output.

**Unit test -- Codex MCP body text preservation (tests/unit/install.test.js):**

4. **"Codex skill conversion preserves MCP tool references in body text"** -- This test covers Success Criterion #2 (Codex CLI preserves MCP). Input: a skill with body text containing MCP tool references like `mcp__context7__resolve-library-id` and `mcp__context7__query-docs` (mimicking the body content found in agents like `gsd-phase-researcher.md`). Use the already-imported `convertClaudeToCodexSkill` function. Assert: output body text still contains `mcp__context7__resolve-library-id`. Assert: output body text still contains `mcp__context7__query-docs`. Assert: built-in tool names in body text ARE converted (e.g., `Read` becomes `read_file` per the claudeToCodexTools map). This proves that MCP references survive the Codex conversion pipeline because `mcp__*` names are not in the claudeToCodexTools mapping and therefore pass through unchanged.

**Integration test (tests/integration/multi-runtime.test.js):**

Add a test within the existing `VALID-02: Gemini installation` describe block:

5. **"Gemini: agent files retain MCP tool references after install"** -- Run the Gemini installer with `--gemini --global`. Then read the installed planner agent file at the Gemini agents directory (the source file is `agents/gsd-planner.md` which contains `tools: Read, Write, Bash, Glob, Grep, WebFetch, mcp__context7__*`). Assert the installed file content contains `mcp__context7` (MCP tool reference preserved, not stripped). Use the existing `tmpdirTest` pattern from the surrounding tests.

The three source agent files that contain MCP tool references are:
- `agents/gsd-planner.md` -- line 4: `tools: Read, Write, Bash, Glob, Grep, WebFetch, mcp__context7__*`
- `agents/gsd-project-researcher.md` -- line 4: `tools: Read, Write, Bash, Grep, Glob, WebSearch, WebFetch, mcp__context7__*`
- `agents/gsd-phase-researcher.md` -- line 4: `tools: Read, Write, Bash, Grep, Glob, WebSearch, WebFetch, mcp__context7__*`

Use `gsd-planner.md` as the test fixture for the integration test (simplest tools list).
  </action>
  <verify>Run `npx vitest run` -- all tests pass including the new ones. Specifically check that the new Gemini MCP tests and the new Codex MCP body text test are reported as passing.</verify>
  <done>5 new tests added (3 Gemini unit, 1 Codex unit, 1 Gemini integration), all pass alongside the existing 127 tests. Total test count is 132+.</done>
</task>

</tasks>

<verification>
1. `npx vitest run` -- all tests pass (127 existing + 5 new)
2. `node -e "const m = require('./bin/install.js'); const r = m.convertClaudeToGeminiAgent('---\ntools: Read, mcp__ctx__t\n---\nbody'); console.log(r.includes('mcp__ctx__t'))"` prints `true`
3. `node -e "const m = require('./bin/install.js'); const r = m.convertClaudeToGeminiAgent('---\ntools: Read, Task, mcp__ctx__t\n---\nbody'); console.log(!r.includes('Task'))"` prints `true` (Task still excluded)
4. `node -e "const m = require('./bin/install.js'); const r = m.convertClaudeToCodexSkill('---\nname: test\n---\nUse mcp__context7__resolve-library-id to query', 'test'); console.log(r.includes('mcp__context7__resolve-library-id'))"` prints `true` (Codex preserves MCP body text)
5. No regressions in existing test suite
</verification>

<success_criteria>
- convertGeminiToolName() returns MCP tool names as-is (not null)
- convertClaudeToGeminiAgent() is exported and testable
- 3 unit tests verify MCP tool preservation in Gemini agent conversion
- 1 unit test verifies Codex skill conversion preserves MCP body text references (proving Success Criterion #2)
- 1 integration test verifies end-to-end Gemini install preserves MCP tools in agents
- All 132+ tests pass (127 existing + 5 new)
- JSDoc comments reflect the corrected behavior
</success_criteria>

<output>
After completion, create `.planning/phases/18-capability-matrix-installer-corrections/18-02-SUMMARY.md`
</output>
