---
phase: 07-fork-strategy-pre-merge-setup
plan: 02
type: execute
wave: 2
depends_on: [07-01]
files_modified:
  - tests/integration/wiring-validation.test.js
autonomous: true

must_haves:
  truths:
    - "All vitest tests pass with 0 failures (npx vitest run exits cleanly)"
    - "An immutable annotated tag v1.12.2-pre-sync exists on main capturing the complete fork state including strategy documentation"
    - "A sync branch sync/v1.13-upstream exists branched from the tagged commit, ready for Phase 8 merge"
  artifacts:
    - path: "tests/integration/wiring-validation.test.js"
      provides: "Fixed wiring validation tests that match current file state"
    - path: "git tag v1.12.2-pre-sync"
      provides: "Immutable pre-merge snapshot of fork state"
    - path: "git branch sync/v1.13-upstream"
      provides: "Dedicated sync branch for Phase 8 upstream merge"
  key_links:
    - from: "npx vitest run"
      to: "git tag v1.12.2-pre-sync"
      via: "tests must pass before tag is created"
      pattern: "Tests passed.*tag"
    - from: "git tag v1.12.2-pre-sync"
      to: "git branch sync/v1.13-upstream"
      via: "sync branch starts from the tagged commit"
      pattern: "sync.*v1.13"
---

<objective>
Fix the 4 failing wiring validation tests caused by deleted agent/command files, then create the pre-merge snapshot tag and sync branch that Phase 8 will use for the upstream merge.

Purpose: The pre-merge snapshot is a safety net -- it captures the exact fork state (including Phase 7 strategy docs) before any upstream merge begins. If the merge goes badly, the fork can be reset to this point. The sync branch isolates merge work from main, keeping main stable for any hotfixes.

Output: Passing test suite, annotated tag `v1.12.2-pre-sync`, and sync branch `sync/v1.13-upstream`.
</objective>

<execution_context>
@/Users/rookslog/.claude/get-shit-done/workflows/execute-plan.md
@/Users/rookslog/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-fork-strategy-pre-merge-setup/07-RESEARCH.md
@.planning/phases/07-fork-strategy-pre-merge-setup/07-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix failing wiring validation tests</name>
  <files>tests/integration/wiring-validation.test.js</files>
  <action>
The wiring validation test suite has 4 failures caused by deleted files. Current git status shows these unstaged deletions:

```
 D .claude/agents/gsd-reflector.md
 D .claude/agents/gsd-signal-collector.md
 D .claude/agents/gsd-spike-runner.md
 D .claude/commands/gsd/reflect.md
 D .claude/commands/gsd/spike.md
```

**Investigation steps:**

1. Read the failing tests in `tests/integration/wiring-validation.test.js` to understand what they validate
2. Check git log for these files -- were they moved, renamed, or consolidated?
3. Check if the functionality exists elsewhere (did the agents get merged into other agents?)

**Resolution (choose based on investigation):**

**If files were intentionally removed/consolidated:**
- Update the wiring validation tests to remove references to deleted files
- If agents were merged into other agents, update the test to reference the new locations
- Stage the deletions: `git add .claude/agents/gsd-reflector.md .claude/agents/gsd-signal-collector.md .claude/agents/gsd-spike-runner.md .claude/commands/gsd/reflect.md .claude/commands/gsd/spike.md`
- Commit the test fix and deletions together

**If files were accidentally deleted:**
- Restore them: `git checkout -- .claude/agents/gsd-reflector.md .claude/agents/gsd-signal-collector.md .claude/agents/gsd-spike-runner.md .claude/commands/gsd/reflect.md .claude/commands/gsd/spike.md`
- Verify tests pass after restore

Also check and handle the other unstaged changes visible in git status:
- ` M .claude/agents/gsd-executor.md` (unstaged modification)
- ` M .claude/agents/gsd-phase-researcher.md` (unstaged modification)
- ` M .claude/agents/gsd-planner.md` (unstaged modification)
- `M  .claude/agents/gsd-debugger.md` (staged modification)
- ` M .planning/config.json` (unstaged modification)
- `?? .planning/migration-log.md` (untracked)

These modifications may be intentional updates from previous work. Review them and stage/commit as appropriate. The key constraint: ALL tests must pass after this task.

Run `npx vitest run` to confirm 0 failures after the fix.
  </action>
  <verify>
Run `npx vitest run` -- expect 0 failures. All test files pass. No skipped tests that were previously passing.
  </verify>
  <done>All wiring validation tests pass. Deleted/modified files are either restored or tests updated to match the current codebase state. All changes committed.</done>
</task>

<task type="auto">
  <name>Task 2: Create pre-merge snapshot tag and sync branch</name>
  <files></files>
  <action>
This task creates the immutable snapshot and sync branch. All prerequisite work (strategy docs from 07-01, test fixes from Task 1) must be committed first.

**Steps:**

1. **Verify clean state:**
   - Run `npx vitest run` one final time to confirm all tests pass
   - Run `git status` to confirm no uncommitted changes remain
   - If uncommitted changes exist, commit them first

2. **Create annotated tag on main:**
   ```bash
   git tag -a v1.12.2-pre-sync -m "Pre-upstream-sync snapshot: fork state before v1.13 merge

   Fork version: v1.12.2
   Upstream target: v1.18.0 (70 commits)
   Modified upstream files: 17
   Fork-only files: 166
   All tests passing at time of tag

   Strategy docs: FORK-STRATEGY.md, FORK-DIVERGENCES.md
   Phase: 07-fork-strategy-pre-merge-setup complete"
   ```

3. **Create sync branch from tagged commit:**
   ```bash
   git checkout -b sync/v1.13-upstream
   ```

4. **Return to main:**
   ```bash
   git checkout main
   ```

5. **Push tag and branch to origin:**
   ```bash
   git push origin v1.12.2-pre-sync
   git push -u origin sync/v1.13-upstream
   ```

6. **Verify:**
   - `git tag -l 'v1.12.2-pre-sync'` shows the tag
   - `git branch -a | grep sync` shows the sync branch locally and on remote
   - `git log --oneline -1 v1.12.2-pre-sync` matches current main HEAD
   - `git log --oneline -1 sync/v1.13-upstream` matches the same commit
  </action>
  <verify>
`git tag -l 'v1.12.2-pre-sync'` returns the tag name. `git branch | grep sync` shows sync/v1.13-upstream. `git log --oneline -1 v1.12.2-pre-sync` and `git log --oneline -1 sync/v1.13-upstream` show the same commit hash. `git show v1.12.2-pre-sync` shows the annotated tag message.
  </verify>
  <done>Annotated tag v1.12.2-pre-sync exists on main. Sync branch sync/v1.13-upstream exists and is pushed to origin. Both point to the same commit. The fork state is immutably captured before any upstream merge begins.</done>
</task>

</tasks>

<verification>
1. `npx vitest run` -- all tests pass, 0 failures
2. `git tag -l 'v1.12.2-pre-sync'` -- tag exists
3. `git branch -a | grep sync` -- sync branch exists locally and on remote
4. `git log --oneline -1 v1.12.2-pre-sync` == `git log --oneline -1 sync/v1.13-upstream` -- same commit
5. `git status` -- clean working tree on main
</verification>

<success_criteria>
- All vitest tests pass with 0 failures
- Annotated tag v1.12.2-pre-sync exists on main with descriptive message
- Sync branch sync/v1.13-upstream exists branched from the tagged commit
- Both tag and branch are pushed to origin
- Working tree is clean on main branch
</success_criteria>

<output>
After completion, create `.planning/phases/07-fork-strategy-pre-merge-setup/07-02-SUMMARY.md`
</output>
