---
phase: 06-production-readiness
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - get-shit-done/references/version-migration.md
  - get-shit-done/templates/config.json
  - hooks/gsd-version-check.js
  - commands/gsd/upgrade-project.md
autonomous: true

must_haves:
  truths:
    - "Projects initialized under older versions can catch up to new features via auto-detect or explicit /gsd:upgrade-project"
    - "Version check hook detects mismatch between installed version and project version on session start"
    - "Migration is additive: new config fields with defaults, new directories, updated templates -- never removes"
    - "Migration prompts for new feature preferences (mini-onboarding) when new configurable features are introduced"
    - "Config template includes gsd_reflect_version, health_check, and devops sections for new projects"
  artifacts:
    - path: "get-shit-done/references/version-migration.md"
      provides: "Migration specification, version comparison logic, migration log format"
      contains: "Migration"
      min_lines: 80
    - path: "hooks/gsd-version-check.js"
      provides: "SessionStart hook for auto-detect migration"
      contains: "gsd_reflect_version"
      min_lines: 20
    - path: "commands/gsd/upgrade-project.md"
      provides: "Explicit version migration command"
      contains: "gsd:upgrade-project"
      min_lines: 15
    - path: "get-shit-done/templates/config.json"
      provides: "Updated config template with new fields"
      contains: "gsd_reflect_version"
  key_links:
    - from: "hooks/gsd-version-check.js"
      to: "~/.claude/cache/gsd-version-check.json"
      via: "cache file write with version comparison result"
      pattern: "gsd-version-check"
    - from: "commands/gsd/upgrade-project.md"
      to: "get-shit-done/references/version-migration.md"
      via: "execution_context reference for migration rules"
      pattern: "version-migration\\.md"
    - from: "get-shit-done/references/version-migration.md"
      to: ".planning/config.json"
      via: "config patching target for additive migrations"
      pattern: "config\\.json"
---

<objective>
Create the version migration system: reference specification, config template updates, version check hook, and upgrade-project command.

Purpose: Projects initialized under older GSD Reflect versions need to catch up to new features without re-initialization. The two-mechanism approach (auto-detect hook + explicit command) ensures every project gets migrated -- auto-detect catches projects on first access, while /gsd:upgrade-project provides an explicit escape hatch.

Output: One reference specification, one updated config template, one new SessionStart hook, and one new command.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-production-readiness/06-CONTEXT.md
@.planning/phases/06-production-readiness/06-RESEARCH.md
@hooks/gsd-check-update.js
@get-shit-done/templates/config.json
@get-shit-done/references/planning-config.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create version-migration reference and update config template</name>
  <files>get-shit-done/references/version-migration.md, get-shit-done/templates/config.json</files>
  <action>
**Create `get-shit-done/references/version-migration.md`** -- the authoritative specification for version migration behavior.

Structure the document with these sections:

**Section 1: Overview**
- Purpose: enable projects to catch up to new GSD Reflect features without re-initialization
- Two mechanisms: auto-detect on session start (primary) + explicit `/gsd:upgrade-project` (secondary)
- Core principle: migrations are ALWAYS additive (add fields with defaults, never remove or change existing values)
- Fork constraint compliance: new hook file, additive config changes only

**Section 2: Version Detection**
- Installed version: read from `~/.claude/get-shit-done/VERSION` (or `.claude/get-shit-done/VERSION` for local installs)
- Project version: read from `.planning/config.json` field `gsd_reflect_version`
- If `gsd_reflect_version` absent: project is "pre-tracking" (treat as 0.0.0)
- Comparison: simple string split on dots, numeric comparison of major.minor.patch
- Include the shell script pattern from research for version comparison

**Section 3: Migration Rules**
- Additive only: new config fields with defaults, new directories if needed, template updates
- No removal: existing fields, values, and directories are never modified or deleted
- Default values: every new field has a sensible default that preserves existing behavior
- Specific migration actions for current version:
  - Add `gsd_reflect_version` field (set to installed version)
  - Add `health_check` section: `{ "frequency": "milestone-only", "stale_threshold_days": 7, "blocking_checks": false }`
  - Add `devops` section: `{ "ci_provider": "none", "deploy_target": "none", "commit_convention": "freeform", "environments": [] }`
- Future migrations: same pattern, add missing fields with defaults

**Section 4: Mini-Onboarding**
- When migration introduces new configurable features, prompt user for preferences
- YOLO mode: apply defaults silently, log what was added
- Interactive mode: use AskUserQuestion for each new feature section
- Current onboarding questions:
  - Health check frequency: "milestone-only" (default), "on-resume", "every-phase", "explicit-only"
  - Health check blocking: true/false (default: false)
  - DevOps context: skip for now or configure basic settings
- Keep questions minimal (2-3 max per migration)

**Section 5: Migration Log**
- Location: `.planning/migration-log.md`
- Format: append-only markdown with version transitions
- Each entry records: source version, target version, timestamp, changes applied, user choices
- Include the migration log format example from research

**Section 6: Auto-Detect Mechanism**
- SessionStart hook (`hooks/gsd-version-check.js`) runs on every session start
- Hook reads VERSION file and `.planning/config.json` `gsd_reflect_version`
- Hook writes comparison result to `~/.claude/cache/gsd-version-check.json`
- Cache format: `{ "project_needs_migration": true/false, "installed": "X.Y.Z", "project": "X.Y.Z", "checked": timestamp }`
- The actual migration is triggered by `/gsd:upgrade-project` or `/gsd:health-check` reading the cache
- Hook does NOT perform migration -- it only detects and caches

**Section 7: Error Handling**
- Missing .planning/config.json: not a migration issue (project not initialized)
- Missing VERSION file: skip migration check (can't determine installed version)
- JSON parse failure on config.json: report as health check issue, skip migration
- Failed migration: log failure, continue with partial migration, report what succeeded/failed
- Blocking behavior: critical failures block (missing config.json), minor warnings don't block

**Update `get-shit-done/templates/config.json`** (ADDITIVE):

Add these new fields to the config template while preserving ALL existing fields exactly as they are. The template is what new projects start with, so it should include all fields:

```json
{
  ...existing fields unchanged...,
  "gsd_reflect_version": "1.12.0",
  "health_check": {
    "frequency": "milestone-only",
    "stale_threshold_days": 7,
    "blocking_checks": false
  },
  "devops": {
    "ci_provider": "none",
    "deploy_target": "none",
    "commit_convention": "freeform",
    "environments": []
  }
}
```

Read the current template first, then add the new fields at the end of the JSON object (before the closing `}`). Do NOT modify any existing fields or their values.
  </action>
  <verify>
```bash
test -f get-shit-done/references/version-migration.md && echo "EXISTS" || echo "MISSING"
grep -c "## " get-shit-done/references/version-migration.md  # Should show 7+ section headers
grep "gsd_reflect_version" get-shit-done/references/version-migration.md | head -1  # Version field documented
grep "additive" get-shit-done/references/version-migration.md | head -1  # Additive principle present
grep "migration-log" get-shit-done/references/version-migration.md | head -1  # Migration log documented
grep "Mini-Onboarding\|mini-onboarding" get-shit-done/references/version-migration.md | head -1  # Mini-onboarding present

# Config template validation
node -e "const c = JSON.parse(require('fs').readFileSync('get-shit-done/templates/config.json','utf8')); console.log('version:', c.gsd_reflect_version); console.log('health_check:', JSON.stringify(c.health_check)); console.log('devops:', JSON.stringify(c.devops)); console.log('mode:', c.mode);"
```
  </verify>
  <done>
version-migration.md exists in get-shit-done/references/ with all 7 sections covering: overview, version detection, migration rules, mini-onboarding, migration log, auto-detect mechanism, and error handling. Config template includes gsd_reflect_version, health_check, and devops sections while preserving all existing fields unchanged.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create version check hook and upgrade-project command</name>
  <files>hooks/gsd-version-check.js, commands/gsd/upgrade-project.md</files>
  <action>
**Create `hooks/gsd-version-check.js`** -- SessionStart hook for auto-detect migration.

Follow the EXACT pattern from `hooks/gsd-check-update.js`:
- Same structure: main script spawns a background child process
- Same caching: write result to `~/.claude/cache/` directory
- Same non-blocking: `child.unref()`, stdio ignored

The hook should:
1. Read installed version from VERSION file (check project `.claude/get-shit-done/VERSION` first, then global `~/.claude/get-shit-done/VERSION`)
2. Read project version from `.planning/config.json` field `gsd_reflect_version`
3. Compare versions (simple string split + numeric comparison)
4. Write result to `~/.claude/cache/gsd-version-check.json`:
   ```json
   {
     "project_needs_migration": true|false,
     "installed": "X.Y.Z",
     "project": "X.Y.Z",
     "project_config": "/absolute/path/to/.planning/config.json",
     "checked": unix_timestamp
   }
   ```

Key constraints:
- Local file reads ONLY -- no npm registry calls (that's /gsd:update's job)
- Sub-millisecond execution target
- If `.planning/config.json` doesn't exist, set `project_needs_migration: false` (not a migration issue)
- If `gsd_reflect_version` field is absent, set `project: "0.0.0"` and `project_needs_migration: true`
- Background spawn pattern: `spawn(process.execPath, ['-e', '...'])` with `stdio: 'ignore'`

The hook source file lives at `hooks/gsd-version-check.js`. It will need to be added to the esbuild config for the build step (note this for the executor -- check `scripts/build-hooks.js` for the pattern).

**Create `commands/gsd/upgrade-project.md`** -- explicit version migration command.

Follow the thin routing pattern from `commands/gsd/collect-signals.md`:

```yaml
---
name: gsd:upgrade-project
description: Migrate project to current GSD Reflect version with mini-onboarding for new features
argument-hint: "[--auto]"
allowed-tools:
  - Read
  - Write
  - Bash
  - Glob
  - Grep
  - AskUserQuestion
---
```

The command should:
1. Read version-migration reference for migration rules
2. Read `.planning/config.json` to get current project version
3. Read installed VERSION file to get target version
4. If versions match: report "Project is up to date" and exit
5. If project version is behind:
   - Display migration banner: "Project Migration: {old} -> {new}"
   - List new features available
   - Apply additive config patches (new fields with defaults)
   - If interactive mode: run mini-onboarding questions for new configurable features
   - If YOLO mode or `--auto` flag: apply defaults silently
   - Update `gsd_reflect_version` in config.json to installed version
   - Append migration entry to `.planning/migration-log.md`
   - Report what changed
6. If installed version is behind project: report "Installed version is older than project version. Run /gsd:update to get latest."

The command does NOT spawn subagents -- it executes migration logic directly (mechanical config patching + optional questions).

Include the execution_context reference to `get-shit-done/references/version-migration.md` so the agent has the full migration specification.
  </action>
  <verify>
```bash
test -f hooks/gsd-version-check.js && echo "EXISTS" || echo "MISSING"
test -f commands/gsd/upgrade-project.md && echo "EXISTS" || echo "MISSING"
grep "gsd-version-check" hooks/gsd-version-check.js | head -1  # Cache file reference
grep "gsd_reflect_version" hooks/gsd-version-check.js | head -1  # Version field read
grep "child.unref" hooks/gsd-version-check.js | head -1  # Background pattern
grep "gsd:upgrade-project" commands/gsd/upgrade-project.md | head -1  # Command name
grep "version-migration.md" commands/gsd/upgrade-project.md | head -1  # Reference loaded
grep "migration-log" commands/gsd/upgrade-project.md | head -1  # Migration log mentioned
```
  </verify>
  <done>
gsd-version-check.js hook exists following the gsd-check-update.js pattern (background spawn, cache write, non-blocking). It compares installed VERSION vs project gsd_reflect_version and writes result to cache. upgrade-project.md command exists as a direct-execution command (no subagent) that reads the migration reference, patches config.json additively, runs mini-onboarding for new features in interactive mode, and logs migrations. The hook needs to be added to the esbuild config in scripts/build-hooks.js.
  </done>
</task>

</tasks>

<verification>
1. `get-shit-done/references/version-migration.md` exists with 80+ lines covering all migration behavior
2. `get-shit-done/templates/config.json` is valid JSON and includes `gsd_reflect_version`, `health_check`, and `devops` fields while preserving all existing fields
3. `hooks/gsd-version-check.js` exists following the background-spawn pattern from `gsd-check-update.js`
4. `commands/gsd/upgrade-project.md` exists with proper frontmatter and migration logic
5. Hook reads only local files (no npm calls)
6. Migration rules are additive only (no removal, no modification of existing values)
7. Mini-onboarding is conditional on interactive mode
8. Migration log format is defined and used
</verification>

<success_criteria>
- Version detection works: installed VERSION vs project gsd_reflect_version comparison
- Migration is additive: new fields added with defaults, nothing removed
- Auto-detect hook follows gsd-check-update.js pattern exactly (background, non-blocking, cache write)
- Explicit command provides full migration with mini-onboarding
- Config template is ready for new projects with all Phase 6 fields
</success_criteria>

<output>
After completion, create `.planning/phases/06-production-readiness/06-02-SUMMARY.md`
</output>
