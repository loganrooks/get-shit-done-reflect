---
phase: 06-production-readiness
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - get-shit-done/references/devops-detection.md
  - commands/gsd/new-project.md
  - get-shit-done/templates/codebase/concerns.md
autonomous: true

must_haves:
  truths:
    - "/gsd:new-project captures DevOps context (branching strategy, CI/CD, deployment targets) during initialization"
    - "DevOps questions adapt based on project signals -- production apps get more, personal tools get fewer"
    - "Codebase mapping surfaces DevOps gaps and feeds findings into health check or roadmap suggestions"
    - "DevOps init detects existing configuration and asks about gaps, not about obvious things already detected"
    - "Greenfield projects with no DevOps signals skip the DevOps round entirely"
  artifacts:
    - path: "get-shit-done/references/devops-detection.md"
      provides: "DevOps file patterns, adaptive question rules, gap detection"
      contains: "DevOps"
      min_lines: 80
    - path: "commands/gsd/new-project.md"
      provides: "Additive Phase 5.7 DevOps questions round"
      contains: "Phase 5.7"
    - path: "get-shit-done/templates/codebase/concerns.md"
      provides: "DevOps Gaps section for codebase mapper"
      contains: "DevOps Gaps"
  key_links:
    - from: "commands/gsd/new-project.md"
      to: "get-shit-done/references/devops-detection.md"
      via: "execution_context reference for detection patterns"
      pattern: "devops-detection\\.md"
    - from: "get-shit-done/references/devops-detection.md"
      to: ".planning/config.json"
      via: "devops config section storage target"
      pattern: "config\\.json"
    - from: "get-shit-done/templates/codebase/concerns.md"
      to: "get-shit-done/references/devops-detection.md"
      via: "DevOps gap detection patterns reference"
      pattern: "DevOps"
---

<objective>
Create the DevOps initialization system: detection reference specification, additive DevOps questions round in new-project.md, and DevOps Gaps section in the codebase concerns template.

Purpose: Projects benefit from captured DevOps context (CI/CD, deployment, branching) that feeds into research (stack-compatible solutions) and planning (CI-aware task generation). Currently, initialization skips DevOps entirely. This plan adds adaptive DevOps questioning that detects what exists and asks about gaps.

Output: One new reference specification, one additive section to new-project.md, and one additive section to the concerns template.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-production-readiness/06-CONTEXT.md
@.planning/phases/06-production-readiness/06-RESEARCH.md
@commands/gsd/new-project.md
@get-shit-done/templates/codebase/concerns.md
@get-shit-done/workflows/map-codebase.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create devops-detection reference specification</name>
  <files>get-shit-done/references/devops-detection.md</files>
  <action>
Create `get-shit-done/references/devops-detection.md` -- the reference defining DevOps detection patterns, adaptive question rules, and gap analysis behavior.

Structure the document with these sections:

**Section 1: Overview**
- Purpose: detect existing DevOps configuration, ask adaptive questions about gaps, store context in config.json
- Scope: CI/CD, deployment targets, commit conventions, environments, git hygiene
- Principle: detect first, ask about gaps only; maximum 3-5 questions; skip for greenfield with no signals
- Storage: config.json `devops` section (machine-readable for agent consumption)

**Section 2: Detection Patterns**

Define file-based detection patterns for each DevOps concern:

**CI/CD Detection:**
| Pattern | Provider |
|---------|----------|
| `.github/workflows/` directory | GitHub Actions |
| `.gitlab-ci.yml` | GitLab CI |
| `.circleci/config.yml` | CircleCI |
| `Jenkinsfile` | Jenkins |
| `bitbucket-pipelines.yml` | Bitbucket Pipelines |
| `.travis.yml` | Travis CI |

**Deployment Target Detection:**
| Pattern | Target |
|---------|--------|
| `vercel.json` or `.vercel/` | Vercel |
| `Dockerfile` or `docker-compose.yml` | Docker/Container |
| `fly.toml` | Fly.io |
| `railway.json` or `railway.toml` | Railway |
| `netlify.toml` | Netlify |
| `serverless.yml` | Serverless Framework |
| `cdk.json` or `template.yaml` (SAM) | AWS |
| `app.yaml` (GCP) | Google Cloud |

**Commit Convention Detection:**
- Check last 20 git commits for conventional commit pattern: `(feat|fix|chore|docs|style|refactor|test|ci|build|perf)(`
- If >50% match: "conventional-commits"
- Otherwise: "freeform"
- Include the shell pattern from research

**Git Hygiene Detection:**
- `.gitignore` exists: yes/no
- `.gitattributes` exists: yes/no
- Branch count: `git branch | wc -l`
- Protected branches: detect from `.github/` settings or repo config

**Environment Detection:**
- `.env.example` or `.env.template` exists: has environment template
- Multiple `.env.*` files: has environment differentiation
- `docker-compose.*.yml` variants: has Docker environment profiles

Include the shell script patterns from research for each detection category.

**Section 3: Adaptive Question Rules**

Define when and what to ask:

**Skip condition:** Greenfield project (no existing code detected, no CI files, no deploy config) AND user didn't mention deployment/CI during questioning → skip DevOps round entirely.

**Question selection logic:**
1. Run all detection patterns
2. For each DETECTED item: record in config, do NOT ask (already known)
3. For each GAP: add to question candidates
4. Select top 3-5 questions from candidates based on project type:
   - Production app (has deploy config OR user mentioned "production/deploy/release"): ask about CI, environments, deployment strategy
   - Library/package (has package.json with no deploy): ask about CI, publish target, versioning
   - Personal/experiment (no signals): skip or ask 1-2 max

**Question templates:**

| Gap | Question | Options |
|-----|----------|---------|
| No CI detected | "No CI/CD detected. Do you use one?" | GitHub Actions / GitLab CI / Other / None for now |
| No deploy target | "Where does this deploy?" | Vercel / Docker / AWS / Other / Not yet |
| Freeform commits | "Your repo uses freeform commits. Adopt conventional commits?" | Yes, adopt / Keep freeform |
| No .gitignore | "No .gitignore detected. Add standard ignores?" | Yes / No |
| No environments | "Do you have staging/production environments?" | Yes, describe / No / Not yet |

**Section 4: Gap Analysis for Codebase Mapper**

Define DevOps gaps that the codebase mapper's concerns explorer should detect:

- No CI/CD configuration in a project with tests → "Tests exist but no CI to run them"
- No .gitignore → "No .gitignore file (risk of committing secrets/artifacts)"
- No .env.example with environment variables referenced in code → "Environment variables used but no .env.example template"
- No README with deploy instructions → "No deployment documentation"
- Docker without .dockerignore → "Dockerfile exists but no .dockerignore"

These gaps appear in the CONCERNS.md "DevOps Gaps" section and feed into health check findings.

**Section 5: Config Storage**

Define the config.json `devops` section structure:
```json
{
  "devops": {
    "ci_provider": "github-actions|gitlab-ci|circleci|jenkins|none",
    "deploy_target": "vercel|docker|fly-io|railway|netlify|aws|gcp|none",
    "commit_convention": "conventional|freeform",
    "environments": ["development", "staging", "production"],
    "detected": {
      "ci_files": [".github/workflows/ci.yml"],
      "deploy_files": ["Dockerfile"],
      "gitignore": true,
      "env_template": false
    }
  }
}
```

The `detected` sub-section stores raw detection results for reference. The top-level fields store the resolved values (from detection + user input).

**Section 6: Downstream Consumers**

Document how DevOps context is consumed:
- **Researcher**: reads `devops.ci_provider` and `devops.deploy_target` to suggest stack-compatible solutions
- **Planner**: reads `devops.ci_provider` to include CI-aware tasks (e.g., "update CI config for new dependency")
- **Health check**: checks for DevOps gaps as part of full check tier
- **Codebase mapper**: includes DevOps gaps in CONCERNS.md
  </action>
  <verify>
```bash
test -f get-shit-done/references/devops-detection.md && echo "EXISTS" || echo "MISSING"
grep -c "## " get-shit-done/references/devops-detection.md  # Should show 6+ section headers
grep "github-actions\|GitHub Actions" get-shit-done/references/devops-detection.md | head -1  # CI patterns
grep "Dockerfile\|Docker" get-shit-done/references/devops-detection.md | head -1  # Deploy patterns
grep "conventional" get-shit-done/references/devops-detection.md | head -1  # Commit convention
grep "adaptive\|Adaptive" get-shit-done/references/devops-detection.md | head -1  # Adaptive rules
grep "config\\.json" get-shit-done/references/devops-detection.md | head -1  # Config storage
```
  </verify>
  <done>
devops-detection.md exists in get-shit-done/references/ with all 6 sections covering: overview, detection patterns (CI/CD, deployment, commits, git hygiene, environments), adaptive question rules (skip conditions, question selection, templates), gap analysis for codebase mapper, config storage format, and downstream consumers. Shell script patterns from research are included for each detection category.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add DevOps round to new-project.md and DevOps Gaps to concerns template</name>
  <files>commands/gsd/new-project.md, get-shit-done/templates/codebase/concerns.md</files>
  <action>
**Update `commands/gsd/new-project.md`** (ADDITIVE ONLY):

Add a new "Phase 5.7: DevOps Context" section BETWEEN the existing Phase 5.5 (Resolve Model Profile) and Phase 6 (Research Decision). This is a conditional phase that only runs for brownfield projects or when DevOps signals were detected.

CRITICAL: Do NOT modify any existing content. Read the file first and add the new section in the correct position. The new section should be inserted after "## Phase 5.5: Resolve Model Profile" and before "## Phase 6: Research Decision".

Also add `@~/.claude/get-shit-done/references/devops-detection.md` to the `<execution_context>` section (add a new line, don't replace existing references).

New section content:

```markdown
## Phase 5.7: DevOps Context (Conditional)

**Skip condition:** If greenfield (no existing code detected in Phase 1 setup) AND user didn't mention deployment, CI, or production during Phase 3 questioning → skip to Phase 6.

**If brownfield project OR DevOps signals detected:**

Display stage banner:
```
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
 GSD ► DEVOPS CONTEXT
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
```

**Step 1: Auto-detect existing DevOps configuration:**

Run detection patterns from `devops-detection.md`:
```bash
# CI/CD detection
DEVOPS_CI="none"
[ -d ".github/workflows" ] && DEVOPS_CI="github-actions"
[ -f ".gitlab-ci.yml" ] && DEVOPS_CI="gitlab-ci"
[ -f ".circleci/config.yml" ] && DEVOPS_CI="circleci"
[ -f "Jenkinsfile" ] && DEVOPS_CI="jenkins"

# Deployment detection
DEVOPS_DEPLOY="none"
[ -f "vercel.json" ] || [ -d ".vercel" ] && DEVOPS_DEPLOY="vercel"
[ -f "Dockerfile" ] && DEVOPS_DEPLOY="docker"
[ -f "fly.toml" ] && DEVOPS_DEPLOY="fly-io"
[ -f "netlify.toml" ] && DEVOPS_DEPLOY="netlify"

# Commit convention detection
CONVENTIONAL=$(git log --oneline -20 2>/dev/null | grep -cE "^[a-f0-9]+ (feat|fix|chore|docs|style|refactor|test|ci|build|perf)\(" || echo "0")
TOTAL=$(git log --oneline -20 2>/dev/null | wc -l | tr -d ' ')
DEVOPS_COMMITS="freeform"
if [ "$TOTAL" -gt "0" ] && [ "$CONVENTIONAL" -gt "$((TOTAL / 2))" ]; then
  DEVOPS_COMMITS="conventional"
fi

# Git hygiene
HAS_GITIGNORE=$([ -f ".gitignore" ] && echo "true" || echo "false")
HAS_ENV_TEMPLATE=$([ -f ".env.example" ] || [ -f ".env.template" ] && echo "true" || echo "false")
```

**Step 2: Report detections and ask about gaps:**

Display what was detected:
```
Found:
- CI/CD: {detected or "none detected"}
- Deployment: {detected or "none detected"}
- Commits: {conventional or freeform}
```

For each gap (where detection returned "none" or missing hygiene files), ask up to 3-5 adaptive questions using AskUserQuestion. Follow the question templates in devops-detection.md. Skip questions for items already detected.

**Step 3: Store DevOps context in config.json:**

Add the `devops` section to the project's `.planning/config.json` with detected values and user responses. The devops section structure is defined in devops-detection.md.

**If no gaps found:** Report "DevOps context captured from existing configuration" and continue without questions.
```

**Update `get-shit-done/templates/codebase/concerns.md`** (ADDITIVE ONLY):

Add a new "## DevOps Gaps" section at the END of the file template (after "## Test Coverage Gaps" and before the closing `---` line). This section is populated by the codebase mapper's concerns explorer when it detects DevOps gaps.

CRITICAL: Do NOT modify any existing content. Read the file first and add the new section before the closing `---` marker in the template.

New section to add to the template:

```markdown
## DevOps Gaps

**[Gap description]:**
- Problem: [What's missing or misconfigured]
- Risk: [What could go wrong without it]
- Detection: [How it was identified]
- Recommendation: [Suggested fix]

**[Gap description]:**
- Problem: [What's missing or misconfigured]
- Risk: [What could go wrong without it]
- Detection: [How it was identified]
- Recommendation: [Suggested fix]
```

Also add a DevOps Gaps example to the `<good_examples>` section showing concrete examples:

```markdown
## DevOps Gaps

**No CI/CD for test suite:**
- Problem: 47 test files exist but no CI pipeline to run them
- Risk: Tests rot silently, regressions go undetected in PRs
- Detection: Found `tests/` directory with 47 files, no `.github/workflows/` or equivalent
- Recommendation: Add GitHub Actions workflow with `npm test` on PR/push

**Missing .gitignore entries:**
- Problem: `node_modules/` and `.env` not in .gitignore
- Risk: Secrets committed to repository, bloated git history
- Detection: .gitignore exists but missing standard entries for Node.js project
- Recommendation: Add Node.js standard entries to .gitignore
```

Add "DevOps Gaps" to the `<guidelines>` "What belongs in CONCERNS.md" list.
  </action>
  <verify>
```bash
# new-project.md has DevOps phase
grep "Phase 5.7" commands/gsd/new-project.md | head -1
grep "DevOps Context" commands/gsd/new-project.md | head -1
grep "devops-detection.md" commands/gsd/new-project.md | head -1

# concerns.md has DevOps Gaps
grep "DevOps Gaps" get-shit-done/templates/codebase/concerns.md | head -2

# Verify existing content not damaged
grep "Phase 6: Research Decision" commands/gsd/new-project.md | head -1  # Still exists
grep "Tech Debt" get-shit-done/templates/codebase/concerns.md | head -1  # Still exists
grep "Test Coverage Gaps" get-shit-done/templates/codebase/concerns.md | head -1  # Still exists
```
  </verify>
  <done>
new-project.md has a new Phase 5.7: DevOps Context section inserted between Phase 5.5 and Phase 6, with auto-detection, adaptive questioning, and config storage. The section is conditional (skips for greenfield with no DevOps signals). devops-detection.md is referenced in execution_context. concerns.md template has a new DevOps Gaps section at the end with template and good examples. All existing content in both files is preserved unchanged.
  </done>
</task>

</tasks>

<verification>
1. `get-shit-done/references/devops-detection.md` exists with 80+ lines covering detection patterns and adaptive rules
2. `commands/gsd/new-project.md` has Phase 5.7 DevOps Context section between Phase 5.5 and Phase 6
3. `commands/gsd/new-project.md` references `devops-detection.md` in execution_context
4. `get-shit-done/templates/codebase/concerns.md` has DevOps Gaps section
5. All existing content in modified files is preserved unchanged (fork constraint compliance)
6. DevOps questions are adaptive (3-5 max, skip for greenfield)
7. Config storage uses the `devops` section structure defined in reference
</verification>

<success_criteria>
- DevOps detection runs during /gsd:new-project for brownfield projects
- Adaptive questions ask about gaps only, not about detected items
- Maximum 3-5 DevOps questions, greenfield skips entirely
- Codebase mapper's concerns template includes DevOps Gaps
- All changes are additive to existing files (fork constraint)
</success_criteria>

<output>
After completion, create `.planning/phases/06-production-readiness/06-03-SUMMARY.md`
</output>
