---
phase: 06-production-readiness
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - get-shit-done/references/health-check.md
  - get-shit-done/workflows/health-check.md
  - commands/gsd/health-check.md
autonomous: true

must_haves:
  truths:
    - "Running /gsd:health-check validates KB integrity, config validity, and stale artifacts and reports categorized findings"
    - "Health check supports tiered execution: default (quick), full, and focused modes"
    - "Stale artifacts (orphaned .continue-here files, abandoned debug sessions, incomplete spikes) are detected and flagged"
    - "Health check findings can be persisted as signals for reflection"
    - "Repair behavior respects autonomy settings (YOLO auto-repairs, interactive asks)"
  artifacts:
    - path: "get-shit-done/references/health-check.md"
      provides: "Check definitions, thresholds, output format, repair rules"
      contains: "KB Integrity"
      min_lines: 100
    - path: "get-shit-done/workflows/health-check.md"
      provides: "Health check orchestration logic"
      contains: "health-check"
      min_lines: 50
    - path: "commands/gsd/health-check.md"
      provides: "Thin routing command entry point"
      contains: "gsd:health-check"
      min_lines: 15
  key_links:
    - from: "commands/gsd/health-check.md"
      to: "get-shit-done/workflows/health-check.md"
      via: "execution_context reference"
      pattern: "workflows/health-check\\.md"
    - from: "get-shit-done/workflows/health-check.md"
      to: "get-shit-done/references/health-check.md"
      via: "reference loading for check definitions"
      pattern: "references/health-check\\.md"
    - from: "get-shit-done/references/health-check.md"
      to: "~/.claude/gsd-knowledge/"
      via: "KB integrity check paths"
      pattern: "gsd-knowledge"
---

<objective>
Create the health check command, workflow, and reference specification for workspace validation.

Purpose: The health check is the primary workspace maintenance tool -- it validates KB integrity, config validity, and detects stale artifacts. It reports categorized findings and optionally repairs issues. This is the first tool users reach for when something seems wrong with their workspace.

Output: Three new files -- a reference specification defining all checks and thresholds, a workflow for orchestration, and a thin routing command.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-production-readiness/06-CONTEXT.md
@.planning/phases/06-production-readiness/06-RESEARCH.md
@get-shit-done/references/signal-detection.md
@.claude/agents/knowledge-store.md
@commands/gsd/collect-signals.md
@get-shit-done/workflows/collect-signals.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create health-check reference specification</name>
  <files>get-shit-done/references/health-check.md</files>
  <action>
Create `get-shit-done/references/health-check.md` -- the authoritative reference defining all health check behavior. This is consumed by the health-check workflow via @ syntax.

Structure the document with these sections:

**Section 1: Overview**
- Purpose: validate workspace state and report actionable findings
- Modes: default (quick), full (`--full`), focused (`--focus kb`, `--focus planning`)
- Repair: `--fix` flag triggers repairs (auto in YOLO, prompt in interactive)
- Staleness: `--stale-days N` overrides configured threshold

**Section 2: Check Categories**

Define three check categories for default (quick) tier:

**KB Integrity checks:**
- Index file exists at `~/.claude/gsd-knowledge/index.md`
- Index is parseable (has Signals, Spikes, Lessons table headers)
- Signal count: index entries vs filesystem files (non-archived)
- Spike count: index entries vs filesystem files (non-archived)
- Lesson count: index entries vs filesystem files (non-archived)
- No frontmatter parse errors in sampled entries (check 5 random files)
- Shell patterns from research: use `grep -c "^| sig-"` for index counting, `find` + status check for filesystem counting

**Config Validity checks:**
- `.planning/config.json` exists
- JSON is parseable (`node -e "JSON.parse(...)"`)
- Required fields present: `mode`, `depth`
- Known field values valid: mode is `yolo|interactive`, depth is `quick|standard|comprehensive`
- `gsd_reflect_version` field exists (if not, flag as "pre-version-tracking project")
- `health_check` section exists (if not, suggest `--fix` to add defaults)

**Stale Artifact checks:**
- Orphaned `.continue-here.md` files older than threshold (default 7 days, configurable via `stale_threshold_days` in config or `--stale-days` flag)
- Abandoned debug sessions: files in `.planning/debug/` without `status:.*resolved` marker, older than threshold
- Incomplete spikes: directories in `.planning/spikes/` with `DESIGN.md` but no `DECISION.md`

Define two additional check categories for full tier (`--full`):

**Planning Consistency checks:**
- Every phase in ROADMAP.md has a corresponding directory in `.planning/phases/`
- Every PLAN.md has a matching SUMMARY.md (for completed phases)
- STATE.md exists and has current position

**Config Drift checks:**
- Config template fields vs project config fields (detect missing new fields)
- Version compatibility: `gsd_reflect_version` in config vs installed VERSION file

**Section 3: Focused Modes**
- `--focus kb`: Run only KB Integrity checks
- `--focus planning`: Run only Planning Consistency checks (implies --full scope for that category)

**Section 4: Output Format**
Use the hybrid categorized checklist format from research:
```
## Workspace Health Report
**Project:** {name} | **Version:** {version} | **Date:** {date}

### {Category} [{PASS|WARNING|FAIL}]
- [x] Check description (detail)
- [ ] Failed check description (remediation hint)

### Summary
**N checks passed** | **M warnings** | **K failures**
```

**Section 5: Repair Rules**
- `--fix` flag enables repair mode
- YOLO mode: auto-repair without prompting
- Interactive mode: ask before each repair using AskUserQuestion
- Repairable issues (with specific repair actions):
  - Missing config fields: add with defaults
  - KB index mismatch: run `kb-rebuild-index.sh`
  - Stale .continue-here files: delete (after confirmation in interactive)
  - Missing `gsd_reflect_version`: set to installed version
- Non-repairable issues (report only):
  - Missing .planning/config.json (user must run /gsd:new-project)
  - Missing KB directory (user must run initialization)
  - Abandoned debug sessions (user decides resolution)

**Section 6: Signal Integration**
- When findings exist, optionally persist a health-check signal to KB
- Signal severity: notable (warnings or failures found), trace (all clean)
- Signal tags: `workspace/health-check`, `workspace/{category}`
- This enables reflection to detect recurring workspace issues

**Section 7: Configuration**
Document the config.json fields this feature uses:
- `health_check.frequency`: "milestone-only" | "on-resume" | "every-phase" | "explicit-only" (default: "milestone-only")
- `health_check.stale_threshold_days`: number (default: 7)
- `health_check.blocking_checks`: boolean (default: false)

Follow the format conventions established by other reference docs (signal-detection.md, reflection-patterns.md). Use markdown headers, tables, and code blocks. Include shell script patterns from the research document for mechanical checks.
  </action>
  <verify>
```bash
test -f get-shit-done/references/health-check.md && echo "EXISTS" || echo "MISSING"
grep -c "## " get-shit-done/references/health-check.md  # Should show 7+ section headers
grep "KB Integrity" get-shit-done/references/health-check.md | head -1  # KB checks present
grep "Stale Artifact" get-shit-done/references/health-check.md | head -1  # Stale checks present
grep "Config Validity" get-shit-done/references/health-check.md | head -1  # Config checks present
grep "\-\-fix" get-shit-done/references/health-check.md | head -1  # Repair rules present
grep "gsd-knowledge" get-shit-done/references/health-check.md | head -1  # KB paths present
grep "stale_threshold_days" get-shit-done/references/health-check.md | head -1  # Config field present
```
  </verify>
  <done>
health-check.md exists in get-shit-done/references/ with all 7 sections covering: overview, check categories (KB integrity, config validity, stale artifacts, planning consistency, config drift), focused modes, output format, repair rules, signal integration, and configuration. Shell script patterns from research are included for mechanical checks. All three tiers (default, full, focused) are defined with specific checks per category.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create health-check workflow and command</name>
  <files>get-shit-done/workflows/health-check.md, commands/gsd/health-check.md</files>
  <action>
**Create `get-shit-done/workflows/health-check.md`** -- orchestration logic for the health check.

Follow the workflow pattern established by `collect-signals.md` workflow. Structure:

1. **Parse arguments**: Extract flags (`--full`, `--focus`, `--fix`, `--stale-days`)
2. **Load configuration**: Read `.planning/config.json` for health_check settings, read autonomy mode for repair behavior
3. **Load reference**: Reference `get-shit-done/references/health-check.md` for check definitions
4. **Determine check scope**: Based on flags, select which check categories to run:
   - No flags: default tier (KB Integrity, Config Validity, Stale Artifacts)
   - `--full`: all categories including Planning Consistency and Config Drift
   - `--focus kb`: KB Integrity only
   - `--focus planning`: Planning Consistency only
5. **Execute checks**: For each category in scope, run the checks defined in the reference. Use Bash tool for shell commands (file existence, JSON parsing, grep counts, find for stale files). Collect results as pass/warning/fail.
6. **Report findings**: Display the hybrid categorized checklist output format from the reference
7. **Repair if --fix**: If repair flag set, iterate repairable issues. In YOLO mode auto-repair. In interactive mode, use AskUserQuestion for each repair.
8. **Signal integration**: If findings include warnings or failures, offer to persist a health-check signal (auto in YOLO, ask in interactive)
9. **Summary**: Display final pass/warning/fail counts with next steps

The workflow should be self-contained (no subagent spawning needed -- the checks are mechanical, not requiring LLM judgment). The orchestrating agent executes all checks directly via Bash/Read/Grep tools.

**Create `commands/gsd/health-check.md`** -- thin routing command.

Follow the exact pattern from `commands/gsd/collect-signals.md`:

```yaml
---
name: gsd:health-check
description: Validate workspace state and report actionable findings
argument-hint: "[--full] [--focus kb|planning] [--fix] [--stale-days N]"
allowed-tools:
  - Read
  - Write
  - Bash
  - Glob
  - Grep
  - AskUserQuestion
---
```

Objective: Validate workspace state (KB integrity, config validity, stale artifacts) and report actionable findings. Optionally repair issues.

Execution context: Reference the workflow and reference files via @ syntax.

Process: Parse arguments, delegate to the health-check workflow. Report completion with finding counts.

Keep the command file thin -- all logic lives in the workflow.
  </action>
  <verify>
```bash
test -f get-shit-done/workflows/health-check.md && echo "EXISTS" || echo "MISSING"
test -f commands/gsd/health-check.md && echo "EXISTS" || echo "MISSING"
grep "gsd:health-check" commands/gsd/health-check.md | head -1  # Command name
grep "workflows/health-check.md" commands/gsd/health-check.md | head -1  # Workflow reference
grep "references/health-check.md" get-shit-done/workflows/health-check.md | head -1  # Reference loaded
grep "\-\-full" commands/gsd/health-check.md | head -1  # Full flag documented
grep "\-\-fix" commands/gsd/health-check.md | head -1  # Fix flag documented
```
  </verify>
  <done>
health-check.md workflow exists with the full orchestration flow (parse args, load config, load reference, determine scope, execute checks, report, repair, signal). health-check.md command exists as a thin routing layer that delegates to the workflow. The command accepts --full, --focus, --fix, and --stale-days flags. The workflow references the health-check reference specification for check definitions.
  </done>
</task>

</tasks>

<verification>
1. `get-shit-done/references/health-check.md` exists with 100+ lines covering all check categories and tiers
2. `get-shit-done/workflows/health-check.md` exists with orchestration logic for all check modes
3. `commands/gsd/health-check.md` exists as thin routing command with proper frontmatter
4. Command references workflow, workflow references reference specification
5. All three tiers (default, full, focused) are defined
6. Stale artifact detection covers .continue-here files, debug sessions, incomplete spikes
7. Repair rules differentiate YOLO vs interactive mode
8. No existing files modified
</verification>

<success_criteria>
- /gsd:health-check command is fully defined and routes to a workflow that executes mechanical checks
- Check definitions cover KB integrity, config validity, stale artifacts (default), plus planning consistency and config drift (full)
- Output format is a categorized checklist with pass/warning/fail status per category
- Repair mode respects YOLO/interactive autonomy settings
- Signal integration allows health findings to feed into reflection
</success_criteria>

<output>
After completion, create `.planning/phases/06-production-readiness/06-01-SUMMARY.md`
</output>
