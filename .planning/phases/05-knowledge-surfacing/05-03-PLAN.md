---
phase: 05-knowledge-surfacing
plan: 03
type: execute
wave: 2
depends_on: ["05-01"]
files_modified:
  - .claude/agents/gsd-debugger.md
  - .claude/agents/gsd-executor.md
autonomous: true

must_haves:
  truths:
    - "The debugger can optionally query KB for lessons and spikes related to the current error"
    - "The executor queries KB ONLY when deviation Rules 1-3 trigger, never during normal execution"
    - "Knowledge surfacing does not modify the executor's existing deviation rules"
  artifacts:
    - path: ".claude/agents/gsd-debugger.md"
      provides: "Optional KB consultation for error-related knowledge"
      contains: "knowledge_surfacing"
    - path: ".claude/agents/gsd-executor.md"
      provides: "Deviation-gated KB consultation"
      contains: "knowledge_surfacing"
  key_links:
    - from: ".claude/agents/gsd-debugger.md"
      to: "get-shit-done/references/knowledge-surfacing.md"
      via: "@ reference in knowledge_surfacing section"
      pattern: "knowledge-surfacing\\.md"
    - from: ".claude/agents/gsd-executor.md"
      to: "get-shit-done/references/knowledge-surfacing.md"
      via: "@ reference in knowledge_surfacing section"
      pattern: "knowledge-surfacing\\.md"
    - from: ".claude/agents/gsd-executor.md"
      to: "deviation Rules 1-3"
      via: "KB query gated on deviation trigger"
      pattern: "Rule [123]"
---

<objective>
Add knowledge surfacing capabilities to the debugger and executor agents via additive XML sections.

Purpose: The debugger gets optional KB querying for error investigation (both lessons and spikes equally). The executor gets strictly deviation-gated KB querying -- only when Rules 1-3 trigger an auto-fix, providing historical context for similar past issues. The executor's existing deviation rules are preserved unchanged.

Output: Two modified agent files with `<knowledge_surfacing>` sections appended.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-knowledge-surfacing/05-CONTEXT.md
@.planning/phases/05-knowledge-surfacing/05-RESEARCH.md
@get-shit-done/references/knowledge-surfacing.md
@.claude/agents/gsd-debugger.md
@.claude/agents/gsd-executor.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add knowledge_surfacing section to gsd-debugger.md</name>
  <files>.claude/agents/gsd-debugger.md</files>
  <action>
Append a `<knowledge_surfacing>` XML section to the END of `.claude/agents/gsd-debugger.md`. This section is additive -- do NOT modify any existing sections in the file.

The debugger's knowledge surfacing is OPTIONAL (like the planner's), but queries both lessons AND spikes equally (unlike the planner which only queries lessons).

The section must include:

**1. Activation check (fork compatibility):**
```markdown
**Activation:** If `get-shit-done/references/knowledge-surfacing.md` exists, apply knowledge surfacing. If not, skip this section.
```

**2. @ reference:**
```markdown
@get-shit-done/references/knowledge-surfacing.md
```

**3. When to query:**
- Optional, at your discretion during debugging
- Most useful when: investigating recurring errors, unfamiliar error patterns, technology-specific issues
- Re-query cue: if your initial debugging approach fails, check KB for alternative approaches

**4. What to query for:**
- Both lessons AND spikes equally (unlike planner which queries lessons only)
- Priority: entries related to the specific error pattern, technology, or failure mode
- Include error keywords in your query context

**5. Query pattern:**
1. Read `~/.claude/gsd-knowledge/index.md`
2. Grep for error-related keywords in both Lessons and Spikes tables
3. Read top 2-3 matching entries
4. Check freshness via `depends_on` if present
5. Apply findings to debugging approach

**6. Token budget:** ~500 tokens (soft cap)

**7. Output:**
- Inline citations when knowledge informs debugging: "A prior lesson [les-xxx] about this error pattern suggests..."
- If KB was consulted and entries applied, note in debugging output

The section should be approximately 40-60 lines. Keep it concise -- the debugger's KB interaction is situational.
  </action>
  <verify>
```bash
# Section exists
grep "knowledge_surfacing" .claude/agents/gsd-debugger.md
# References the specification
grep "knowledge-surfacing.md" .claude/agents/gsd-debugger.md
# Has optional framing
grep -i "optional\|discretion" .claude/agents/gsd-debugger.md | head -2
# Has both types
grep -i "lessons AND spikes\|both.*equally" .claude/agents/gsd-debugger.md | head -1
# Existing sections unchanged
head -10 .claude/agents/gsd-debugger.md | grep "gsd-debugger"
```
  </verify>
  <done>
gsd-debugger.md has a `<knowledge_surfacing>` section appended that includes: fork activation check, @ reference to knowledge-surfacing.md, optional query guidance (when debugging errors), both lessons and spikes equally prioritized, query pattern (index.md -> grep error keywords -> read entries), token budget (~500), and output format (inline citations). No existing sections modified.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add knowledge_surfacing section to gsd-executor.md</name>
  <files>.claude/agents/gsd-executor.md</files>
  <action>
Append a `<knowledge_surfacing>` XML section to the END of `.claude/agents/gsd-executor.md`. This section is additive -- do NOT modify any existing sections in the file. This is CRITICAL: the executor's existing `<deviation_rules>` or equivalent section MUST remain completely unchanged.

The executor's knowledge surfacing is STRICTLY gated on deviation Rules 1-3. It NEVER queries KB during normal execution.

The section must include:

**1. Activation check (fork compatibility):**
```markdown
**Activation:** If `get-shit-done/references/knowledge-surfacing.md` exists, apply knowledge surfacing. If not, skip this section.
```

**2. @ reference:**
```markdown
@get-shit-done/references/knowledge-surfacing.md
```

**3. When to query (STRICT gate):**

ONLY query the knowledge base when you are about to apply a deviation auto-fix under Rule 1 (fix build/lint/test errors that block progress), Rule 2 (add missing critical functionality omitted from the plan), or Rule 3 (fix blocking integration issues).

Do NOT query KB:
- At plan start
- Before each task
- During normal task execution
- When applying Rule 4 (architectural deviation -- checkpoint to user instead)

**4. Query trigger flow:**
1. You encounter an issue requiring auto-fix (Rule 1, 2, or 3)
2. BEFORE applying your fix, check KB for similar past issues:
   ```bash
   grep -i "{error-keyword}" ~/.claude/gsd-knowledge/index.md
   grep -i "{technology}" ~/.claude/gsd-knowledge/index.md
   ```
3. If a matching lesson exists, read it:
   ```bash
   cat ~/.claude/gsd-knowledge/lessons/{path-from-index}.md
   ```
4. Apply knowledge to your fix (may avoid a previously-failed approach)
5. Cite in deviation tracking:
   ```
   [Rule 1 - Bug] Fixed {issue} (informed by [les-xxx])
   ```

**5. What to query for:**
- Lessons related to the specific error pattern
- NOT spikes (spike decisions are already incorporated via PLAN.md from the planner)

**6. Token budget:** ~200 tokens (deviation context only -- much smaller than other agents)

**7. Output:**
- Cite KB entries in deviation tracking when they informed a fix
- Do NOT add a separate Knowledge Applied section (executor output is task-focused)

The section should be approximately 40-50 lines. Be very explicit about the deviation gate -- this is the section most likely to be misapplied if instructions are vague. The opening of the section should clearly state: "This section activates ONLY during deviation handling. Do not query KB during normal execution."
  </action>
  <verify>
```bash
# Section exists
grep "knowledge_surfacing" .claude/agents/gsd-executor.md
# References the specification
grep "knowledge-surfacing.md" .claude/agents/gsd-executor.md
# Has strict deviation gate
grep -i "ONLY.*deviation\|Rule 1.*2.*3\|Do NOT query" .claude/agents/gsd-executor.md | head -3
# Has 200 token budget
grep "200 token" .claude/agents/gsd-executor.md
# Existing sections unchanged -- verify deviation rules intact
grep -c "deviation\|Rule [1234]" .claude/agents/gsd-executor.md  # Should have both old and new references
head -10 .claude/agents/gsd-executor.md | grep "gsd-executor"
```
  </verify>
  <done>
gsd-executor.md has a `<knowledge_surfacing>` section appended that includes: fork activation check, @ reference to knowledge-surfacing.md, STRICT deviation gate (Rules 1-3 only), explicit "do NOT query" list (plan start, each task, normal execution, Rule 4), query trigger flow with grep examples, lessons-only focus, ~200 token budget, and citation in deviation tracking. No existing sections modified -- the executor's existing deviation rules remain completely untouched.
  </done>
</task>

</tasks>

<verification>
1. `.claude/agents/gsd-debugger.md` has `<knowledge_surfacing>` section with optional querying for both lessons and spikes
2. `.claude/agents/gsd-executor.md` has `<knowledge_surfacing>` section strictly gated on deviation Rules 1-3
3. Neither agent file has ANY existing sections modified (only appended)
4. Both sections reference `get-shit-done/references/knowledge-surfacing.md` via @ syntax
5. Both sections include fork activation check
6. Executor section explicitly lists what NOT to do (no KB query at plan start, before tasks, during normal execution, on Rule 4)
7. Executor's existing deviation rules are completely unchanged
8. Debugger queries both types; executor queries lessons only
</verification>

<success_criteria>
- Debugger can optionally query KB when investigating errors (both lessons and spikes)
- Executor ONLY queries KB when Rules 1-3 trigger, with explicit prohibitions on other triggers
- Executor's existing deviation rules are untouched (fork constraint preserved)
- Both agent files have ONLY additive changes (new XML section appended)
- Both sections include the fork detection activation check
- Executor has ~200 token budget (smaller than other agents)
</success_criteria>

<output>
After completion, create `.planning/phases/05-knowledge-surfacing/05-03-SUMMARY.md`
</output>
