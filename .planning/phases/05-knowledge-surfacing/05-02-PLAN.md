---
phase: 05-knowledge-surfacing
plan: 02
type: execute
wave: 2
depends_on: ["05-01"]
files_modified:
  - .claude/agents/gsd-phase-researcher.md
  - .claude/agents/gsd-planner.md
autonomous: true

must_haves:
  truths:
    - "During research phases, the phase researcher automatically queries the knowledge base before external investigation"
    - "Spike deduplication happens as part of the researcher's mandatory initial KB query"
    - "The planner can optionally query KB for strategic lessons when making planning decisions"
    - "Cross-project lessons are surfaced because the researcher queries without project filter"
  artifacts:
    - path: ".claude/agents/gsd-phase-researcher.md"
      provides: "Mandatory KB consultation at research start, spike dedup, citation format"
      contains: "knowledge_surfacing"
    - path: ".claude/agents/gsd-planner.md"
      provides: "Optional KB consultation for strategic lessons"
      contains: "knowledge_surfacing"
  key_links:
    - from: ".claude/agents/gsd-phase-researcher.md"
      to: "get-shit-done/references/knowledge-surfacing.md"
      via: "@ reference in knowledge_surfacing section"
      pattern: "knowledge-surfacing\\.md"
    - from: ".claude/agents/gsd-phase-researcher.md"
      to: "~/.claude/gsd-knowledge/index.md"
      via: "mandatory initial KB query instructions"
      pattern: "gsd-knowledge/index\\.md"
    - from: ".claude/agents/gsd-planner.md"
      to: "get-shit-done/references/knowledge-surfacing.md"
      via: "@ reference in knowledge_surfacing section"
      pattern: "knowledge-surfacing\\.md"
---

<objective>
Add knowledge surfacing capabilities to the phase researcher and planner agents via additive XML sections.

Purpose: The phase researcher is the primary knowledge consumer -- it does the mandatory initial KB query that satisfies SURF-01 (knowledge researcher spawned in parallel), SURF-02 (relevance filtering), SURF-03 (token budget), SURF-04 (cross-project), SURF-05 (spike surfacing), and SPKE-08 (spike dedup). The planner gets optional querying for strategic lessons. These are the two most important agent integrations.

Output: Two modified agent files with `<knowledge_surfacing>` sections appended.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-knowledge-surfacing/05-CONTEXT.md
@.planning/phases/05-knowledge-surfacing/05-RESEARCH.md
@get-shit-done/references/knowledge-surfacing.md
@.claude/agents/gsd-phase-researcher.md
@.claude/agents/gsd-planner.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add knowledge_surfacing section to gsd-phase-researcher.md</name>
  <files>.claude/agents/gsd-phase-researcher.md</files>
  <action>
Append a `<knowledge_surfacing>` XML section to the END of `.claude/agents/gsd-phase-researcher.md`. This section is additive -- do NOT modify any existing sections in the file.

The section must include:

**1. Activation check (fork compatibility):**
```markdown
**Activation:** If `get-shit-done/references/knowledge-surfacing.md` exists, apply knowledge surfacing. If not, skip this section (upstream GSD without reflect fork).
```

**2. @ reference to the specification:**
```markdown
@get-shit-done/references/knowledge-surfacing.md
```

**3. Mandatory initial KB query (before external research):**
Step-by-step instructions:
1. Read `~/.claude/gsd-knowledge/index.md`
2. Scan the Lessons table for entries whose tags overlap with:
   - The phase's technology domain (from CONTEXT.md or phase goal)
   - The phase's goal/purpose keywords
   - Any specific libraries or patterns mentioned in requirements
3. Scan the Spikes table for entries whose tags match current research questions
4. For matching entries (up to 5), read the full entry files
5. Check freshness via `depends_on` in frontmatter (if present) -- see reference for details
6. Incorporate relevant findings into RESEARCH.md

**4. Spike deduplication (SPKE-08):**
As part of the initial query:
- Check if any spike in the index already answers a current research question
- Matching criteria: same technology, same constraints, no significant codebase drift
- If applicable: adopt finding, cite, note as "spike avoided"
- Partial match: adopt answered portion, note the gap
- Do NOT trigger a new spike if an existing one already answers the question

**5. Cross-project surfacing (SURF-04):**
- Query index.md WITHOUT filtering by project name
- This naturally surfaces lessons from all projects (the index contains everything)
- Global lessons (`_global` project) are always included

**6. Re-query triggers:**
- If you encounter unexpected errors during research, re-query KB for similar error patterns
- If you change research direction, re-query with updated keywords

**7. Token budget:** ~500 tokens of surfaced knowledge (soft cap)

**8. Priority ordering:** Spike decisions first (empirical proof), then lessons (strategic patterns)

**9. Output requirements:**
- Inline citations throughout RESEARCH.md: "A prior lesson [les-xxx] found that..."
- Add "## Knowledge Applied" section to RESEARCH.md with:
  - KB entries consulted count
  - Applied entries with ID and how they influenced research
  - Dismissed entries (only if they contradicted the chosen approach)
  - Spikes avoided count and IDs
- If no relevant entries: "Checked knowledge base, no relevant entries found."

**10. Debug mode:**
```markdown
**Debug mode:** If `knowledge_debug: true` in `.planning/config.json`, include a "## KB Debug Log" section listing all index entries scanned with relevance assessments.
```

The section should be approximately 80-120 lines. Follow the XML section pattern used by other fork additions (see spike-integration references in other agents for the pattern). The content should be specific enough that a different Claude instance could execute KB queries without asking clarifying questions.
  </action>
  <verify>
```bash
# Section exists
grep "knowledge_surfacing" .claude/agents/gsd-phase-researcher.md
# References the specification
grep "knowledge-surfacing.md" .claude/agents/gsd-phase-researcher.md
# Has mandatory query instructions
grep -i "mandatory\|initial.*query\|before.*research" .claude/agents/gsd-phase-researcher.md | head -3
# Has spike dedup
grep -i "spike.*dedup\|spike.*avoid\|SPKE-08" .claude/agents/gsd-phase-researcher.md | head -2
# Has cross-project
grep -i "cross-project\|without.*project.*filter\|_global" .claude/agents/gsd-phase-researcher.md | head -2
# Has Knowledge Applied output
grep "Knowledge Applied" .claude/agents/gsd-phase-researcher.md
# Existing sections unchanged -- verify first section still intact
head -10 .claude/agents/gsd-phase-researcher.md | grep "gsd-phase-researcher"
```
  </verify>
  <done>
gsd-phase-researcher.md has a `<knowledge_surfacing>` section appended that includes: fork activation check, @ reference to knowledge-surfacing.md, mandatory initial KB query steps (index.md -> filter -> read entries -> check freshness), spike deduplication (SPKE-08), cross-project surfacing (no project filter), re-query triggers, token budget (~500), priority ordering (spikes first), output format (inline citations + Knowledge Applied section), and debug mode instructions. No existing sections modified.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add knowledge_surfacing section to gsd-planner.md</name>
  <files>.claude/agents/gsd-planner.md</files>
  <action>
Append a `<knowledge_surfacing>` XML section to the END of `.claude/agents/gsd-planner.md`. This section is additive -- do NOT modify any existing sections in the file.

The planner's knowledge surfacing is OPTIONAL (not mandatory like the researcher's). The planner queries when it judges it helpful for planning decisions.

The section must include:

**1. Activation check (fork compatibility):**
```markdown
**Activation:** If `get-shit-done/references/knowledge-surfacing.md` exists, apply knowledge surfacing. If not, skip this section.
```

**2. @ reference:**
```markdown
@get-shit-done/references/knowledge-surfacing.md
```

**3. When to query:**
- Optional, at your discretion during planning
- Useful when: making technology choices, designing task structure, encountering familiar-sounding patterns
- NOT required for every plan -- only when accumulated knowledge might inform decisions
- The researcher's RESEARCH.md already contains surfaced knowledge from its mandatory query -- check there first before querying KB directly

**4. What to query for:**
- Lessons only (NOT spikes -- spike decisions are the researcher's domain)
- Priority: strategic lessons about conventions, patterns, architectural decisions
- Filter by tags relevant to the current phase's domain

**5. Query pattern:**
1. Check if RESEARCH.md already contains a "## Knowledge Applied" section (avoid redundant queries)
2. If additional KB context is needed: read `~/.claude/gsd-knowledge/index.md`
3. Scan Lessons table for strategic/architectural entries matching phase domain
4. Read top 2-3 matching entries
5. Apply findings to plan structure or task design

**6. Token budget:** ~500 tokens (soft cap)

**7. Output:**
- Inline citations in PLAN.md tasks where knowledge influenced the plan: "Based on [les-xxx], avoid approach Y..."
- If KB was consulted, note in plan documentation
- No separate Knowledge Applied section needed (researcher already produces one)

**8. Downstream propagation:**
- Knowledge the planner applies becomes part of the PLAN.md instructions
- The executor reads PLAN.md and thus receives the knowledge indirectly
- The planner does NOT need to create a separate knowledge hand-off

The section should be approximately 40-60 lines. Keep it concise -- the planner's KB interaction is optional and supplementary.
  </action>
  <verify>
```bash
# Section exists
grep "knowledge_surfacing" .claude/agents/gsd-planner.md
# References the specification
grep "knowledge-surfacing.md" .claude/agents/gsd-planner.md
# Has optional framing
grep -i "optional\|discretion\|not required" .claude/agents/gsd-planner.md | head -2
# Has lessons-only focus
grep -i "lessons only\|NOT spikes\|strategic" .claude/agents/gsd-planner.md | head -2
# Existing sections unchanged
head -10 .claude/agents/gsd-planner.md | grep "gsd-planner"
```
  </verify>
  <done>
gsd-planner.md has a `<knowledge_surfacing>` section appended that includes: fork activation check, @ reference to knowledge-surfacing.md, optional query guidance (when helpful for planning decisions), lessons-only focus (spikes are researcher domain), query pattern (check RESEARCH.md first, then KB if needed), token budget (~500), output format (inline citations in PLAN.md), and downstream propagation notes. No existing sections modified.
  </done>
</task>

</tasks>

<verification>
1. `.claude/agents/gsd-phase-researcher.md` has `<knowledge_surfacing>` section with mandatory KB query, spike dedup, and cross-project surfacing
2. `.claude/agents/gsd-planner.md` has `<knowledge_surfacing>` section with optional KB query for strategic lessons
3. Neither agent file has ANY existing sections modified (only appended)
4. Both sections reference `get-shit-done/references/knowledge-surfacing.md` via @ syntax
5. Both sections include fork activation check (file existence)
6. Researcher section covers SURF-01, SURF-02, SURF-03, SURF-04, SURF-05, SPKE-08
7. Planner section is concise and optional (not mandatory)
</verification>

<success_criteria>
- Phase researcher does a mandatory KB query before any external research
- Spike deduplication is part of the researcher's initial query (no separate step)
- Cross-project entries are surfaced because the researcher queries without project filter
- Planner can optionally query KB for strategic lessons but checks RESEARCH.md first
- Both agent files have ONLY additive changes (new XML section appended)
- Both sections include the fork detection activation check
</success_criteria>

<output>
After completion, create `.planning/phases/05-knowledge-surfacing/05-02-SUMMARY.md`
</output>
