---
phase: 26-backlog-workflow-integration
plan: 02
type: execute
wave: 2
depends_on: ["26-01"]
files_modified:
  - get-shit-done/workflows/new-milestone.md
  - get-shit-done/workflows/check-todos.md
  - get-shit-done/workflows/complete-milestone.md
autonomous: true

must_haves:
  truths:
    - "new-milestone workflow includes Step 1b that reads backlog items grouped by theme, displays them with priority, and offers multi-select for milestone scope"
    - "new-milestone workflow includes Step 9b that promotes selected backlog items with --to and --milestone flags after requirements are defined"
    - "check-todos workflow offers 'Promote to backlog' action for pending todos using backlog add CLI command"
    - "check-todos workflow supports priority and status filtering via arguments"
    - "complete-milestone workflow includes a backlog review step that surfaces un-promoted items and offers keep/defer/discard options"
  artifacts:
    - path: "get-shit-done/workflows/new-milestone.md"
      provides: "Steps 1b (backlog review for scoping) and 9b (promote selected items)"
    - path: "get-shit-done/workflows/check-todos.md"
      provides: "Promote-to-backlog action and priority/status filter support"
    - path: "get-shit-done/workflows/complete-milestone.md"
      provides: "Backlog review step after evolve_project"
  key_links:
    - from: "new-milestone.md Step 1b"
      to: "backlog group --by theme CLI"
      via: "bash command calling gsd-tools backlog group"
      pattern: "backlog group --by theme"
    - from: "new-milestone.md Step 9b"
      to: "backlog promote --to --milestone CLI"
      via: "bash command calling gsd-tools backlog promote"
      pattern: "backlog promote.*--to.*--milestone"
    - from: "check-todos.md promote action"
      to: "backlog add CLI"
      via: "bash command calling gsd-tools backlog add"
      pattern: "backlog add --title"
    - from: "complete-milestone.md review step"
      to: "backlog list --status CLI"
      via: "bash command calling gsd-tools backlog list"
      pattern: "backlog list.*--status"
---

<objective>
Integrate the backlog system into three existing GSD workflows: new-milestone (backlog-aware scoping and promote), check-todos (promote-to-backlog action), and complete-milestone (backlog review step).

Purpose: Connect the capture-to-requirements pipeline end-to-end. Backlog items inform milestone planning, todos can be elevated to structured backlog items, and un-promoted items are reviewed at milestone boundaries.

Output: Updated workflow instruction files with backlog integration points.
</objective>

<execution_context>
@/Users/rookslog/.claude/get-shit-done/workflows/execute-plan.md
@/Users/rookslog/.claude/get-shit-done/templates/summary-standard.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/26-backlog-workflow-integration/26-RESEARCH.md
@.planning/phases/26-backlog-workflow-integration/26-01-SUMMARY.md
@get-shit-done/workflows/new-milestone.md
@get-shit-done/workflows/check-todos.md
@get-shit-done/workflows/complete-milestone.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add backlog integration to new-milestone workflow</name>
  <files>get-shit-done/workflows/new-milestone.md</files>
  <action>
    All changes go to source file (get-shit-done/workflows/), NOT installed copy (.claude/get-shit-done/workflows/).

    Insert Step 1b between existing Step 1 (Load Context) and Step 2 (Gather Milestone Goals):

    **Step 1b: Review Backlog Items**
    - Run `backlog group --by theme --raw` and `backlog stats --raw` via gsd-tools CLI
    - Parse stats for total count. If total is 0, skip to Step 2
    - If items exist, display grouped by theme with priority indicators:
      ```
      ## Backlog Items ([total] items)
      ### [Theme]
      - [HIGH] Title (tags: x, y)
      - [MEDIUM] Title (tags: z)
      ### (no theme)
      - [LOW] Title
      ```
    - Use AskUserQuestion with multiSelect: true
      - header: "Milestone Scope"
      - question: "Select backlog items to include in this milestone:"
      - options: one per item formatted as "[PRIORITY] Title (theme/tags)"
      - Include "None -- start fresh" option
    - CRITICAL: Track selected item IDs for Step 9b. Do NOT promote yet (REQ-IDs don't exist until Step 9)
    - Deduplicate selected items by ID (items with multiple tags may appear in multiple groups)

    Insert Step 9b after existing Step 9 (Define Requirements):

    **Step 9b: Promote Selected Backlog Items**
    - Only execute if items were selected in Step 1b
    - For each selected backlog item:
      1. Match item to the most closely related generated requirement (by title/tags/theme similarity)
      2. Run: `node ~/.claude/get-shit-done/bin/gsd-tools.js backlog promote <item-id> --to <REQ-ID> --milestone v[X.Y]`
    - Present mapping table for confirmation:
      ```
      ## Backlog Items Promoted
      | Backlog Item | Requirement | Milestone |
      |--------------|-------------|-----------|
      | [Title 1]    | AUTH-01     | v1.2      |
      ```
    - Deduplicate by item ID before promoting (safety check against double-select)

    Preserve all existing steps and formatting. Only insert new steps -- do not modify existing content.
  </action>
  <verify>
    Read get-shit-done/workflows/new-milestone.md and verify:
    1. Step 1b exists between Step 1 and Step 2
    2. Step 1b calls `backlog group --by theme --raw` and `backlog stats --raw`
    3. Step 1b uses AskUserQuestion with multiSelect
    4. Step 1b includes deduplication instruction
    5. Step 9b exists after Step 9
    6. Step 9b calls `backlog promote <id> --to <REQ-ID> --milestone v[X.Y]`
    7. Step 9b includes mapping confirmation table
    8. All original steps are intact and unchanged
  </verify>
  <done>new-milestone.md has Steps 1b and 9b for backlog-aware milestone scoping and promotion</done>
</task>

<task type="auto">
  <name>Task 2: Add backlog integration to check-todos and complete-milestone workflows</name>
  <files>get-shit-done/workflows/check-todos.md, get-shit-done/workflows/complete-milestone.md</files>
  <action>
    All changes go to source files (get-shit-done/workflows/), NOT installed copies (.claude/get-shit-done/workflows/).

    **check-todos.md changes:**

    1. In the `parse_filter` step (after area filter), add support for priority and status filters:
       - `/gsd:check-todos --priority HIGH` -> filter by priority
       - `/gsd:check-todos --status pending` -> filter by status
       Keep existing area filter working. These are additive filters.

    2. In the `offer_actions` step, add a "Promote to backlog" option to BOTH the roadmap-match and no-match action lists:
       - Option text: "Promote to backlog" -- create structured backlog item from this todo
       - Add BEFORE the "Put it back" option in each list

    3. In the `execute_action` step, add the handler for "Promote to backlog":
       ```
       **Promote to backlog:**
       Create a backlog item from the todo:
       ```bash
       node ~/.claude/get-shit-done/bin/gsd-tools.js backlog add \
         --title "[todo title]" \
         --tags "[todo area]" \
         --priority [todo priority or MEDIUM] \
         --source "command" \
         --theme "[inferred from area]"
       ```

       Then ask user via AskUserQuestion:
       - header: "Todo Status"
       - question: "Todo promoted to backlog. Mark original todo as done?"
       - options:
         - "Yes -- mark done" -> mv todo to done/, update STATE.md, commit
         - "No -- keep in pending" -> leave todo as-is
       Report: "Backlog item created: [id]. Todo [kept/completed]."
       ```

    **complete-milestone.md changes:**

    Insert a new step `backlog_review` AFTER the `evolve_project_full_review` step and BEFORE the `reorganize_roadmap` step:

    **Step: Backlog Review**
    ```
    ## Post-Evolve: Backlog Review

    ```bash
    BACKLOG_LIST=$(node ~/.claude/get-shit-done/bin/gsd-tools.js backlog list --status captured,triaged --raw)
    ```

    Parse BACKLOG_LIST for item count. If 0 unpromoted items, skip to next step.

    If unpromoted items exist, display:
    ```
    ## Backlog Review

    [N] backlog items were not promoted during this milestone:

    | # | Priority | Title | Status | Tags |
    |---|----------|-------|--------|------|
    | 1 | HIGH     | ...   | captured | ... |
    ```

    Use AskUserQuestion:
    - header: "Backlog Review"
    - question: "How would you like to handle these items?"
    - options:
      - "Review individually" -- per-item keep/defer/discard
      - "Keep all" -- no changes, carry forward
      - "Defer all" -- set all to status: deferred
      - "Skip review" -- proceed without changes

    If "Review individually": For each item, AskUserQuestion with:
    - "Keep" -- no change
    - "Defer" -- `backlog update <id> --status deferred`
    - "Discard" -- `backlog update <id> --status done`

    If "Defer all":
    ```bash
    # For each unpromoted item:
    node ~/.claude/get-shit-done/bin/gsd-tools.js backlog update <id> --status deferred
    ```

    Also check for items with status: planned (promoted during this milestone). Offer to mark them as done since the milestone shipped:
    ```bash
    PLANNED=$(node ~/.claude/get-shit-done/bin/gsd-tools.js backlog list --status planned --raw)
    ```
    If planned items exist, AskUserQuestion:
    - "Mark all as done" -- `backlog update <id> --status done` for each
    - "Keep as planned" -- no change (useful if milestone partially shipped)
    ```

    This step must be skippable -- never gate milestone completion on backlog triage.

    Preserve all existing steps and formatting. Only insert the new step -- do not modify existing content.
  </action>
  <verify>
    Read get-shit-done/workflows/check-todos.md and verify:
    1. parse_filter step supports --priority and --status arguments
    2. offer_actions step includes "Promote to backlog" option in both roadmap-match and no-match lists
    3. execute_action step includes "Promote to backlog" handler with `backlog add` CLI call
    4. execute_action includes AskUserQuestion for marking original todo done/kept

    Read get-shit-done/workflows/complete-milestone.md and verify:
    5. backlog_review step exists after evolve_project_full_review and before reorganize_roadmap
    6. backlog_review calls `backlog list --status captured,triaged --raw`
    7. backlog_review offers keep/defer/discard/skip options
    8. backlog_review handles planned items (offer to mark as done)
    9. Step is skippable (0 items or "Skip review" option)
    10. All original steps are intact and unchanged
  </verify>
  <done>check-todos.md has promote-to-backlog action and filter support; complete-milestone.md has backlog review step with keep/defer/discard triage</done>
</task>

</tasks>

<verification>
Read all three modified workflow files and verify:
1. new-milestone.md: Steps 1b and 9b present with correct CLI commands
2. check-todos.md: "Promote to backlog" action with backlog add CLI, priority/status filters
3. complete-milestone.md: Backlog review step with backlog list/update CLI commands
4. All original content in each file preserved unchanged
5. No references to .claude/get-shit-done/ paths (only ~/.claude/get-shit-done/ in workflow instructions)
</verification>

<success_criteria>
- new-milestone.md has Step 1b (backlog scoping with multi-select) and Step 9b (promote with --milestone)
- check-todos.md offers "Promote to backlog" and supports priority/status filtering
- complete-milestone.md has skippable backlog review after project evolution
- All workflow instructions use existing CLI commands (no custom file parsing)
- Two-phase promote pattern: select in Step 1b, promote in Step 9b (after REQ-IDs exist)
- Deduplication instructions present for multi-select (tag group overlap)
</success_criteria>

<output>
After completion, create `.planning/phases/26-backlog-workflow-integration/26-02-SUMMARY.md`
</output>
