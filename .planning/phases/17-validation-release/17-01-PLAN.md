---
phase: 17-validation-release
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - tests/integration/multi-runtime.test.js
autonomous: true

must_haves:
  truths:
    - "OpenCode installation produces correct file layout with gsd-*.md commands, agents, and references"
    - "OpenCode installed files have all ~/.claude/ paths replaced with ~/.config/opencode/"
    - "Gemini installation produces correct file layout with .toml commands, agents, and references"
    - "Gemini installed files have all ~/.claude/ paths replaced with ~/.gemini/"
    - "--all flag installs all 4 runtimes with deep content correctness, not just directory existence"
    - "No runtime has leaked ~/.claude/ paths (except Claude itself)"
    - "All runtimes reference ~/.gsd/knowledge/ for KB paths"
  artifacts:
    - path: "tests/integration/multi-runtime.test.js"
      provides: "Deep validation tests for per-runtime install correctness and multi-runtime --all install"
      min_lines: 200
  key_links:
    - from: "tests/integration/multi-runtime.test.js"
      to: "bin/install.js"
      via: "execSync subprocess with HOME override"
      pattern: "execSync.*node.*install\\.js"
    - from: "tests/integration/multi-runtime.test.js"
      to: "tests/helpers/tmpdir.js"
      via: "tmpdirTest fixture import"
      pattern: "import.*tmpdirTest.*from.*tmpdir"
---

<objective>
Create deep integration tests that validate per-runtime installation correctness (VALID-01, VALID-02) and multi-runtime --all installation (VALID-03).

Purpose: The existing install tests (64 tests in install.test.js) verify installer mechanics -- directory creation, path replacement for Claude and Codex. Phase 17 extends this with deep content validation for OpenCode (VALID-01) and Gemini (VALID-02), plus a comprehensive --all install test (VALID-03) that goes beyond directory existence checks to verify file content, format conversion, and path transformation for all 4 runtimes simultaneously.

Output: `tests/integration/multi-runtime.test.js` with passing tests covering all three requirements.
</objective>

<execution_context>
@/Users/rookslog/.claude/get-shit-done/workflows/execute-plan.md
@/Users/rookslog/.claude/get-shit-done/templates/summary-standard.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/17-validation-release/17-RESEARCH.md

@tests/helpers/tmpdir.js
@tests/unit/install.test.js
@bin/install.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create per-runtime deep validation tests (VALID-01, VALID-02)</name>
  <files>tests/integration/multi-runtime.test.js</files>
  <action>
Create `tests/integration/multi-runtime.test.js` with deep validation tests for OpenCode and Gemini installations. This file will also contain the VALID-03 tests (Task 2 adds them to the same file).

**Test structure:**
```
describe('multi-runtime validation', () => {
  describe('VALID-01: OpenCode installation', () => { ... })
  describe('VALID-02: Gemini installation', () => { ... })
  describe('VALID-03: Multi-runtime --all install', () => { ... })  // Task 2
})
```

**Reusable helpers (define at top of file):**

1. `verifyRuntimeLayout(rootDir, runtime)` -- Checks expected directory structure per runtime:
   - Claude: `commands/gsd/*.md`, `get-shit-done/**`, `agents/gsd-*.md`, `hooks/*.js`, `settings.json`
   - OpenCode: `command/gsd-*.md` (flat), `get-shit-done/**`, `agents/gsd-*.md` (XDG_CONFIG_HOME path)
   - Gemini: `commands/gsd/*.toml`, `get-shit-done/**`, `agents/gsd-*.md`, `hooks/*.js`, `settings.json`
   - Codex: `skills/gsd-*/SKILL.md`, `get-shit-done/**`, `AGENTS.md` (no agents dir, no hooks, no settings.json)

2. `verifyNoLeakedPaths(runtimeDir, runtime)` -- Scans all .md and .toml files recursively, asserts no `~/.claude/` paths remain (except in Claude install). Also verifies KB paths use `~/.gsd/knowledge/` not old `~/.claude/gsd-knowledge/`.

3. `verifyKBPathsShared(runtimeDir)` -- Scans installed files for any reference to `knowledge` and verifies they use `~/.gsd/knowledge/`.

**VALID-01 tests (OpenCode):**
- `tmpdirTest('OpenCode: correct file layout after install')` -- Run installer with `--opencode --global`, verify layout via `verifyRuntimeLayout`
- `tmpdirTest('OpenCode: all paths transformed from ~/.claude/ to XDG path')` -- Run installer, use `verifyNoLeakedPaths` on installed dir
- `tmpdirTest('OpenCode: command files use flat gsd-*.md naming')` -- Verify files in `command/` dir match `gsd-*.md` pattern (not nested `gsd/` subdirectory)
- `tmpdirTest('OpenCode: KB paths reference shared ~/.gsd/knowledge/')` -- Use `verifyKBPathsShared`

**VALID-02 tests (Gemini):**
- `tmpdirTest('Gemini: correct file layout after install')` -- Run installer with `--gemini --global`, verify layout via `verifyRuntimeLayout`
- `tmpdirTest('Gemini: all paths transformed from ~/.claude/ to ~/.gemini/')` -- Run installer, use `verifyNoLeakedPaths`
- `tmpdirTest('Gemini: command files are .toml format')` -- Verify files in `commands/gsd/` are `.toml` not `.md`
- `tmpdirTest('Gemini: KB paths reference shared ~/.gsd/knowledge/')` -- Use `verifyKBPathsShared`

**Important patterns to follow:**
- Always set `XDG_CONFIG_HOME` explicitly for OpenCode tests (prevents flakiness)
- Use `execSync` with `{ env: { ...process.env, HOME: tmpdir, XDG_CONFIG_HOME: configHome } }` and `timeout: 15000`
- Import `tmpdirTest` from `../helpers/tmpdir.js`
- Use `fs/promises` for async file operations, `node:fs` (sync) only when necessary
- Follow the existing Codex path replacement test pattern (install.test.js lines 1099-1131) for path scanning

**What NOT to do:**
- Do NOT modify `install.test.js` or `bin/install.js` -- this is a validation-only phase
- Do NOT test with real runtime CLIs (no launching `opencode`, `gemini`)
- Do NOT test against the user's real HOME directory
  </action>
  <verify>Run `npx vitest run tests/integration/multi-runtime.test.js` -- all VALID-01 and VALID-02 tests pass. Run `npx vitest run` -- all 105+ existing tests still pass (no regressions).</verify>
  <done>OpenCode install validation tests pass: layout correct, paths transformed, flat naming confirmed, KB paths shared. Gemini install validation tests pass: layout correct, paths transformed, .toml format confirmed, KB paths shared.</done>
</task>

<task type="auto">
  <name>Task 2: Add multi-runtime --all deep validation tests (VALID-03)</name>
  <files>tests/integration/multi-runtime.test.js</files>
  <action>
Add the `describe('VALID-03: Multi-runtime --all install')` block to the same `tests/integration/multi-runtime.test.js` file created in Task 1.

**VALID-03 tests:**

1. `tmpdirTest('--all installs all 4 runtimes with correct file layouts')` -- Run `--all --global`, then call `verifyRuntimeLayout` for each of the 4 runtimes (claude, opencode, gemini, codex). This goes beyond the existing --all test in install.test.js (which only checks directory existence) by validating the full file tree.

2. `tmpdirTest('--all install: no cross-runtime path leakage')` -- Run `--all --global`, then for each non-Claude runtime, call `verifyNoLeakedPaths` to ensure no `~/.claude/` references leaked through. Also verify that each runtime's installed files reference the correct runtime-specific prefix:
   - Claude: `~/.claude/`
   - OpenCode: `~/.config/opencode/`
   - Gemini: `~/.gemini/`
   - Codex: `~/.codex/`

3. `tmpdirTest('--all install: each runtime has format-correct command files')` -- Verify:
   - Claude: `.md` files in `commands/gsd/`
   - OpenCode: `.md` files matching `gsd-*.md` in `command/` (flat)
   - Gemini: `.toml` files in `commands/gsd/`
   - Codex: `SKILL.md` files in `skills/gsd-*/`
   Assert that each runtime has at least 3 command files (matching the GSD command set).

4. `tmpdirTest('--all install: shared KB directory created with correct structure')` -- Verify `~/.gsd/knowledge/` directory exists with `signals/`, `spikes/`, `lessons/` subdirectories. Verify Claude backward-compat symlink at `~/.claude/gsd-knowledge` is a symlink pointing to `~/.gsd/knowledge/`.

5. `tmpdirTest('--all install: VERSION files present in all runtimes')` -- Verify each runtime has a `get-shit-done/VERSION` file. Read it and confirm all 4 runtimes have the same version string.

**Important:** Set timeout to 30000ms for --all tests (4 runtimes is slower). Use `XDG_CONFIG_HOME` for OpenCode path determinism.
  </action>
  <verify>Run `npx vitest run tests/integration/multi-runtime.test.js` -- all VALID-03 tests pass alongside VALID-01 and VALID-02 tests. Run `npx vitest run` -- full suite passes.</verify>
  <done>Multi-runtime --all tests pass: all 4 runtimes have correct layouts, no path leakage between runtimes, format-correct command files per runtime, shared KB with correct structure, consistent VERSION files across runtimes.</done>
</task>

</tasks>

<verification>
1. `npx vitest run tests/integration/multi-runtime.test.js` -- all tests pass
2. `npx vitest run` -- full test suite passes (no regressions to existing 105 tests)
3. Each VALID-0X requirement has at least 2 test cases covering it
</verification>

<success_criteria>
- VALID-01: OpenCode installation validated with layout, path transformation, flat naming, and KB path checks
- VALID-02: Gemini installation validated with layout, path transformation, TOML format, and KB path checks
- VALID-03: --all multi-runtime install validated with deep content checks across all 4 runtimes
- All new tests pass alongside existing 105 tests with zero regressions
</success_criteria>

<output>
After completion, create `.planning/phases/17-validation-release/17-01-SUMMARY.md`
</output>
