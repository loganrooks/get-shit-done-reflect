---
phase: 17-validation-release
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - tests/integration/cross-runtime-kb.test.js
autonomous: true

must_haves:
  truths:
    - "A signal written to ~/.gsd/knowledge/ is readable from any runtime's installed path references"
    - "Claude backward-compatibility symlink at ~/.claude/gsd-knowledge provides transparent access to shared KB"
    - "Signals with both old format (no runtime/model) and new format (with runtime/model) are readable from shared KB"
    - "KB index can be rebuilt after cross-runtime signal creation"
  artifacts:
    - path: "tests/integration/cross-runtime-kb.test.js"
      provides: "Cross-runtime KB write-read validation tests"
      min_lines: 100
  key_links:
    - from: "tests/integration/cross-runtime-kb.test.js"
      to: "bin/install.js"
      via: "execSync subprocess with --all flag"
      pattern: "execSync.*install.*--all"
    - from: "tests/integration/cross-runtime-kb.test.js"
      to: "tests/helpers/tmpdir.js"
      via: "tmpdirTest fixture import"
      pattern: "import.*tmpdirTest.*from.*tmpdir"
---

<objective>
Create cross-runtime KB accessibility tests (VALID-04) that verify signals written to the shared ~/.gsd/knowledge/ location are readable from all installed runtimes.

Purpose: Phases 13-16 established a shared KB at ~/.gsd/knowledge/ with backward-compat symlink for Claude. This plan validates the final requirement (VALID-04): that the KB is truly accessible and writable from all runtime perspectives. This is the last validation gate before v1.14 release readiness.

Output: `tests/integration/cross-runtime-kb.test.js` with passing tests covering VALID-04.
</objective>

<execution_context>
@/Users/rookslog/.claude/get-shit-done/workflows/execute-plan.md
@/Users/rookslog/.claude/get-shit-done/templates/summary-standard.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/17-validation-release/17-RESEARCH.md

@tests/helpers/tmpdir.js
@tests/integration/kb-infrastructure.test.js
@tests/integration/kb-write.test.js
@bin/install.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create cross-runtime KB accessibility tests (VALID-04)</name>
  <files>tests/integration/cross-runtime-kb.test.js</files>
  <action>
Create `tests/integration/cross-runtime-kb.test.js` with tests that validate KB shared access across runtimes.

**Test structure:**
```
describe('VALID-04: Cross-runtime KB accessibility', () => {
  describe('shared KB after --all install', () => { ... })
  describe('signal format compatibility', () => { ... })
  describe('Claude backward-compat symlink', () => { ... })
})
```

**Tests:**

1. `tmpdirTest('--all install creates shared KB at ~/.gsd/knowledge/')` -- Run `--all --global`, verify `~/.gsd/knowledge/` exists with `signals/`, `spikes/`, `lessons/` subdirectories. This overlaps slightly with 17-01 but is the foundational assertion for VALID-04.

2. `tmpdirTest('signal written to shared KB is readable at shared path')` -- Run `--all --global`. Write a signal file to `$HOME/.gsd/knowledge/signals/test-project/sig-cross-rt.md` with frontmatter including `runtime: claude-code`, `model: claude-opus-4-6`. Read it back from the same path. Verify content matches.

3. `tmpdirTest('signal written to shared KB is readable via Claude symlink')` -- Run `--all --global`. Write a signal to `$HOME/.gsd/knowledge/signals/test-project/sig-symlink-test.md`. Read it via `$HOME/.claude/gsd-knowledge/signals/test-project/sig-symlink-test.md`. Verify content is identical. Verify `$HOME/.claude/gsd-knowledge` is a symlink (using `fs.lstat` + `isSymbolicLink()`).

4. `tmpdirTest('old-format signal (no runtime/model fields) is readable')` -- Write a signal to shared KB with the old format (only id, type, project, tags, severity, etc. -- no `runtime:` or `model:` fields). Read it back. Verify the content is readable and parseable. This validates backward compatibility per Phase 16's signal schema extension (optional fields).

5. `tmpdirTest('new-format signal (with runtime/model fields) is readable')` -- Write a signal with the new format including `runtime: opencode`, `model: gpt-4.1`. Read it back. Verify both the standard fields and the new runtime/model fields are present.

6. `tmpdirTest('multiple signals from different runtimes coexist in shared KB')` -- Write 3 signals to the same project directory, each with different `runtime:` values (claude-code, opencode, codex-cli). Read all 3 back. Verify each has the correct runtime field. Verify all 3 coexist in the same directory listing.

7. `tmpdirTest('KB paths in installed workflow files reference ~/.gsd/knowledge/')` -- After `--all --global`, for each runtime's `get-shit-done/` reference docs, scan files that mention "knowledge" and verify they reference `~/.gsd/knowledge/` (not `~/.claude/gsd-knowledge/`). This validates that installed workflow files will direct each runtime to the correct shared KB location.

**Patterns to follow:**
- Use `tmpdirTest` from `../helpers/tmpdir.js`
- Use `execSync` with HOME override for installer runs (timeout: 30000 for --all)
- Set `XDG_CONFIG_HOME` for OpenCode path determinism
- Follow signal writing patterns from `tests/integration/kb-infrastructure.test.js` (writeSignal helper)
- Use `fs/promises` for async file operations

**What NOT to do:**
- Do NOT modify `bin/install.js` -- validation only
- Do NOT require actual runtime CLIs to be installed
- Do NOT test against real HOME directory
- Do NOT assume `runtime:` and `model:` fields are required in signal frontmatter (they are optional, Phase 16 decision)
  </action>
  <verify>Run `npx vitest run tests/integration/cross-runtime-kb.test.js` -- all VALID-04 tests pass. Run `npx vitest run` -- full suite passes with zero regressions.</verify>
  <done>Cross-runtime KB tests pass: shared KB created by --all install, signals writable and readable from shared path, Claude symlink provides transparent access, both old-format and new-format signals are compatible, multiple runtime signals coexist, installed workflow files reference correct KB path.</done>
</task>

<task type="auto">
  <name>Task 2: Create v1.14 release readiness summary</name>
  <files>tests/integration/cross-runtime-kb.test.js</files>
  <action>
Add a final describe block to `tests/integration/cross-runtime-kb.test.js` that serves as a release readiness validation:

```
describe('v1.14 release readiness', () => { ... })
```

**Tests:**

1. `tmpdirTest('all runtimes produce consistent VERSION files')` -- Run `--all --global`. Read VERSION file from each runtime's `get-shit-done/VERSION`. Verify all 4 match. Verify the version string is a valid semver pattern.

2. `tmpdirTest('no test regressions: full suite baseline')` -- This is a meta-test that simply verifies the test runner can execute the full suite. Run `execSync('npx vitest run --reporter=json')` and parse the JSON output. Verify `numTotalTests > 100` (baseline: 105 existing + new tests). Verify `numFailedTests === 0`. This captures the "all tests pass" release gate as an automated assertion.

**NOTE:** If the meta-test is impractical (nested vitest), skip it and instead add a comment documenting the manual release verification step: `// Release gate: npx vitest run must show 0 failures`.

After all tests pass, print the release readiness state by examining what Phase 17 validated:
- VALID-01: OpenCode install correctness (17-01)
- VALID-02: Gemini install correctness (17-01)
- VALID-03: Multi-runtime --all install depth (17-01)
- VALID-04: Cross-runtime KB accessibility (this plan)
  </action>
  <verify>Run `npx vitest run tests/integration/cross-runtime-kb.test.js` -- all tests pass including release readiness block. Run `npx vitest run` -- full suite passes.</verify>
  <done>Release readiness tests pass: VERSION consistency confirmed across all 4 runtimes, total test count exceeds baseline, zero failures in full suite.</done>
</task>

</tasks>

<verification>
1. `npx vitest run tests/integration/cross-runtime-kb.test.js` -- all tests pass
2. `npx vitest run` -- full test suite passes (existing 105 + all new tests, zero failures)
3. VALID-04 requirement has at least 5 test cases covering signal write/read/symlink/format-compat/coexistence
</verification>

<success_criteria>
- VALID-04: Cross-runtime KB accessibility validated with shared path, Claude symlink, old/new format compatibility, multi-runtime signal coexistence, and correct KB path references in installed files
- Release readiness: VERSION consistency, full test suite passing, all 4 VALID requirements covered
- All new tests pass alongside existing tests with zero regressions
</success_criteria>

<output>
After completion, create `.planning/phases/17-validation-release/17-02-SUMMARY.md`
</output>
