---
phase: 21-workflow-refinements
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - commands/gsd/signal.md
  - get-shit-done/workflows/signal.md
autonomous: true

must_haves:
  truths:
    - "/gsd:signal loads fewer than 200 lines of reference context total"
    - "Signal command is self-contained with all rules inlined (severity, frustration, dedup, cap, schema)"
    - "Signal workflow file no longer duplicates the 10-step process"
    - "Other consumers of signal-detection.md and knowledge-store.md are not affected"
  artifacts:
    - path: "commands/gsd/signal.md"
      provides: "Self-contained signal command with inlined rules"
      contains: "signal_rules"
    - path: "get-shit-done/workflows/signal.md"
      provides: "Thin redirect or eliminated workflow"
  key_links:
    - from: "commands/gsd/signal.md"
      to: "~/.gsd/knowledge/signals/"
      via: "Inlined KB path and naming conventions"
      pattern: "~/.gsd/knowledge/signals/"
    - from: "commands/gsd/signal.md"
      to: "~/.gsd/bin/kb-rebuild-index.sh"
      via: "Index rebuild step"
      pattern: "kb-rebuild-index"
---

<objective>
Consolidate the /gsd:signal command into a self-contained file that loads fewer than 200 lines of reference context, eliminating the 888-line context bloat from importing full reference documents.

Purpose: The signal command currently loads knowledge-store.md (366 lines), signal-detection.md (258 lines), and the signal template (29 lines) via @ imports, but only uses ~150 lines of extracted rules from those documents. This wastes 4x context on every /gsd:signal invocation. Consolidation reduces context to ~200 lines while preserving all functionality.

Output: A self-contained `commands/gsd/signal.md` (~180-200 lines) with zero @ reference imports for large docs, and a reduced `get-shit-done/workflows/signal.md` that redirects to the command (no longer duplicating the 10-step process).
</objective>

<execution_context>
@.claude/get-shit-done/workflows/execute-plan.md
@.claude/get-shit-done/templates/summary-standard.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/21-workflow-refinements/21-RESEARCH.md

Source files to modify:
@commands/gsd/signal.md
@get-shit-done/workflows/signal.md

Reference files (DO NOT MODIFY -- other consumers depend on these):
@get-shit-done/references/signal-detection.md
@.claude/agents/knowledge-store.md
@.claude/agents/kb-templates/signal.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Rewrite signal command as self-contained file with inlined rules</name>
  <files>commands/gsd/signal.md</files>
  <action>
Rewrite `commands/gsd/signal.md` to be fully self-contained. The file must contain all rules needed for signal creation WITHOUT any @ imports to large reference documents.

**Structure of the new command file:**

1. **Frontmatter** (keep existing: name, description, argument-hint, allowed-tools)

2. **Objective section** -- brief (2-3 lines)

3. **Execution context** -- reference ONLY the execute-plan and summary template (standard GSD boilerplate), NOT the signal workflow, NOT knowledge-store.md, NOT signal-detection.md

4. **Context section** -- reference ONLY `.planning/STATE.md` and `.planning/config.json` (for project context and commit settings). NO @ import of knowledge-store.md, signal-detection.md, or kb-templates/signal.md.

5. **Signal rules section** (`<signal_rules>`) -- inline the following extracted from reference docs:

   a. **Signal schema** (~15 lines): File path pattern (`~/.gsd/knowledge/signals/{project}/{YYYY-MM-DD}-{slug}.md`), ID pattern (`sig-{YYYY-MM-DD}-{slug}`), complete frontmatter field list (id, type, project, tags, created, updated, durability, status, severity, signal_type, phase, plan, polarity, source, occurrence_count, related_signals, runtime, model, gsd_version), body sections (What Happened, Context, Potential Cause).

   b. **Severity auto-assignment** (~10 lines): Table from signal-detection.md Section 6 (SGNL-04). Critical: verification failed, config mismatch. Notable: multiple issues, non-trivial problems, unexpected improvements. Manual signals always persisted regardless of severity.

   c. **Frustration patterns** (~12 lines): The 10 patterns from signal-detection.md Section 5 (SGNL-06) plus threshold (2+ patterns). Note that detection is suggestive, not automatic.

   d. **Dedup logic** (~15 lines): 4-step process from signal-detection.md Section 9 (SGNL-05). Read index, match criteria (same signal_type + same project + 2+ shared tags), populate related_signals and occurrence_count. Do NOT modify existing signals (immutable).

   e. **Cap enforcement** (~10 lines): From signal-detection.md Section 10 (SGNL-09). Max 10 active signals per phase per project. If at cap, compare severity and archive lowest if new >= lowest. Severity ordering: critical > notable.

   f. **KB path and naming** (~5 lines): KB root at `~/.gsd/knowledge/`, slugs are kebab-case max 50 chars, index at `~/.gsd/knowledge/index.md`, rebuild via `bash ~/.gsd/bin/kb-rebuild-index.sh`.

6. **Process section** (`<process>`) -- the full 10-step signal creation process currently in the workflow file, adapted to reference the inlined rules above instead of external documents:
   - Step 1: Parse arguments (description, --severity, --type)
   - Step 2: Extract conversation context (phase/plan from STATE.md, project name from cwd, frustration detection using inlined patterns, runtime detection from path prefix, model detection from self-knowledge)
   - Step 3: Fill missing info (max 1 follow-up, auto-assign severity using inlined table, infer type from keywords, auto-assign polarity)
   - Step 4: Preview before writing
   - Step 5: Dedup check using inlined rules
   - Step 6: Cap check using inlined rules
   - Step 7: Write signal file using inlined schema
   - Step 8: Rebuild index (`bash ~/.gsd/bin/kb-rebuild-index.sh`)
   - Step 9: Git commit (conditional on commit_docs setting)
   - Step 10: Confirm

7. **Design notes** (~5 lines): Max 2 interaction rounds, frustration detection is suggestive, git follows commit_docs, all manual signals persisted, source always "manual", runtime/model best-effort.

**CRITICAL constraints:**
- Do NOT modify or delete `get-shit-done/references/signal-detection.md` -- other consumers (gsd-signal-collector) depend on it
- Do NOT modify or delete `.claude/agents/knowledge-store.md` -- other consumers (gsd-spike-runner, run-spike workflow) depend on it
- Do NOT modify `.claude/agents/kb-templates/signal.md` -- it remains the canonical template for reference
- The command's `<execution_context>` must NOT include `@` references to signal-detection.md, knowledge-store.md, or the signal workflow
- Target: the command file itself should be ~180-200 lines. The key metric is that total REFERENCE CONTEXT loaded (via @ imports) is under 200 lines. With no large @ imports, the only context is STATE.md and config.json (~110 lines combined).
  </action>
  <verify>
1. `wc -l commands/gsd/signal.md` shows approximately 180-200 lines (acceptable range: 150-220)
2. `grep -c '@.*signal-detection' commands/gsd/signal.md` returns 0 (no import of signal-detection.md)
3. `grep -c '@.*knowledge-store' commands/gsd/signal.md` returns 0 (no import of knowledge-store.md)
4. `grep -c '@.*workflows/signal' commands/gsd/signal.md` returns 0 (no import of signal workflow)
5. `grep -c '@.*kb-templates/signal' commands/gsd/signal.md` returns 0 (no import of signal template)
6. `grep -c 'SGNL-04\|severity.*auto\|Severity Auto' commands/gsd/signal.md` returns >= 1 (severity rules inlined)
7. `grep -c 'SGNL-06\|frustration\|still not working' commands/gsd/signal.md` returns >= 1 (frustration patterns inlined)
8. `grep -c 'SGNL-05\|[Dd]edup' commands/gsd/signal.md` returns >= 1 (dedup rules inlined)
9. `grep -c 'SGNL-09\|cap\|Max 10' commands/gsd/signal.md` returns >= 1 (cap rules inlined)
10. `grep -c '~/.gsd/knowledge/signals/' commands/gsd/signal.md` returns >= 1 (KB path inlined)
11. `grep -c 'kb-rebuild-index' commands/gsd/signal.md` returns >= 1 (index rebuild inlined)
12. signal-detection.md and knowledge-store.md are UNCHANGED: `git diff get-shit-done/references/signal-detection.md` and `git diff .claude/agents/knowledge-store.md` show no changes
  </verify>
  <done>commands/gsd/signal.md is a self-contained signal command (~180-200 lines) with all five rule sets inlined (severity, frustration, dedup, cap, schema), zero @ imports to large reference docs, and the complete 10-step signal creation process. Total reference context loaded is under 200 lines (only STATE.md + config.json).</done>
</task>

<task type="auto">
  <name>Task 2: Reduce signal workflow to thin redirect</name>
  <files>get-shit-done/workflows/signal.md</files>
  <action>
Replace the full 257-line signal workflow file with a thin redirect (~15-20 lines) that points to the command file.

**Why a redirect instead of deletion:** The workflow file path appears in planning history and may be referenced by agents or docs that load workflows by convention. A redirect is safer than deletion.

**New content for `get-shit-done/workflows/signal.md`:**

```markdown
# Signal Workflow

This workflow has been consolidated into the signal command for context efficiency.

## Redirect

The complete signal creation process (all 10 steps) is now self-contained in:

`commands/gsd/signal.md`

The command was consolidated to eliminate ~700 lines of unnecessary reference context loading. All signal rules (severity auto-assignment, frustration detection, deduplication, cap enforcement, schema) are inlined directly in the command.

## Why This Changed

The original architecture split signal logic between this workflow file and the command file, with both loading full reference documents (signal-detection.md at 258 lines, knowledge-store.md at 366 lines). The command now contains everything needed for /gsd:signal execution without external reference imports.

## Reference Documents (unchanged)

These reference docs still exist for other consumers (gsd-signal-collector, gsd-spike-runner):
- `get-shit-done/references/signal-detection.md` -- detection rules for automated signal collection
- `.claude/agents/knowledge-store.md` -- KB schema for all entry types
```

This keeps the file as a useful pointer while eliminating the 257-line duplication of the signal creation process.
  </action>
  <verify>
1. `wc -l get-shit-done/workflows/signal.md` shows approximately 15-25 lines (significantly reduced from 257)
2. `grep -c 'commands/gsd/signal.md' get-shit-done/workflows/signal.md` returns >= 1 (points to consolidated command)
3. `grep -c 'required_reading' get-shit-done/workflows/signal.md` returns 0 (no more required_reading section that triggers additional context loading)
4. `grep -c '<step' get-shit-done/workflows/signal.md` returns 0 (no more step-by-step process -- that is in the command now)
  </verify>
  <done>get-shit-done/workflows/signal.md is a thin redirect (~20 lines) pointing to commands/gsd/signal.md. No more duplicated 10-step process. No more required_reading section triggering additional context loading.</done>
</task>

</tasks>

<verification>
1. Total reference context for /gsd:signal: Count lines of all @ imports in commands/gsd/signal.md. Should be < 200 lines total (STATE.md ~106 lines + config.json ~10 lines = ~116 lines, well under 200).
2. Signal command self-containment: All five rule sets (SGNL-04 severity, SGNL-05 dedup, SGNL-06 frustration, SGNL-09 cap, schema) are present in the command file.
3. No collateral damage: `git diff get-shit-done/references/signal-detection.md` and `git diff .claude/agents/knowledge-store.md` and `git diff .claude/agents/kb-templates/signal.md` all show no changes.
4. Workflow reduction: `wc -l get-shit-done/workflows/signal.md` shows ~20 lines (down from 257).
</verification>

<success_criteria>
- /gsd:signal loads fewer than 200 lines of reference context (down from ~888)
- commands/gsd/signal.md is self-contained at ~180-200 lines with all rules inlined
- get-shit-done/workflows/signal.md is a thin redirect (~20 lines)
- signal-detection.md, knowledge-store.md, and kb-templates/signal.md are unchanged
- All signal creation functionality preserved (10 steps, all rules)
</success_criteria>

<output>
After completion, create `.planning/phases/21-workflow-refinements/21-01-SUMMARY.md`
</output>
