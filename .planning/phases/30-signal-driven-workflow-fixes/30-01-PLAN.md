---
phase: 30-signal-driven-workflow-fixes
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - get-shit-done/workflows/execute-phase.md
  - get-shit-done/workflows/complete-milestone.md
  - get-shit-done/workflows/resume-project.md
autonomous: true

must_haves:
  truths:
    - "Stale .continue-here.md files are deleted when a phase completes via execute-phase"
    - "Stale .continue-here.md files are deleted across all milestone phases when a milestone completes"
    - ".continue-here.md is deleted after resume-work successfully loads its context"
    - "resume-work searches both .planning/phases/*/ and .planning/ for handoff files"
  artifacts:
    - path: "get-shit-done/workflows/execute-phase.md"
      provides: "cleanup_handoffs step between aggregate_results and verify_phase_goal"
      contains: "cleanup_handoffs"
    - path: "get-shit-done/workflows/complete-milestone.md"
      provides: "cleanup_milestone_handoffs step before archival"
      contains: "cleanup_milestone_handoffs"
    - path: "get-shit-done/workflows/resume-project.md"
      provides: "delete-after-load logic and expanded search paths"
      contains: ".planning/.continue-here.md"
  key_links:
    - from: "get-shit-done/workflows/execute-phase.md"
      to: ".planning/phases/XX-name/.continue-here*.md"
      via: "rm -f in cleanup_handoffs step"
      pattern: "rm -f.*\\.continue-here"
    - from: "get-shit-done/workflows/complete-milestone.md"
      to: ".planning/phases/*/.continue-here*.md"
      via: "for loop iterating milestone phase directories"
      pattern: "for phase_dir in .planning/phases"
    - from: "get-shit-done/workflows/resume-project.md"
      to: ".planning/.continue-here.md"
      via: "expanded search in check_incomplete_work"
      pattern: "ls .planning/\\.continue-here"
---

<objective>
Fix the .continue-here.md lifecycle so handoff files are cleaned up at every completion boundary and after resume loads their context.

Purpose: Three open signals (sig-2026-02-16-stale-continue-here-files-not-cleaned, sig-2026-02-17-continue-here-not-deleted-after-resume, sig-2026-02-17-resume-work-misses-non-phase-handoffs) identify gaps where .continue-here.md files persist beyond their useful life, confusing subsequent resume operations and accumulating stale state.

Output: Three workflow source files updated with cleanup logic.
</objective>

<execution_context>
@/Users/rookslog/.claude/get-shit-done/workflows/execute-plan.md
@/Users/rookslog/.claude/get-shit-done/templates/summary-standard.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/30-signal-driven-workflow-fixes/30-RESEARCH.md

@get-shit-done/workflows/execute-phase.md
@get-shit-done/workflows/complete-milestone.md
@get-shit-done/workflows/resume-project.md
@get-shit-done/workflows/transition.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add cleanup_handoffs steps to execute-phase.md and complete-milestone.md</name>
  <files>
    get-shit-done/workflows/execute-phase.md
    get-shit-done/workflows/complete-milestone.md
  </files>
  <action>
    **In execute-phase.md:** Add a new `<step name="cleanup_handoffs">` between the closing `</step>` of `aggregate_results` (after line 285) and the opening `<step name="verify_phase_goal">` (line 287). The step should:

    ```xml
    <step name="cleanup_handoffs">
    Clean up any .continue-here files from the completed phase:

    ```bash
    rm -f "${PHASE_DIR}/.continue-here"*.md
    ```

    Phase execution is complete -- any handoff files are now stale.
    </step>
    ```

    This replicates the existing pattern from transition.md (step cleanup_handoff, lines 109-119) which already handles this for phase-to-phase transitions. The execute-phase workflow is an alternative completion path that currently misses this cleanup.

    **In complete-milestone.md:** Add a new `<step name="cleanup_milestone_handoffs">` between the closing `</step>` of `verify_readiness` (after line 98) and the opening `<step name="gather_stats">` (line 100). The step should iterate over ALL phase directories in the milestone:

    ```xml
    <step name="cleanup_milestone_handoffs">
    Clean up .continue-here files across all phases in this milestone:

    ```bash
    for phase_dir in .planning/phases/*/; do
      rm -f "${phase_dir}.continue-here"*.md
    done
    ```

    Milestone is complete -- all phase handoffs are stale.
    </step>
    ```

    The milestone cleanup iterates all phase directories (not just one) because a milestone encompasses multiple phases, any of which could have lingering handoff files.

    Use `rm -f` (not `rm`) for defensive deletion -- the file may not exist in most directories.
  </action>
  <verify>
    1. `grep -n "cleanup_handoffs" get-shit-done/workflows/execute-phase.md` returns a match showing the new step
    2. `grep -n "cleanup_milestone_handoffs" get-shit-done/workflows/complete-milestone.md` returns a match showing the new step
    3. Verify ordering: in execute-phase.md, `cleanup_handoffs` appears AFTER `aggregate_results` and BEFORE `verify_phase_goal`
    4. Verify ordering: in complete-milestone.md, `cleanup_milestone_handoffs` appears AFTER `verify_readiness` and BEFORE `gather_stats`
    5. Both files still parse as valid XML-like workflow structure (no unclosed tags)
  </verify>
  <done>
    execute-phase.md contains a cleanup_handoffs step that deletes .continue-here*.md from the completed phase directory, placed between aggregate_results and verify_phase_goal. complete-milestone.md contains a cleanup_milestone_handoffs step that iterates all phase directories and deletes .continue-here*.md files, placed between verify_readiness and gather_stats. Both use rm -f for defensive deletion.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add delete-after-load and expanded search paths to resume-project.md</name>
  <files>
    get-shit-done/workflows/resume-project.md
  </files>
  <action>
    **Expand search paths in check_incomplete_work step (line 82):**

    Replace the existing single search:
    ```bash
    ls .planning/phases/*/.continue-here*.md 2>/dev/null
    ```

    With expanded search that includes project-level handoffs:
    ```bash
    # Check for phase-level handoffs (mid-plan resumption)
    ls .planning/phases/*/.continue-here*.md 2>/dev/null

    # Check for project-level handoffs (not tied to a specific phase)
    ls .planning/.continue-here.md 2>/dev/null
    ```

    **Add delete-after-load logic after context extraction (after line 119, before the `present_status` step):**

    After the "If .continue-here file exists" block reads the file and extracts context, and after the "If interrupted agent found" block, add a deletion instruction before the step closes:

    Insert the following text after the "Flag: Found interrupted agent" line (line 118) and before the `</step>` closing tag (line 119):

    ```markdown

    **After loading .continue-here context, delete the file:**

    ```bash
    # Delete the loaded handoff file (phase-level or project-level)
    rm -f "$CONTINUE_HERE_PATH"
    ```

    The handoff context is now loaded into this session. The file is stale.
    The continue-here template contract states: "This file gets DELETED after resume -- it's not permanent storage."
    If the session ends unexpectedly before work completes, the user can re-create
    a handoff with /gsd:pause-work.
    ```

    The deletion must happen AFTER the file is read and context extracted (anti-pattern from research: deleting before loading loses handoff data). The `$CONTINUE_HERE_PATH` variable refers to whichever .continue-here file was found and loaded by the search above.

    Note: The pause-work workflow currently only creates .continue-here.md inside phase directories. The project-level `.planning/.continue-here.md` search makes resume robust against future changes or manual file placement, even though no workflow currently creates files there.
  </action>
  <verify>
    1. `grep -n "planning/.continue-here.md" get-shit-done/workflows/resume-project.md` returns a match showing the expanded search path
    2. `grep -n "rm -f" get-shit-done/workflows/resume-project.md` returns a match showing the delete-after-load logic
    3. `grep -n "DELETED after resume" get-shit-done/workflows/resume-project.md` confirms the contract reference is present
    4. Verify the delete logic appears AFTER the "Read the file for specific resumption context" instruction and BEFORE the `present_status` step
    5. The file still has valid workflow structure (no unclosed tags)
  </verify>
  <done>
    resume-project.md searches both `.planning/phases/*/.continue-here*.md` AND `.planning/.continue-here.md` for handoff files. After loading .continue-here context, the file is deleted with rm -f. The deletion happens after context extraction and before status presentation, matching the template contract that states the file gets deleted after resume.
  </done>
</task>

</tasks>

<verification>
1. All three source workflow files contain the expected changes:
   - execute-phase.md: cleanup_handoffs step present between aggregate_results and verify_phase_goal
   - complete-milestone.md: cleanup_milestone_handoffs step present between verify_readiness and gather_stats
   - resume-project.md: expanded search + delete-after-load present in check_incomplete_work step
2. No existing workflow logic has been removed or broken
3. All rm commands use -f flag for defensive deletion
4. The resume-project.md delete happens AFTER context loading (critical ordering)
</verification>

<success_criteria>
SC1: execute-phase.md and complete-milestone.md delete .continue-here.md files in the completed phase directory (cleanup_handoffs and cleanup_milestone_handoffs steps exist)
SC2: resume-project.md deletes .continue-here.md after successfully loading context (delete-after-load logic exists after context extraction)
SC3: resume-project.md searches both .planning/phases/*/.continue-here.md AND .planning/.continue-here.md (expanded search in check_incomplete_work)
</success_criteria>

<output>
After completion, create `.planning/phases/30-signal-driven-workflow-fixes/30-01-SUMMARY.md`
</output>
