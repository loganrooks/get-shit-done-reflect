---
phase: 15-codex-cli-integration
plan: 02
type: tdd
wave: 2
depends_on: ["15-01"]
files_modified:
  - tests/unit/install.test.js
  - bin/install.js
autonomous: true

must_haves:
  truths:
    - "convertClaudeToCodexSkill correctly strips disallowed frontmatter fields and produces valid SKILL.md format"
    - "copyCodexSkills creates directory-per-skill structure with SKILL.md inside each"
    - "generateCodexAgentsMd creates AGENTS.md with GSD markers and is idempotent on re-install"
    - "--codex flag integration test produces correct file layout in tmpdir"
    - "Path replacement converts ~/.claude/ to ~/.codex/ in installed Codex files"
    - "Uninstall removes GSD skills and AGENTS.md section cleanly"
  artifacts:
    - path: "tests/unit/install.test.js"
      provides: "Codex-specific unit and integration tests"
      contains: "convertClaudeToCodexSkill"
  key_links:
    - from: "tests/unit/install.test.js"
      to: "bin/install.js"
      via: "require() import of exported functions + execSync for integration tests"
      pattern: "require.*install\\.js"
    - from: "unit tests"
      to: "convertClaudeToCodexSkill"
      via: "direct function call with mock content"
      pattern: "convertClaudeToCodexSkill\\("
    - from: "integration tests"
      to: "--codex flag"
      via: "execSync with --codex --global flag"
      pattern: "execSync.*--codex"
---

<objective>
Add comprehensive tests for Codex CLI integration: unit tests for convertClaudeToCodexSkill(), generateCodexAgentsMd(), and integration tests for --codex install/uninstall.

Purpose: Verify the Codex adapter functions produce correct SKILL.md format, AGENTS.md content, and that the full --codex installation flow creates the expected file layout. Tests follow TDD pattern: write failing tests first, then fix any implementation issues discovered.

Output: Extended tests/unit/install.test.js with Codex test suite, any bug fixes to bin/install.js discovered during testing.
</objective>

<execution_context>
@/Users/rookslog/.claude/get-shit-done/workflows/execute-plan.md
@/Users/rookslog/.claude/get-shit-done/templates/summary-standard.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/15-codex-cli-integration/15-RESEARCH.md
@.planning/phases/15-codex-cli-integration/15-01-SUMMARY.md
@bin/install.js
@tests/unit/install.test.js
</context>

<feature>
  <name>Codex CLI Installation Tests</name>
  <files>tests/unit/install.test.js, bin/install.js</files>
  <behavior>
    Tests cover three layers:

    **Unit tests for convertClaudeToCodexSkill():**
    - Input: Claude command with full frontmatter (name, description, allowed-tools, argument-hint, color) and body referencing Claude tools and /gsd: commands
    - Expected: SKILL.md with only name + description in frontmatter, body has tool names replaced (Read -> read_file, Bash -> shell, etc.), /gsd:command -> $gsd-command, @~/.codex/ refs converted to explicit read instructions
    - Input: Command with no frontmatter -> wrapped in minimal SKILL.md frontmatter
    - Input: Command with empty description -> uses fallback "GSD command: {name}"
    - Input: Description with angle brackets -> brackets stripped
    - Input: Description longer than 1024 chars -> truncated

    **Unit tests for generateCodexAgentsMd():**
    - Input: targetDir with no existing AGENTS.md -> creates new file with GSD markers
    - Input: targetDir with existing AGENTS.md without GSD section -> appends GSD section
    - Input: targetDir with existing AGENTS.md with GSD section -> replaces GSD section (idempotent)
    - Verify: Content contains $gsd-help, ~/.gsd/knowledge, codex exec reference, capability notes
    - Verify: Content is under 4KB

    **Integration tests for --codex flag:**
    - Run installer with --codex --global in tmpdir
    - Verify: ~/.codex/skills/ contains gsd-*/SKILL.md directories (at least gsd-help, gsd-new-project, gsd-plan-phase)
    - Verify: SKILL.md files have correct frontmatter format (name: gsd-*, description: present, no allowed-tools/color)
    - Verify: Paths in SKILL.md use ~/.codex/ not ~/.claude/
    - Verify: ~/.codex/get-shit-done/ exists with reference docs
    - Verify: ~/.codex/AGENTS.md exists with GSD markers
    - Verify: NO ~/.codex/agents/gsd-*.md files (agents skipped for Codex)
    - Verify: NO ~/.codex/hooks/ directory (hooks skipped for Codex)

    **Integration test for --codex --uninstall:**
    - After install, run --codex --global --uninstall
    - Verify: gsd-* skill directories removed
    - Verify: GSD section removed from AGENTS.md

    **Integration test for --all including Codex:**
    - Run --all --global in tmpdir
    - Verify: ~/.codex/ exists alongside ~/.claude/, opencode, ~/.gemini/
  </behavior>
  <implementation>
    Add a new `describe('Codex CLI integration', () => { ... })` block to tests/unit/install.test.js.

    Import convertClaudeToCodexSkill and generateCodexAgentsMd from bin/install.js via the existing createRequire pattern (line 13).

    Unit tests: Direct function calls with crafted input strings, assert output matches expected format.

    Integration tests: Follow the existing tmpdirTest pattern (lines 142-232) using execSync with HOME env override. The --codex flag tests parallel the --opencode flag tests (line 170).

    Fix any bugs discovered during testing by modifying bin/install.js as needed.
  </implementation>
</feature>

<verification>
1. `npx vitest run tests/unit/install.test.js` -- all tests pass (existing + new Codex tests)
2. New test count: at least 12 new tests (5 unit for convertClaudeToCodexSkill, 3 unit for generateCodexAgentsMd, 4 integration)
3. Zero regressions in existing test suite
</verification>

<success_criteria>
- convertClaudeToCodexSkill unit tests verify frontmatter stripping, tool name mapping, command invocation replacement, @ reference conversion
- generateCodexAgentsMd unit tests verify creation, append, and idempotent replace behaviors
- --codex integration test verifies complete file layout (skills, reference docs, AGENTS.md, no agents, no hooks)
- --codex --uninstall integration test verifies clean removal
- All tests pass including pre-existing tests
</success_criteria>

<output>
After completion, create `.planning/phases/15-codex-cli-integration/15-02-SUMMARY.md`
</output>
