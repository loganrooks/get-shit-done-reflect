---
phase: 15-codex-cli-integration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - bin/install.js
autonomous: true

must_haves:
  truths:
    - "Running --codex flag installs GSD commands as Codex Skills in ~/.codex/skills/ with SKILL.md directory structure"
    - "Running --codex generates ~/.codex/AGENTS.md with GSD workflow instructions"
    - "Running --codex installs reference docs to ~/.codex/get-shit-done/ with ~/.claude/ paths converted to ~/.codex/"
    - "Running --all includes Codex as 4th runtime alongside Claude, OpenCode, and Gemini"
    - "Running --codex --uninstall removes Skills directories and GSD section from AGENTS.md"
  artifacts:
    - path: "bin/install.js"
      provides: "Codex adapter functions, install path, uninstall path, --codex flag"
      contains: "convertClaudeToCodexSkill"
  key_links:
    - from: "convertClaudeToCodexSkill()"
      to: "copyCodexSkills()"
      via: "called per command during skill copy"
      pattern: "convertClaudeToCodexSkill"
    - from: "copyCodexSkills()"
      to: "install()"
      via: "called in Codex install path"
      pattern: "isCodex.*copyCodexSkills"
    - from: "generateCodexAgentsMd()"
      to: "install()"
      via: "called after skill install"
      pattern: "isCodex.*generateCodexAgentsMd"
    - from: "--codex flag"
      to: "selectedRuntimes"
      via: "CLI arg parsing"
      pattern: "hasCodex.*selectedRuntimes"
    - from: "--all flag"
      to: "codex in runtimes array"
      via: "selectedRuntimes includes codex"
      pattern: "selectedRuntimes.*codex"
---

<objective>
Add Codex CLI as the 4th GSD runtime in the installer: adapter functions (convertClaudeToCodexSkill, copyCodexSkills, generateCodexAgentsMd), install/uninstall paths, CLI flag handling, and --all update.

Purpose: This is the core implementation that enables GSD to be installed into Codex CLI. It follows the exact same architectural pattern established by OpenCode (Phase 10) and Gemini (Phase 11) integrations -- a conversion function, a copy function, and runtime-specific logic in install()/uninstall().

Output: Modified bin/install.js with full Codex support (install, uninstall, --codex flag, --all includes Codex, interactive prompt updated).
</objective>

<execution_context>
@/Users/rookslog/.claude/get-shit-done/workflows/execute-plan.md
@/Users/rookslog/.claude/get-shit-done/templates/summary-standard.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/15-codex-cli-integration/15-RESEARCH.md
@.planning/phases/13-path-abstraction-capability-matrix/13-01-SUMMARY.md
@.planning/phases/14-knowledge-base-migration/14-02-SUMMARY.md
@bin/install.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Codex adapter functions and tool name mapping</name>
  <files>bin/install.js</files>
  <action>
Add three new functions and one constant to bin/install.js, positioned after the existing Gemini adapter functions (~line 554):

1. **Tool name mapping constant** (after `claudeToGeminiTools` around line 424):
```javascript
const claudeToCodexTools = {
  Read: 'read_file',
  Write: 'apply_patch',
  Edit: 'apply_patch',
  Bash: 'shell',
  Glob: 'list_dir',
  Grep: 'grep_files',
  WebSearch: 'web_search',
  WebFetch: null,
  AskUserQuestion: 'request_user_input',
  Task: null,
  TodoWrite: 'update_plan',
  SlashCommand: null,
};
```

2. **`convertClaudeToCodexSkill(content, commandName)`** -- Converts a Claude Code command markdown into Codex SKILL.md format:
   - Replace tool name references in body text using word-boundary regex (same pattern as `convertClaudeToOpencodeFrontmatter` lines 559-563)
   - Replace `/gsd:command-name` with `$gsd-command-name` for Codex skill mention syntax
   - Convert `@~/.codex/path/to/file.md` file references to `Read the file at \`~/.codex/path/to/file.md\`` (Codex does not support @ file references)
   - Parse frontmatter: keep only `name` (rewritten as commandName) and `description` (truncated to 1024 chars, angle brackets removed). Drop `allowed-tools`, `argument-hint`, `color` fields.
   - Rebuild as minimal SKILL.md frontmatter: `---\nname: {commandName}\ndescription: {description}\n---`
   - If description is empty after parsing, use `GSD command: {commandName}`
   - Follow the code pattern from research Example 1

3. **`copyCodexSkills(srcDir, destDir, prefix, pathPrefix)`** -- Copies GSD commands as Codex Skill directories:
   - Clean existing GSD skills before copying (remove directories starting with `{prefix}-` in destDir)
   - Create destDir if it does not exist
   - Recurse into subdirectories, building compound names: `commands/gsd/debug/start.md` -> `skills/gsd-debug-start/SKILL.md`
   - For each .md file: read content, apply `replacePathsInContent(content, pathPrefix)`, apply `processAttribution(content, getCommitAttribution('codex'))`, apply `convertClaudeToCodexSkill(content, skillName)`, write to `{destDir}/{skillName}/SKILL.md`
   - Pattern: Follow `copyFlattenedCommands()` (lines 755-797) but output directories instead of flat files
   - IMPORTANT: Call `replacePathsInContent()` BEFORE `convertClaudeToCodexSkill()` so that `@~/.claude/` is already `@~/.codex/` when the `@` reference conversion runs

4. **`generateCodexAgentsMd(targetDir, pathPrefix)`** -- Generates ~/.codex/AGENTS.md:
   - Use `<!-- GSD:BEGIN (get-shit-done-reflect-cc) -->` and `<!-- GSD:END (get-shit-done-reflect-cc) -->` as markers (distinctive to avoid conflicts)
   - Content: GSD workflow awareness section (~2KB, well under 4KB limit). Include: available commands table (key commands: gsd-help, gsd-new-project, gsd-plan-phase, gsd-execute-phase, gsd-resume-work, gsd-pause-work, gsd-progress, gsd-signal), workflow conventions, KB location (`~/.gsd/knowledge/`), runtime capability notes, `codex exec` usage tip
   - Reference the pathPrefix for capability matrix path
   - If AGENTS.md exists: check for markers. If found, replace section. If not found, append with clear delimiter
   - If AGENTS.md does not exist: create with GSD section only
   - Follow research Example 3 pattern

Add `convertClaudeToCodexSkill` to the module.exports at the bottom of the file (alongside existing exports).

Do NOT add `getCommitAttribution` for 'codex' in the attribution cache function -- the existing function handles unknown runtimes gracefully (falls through to Claude Code path with same settings.json lookup pattern). The Codex path in install() will not have a settings.json to read, so attribution will default to `undefined` (keep as-is), which is correct.
  </action>
  <verify>
Run `node -e "const m = require('./bin/install.js'); console.log(typeof m.convertClaudeToCodexSkill)"` from the project root. Should print `function`.

Manually verify that the 4 new items exist in install.js:
- `claudeToCodexTools` constant
- `convertClaudeToCodexSkill` function
- `copyCodexSkills` function
- `generateCodexAgentsMd` function
  </verify>
  <done>
All 4 Codex adapter components exist in install.js. `convertClaudeToCodexSkill` is exported for testing. The functions follow the established patterns from OpenCode/Gemini adapters.
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire Codex into installer CLI, install(), uninstall(), and interactive prompt</name>
  <files>bin/install.js</files>
  <action>
Modify existing functions in bin/install.js to add Codex as a runtime:

1. **CLI flag parsing** (around line 28):
   - Add `const hasCodex = args.includes('--codex');`
   - Update `--all` to include codex: `selectedRuntimes = ['claude', 'opencode', 'gemini', 'codex'];`
   - Add `if (hasCodex) selectedRuntimes.push('codex');` alongside the other runtime push statements

2. **`getDirName(runtime)`** (line 43):
   - Add: `if (runtime === 'codex') return '.codex';`

3. **`getGlobalDir(runtime, explicitDir)`** (line 79):
   - Add Codex block before the Claude default:
   ```javascript
   if (runtime === 'codex') {
     if (explicitDir) return expandTilde(explicitDir);
     if (process.env.CODEX_CONFIG_DIR) return expandTilde(process.env.CODEX_CONFIG_DIR);
     return path.join(os.homedir(), '.codex');
   }
   ```

4. **Help text** (line 160): Add `--codex` to the options list and update the `--all` description to mention "all 4 runtimes". Add an example: `npx get-shit-done-reflect-cc --codex --global`.

5. **`getCommitAttribution(runtime)`** (around line 321): Add a Codex case that returns `undefined` (keep default attribution, since Codex has no settings.json for GSD to read):
   ```javascript
   } else if (runtime === 'codex') {
     result = undefined; // No settings.json in Codex
   } else {
   ```

6. **`install(isGlobal, runtime)`** (line 1426):
   - Add `const isCodex = runtime === 'codex';` alongside existing isOpencode/isGemini
   - Add `if (isCodex) runtimeLabel = 'Codex CLI';`
   - **Command installation block** (around line 1465): Add Codex path BEFORE the existing Claude/Gemini else block:
   ```javascript
   if (isCodex) {
     const skillsDir = path.join(targetDir, 'skills');
     fs.mkdirSync(skillsDir, { recursive: true });
     const gsdSrc = path.join(src, 'commands', 'gsd');
     copyCodexSkills(gsdSrc, skillsDir, 'gsd', pathPrefix);
     if (verifyInstalled(skillsDir, 'skills/gsd-*')) {
       const count = fs.readdirSync(skillsDir).filter(d =>
         d.startsWith('gsd-') && fs.statSync(path.join(skillsDir, d)).isDirectory()
       ).length;
       console.log(`  ${green}+${reset} Installed ${count} skills to skills/`);
     } else {
       failures.push('skills/gsd-*');
     }
   } else if (isOpencode) {
   ```
   - **get-shit-done reference docs**: Already uses `copyWithPathReplacement()` which handles path replacement. For Codex, we need to also apply `stripSubTags()` since Codex terminals may not render HTML subscript. After the existing `copyWithPathReplacement` call for get-shit-done, add:
   Actually, the existing copyWithPathReplacement already handles all runtimes. Codex needs no special treatment for get-shit-done since it uses the Claude path (non-TOML, non-OpenCode). The function will correctly replace paths. No change needed here.
   - **Agent installation block** (around line 1504): Skip for Codex (Codex uses AGENTS.md, not agent files):
   ```javascript
   if (fs.existsSync(agentsSrc) && !isCodex) {
   ```
   - **AGENTS.md generation**: After the agent installation block (after line 1541), add:
   ```javascript
   if (isCodex) {
     generateCodexAgentsMd(targetDir, pathPrefix);
     console.log(`  ${green}+${reset} Generated AGENTS.md`);
   }
   ```
   - **Hooks block** (around line 1564): Skip for Codex (no hook system):
   ```javascript
   const hooksSrc = path.join(src, 'hooks', 'dist');
   if (fs.existsSync(hooksSrc) && !isCodex) {
   ```
   - **Settings/statusline/hooks config** (around line 1589): Skip for Codex. Wrap the entire settings.json configuration block (lines 1589-1663) in `if (!isCodex)`. For Codex, still need to write manifest and report patches, so keep those. Return a result object with runtime but without settingsPath/settings for Codex:
   ```javascript
   if (isCodex) {
     writeManifest(targetDir);
     console.log(`  ${green}+${reset} Wrote file manifest (${MANIFEST_NAME})`);
     reportLocalPatches(targetDir);
     return { settingsPath: null, settings: {}, statuslineCommand: null, runtime };
   }
   ```
   Place this before the settings configuration block.

7. **`uninstall(isGlobal, runtime)`** (line 932):
   - Add `const isCodex = runtime === 'codex';`
   - Add `if (isCodex) runtimeLabel = 'Codex CLI';`
   - **Command removal** (around line 960): Add Codex block for removing skill directories:
   ```javascript
   if (isCodex) {
     const skillsDir = path.join(targetDir, 'skills');
     if (fs.existsSync(skillsDir)) {
       for (const entry of fs.readdirSync(skillsDir, { withFileTypes: true })) {
         if (entry.isDirectory() && entry.name.startsWith('gsd-')) {
           fs.rmSync(path.join(skillsDir, entry.name), { recursive: true });
           removedCount++;
         }
       }
       if (removedCount > 0) {
         console.log(`  ${green}+${reset} Removed GSD skills`);
       }
     }
   } else if (isOpencode) {
   ```
   - **AGENTS.md cleanup** (after the get-shit-done removal, around line 990): Add Codex AGENTS.md section removal:
   ```javascript
   if (isCodex) {
     const agentsMdPath = path.join(targetDir, 'AGENTS.md');
     if (fs.existsSync(agentsMdPath)) {
       let content = fs.readFileSync(agentsMdPath, 'utf8');
       const GSD_BEGIN = '<!-- GSD:BEGIN (get-shit-done-reflect-cc) -->';
       const GSD_END = '<!-- GSD:END (get-shit-done-reflect-cc) -->';
       const beginIdx = content.indexOf(GSD_BEGIN);
       const endIdx = content.indexOf(GSD_END);
       if (beginIdx !== -1 && endIdx !== -1) {
         content = content.substring(0, beginIdx) + content.substring(endIdx + GSD_END.length);
         content = content.trim();
         if (content.length === 0) {
           fs.unlinkSync(agentsMdPath);
         } else {
           fs.writeFileSync(agentsMdPath, content + '\n');
         }
         console.log(`  ${green}+${reset} Removed GSD section from AGENTS.md`);
         removedCount++;
       }
     }
   }
   ```
   - **Skip agent cleanup for Codex** (around line 992): `if (fs.existsSync(agentsDir) && !isCodex) {`
   - **Skip hooks cleanup for Codex** (around line 1009): Wrap hooks cleanup and settings.json cleanup in `if (!isCodex)` -- Codex has no hooks or settings.json.

8. **`installAllRuntimes()`** (line 1840): Update the completion logic to handle Codex. After the for loop, the function handles statusline for Claude/Gemini and finishes OpenCode. Add Codex handling:
   - In the `if (claudeResult || geminiResult)` block's handleStatusline callback, after the opencodeResult handling, add:
   ```javascript
   const codexResult = results.find(r => r.runtime === 'codex');
   if (codexResult) {
     console.log(`\n  ${green}Done!${reset} Launch Codex CLI and run ${cyan}$gsd-help${reset}.\n`);
   }
   ```
   - In the else block (only non-Claude/non-Gemini runtimes), handle Codex result similarly.

9. **Interactive prompt** (line 1754, `promptRuntime()`): Add Codex option and update All:
   ```
   1) Claude Code  (~/.claude)
   2) OpenCode     (~/.config/opencode) - open source, free models
   3) Gemini       (~/.gemini)
   4) Codex CLI    (~/.codex)
   5) All
   ```
   Update the callback logic: choice '5' -> all 4 runtimes, choice '4' -> ['codex'], keep existing 1-3.

10. **Module exports** (line 1924): Add new exports:
    ```javascript
    module.exports = { replacePathsInContent, getGsdHome, migrateKB, countKBEntries, convertClaudeToCodexSkill, copyCodexSkills, generateCodexAgentsMd };
    ```
  </action>
  <verify>
Run `node -e "const m = require('./bin/install.js'); console.log(Object.keys(m).sort().join(', '))"` -- should include convertClaudeToCodexSkill, copyCodexSkills, generateCodexAgentsMd alongside existing exports.

Run `node bin/install.js --help` -- should show --codex flag in options and "all 4 runtimes" in --all description.

Run existing test suite to ensure no regressions: `npx vitest run tests/unit/install.test.js`
  </verify>
  <done>
The --codex flag is recognized, --all includes 4 runtimes, install() has a Codex code path that creates skills directories + AGENTS.md + reference docs, uninstall() cleanly removes Codex artifacts, interactive prompt offers Codex as option 4, and all existing tests pass.
  </done>
</task>

</tasks>

<verification>
1. `node -e "require('./bin/install.js')"` -- no errors (module loads cleanly)
2. `node bin/install.js --help` -- shows --codex flag
3. `npx vitest run tests/unit/install.test.js` -- all existing tests pass (no regressions)
4. `node -e "const m = require('./bin/install.js'); console.log(typeof m.convertClaudeToCodexSkill, typeof m.copyCodexSkills, typeof m.generateCodexAgentsMd)"` -- prints `function function function`
</verification>

<success_criteria>
- bin/install.js contains all Codex adapter functions (convertClaudeToCodexSkill, copyCodexSkills, generateCodexAgentsMd)
- --codex flag is parsed and creates Skills in ~/.codex/skills/gsd-*/SKILL.md
- --all includes codex as 4th runtime
- install() Codex path: creates skills, installs get-shit-done, generates AGENTS.md, skips agents/hooks/settings
- uninstall() Codex path: removes skill directories, removes GSD section from AGENTS.md
- Interactive prompt shows 5 options (4 runtimes + All)
- All existing tests pass (zero regressions)
</success_criteria>

<output>
After completion, create `.planning/phases/15-codex-cli-integration/15-01-SUMMARY.md`
</output>
