---
phase: 08-core-merge
plan: 04
type: execute
wave: 4
depends_on: [08-03]
files_modified:
  - package-lock.json
  - .planning/FORK-STRATEGY.md
  - .planning/FORK-DIVERGENCES.md
  - .planning/phases/08-core-merge/08-MERGE-REPORT.md
autonomous: false

must_haves:
  truths:
    - "The merge commit exists on sync/v1.13-upstream incorporating all 70 upstream commits"
    - "npx vitest run passes all tests (0 failures)"
    - "grep -r for ghost references (gsd_memory, gsd-memory, projects.json) returns zero hits in .md and .js files (excluding .planning/ knowledge base)"
    - "All 5 Phase 8 success criteria are verified with evidence"
    - "A categorized merge summary documents what landed from upstream"
  artifacts:
    - path: "merge commit on sync/v1.13-upstream"
      provides: "Complete upstream merge with all 70 commits as ancestors"
    - path: "package-lock.json"
      provides: "Regenerated lockfile matching resolved package.json"
    - path: ".planning/phases/08-core-merge/08-MERGE-REPORT.md"
      provides: "Categorized summary of upstream additions, conflict resolutions, and bug fix status"
    - path: ".planning/FORK-STRATEGY.md"
      provides: "Updated Merge Decision Log with actual resolution decisions"
    - path: ".planning/FORK-DIVERGENCES.md"
      provides: "Updated manifest reflecting post-merge divergence state"
  key_links:
    - from: "git log upstream/main..HEAD"
      to: "merge commit"
      via: "all 70 upstream commits are ancestors"
      pattern: "upstream/main"
    - from: "npx vitest run"
      to: "merge validation"
      via: "all fork tests pass post-merge"
      pattern: "Tests.*passed"
    - from: "08-MERGE-REPORT.md"
      to: "Phase 9 planning"
      via: "categorized summary feeds architecture adoption scope"
      pattern: "workflows|gsd-tools"
---

<objective>
Finalize the merge commit, regenerate package-lock.json, run all validation checks, verify every Phase 8 success criterion, and produce a categorized merge summary for future phases.

Purpose: This plan converts the resolved merge state into a committed, validated result. The merge summary becomes input for Phase 9-12 planning. Without passing this plan's validation, the sync branch must not be merged to main.

Output: Committed merge on sync/v1.13-upstream, passing tests, verified success criteria, merge report, and updated fork documentation.
</objective>

<execution_context>
@/Users/rookslog/.claude/get-shit-done/workflows/execute-plan.md
@/Users/rookslog/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/FORK-STRATEGY.md
@.planning/FORK-DIVERGENCES.md
@.planning/phases/08-core-merge/08-RESEARCH.md
@.planning/phases/08-core-merge/08-CONTEXT.md
@.planning/phases/08-core-merge/08-03-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Commit merge, regenerate package-lock.json, run tests</name>
  <files>package-lock.json</files>
  <action>
Finalize the merge state into a proper merge commit, then validate with tests.

**Step 1: Verify merge is ready**

```bash
git status
```

Should show "All conflicts fixed but you are still merging" (or similar). If unresolved conflicts remain, STOP -- Plan 08-03 did not complete successfully.

**Step 2: Create the merge commit**

```bash
git commit --no-edit
```

The `--no-edit` flag accepts git's auto-generated merge commit message (e.g., "Merge remote-tracking branch 'upstream/main' into sync/v1.13-upstream"). This is the standard approach for merge commits.

Verify: `git log --oneline -1` shows the merge commit.

**Step 3: Regenerate package-lock.json**

The package-lock.json currently has the fork's pre-merge version (accepted via `--ours` in Plan 08-03). It needs to be regenerated to match the resolved package.json.

```bash
npm install
```

This produces a fresh lockfile based on the current package.json. Verify it worked:

```bash
node -e "JSON.parse(require('fs').readFileSync('package-lock.json','utf8')); console.log('valid JSON')"
```

Stage and commit:

```bash
git add package-lock.json
git commit -m "chore: regenerate package-lock.json after upstream merge"
```

**Step 4: Run fork tests (BLOCKING)**

```bash
npx vitest run
```

ALL tests must pass. If any test fails:
- Read the failure output carefully
- Determine if it's a merge resolution issue (go back and fix the file) or a pre-existing issue
- Fix merge-caused failures and commit the fix
- Re-run tests until green
- If the failure is complex and not clearly merge-related, flag it for the user

**Step 5: Run smoke tests (BLOCKING if claude CLI available)**

```bash
which claude 2>/dev/null && SMOKE_TIER=quick bash tests/smoke/run-smoke.sh
```

If `claude` CLI is available, quick smoke tests must pass. If not available, skip (same as Phase 7 decision).

**Step 6: Run upstream tests (INFORMATIONAL)**

```bash
node --test get-shit-done/bin/gsd-tools.test.js 2>&1 || true
```

Document the results but do NOT block on failures. These tests may require Phase 9 configuration to pass fully. Record pass/fail count for the merge report.
  </action>
  <verify>
`git log --oneline -3` shows the merge commit and package-lock regeneration commit. `npx vitest run` passes all tests (0 failures). `node -e "JSON.parse(require('fs').readFileSync('package-lock.json','utf8'))"` succeeds (valid lockfile).
  </verify>
  <done>Merge committed on sync/v1.13-upstream. package-lock.json regenerated. Fork tests pass. Smoke tests pass (or skipped if no claude CLI). Upstream test results documented.</done>
</task>

<task type="interactive">
  <name>Task 2: Verify success criteria, ghost check, merge summary, update fork docs</name>
  <files>.planning/phases/08-core-merge/08-MERGE-REPORT.md, .planning/FORK-STRATEGY.md, .planning/FORK-DIVERGENCES.md</files>
  <action>
Walk through every Phase 8 success criterion with evidence, check for ghost references, produce the categorized merge summary, and update fork documentation.

**Part A: Success Criteria Verification**

Verify each criterion and document the evidence:

**Criterion 1: All 70 upstream commits are ancestors**
```bash
# Count upstream commits that are NOT ancestors of HEAD
git log --oneline upstream/main..HEAD | grep -v "^[a-f0-9]* Merge" | head -5
# The merge commit should make all upstream commits ancestors
# Verify with:
git merge-base --is-ancestor upstream/main HEAD && echo "PASS: upstream/main is ancestor" || echo "FAIL"
```

**Criterion 2: Installer has fork branding + upstream features**
```bash
grep "REFLECT" bin/install.js
grep "get-shit-done-reflect-cc" bin/install.js
grep "parseJsonc" bin/install.js
grep "saveLocalPatches" bin/install.js
grep "gsd-statusline" bin/install.js
```
All should return matches.

**Criterion 3: package.json has fork identity + upstream additions**
```bash
grep '"name": "get-shit-done-reflect-cc"' package.json
grep '"files"' package.json
grep '"get-shit-done"' package.json
```
All should return matches.

**Criterion 4: No ghost references**
```bash
grep -r "gsd_memory\|gsd-memory\|projects\.json" --include="*.md" --include="*.js" . | grep -v ".planning/" | grep -v "node_modules/"
```
Should return zero hits. The `.planning/` exclusion is intentional -- our knowledge base documentation may reference the upstream memory system for comparison purposes. If hits are found outside `.planning/`, present each one to the user for review (do NOT auto-remove per CONTEXT.md decision).

**Criterion 5: All 11 bug fixes present**

Spot-check the 3 fixes that touch conflicting files (verified during resolution):
```bash
# FIX-07: Color validation in install.js
grep -A2 "hex.*color\|color.*valid" bin/install.js | head -5

# FIX-08: Statusline reference update in install.js
grep "gsd-statusline\|statusline\.js" bin/install.js | head -5

# FIX-02: user_constraints in research template
grep "user_constraints" get-shit-done/templates/research.md
```

For the 8 fixes that landed cleanly via merge, verify file presence:
```bash
# FIX-01: Executor verification
grep -l "completion.*verif\|verif.*completion" agents/gsd-executor.md 2>/dev/null || echo "Check agents/gsd-executor.md manually"

# FIX-03: Parallelization config
ls get-shit-done/workflows/execute-phase.md 2>/dev/null && echo "PRESENT" || echo "MISSING"

# FIX-06: Auto-create config
grep -l "config.*missing\|missing.*config\|create.*config" commands/gsd/set-profile.md commands/gsd/settings.md 2>/dev/null | head -3

# FIX-09: API key prevention
grep -l "sensitive\|api.*key\|credential" agents/gsd-codebase-mapper.md 2>/dev/null | head -3

# FIX-10: subagent_type
grep "gsd-executor" get-shit-done/workflows/execute-phase.md 2>/dev/null | head -3

# FIX-11: classifyHandoffIfNeeded workaround
grep -l "classifyHandoff\|handoff" get-shit-done/workflows/*.md 2>/dev/null | head -5
```

Document pass/fail for each criterion.

**Part B: Categorized Merge Summary**

Create `.planning/phases/08-core-merge/08-MERGE-REPORT.md` with these sections:

1. **Merge Overview** -- Date, branch, commit hash, upstream range (v1.11.2 to v1.18.0), total commits merged (70)

2. **Conflict Resolution Summary** -- Table of all conflicted files with: file, risk level, resolution strategy used, key decisions made. Pull from Plans 08-02 and 08-03 summaries.

3. **New Upstream Additions (by category):**
   - **CLI Tooling:** gsd-tools.js (4,597 lines), gsd-tools.test.js (2,033 lines)
   - **Workflow Files (16):** List the key ones (help.md, new-project.md, update.md, execute-phase.md, etc.)
   - **New Commands (1):** reapply-patches.md
   - **New References (4):** decimal-phase-calculation.md, git-planning-commit.md, model-profile-resolution.md, phase-argument-parsing.md
   - **New Templates (3):** summary-complex.md, summary-minimal.md, summary-standard.md
   - **GitHub/Community (6):** CODEOWNERS, issue templates, auto-label, SECURITY.md
   - **Assets (2):** Logo files
   - **Deleted by Upstream (3):** CONTRIBUTING.md, GSD-STYLE.md, MAINTAINERS.md
   Count total new files added.

4. **Bug Fix Status** -- Table of all 11 fixes with: fix ID, description, landed cleanly (yes/no), verification status

5. **Fork Identity Verification** -- Confirm fork branding is intact in all critical files

6. **Ghost Reference Check** -- Results of the memory system grep

7. **Test Results** -- Fork vitest results, smoke test results, upstream test results (informational)

8. **Open Items for Phase 9+** -- Things discovered during merge that need attention:
   - Thin orchestrator migration (command files still using inline versions)
   - Workflow files containing upstream references
   - Any upstream test failures that need investigation
   - Any other issues discovered

**Part C: Update FORK-STRATEGY.md Merge Decision Log**

Add entries to the Merge Decision Log table in `.planning/FORK-STRATEGY.md` for each conflicted file resolved during the merge. Use the actual decisions made in Plans 08-02 and 08-03. Format:

| File | Decision | Rationale | Sync Version |
|------|----------|-----------|--------------|

**Part D: Update FORK-DIVERGENCES.md**

Update the divergence manifest to reflect the post-merge state:
- Update "Last sync" from "N/A" to the current date
- Review each file in the manifest -- are the merge stances still accurate?
- Note any new divergences introduced by the merge resolution
- Update the summary stats if counts changed

**Part E: CHECKPOINT -- Present results to user**

Show the user:
- Success criteria checklist (all 5 criteria with pass/fail and evidence)
- Ghost reference check results
- Key findings from the merge summary
- Any open items flagged for Phase 9+
- Recommendation on sync branch to main merge timing

Wait for user acknowledgment.

Stage and commit the documentation updates:
```bash
git add .planning/phases/08-core-merge/08-MERGE-REPORT.md
git add .planning/FORK-STRATEGY.md
git add .planning/FORK-DIVERGENCES.md
git commit -m "docs(08): merge report, decision log, and updated divergence manifest"
```
  </action>
  <verify>
All 5 success criteria verified with evidence. `cat .planning/phases/08-core-merge/08-MERGE-REPORT.md | head -5` shows the merge report exists. `grep "v1.13" .planning/FORK-STRATEGY.md` shows Merge Decision Log entries. `grep "Last sync" .planning/FORK-DIVERGENCES.md` shows updated sync date. Ghost reference check returned zero hits (or flagged items were reviewed).
  </verify>
  <done>All Phase 8 success criteria verified and documented. Merge report produced with categorized upstream additions. Fork documentation updated with merge decisions and current divergence state. User has reviewed results.</done>
</task>

</tasks>

<verification>
1. `git log --oneline -5` shows merge commit + package-lock regeneration + docs commit
2. `git merge-base --is-ancestor upstream/main HEAD` exits 0 (all upstream commits are ancestors)
3. `npx vitest run` passes all tests
4. `grep -r "gsd_memory\|gsd-memory\|projects\.json" --include="*.md" --include="*.js" . | grep -v ".planning/" | grep -v "node_modules/"` returns nothing
5. `.planning/phases/08-core-merge/08-MERGE-REPORT.md` exists with all 8 sections
6. `.planning/FORK-STRATEGY.md` has populated Merge Decision Log
7. `.planning/FORK-DIVERGENCES.md` has updated "Last sync" date
</verification>

<success_criteria>
- Merge commit exists on sync/v1.13-upstream with all 70 upstream commits as ancestors
- package-lock.json regenerated and valid
- All fork tests pass (npx vitest run)
- All 5 Phase 8 success criteria verified with documented evidence
- Ghost reference check clean (or flagged items reviewed by user)
- Categorized merge report produced at 08-MERGE-REPORT.md
- FORK-STRATEGY.md Merge Decision Log populated with actual decisions
- FORK-DIVERGENCES.md updated to reflect post-merge state
- User has reviewed the validation results and merge summary
</success_criteria>

<output>
After completion, create `.planning/phases/08-core-merge/08-04-SUMMARY.md`
</output>
