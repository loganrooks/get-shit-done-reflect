---
phase: 08-core-merge
plan: 02
type: execute
wave: 2
depends_on: [08-01]
files_modified:
  - package.json
  - commands/gsd/new-project.md
  - bin/install.js
autonomous: false

must_haves:
  truths:
    - "package.json has fork identity (name: get-shit-done-reflect-cc, correct repository/bin URLs) with upstream structural additions (files array including gsd-tools.js via get-shit-done entry, esbuild devDep)"
    - "commands/gsd/new-project.md retains the fork's inline logic (including DevOps Phase 5.7) and is NOT the upstream thin orchestrator stub"
    - "bin/install.js displays fork branding (REFLECT banner, package name get-shit-done-reflect-cc, fork help text) while incorporating upstream's JSONC parsing, patch persistence system, statusline reference update, and color validation fix"
    - "Each resolved file has been reviewed and approved by the user before moving to the next"
  artifacts:
    - path: "package.json"
      provides: "Fork identity + upstream structural additions"
      contains: "get-shit-done-reflect-cc"
    - path: "commands/gsd/new-project.md"
      provides: "Fork inline command with DevOps context preserved"
      contains: "DevOps"
    - path: "bin/install.js"
      provides: "Fork-branded installer with upstream features"
      contains: "REFLECT"
  key_links:
    - from: "package.json"
      to: "bin/install.js"
      via: "bin field maps to installer"
      pattern: "get-shit-done-reflect-cc.*install.js"
    - from: "bin/install.js"
      to: "upstream patch persistence system"
      via: "adopted upstream functions"
      pattern: "saveLocalPatches|writeManifest|parseJsonc"
---

<objective>
Resolve the 3 HIGH-risk merge conflict files: package.json, new-project.md, and install.js. Each file is resolved individually, with a diff and rationale presented for user review before proceeding to the next.

Purpose: These 3 files have the most complex conflicts where both fork and upstream made significant changes. Getting them right is critical for fork identity (package.json), command functionality (new-project.md), and the install experience (install.js).

Output: Three HIGH-risk files resolved and staged (`git add`), each reviewed and approved by the user.
</objective>

<execution_context>
@/Users/rookslog/.claude/get-shit-done/workflows/execute-plan.md
@/Users/rookslog/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/FORK-STRATEGY.md
@.planning/FORK-DIVERGENCES.md
@.planning/phases/08-core-merge/08-RESEARCH.md
@.planning/phases/08-core-merge/08-CONTEXT.md
@.planning/phases/08-core-merge/08-01-SUMMARY.md
</context>

<tasks>

<task type="interactive">
  <name>Task 1: Resolve package.json (hybrid merge)</name>
  <files>package.json</files>
  <action>
Resolve the package.json merge conflict using the hybrid merge stance: fork identity is inviolable, upstream structural additions are adopted.

**Resolution approach:**

1. **Read the conflicted file** to see the conflict markers (with diff3 showing common ancestor).

2. **Produce the resolved version** combining:

   **Fork identity (KEEP as-is):**
   - `"name": "get-shit-done-reflect-cc"`
   - `"description": "A self-improving AI coding system..."` (fork description)
   - `"bin": { "get-shit-done-reflect-cc": "bin/install.js" }`
   - `"repository"`, `"homepage"`, `"bugs"` -- all fork GitHub URLs
   - `"keywords"` -- fork keywords including knowledge-base, signal-tracking, etc.
   - `"author": "TACHES"`

   **Upstream additions (ADOPT):**
   - `"files"` array: `["bin", "commands", "get-shit-done", "agents", "hooks/dist", "scripts"]` -- ensures gsd-tools.js is included via the `get-shit-done` entry
   - `"esbuild": "^0.24.0"` in devDependencies (upstream uses for hook bundling)
   - Any new npm scripts from upstream that don't conflict with fork scripts

   **Fork additions (KEEP):**
   - All fork devDependencies: `vitest`, `@vitest/coverage-v8`
   - All fork npm scripts: `test`, `test:watch`, `test:coverage`, `test:infra`, `test:smoke`, `test:smoke:quick`, `test:smoke:full`
   - Add upstream's test command as `test:upstream`: `"node --test get-shit-done/bin/gsd-tools.test.js"`

   **Version:** Keep at `"1.12.2"` (version bump happens in Phase 12)

   See research section "Hybrid Merge Pattern for package.json" for the complete target structure.

3. **Write the resolved file** (no conflict markers remaining).

4. **Stage it:**
   ```bash
   git add package.json
   ```

5. **CHECKPOINT -- Present for review:**
   Show the user:
   - A diff of the resolved file vs. the fork's pre-merge version (`git diff HEAD -- package.json` or equivalent)
   - Brief rationale for each merge decision (what was kept from fork, what was adopted from upstream, what was combined)
   - Explicit confirmation that fork package name `get-shit-done-reflect-cc` appears everywhere it should
   - Explicit confirmation that NO upstream package name `get-shit-done-cc` leaked in

   **Wait for user approval before proceeding to Task 2.**

   If user requests changes: apply them, re-show the diff, wait for approval again.
  </action>
  <verify>
`grep "get-shit-done-reflect-cc" package.json` returns the package name. `grep "get-shit-done-cc" package.json` returns ONLY lines containing "reflect" (no upstream name leaks). `grep "files" package.json` shows the files array is present. The file has no conflict markers (`grep "<<<<<<<" package.json` returns nothing). The file is valid JSON (`node -e "JSON.parse(require('fs').readFileSync('package.json','utf8'))"`).
  </verify>
  <done>package.json resolved with fork identity intact and upstream structural additions adopted. User has reviewed and approved the resolution.</done>
</task>

<task type="interactive">
  <name>Task 2: Resolve commands/gsd/new-project.md (keep fork inline version)</name>
  <files>commands/gsd/new-project.md</files>
  <action>
Resolve the new-project.md merge conflict. This is the most dramatic structural conflict: upstream shrank this file from ~1000 lines to ~42 lines (thin orchestrator delegating to a workflow file). The fork has ~1089 lines with inline logic including the DevOps Phase 5.7 addition.

**Resolution approach: Keep fork's inline version.**

The thin orchestrator migration happens in Phase 9 (MERGE-03, ARCH-02). For Phase 8, the fork's inline version must be preserved because:
- The fork has not customized the upstream workflow files yet
- Accepting upstream's stub would break the command (it delegates to workflows with upstream content)
- The fork's DevOps Phase 5.7 section is a fork feature that needs to survive

1. **Read the conflicted file** to understand what upstream changed vs. what the fork has.

2. **Resolution strategy:**
   - Start from the fork's version (the `--ours` side)
   - Evaluate whether upstream made any additions WITHIN the inline content that should be adopted (e.g., --auto flag support, new workflow steps)
   - The research notes upstream added `--auto` flag and other features -- evaluate whether any can be incorporated into the fork's inline version without introducing workflow dependencies
   - If upstream's changes are purely structural (thin orchestrator conversion), take the fork's version entirely
   - If upstream added substantive content improvements that work standalone, adopt those into the fork's inline version

3. **Write the resolved file.**

4. **Stage it:**
   ```bash
   git add commands/gsd/new-project.md
   ```

5. **CHECKPOINT -- Present for review:**
   Show the user:
   - What upstream changed (thin orchestrator conversion + any new features)
   - What the fork's version contains (inline logic + DevOps Phase 5.7)
   - The resolution decision and rationale
   - If any upstream additions were adopted into the fork's inline version, highlight what and why
   - If the resolution is purely "fork wins," explain why upstream's changes are deferred to Phase 9

   **Wait for user approval before proceeding to Task 3.**

   If user requests changes: apply them, re-show, wait for approval.

**Warning sign:** If the resolved file is under 50 lines, something went wrong -- the fork's inline version should be ~1000+ lines.
  </action>
  <verify>
`wc -l commands/gsd/new-project.md` shows 900+ lines (fork's inline version, not upstream's stub). `grep "DevOps" commands/gsd/new-project.md` finds the Phase 5.7 section. `grep "<<<<<<<" commands/gsd/new-project.md` returns nothing (no conflict markers). The file is syntactically valid Markdown.
  </verify>
  <done>new-project.md resolved preserving the fork's inline logic and DevOps Phase 5.7 section. Thin orchestrator migration deferred to Phase 9. User has reviewed and approved.</done>
</task>

<task type="interactive">
  <name>Task 3: Resolve bin/install.js (hybrid merge -- most complex)</name>
  <files>bin/install.js</files>
  <action>
Resolve the install.js merge conflict. This is the most complex conflict in the entire merge: upstream added ~200 lines of new functionality (patch persistence, JSONC parsing, bug fixes) to a file the fork has significantly customized with REFLECT branding.

**Resolution approach: Hybrid merge -- fork branding is sacred, upstream features are adopted.**

Start from the fork's version and surgically add upstream features. Do NOT start from upstream's version and try to add fork branding -- that risks losing fork customizations.

**Upstream additions to adopt (in order of surgical insertion):**

1. **`const crypto = require('crypto');`** -- Add to the requires section at the top. Needed for patch manifest hashing.

2. **Color validation fix** in `convertClaudeToOpencodeFrontmatter` (~6 lines) -- Validates hex color format. This is FIX-07 partial.

3. **`cleanedHooks` variable rename** in `cleanupOrphanedHooks` (~3 lines) -- Variable renamed from `cleaned` to `cleanedHooks` for clarity.

4. **Statusline reference update fix** in `cleanupOrphanedHooks` (~12 lines) -- Updates old `statusline.js` references to `gsd-statusline.js`. This is FIX-08.

5. **`parseJsonc()` function** (~60 lines) -- JSONC parser that strips comments before JSON.parse. Place near other utility functions.

6. **Updated `configureOpencodePermissions()`** to use parseJsonc (~12 lines) -- Better error handling, doesn't overwrite on parse error.

7. **Windows backslash normalization** (~1 line) -- In `pathPrefix` assignment, normalize backslashes.

8. **Entire patch persistence system** (~130 lines) -- Functions: `fileHash()`, `generateManifest()`, `writeManifest()`, `saveLocalPatches()`, `reportLocalPatches()`. Place as a new section before the `install()` function.

9. **Calls in `install()` function** (~7 lines) -- `saveLocalPatches(targetDir)` call early in install, `writeManifest(targetDir)` + `reportLocalPatches(targetDir)` calls near end of install.

**Fork additions to preserve (non-negotiable):**

1. **REFLECT ASCII banner** -- The fork's banner display, not upstream's
2. **Package name `get-shit-done-reflect-cc`** everywhere -- banner, help text, all references
3. **`gsd-version-check.js` hook registration** -- The fork's additional hook
4. **Fork-specific description** in the banner
5. **Fork-specific help text examples** using `npx get-shit-done-reflect-cc`

**Process:**

1. **Read the conflicted file** carefully. With diff3, identify each conflict block's three parts: common ancestor, fork (ours), upstream (theirs).

2. **For each conflict block**, decide:
   - If it's purely fork branding vs. upstream branding: keep fork
   - If upstream added new code that doesn't exist in the fork: adopt the new code while keeping fork context
   - If both sides modified the same function: combine, with fork identity taking priority

3. **Write the resolved file.** Ensure:
   - No conflict markers remain
   - No upstream package name `get-shit-done-cc` (without `reflect`) appears
   - All 9 upstream additions listed above are present
   - All 5 fork additions listed above are preserved
   - The file is valid JavaScript (no syntax errors from bad merging)

4. **Stage it:**
   ```bash
   git add bin/install.js
   ```

5. **Validate the resolved file:**
   ```bash
   # Check for conflict markers
   grep "<<<<<<<" bin/install.js
   # Should return nothing

   # Check for upstream package name leaks
   grep "get-shit-done-cc" bin/install.js | grep -v "reflect"
   # Should return nothing

   # Verify fork branding
   grep "REFLECT" bin/install.js
   grep "get-shit-done-reflect-cc" bin/install.js

   # Verify upstream additions
   grep "crypto" bin/install.js
   grep "parseJsonc" bin/install.js
   grep "saveLocalPatches" bin/install.js
   grep "writeManifest" bin/install.js
   grep "cleanedHooks" bin/install.js

   # Verify fork hook registration
   grep "gsd-version-check" bin/install.js

   # Syntax check
   node -c bin/install.js
   ```

6. **CHECKPOINT -- Present for review:**
   Show the user:
   - Summary of all upstream additions that were adopted (the 9 items above)
   - Confirmation that all 5 fork additions are preserved
   - Any conflict blocks where the resolution required judgment (not just "keep ours" or "take theirs")
   - The validation results from step 5
   - Specific attention to FIX-07 (color validation) and FIX-08 (statusline reference) -- confirm these bug fixes are present

   **Wait for user approval.**

   If user requests changes: apply them, re-validate, re-show, wait for approval.
  </action>
  <verify>
`node -c bin/install.js` exits cleanly (valid JavaScript syntax). `grep "REFLECT" bin/install.js` finds the banner. `grep "get-shit-done-reflect-cc" bin/install.js` finds fork package name. `grep "parseJsonc" bin/install.js` finds JSONC parser. `grep "saveLocalPatches" bin/install.js` finds patch persistence. `grep "cleanedHooks" bin/install.js` finds the renamed variable. `grep "gsd-version-check" bin/install.js` finds the fork hook registration. `grep "<<<<<<<" bin/install.js` returns nothing.
  </verify>
  <done>install.js resolved with fork branding intact and all 9 upstream feature additions adopted. Bug fixes FIX-07 and FIX-08 verified present. User has reviewed and approved.</done>
</task>

</tasks>

<verification>
1. `grep "<<<<<<<" package.json commands/gsd/new-project.md bin/install.js` returns nothing (no conflict markers in any HIGH-risk file)
2. `git diff --cached --name-only` includes package.json, commands/gsd/new-project.md, bin/install.js (all staged)
3. `grep "get-shit-done-reflect-cc" package.json` confirms fork identity
4. `wc -l commands/gsd/new-project.md` shows 900+ lines (not upstream's 42-line stub)
5. `node -c bin/install.js` exits cleanly
6. `grep "parseJsonc\|saveLocalPatches\|REFLECT\|gsd-version-check" bin/install.js` finds all expected strings
7. All three files were individually reviewed and approved by the user
</verification>

<success_criteria>
- package.json has fork identity with upstream structural additions, user-approved
- new-project.md retains fork inline logic (~1000 lines) with DevOps context, user-approved
- install.js has fork branding + all upstream features (JSONC, patch persistence, bug fixes), user-approved
- No conflict markers remain in any of the 3 files
- No upstream package names leaked into any resolved file
- All 3 files are staged for the eventual merge commit
</success_criteria>

<output>
After completion, create `.planning/phases/08-core-merge/08-02-SUMMARY.md`
</output>
