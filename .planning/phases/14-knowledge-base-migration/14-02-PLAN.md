---
phase: 14-knowledge-base-migration
plan: 02
type: execute
wave: 2
depends_on: ["14-01"]
files_modified:
  - bin/install.js
  - tests/unit/install.test.js
autonomous: true

must_haves:
  truths:
    - "Running the installer creates ~/.gsd/knowledge/ with signals/, spikes/, lessons/ subdirectories"
    - "Running the installer on a machine with existing ~/.claude/gsd-knowledge/ data migrates all content to ~/.gsd/knowledge/ with zero data loss"
    - "After migration, ~/.claude/gsd-knowledge/ is a symlink pointing to ~/.gsd/knowledge/"
    - "Setting GSD_HOME=/custom/path causes the KB to reside at /custom/path/knowledge/ instead of ~/.gsd/knowledge/"
    - "Re-running the installer after migration is idempotent (detects existing symlink, skips migration)"
    - "Symlink bridge at ~/.claude/gsd-knowledge/ is only created when Claude runtime is being installed"
  artifacts:
    - path: "bin/install.js"
      provides: "KB migration logic, GSD_HOME resolution, directory creation"
      contains: "migrateKB"
    - path: "bin/install.js"
      provides: "GSD_HOME environment variable resolution"
      contains: "getGsdHome"
    - path: "tests/unit/install.test.js"
      provides: "Migration, symlink, GSD_HOME, and idempotency tests"
      contains: "migrateKB"
  key_links:
    - from: "bin/install.js getGsdHome()"
      to: "process.env.GSD_HOME"
      via: "Environment variable check with fallback to ~/.gsd/"
      pattern: "process\\.env\\.GSD_HOME"
    - from: "bin/install.js migrateKB()"
      to: "fs.cpSync"
      via: "Recursive directory copy for migration"
      pattern: "fs\\.cpSync.*recursive"
    - from: "bin/install.js migrateKB()"
      to: "fs.symlinkSync"
      via: "Backward-compatible symlink creation"
      pattern: "fs\\.symlinkSync"
    - from: "bin/install.js main install flow"
      to: "migrateKB()"
      via: "Called once before per-runtime loop"
      pattern: "migrateKB\\(gsdHome\\)"
---

<objective>
Add KB directory creation, migration logic, symlink bridge, and GSD_HOME support to the installer. When run, the installer will: (1) resolve the GSD home directory (default ~/.gsd/ or $GSD_HOME), (2) create KB subdirectories, (3) migrate existing data from ~/.claude/gsd-knowledge/ if present, (4) create a backward-compatible symlink, and (5) verify zero data loss.

Purpose: This is the core migration mechanism that moves user KB data to the runtime-agnostic location. Combined with Plan 01's source file updates, this completes the full KB migration -- source files reference the new path, and the installer ensures the data is actually there.

Output: Updated bin/install.js with getGsdHome() and migrateKB() functions, updated tests verifying all migration scenarios.
</objective>

<execution_context>
@/Users/rookslog/.claude/get-shit-done/workflows/execute-plan.md
@/Users/rookslog/.claude/get-shit-done/templates/summary-standard.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/14-knowledge-base-migration/14-RESEARCH.md
@.planning/phases/14-knowledge-base-migration/14-01-SUMMARY.md
@.planning/phases/13-path-abstraction-capability-matrix/13-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add getGsdHome() and migrateKB() to installer</name>
  <files>bin/install.js</files>
  <action>
    Add two new functions and integrate them into the install flow.

    **Function 1: getGsdHome()**
    ```javascript
    function getGsdHome() {
      if (process.env.GSD_HOME) {
        const gsdHome = process.env.GSD_HOME;
        if (gsdHome.startsWith('~/')) {
          return path.join(os.homedir(), gsdHome.slice(2));
        }
        return gsdHome;
      }
      return path.join(os.homedir(), '.gsd');
    }
    ```
    - Place near the top of install.js with other utility functions
    - Export via module.exports (extend existing exports from Phase 13's require.main guard)

    **Function 2: migrateKB(gsdHome)**

    Implements copy-then-symlink migration per research pattern:

    1. **Create new KB directory structure:**
       ```javascript
       const newKBDir = path.join(gsdHome, 'knowledge');
       fs.mkdirSync(path.join(newKBDir, 'signals'), { recursive: true });
       fs.mkdirSync(path.join(newKBDir, 'spikes'), { recursive: true });
       fs.mkdirSync(path.join(newKBDir, 'lessons'), { recursive: true });
       ```

    2. **Check for existing old KB:**
       ```javascript
       const oldKBDir = path.join(os.homedir(), '.claude', 'gsd-knowledge');
       ```

    3. **If old KB exists and is NOT a symlink (first migration):**
       - Count entries in old KB using countKBEntries()
       - Copy with `fs.cpSync(oldKBDir, newKBDir, { recursive: true })`
       - Count entries in new KB
       - Verify: if newEntries < oldEntries, abort (do not create symlink, log error, leave both copies)
       - If verified: rename old to backup (`oldKBDir + '.migration-backup'`), create symlink from old path to new path
       - CRITICAL argument order: `fs.symlinkSync(newKBDir, oldKBDir)` -- symlink lives at oldKBDir, points to newKBDir

    4. **If old KB exists and IS a symlink (re-install after migration):**
       - Skip migration entirely, log "KB already migrated"
       - Return early

    5. **If old KB does NOT exist but new KB does (fresh install or non-Claude):**
       - Only create symlink if Claude runtime is being installed (check selectedRuntimes includes 'claude')
       - Create `~/.claude/` directory if needed: `fs.mkdirSync(path.join(os.homedir(), '.claude'), { recursive: true })`
       - Create symlink: `fs.symlinkSync(newKBDir, oldKBDir)`

    **Helper function: countKBEntries(kbDir)**
    ```javascript
    function countKBEntries(kbDir) {
      let count = 0;
      for (const subdir of ['signals', 'spikes', 'lessons']) {
        const typeDir = path.join(kbDir, subdir);
        if (!fs.existsSync(typeDir)) continue;
        const entries = fs.readdirSync(typeDir, { recursive: true });
        count += entries.filter(f => typeof f === 'string' && f.endsWith('.md')).length;
      }
      return count;
    }
    ```
    Note: `fs.readdirSync` with `{ recursive: true }` may return strings or Dirent objects depending on options. Filter with `typeof f === 'string'` for safety since we're not passing `withFileTypes`.

    **Integration into install flow:**
    - Call `const gsdHome = getGsdHome();` ONCE, early in the main install flow (after arg parsing, before per-runtime loop)
    - Call `migrateKB(gsdHome);` immediately after
    - Pass `selectedRuntimes` context to migrateKB (or check it inside the function) for the Claude-only symlink decision
    - This runs BEFORE the per-runtime installation loop

    **Export via module.exports:**
    - Add `getGsdHome`, `migrateKB`, and `countKBEntries` to the existing module.exports block (from Phase 13)
    - This enables direct unit testing

    **Console output:**
    - Migration: `"Migrated knowledge base: N entries"` + `"  old_path -> new_path"`
    - Fresh install: `"Created knowledge base at: path"`
    - Already migrated: `"Knowledge base already at: path"` (or silent)
    - Error: `"Migration verification failed: N entries in source, M in destination"`
  </action>
  <verify>
    Verify the functions exist and are exported:
    ```
    node -e "const m = require('./bin/install.js'); console.log(typeof m.getGsdHome, typeof m.migrateKB, typeof m.countKBEntries)"
    ```
    Should output: `function function function`

    Verify getGsdHome() works:
    ```
    node -e "const m = require('./bin/install.js'); console.log(m.getGsdHome())"
    ```
    Should output something like `/Users/username/.gsd`

    Verify install.js still runs as CLI:
    ```
    node bin/install.js --help 2>&1 | head -5
    ```
    Should show help output (not crash).
  </verify>
  <done>
    bin/install.js contains getGsdHome(), migrateKB(), and countKBEntries() functions. Functions are exported for testing. Install flow calls migrateKB() once before per-runtime loop. CLI behavior unchanged.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add migration tests and verify full test suite</name>
  <files>tests/unit/install.test.js</files>
  <action>
    Add comprehensive tests for the new migration functionality. These tests use the existing tmpdir-based test pattern established in Phase 13.

    **Test cases to add:**

    1. **getGsdHome() tests:**
       - Returns `~/.gsd` by default (when GSD_HOME not set)
       - Returns custom path when GSD_HOME is set
       - Expands tilde in GSD_HOME value (e.g., `~/custom` -> `/Users/name/custom`)

    2. **countKBEntries() tests:**
       - Returns 0 for empty KB directory
       - Counts .md files across signals/, spikes/, lessons/ subdirectories
       - Ignores non-.md files
       - Handles missing subdirectories gracefully

    3. **migrateKB() tests (core migration scenarios):**
       - **Fresh install (no old KB):** Creates `~/.gsd/knowledge/` with signals/, spikes/, lessons/ subdirectories. No symlink created if Claude not in runtimes.
       - **Migration (old KB exists):** Copies all entries from old to new location. Old location becomes symlink pointing to new. Entry count matches (zero data loss). Backup directory exists at `old_path.migration-backup`.
       - **Idempotent re-run (old KB is symlink):** Skips migration, does not duplicate data, does not error.
       - **Verification failure (simulated):** If somehow copy produces fewer entries, migration aborts without creating symlink, both copies remain.

    4. **Symlink bridge tests:**
       - Symlink created at `~/.claude/gsd-knowledge/` when Claude runtime selected
       - Symlink NOT created when only non-Claude runtimes selected (e.g., --opencode only)
       - Reading through symlink path returns same content as reading from new path

    5. **GSD_HOME override test:**
       - Set GSD_HOME to custom tmpdir path
       - Run migration
       - KB created at `$GSD_HOME/knowledge/` not `~/.gsd/knowledge/`

    **Test setup pattern (use existing tmpdir helper):**
    ```javascript
    // Each test should:
    // 1. Create a tmpdir
    // 2. Set up old KB structure if testing migration
    // 3. Call migrateKB() with appropriate gsdHome
    // 4. Assert on file existence, symlink targets, entry counts
    ```

    **Import the functions directly:**
    ```javascript
    const { getGsdHome, migrateKB, countKBEntries } = require('../../bin/install.js');
    ```

    After adding tests, run the FULL test suite (not just new tests) to ensure Plan 01's test updates + Plan 02's new tests all pass together.
  </action>
  <verify>
    Run the new tests:
    ```
    npx vitest run tests/unit/install.test.js
    ```
    All tests must pass (both existing Phase 13 tests and new migration tests).

    Run full test suite:
    ```
    npx vitest run
    ```
    All tests green.

    Verify test coverage of key scenarios:
    ```
    npx vitest run tests/unit/install.test.js --reporter=verbose 2>&1 | grep -E '(migrateKB|getGsdHome|countKBEntries|migration|symlink|GSD_HOME)'
    ```
    Should show 8+ test names covering the scenarios above.
  </verify>
  <done>
    10+ new tests covering: getGsdHome() default and override, countKBEntries() counting, migrateKB() fresh install, migration with data, idempotent re-run, symlink bridge, GSD_HOME override. Full test suite passes.
  </done>
</task>

</tasks>

<verification>
After both tasks complete:

1. **Migration functions exist and are exported:**
   ```
   node -e "const m = require('./bin/install.js'); console.log(Object.keys(m).sort().join(', '))"
   ```
   Should include: `countKBEntries, getGsdHome, migrateKB, replacePathsInContent`

2. **Full test suite passes:**
   ```
   npx vitest run
   ```
   All green.

3. **End-to-end check** -- run installer in dry mode (local install in temp dir) and verify KB dir created:
   ```
   node -e "
     const { getGsdHome, migrateKB } = require('./bin/install.js');
     const fs = require('fs');
     const path = require('path');
     const os = require('os');
     const tmpdir = fs.mkdtempSync(path.join(os.tmpdir(), 'gsd-test-'));
     const gsdHome = path.join(tmpdir, '.gsd');
     migrateKB(gsdHome);
     console.log('signals:', fs.existsSync(path.join(gsdHome, 'knowledge', 'signals')));
     console.log('spikes:', fs.existsSync(path.join(gsdHome, 'knowledge', 'spikes')));
     console.log('lessons:', fs.existsSync(path.join(gsdHome, 'knowledge', 'lessons')));
     fs.rmSync(tmpdir, { recursive: true });
   "
   ```
   Should output: `signals: true`, `spikes: true`, `lessons: true`
</verification>

<success_criteria>
- getGsdHome() resolves to ~/.gsd/ by default or $GSD_HOME if set
- migrateKB() creates KB directory structure on fresh install
- migrateKB() copies data and creates symlink on migration
- migrateKB() is idempotent on re-run (detects existing symlink)
- Symlink bridge only created for Claude runtime installs
- Zero data loss verified by entry counting
- 10+ new tests covering all migration scenarios
- Full test suite passes (existing + new tests)
</success_criteria>

<output>
After completion, create `.planning/phases/14-knowledge-base-migration/14-02-SUMMARY.md`
</output>
