---
phase: 00-deployment-infrastructure
plan: 06
type: execute
wave: 1
depends_on: ["00-03"]
files_modified:
  - .github/workflows/publish.yml
  - .github/workflows/smoke-test.yml
autonomous: false

must_haves:
  truths:
    - "Publish workflow extracts release notes from CHANGELOG.md and includes them in the GitHub release body"
    - "Smoke tests can be triggered manually via workflow_dispatch with tier selection"
    - "Authenticated smoke tests skip gracefully when ANTHROPIC_API_KEY secret is not available"
    - "Branch protection rules for main are documented and actionable"
  artifacts:
    - path: ".github/workflows/publish.yml"
      provides: "Enhanced publish workflow with release notes"
      contains: "CHANGELOG.md"
    - path: ".github/workflows/smoke-test.yml"
      provides: "Manual smoke test workflow with auth strategy"
      contains: "workflow_dispatch"
  key_links:
    - from: ".github/workflows/publish.yml"
      to: "CHANGELOG.md"
      via: "Release notes extraction"
      pattern: "CHANGELOG"
    - from: ".github/workflows/smoke-test.yml"
      to: "tests/smoke/run-smoke.sh"
      via: "npm run test:smoke"
      pattern: "test:smoke"
---

<objective>
Improve the release workflow with automated release notes from CHANGELOG.md, create a manual-trigger workflow for authenticated smoke tests, and document branch protection rules for main.

Purpose: The publish workflow currently has no automated release notes -- maintainers must manually write them. Smoke tests (Tier 2+3) require Claude CLI authentication and cannot run in standard CI, so a separate manually-triggered workflow with secrets access is needed. Branch protection ensures no accidental direct pushes to main.
Output: Enhanced publish.yml, new smoke-test.yml workflow, and branch protection configuration guidance.
</objective>

<execution_context>
@/Users/rookslog/.claude/get-shit-done/workflows/execute-plan.md
@/Users/rookslog/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/00-deployment-infrastructure/00-03-SUMMARY.md
@.github/workflows/publish.yml
@CHANGELOG.md
@package.json
@tests/smoke/run-smoke.sh
</context>

<tasks>

<task type="auto">
  <name>Task 1: Enhance publish workflow with automated release notes</name>
  <files>.github/workflows/publish.yml</files>
  <action>
Improve publish.yml to extract release notes from CHANGELOG.md and attach them to the GitHub release. Add a step between "Verify version matches release tag" and "Run tests before publish" that:

1. Extracts the changelog entry for the current version from CHANGELOG.md
2. Updates the GitHub release body with the extracted notes (using `gh` CLI)

Insert this step after the version verification step:

```yaml
      - name: Extract release notes from CHANGELOG
        id: release_notes
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "Extracting release notes for version $VERSION"

          # Extract content between this version header and the next version header
          # CHANGELOG.md uses format: ## [X.Y.Z] - YYYY-MM-DD
          NOTES=$(awk "/^## \\[$VERSION\\]/{found=1; next} /^## \\[/{if(found) exit} found{print}" CHANGELOG.md)

          if [ -z "$NOTES" ]; then
            echo "No changelog entry found for version $VERSION"
            NOTES="No changelog entry found. See [CHANGELOG.md](https://github.com/rookslog/get-shit-done-reflect/blob/main/CHANGELOG.md) for details."
          fi

          # Write to file for multi-line handling
          echo "$NOTES" > /tmp/release-notes.md
          echo "notes_file=/tmp/release-notes.md" >> "$GITHUB_OUTPUT"

      - name: Update release with changelog notes
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          # Append changelog notes to existing release body
          gh release edit "v$VERSION" --notes-file /tmp/release-notes.md 2>/dev/null || \
            echo "Warning: Could not update release notes (release may not exist yet)"
```

This requires adding `contents: write` to the permissions block (currently only `contents: read`):

```yaml
    permissions:
      contents: write
      id-token: write
```

The `contents: write` permission is needed for `gh release edit`.
  </action>
  <verify>
1. `grep "Extract release notes" .github/workflows/publish.yml` confirms step exists
2. `grep "CHANGELOG.md" .github/workflows/publish.yml` confirms changelog reference
3. `grep "contents: write" .github/workflows/publish.yml` confirms write permission
4. `grep "gh release edit" .github/workflows/publish.yml` confirms release update
5. YAML syntax is valid (check indentation visually)
  </verify>
  <done>Publish workflow extracts release notes from CHANGELOG.md and updates the GitHub release body automatically.</done>
</task>

<task type="auto">
  <name>Task 2: Create manual smoke test workflow for authenticated tests</name>
  <files>.github/workflows/smoke-test.yml</files>
  <action>
Create a new workflow file `.github/workflows/smoke-test.yml` that allows manual triggering of smoke tests (Tier 2+3) which require Claude CLI authentication.

The workflow uses `workflow_dispatch` with a tier input, and requires the `ANTHROPIC_API_KEY` secret. It skips gracefully if the secret is not configured.

```yaml
name: Smoke Tests (Manual)

on:
  workflow_dispatch:
    inputs:
      tier:
        description: 'Smoke test tier to run'
        required: true
        default: 'quick'
        type: choice
        options:
          - quick
          - full

jobs:
  smoke:
    name: Smoke Tests (${{ inputs.tier }})
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build hooks
        run: npm run build:hooks

      - name: Check authentication
        id: auth_check
        run: |
          if [ -z "$ANTHROPIC_API_KEY" ]; then
            echo "has_auth=false" >> "$GITHUB_OUTPUT"
            echo "::warning::ANTHROPIC_API_KEY secret not configured. Tier 2+3 tests will be skipped."
            echo "To enable authenticated smoke tests, add ANTHROPIC_API_KEY as a repository secret."
          else
            echo "has_auth=true" >> "$GITHUB_OUTPUT"
            echo "Authentication available for smoke tests."
          fi
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}

      - name: Run Tier 1 smoke tests (no auth required)
        run: SMOKE_TIER=quick bash tests/smoke/run-smoke.sh

      - name: Install Claude CLI
        if: steps.auth_check.outputs.has_auth == 'true' && inputs.tier == 'full'
        run: npm install -g @anthropic-ai/claude-code || echo "::warning::Claude CLI install failed"

      - name: Run full smoke tests (auth required)
        if: steps.auth_check.outputs.has_auth == 'true' && inputs.tier == 'full'
        run: SMOKE_TIER=full bash tests/smoke/run-smoke.sh
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}

      - name: Skip notice for unauthenticated full tier
        if: steps.auth_check.outputs.has_auth != 'true' && inputs.tier == 'full'
        run: |
          echo "::notice::Full smoke tests skipped - ANTHROPIC_API_KEY not configured."
          echo "Tier 1 (quick) tests ran successfully."
          echo "To run Tier 2+3 tests, configure the ANTHROPIC_API_KEY repository secret."
```

**Key design decisions:**
- `workflow_dispatch` for manual triggering from GitHub Actions UI
- Tier selection via dropdown (quick or full)
- Auth check step detects missing secret gracefully
- Tier 1 always runs (no auth needed)
- Tier 2+3 only run when auth is available AND full tier is selected
- 30-minute timeout matches comprehensive tier budget
- Claude CLI installed only when needed for full tier
  </action>
  <verify>
1. `grep "workflow_dispatch" .github/workflows/smoke-test.yml` confirms manual trigger
2. `grep "ANTHROPIC_API_KEY" .github/workflows/smoke-test.yml` confirms auth handling
3. `grep "SMOKE_TIER" .github/workflows/smoke-test.yml` confirms tier selection
4. `grep "quick" .github/workflows/smoke-test.yml` confirms Tier 1 always runs
5. YAML syntax is valid
  </verify>
  <done>Manual smoke test workflow supports tier selection, handles missing auth gracefully, and always runs Tier 1 tests.</done>
</task>

<task type="checkpoint:human-action" gate="blocking">
  <name>Task 3: Configure branch protection on main</name>
  <action>
Configure branch protection rules on the `main` branch in GitHub repository settings.
  </action>
  <instructions>
Go to: **GitHub > rookslog/get-shit-done-reflect > Settings > Branches > Branch protection rules**

Click "Add branch protection rule" and configure:

**Branch name pattern:** `main`

**Protect matching branches:**
- [x] Require a pull request before merging
  - Required number of approvals: 0 (solo developer -- PRs required but self-merge is fine)
  - [x] Dismiss stale pull request approvals when new commits are pushed
- [x] Require status checks to pass before merging
  - [x] Require branches to be up to date before merging
  - Required status checks: `Test` (the CI job name from ci.yml)
- [x] Require conversation resolution before merging
- [ ] Require signed commits (optional, leave unchecked for now)
- [ ] Require linear history (optional, leave unchecked -- squash merge already produces linear history)
- [x] Do not allow bypassing the above settings (prevents force-pushing to main even for admins)

**Also configure:**
- Go to Settings > General > Pull Requests
  - [x] Allow squash merging (default merge strategy)
  - [x] Automatically delete head branches

This prevents accidental direct pushes to main, ensures CI passes before merge, and cleans up feature branches after merge.

**Optional (if using GitHub rulesets instead of legacy branch protection):**
Navigate to Settings > Rules > Rulesets > New ruleset instead, and apply equivalent rules. Rulesets are the newer GitHub mechanism and offer more granular control.
  </instructions>
  <resume-signal>Type "done" after configuring branch protection, or "skip" to defer this to later.</resume-signal>
</task>

</tasks>

<verification>
After all tasks complete:
1. `cat .github/workflows/publish.yml` shows release notes extraction step
2. `cat .github/workflows/smoke-test.yml` shows workflow_dispatch with tier input
3. Branch protection is configured on main (verify by attempting direct push -- it should be blocked)
4. All YAML files are syntactically valid
</verification>

<success_criteria>
- Publish workflow extracts and attaches CHANGELOG.md notes to GitHub releases
- Smoke test workflow allows manual CI trigger with tier selection
- Unauthenticated smoke test runs skip gracefully with informative notice
- Branch protection prevents direct pushes to main
- CI status check is required before PR merge
</success_criteria>

<output>
After completion, create `.planning/phases/00-deployment-infrastructure/00-06-SUMMARY.md`
</output>
