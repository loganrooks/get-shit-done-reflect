---
phase: 00-deployment-infrastructure
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - .github/workflows/ci.yml
  - .github/workflows/publish.yml
  - scripts/dev-setup.sh
  - scripts/dev-teardown.sh
autonomous: true

must_haves:
  truths:
    - "CI workflow runs tests on push to main and on pull requests"
    - "Publish workflow triggers on GitHub releases"
    - "Dev setup script creates symlinks for hot reload"
    - "Dev teardown script restores original state"
  artifacts:
    - path: ".github/workflows/ci.yml"
      provides: "Continuous integration workflow"
      contains: "npm test"
    - path: ".github/workflows/publish.yml"
      provides: "npm publish workflow"
      contains: "npm publish"
    - path: "scripts/dev-setup.sh"
      provides: "Development environment setup"
      contains: "ln -sfn"
    - path: "scripts/dev-teardown.sh"
      provides: "Development environment cleanup"
      contains: "rm"
  key_links:
    - from: ".github/workflows/ci.yml"
      to: "package.json"
      via: "npm test command"
      pattern: "npm test"
    - from: ".github/workflows/publish.yml"
      to: "package.json"
      via: "npm publish command"
      pattern: "npm publish"
---

<objective>
Create CI/CD workflows and local development scripts for the GSD Reflect fork. This establishes automated testing on every PR, npm publishing on releases, and a developer-friendly workflow for local changes.

Purpose: Enable continuous integration to catch regressions, automate releases, and provide a frictionless local development experience.
Output: GitHub Actions workflows for CI and publishing, plus scripts for local development hot reload.
</objective>

<execution_context>
@/Users/rookslog/.claude/get-shit-done/workflows/execute-plan.md
@/Users/rookslog/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/00-deployment-infrastructure/00-CONTEXT.md
@.planning/phases/00-deployment-infrastructure/00-RESEARCH.md
@package.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create CI workflow</name>
  <files>.github/workflows/ci.yml</files>
  <action>
Create the GitHub Actions CI workflow that runs tests on every push and pull request.

**.github/workflows/ci.yml:**
```yaml
name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  test:
    name: Test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build hooks
        run: npm run build:hooks

      - name: Run tests
        run: npm test

      - name: Run tests with coverage
        if: github.event_name == 'pull_request'
        run: npm run test:coverage

  # Separate job for lint if eslint is configured
  lint:
    name: Lint
    runs-on: ubuntu-latest
    # Only run if eslint config exists
    if: hashFiles('.eslintrc*', 'eslint.config.*') != ''
    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run lint
        run: npm run lint
```

Key features:
- Runs on push to main and all PRs
- Uses Node.js 20.x (LTS)
- Caches npm dependencies for speed
- Builds hooks before testing (existing prepublishOnly pattern)
- Coverage only on PRs (to catch regressions, not on every push)
- Lint job only runs if eslint config exists
  </action>
  <verify>
Verify workflow file:
1. `cat .github/workflows/ci.yml` shows the workflow
2. `grep "npm test" .github/workflows/ci.yml` confirms test step
3. `grep "branches: \[main\]" .github/workflows/ci.yml` confirms trigger
  </verify>
  <done>CI workflow will run tests on every PR and push to main.</done>
</task>

<task type="auto">
  <name>Task 2: Create publish workflow</name>
  <files>.github/workflows/publish.yml</files>
  <action>
Create the GitHub Actions workflow for publishing to npm when a release is created.

**.github/workflows/publish.yml:**
```yaml
name: Publish to npm

on:
  release:
    types: [published]

jobs:
  publish:
    name: Publish
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          registry-url: 'https://registry.npmjs.org'

      - name: Install dependencies
        run: npm ci

      - name: Build hooks
        run: npm run build:hooks

      - name: Verify version matches release tag
        run: |
          PKG_VERSION=$(node -p "require('./package.json').version")
          TAG_VERSION=${GITHUB_REF#refs/tags/v}
          if [ "$PKG_VERSION" != "$TAG_VERSION" ]; then
            echo "::error::Version mismatch: package.json has $PKG_VERSION but tag is v$TAG_VERSION"
            exit 1
          fi
          echo "Version verified: $PKG_VERSION"

      - name: Run tests before publish
        run: npm test

      - name: Publish to npm
        run: npm publish --provenance --access public
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
```

Key features:
- Triggers only on published releases (not drafts)
- Uses OIDC permissions for provenance attestation
- Verifies package.json version matches release tag (prevents version mismatch)
- Runs tests before publishing (safety check)
- Uses NPM_TOKEN secret for authentication
- --provenance flag adds supply chain security attestation
- --access public ensures scoped packages are public

Note: The user will need to:
1. Create an npm account if they don't have one
2. Create an NPM_TOKEN secret in the repository settings
3. Optionally set up OIDC trusted publishing on npm for enhanced security
  </action>
  <verify>
Verify publish workflow:
1. `cat .github/workflows/publish.yml` shows the workflow
2. `grep "npm publish" .github/workflows/publish.yml` confirms publish step
3. `grep "release:" .github/workflows/publish.yml` confirms trigger
4. `grep "NPM_TOKEN" .github/workflows/publish.yml` confirms secret usage
  </verify>
  <done>Publish workflow will release to npm when GitHub releases are created.</done>
</task>

<task type="auto">
  <name>Task 3: Create development scripts</name>
  <files>scripts/dev-setup.sh, scripts/dev-teardown.sh</files>
  <action>
Create scripts for local development that use symlinks for hot reload.

**scripts/dev-setup.sh:**
```bash
#!/bin/bash
# Development setup script for GSD Reflect
# Creates symlinks from ~/.claude/ to repo files for instant hot reload
# Mac/Linux only (per CONTEXT.md decision)

set -e

CLAUDE_DIR="$HOME/.claude"
REPO_DIR="$(cd "$(dirname "$0")/.." && pwd)"

echo "GSD Reflect Development Setup"
echo "=============================="
echo ""
echo "Repo: $REPO_DIR"
echo "Target: $CLAUDE_DIR"
echo ""

# Ensure base directory exists
mkdir -p "$CLAUDE_DIR"
mkdir -p "$CLAUDE_DIR/commands"

# Check for and backup existing non-symlink directories
backup_if_needed() {
  local target="$1"
  local name="$2"

  if [ -d "$target" ] && [ ! -L "$target" ]; then
    echo "Backing up existing $name to ${name}.bak"
    mv "$target" "${target}.bak"
  elif [ -L "$target" ]; then
    echo "Removing existing symlink: $name"
    rm "$target"
  fi
}

backup_if_needed "$CLAUDE_DIR/commands/gsd" "commands/gsd"
backup_if_needed "$CLAUDE_DIR/get-shit-done" "get-shit-done"
backup_if_needed "$CLAUDE_DIR/agents" "agents"

# Create symlinks
echo ""
echo "Creating symlinks..."

ln -sfn "$REPO_DIR/commands/gsd" "$CLAUDE_DIR/commands/gsd"
echo "  $CLAUDE_DIR/commands/gsd -> $REPO_DIR/commands/gsd"

ln -sfn "$REPO_DIR/get-shit-done" "$CLAUDE_DIR/get-shit-done"
echo "  $CLAUDE_DIR/get-shit-done -> $REPO_DIR/get-shit-done"

ln -sfn "$REPO_DIR/agents" "$CLAUDE_DIR/agents"
echo "  $CLAUDE_DIR/agents -> $REPO_DIR/agents"

echo ""
echo "Development setup complete!"
echo ""
echo "Changes to files in the repo now reflect immediately in Claude Code."
echo "To restore original state, run: scripts/dev-teardown.sh"
echo ""
```

**scripts/dev-teardown.sh:**
```bash
#!/bin/bash
# Development teardown script for GSD Reflect
# Removes symlinks and optionally restores backups

set -e

CLAUDE_DIR="$HOME/.claude"

echo "GSD Reflect Development Teardown"
echo "================================="
echo ""

restore_backup() {
  local target="$1"
  local name="$2"

  if [ -L "$target" ]; then
    echo "Removing symlink: $name"
    rm "$target"

    if [ -d "${target}.bak" ]; then
      echo "Restoring backup: ${name}.bak"
      mv "${target}.bak" "$target"
    fi
  elif [ -d "$target" ]; then
    echo "Not a symlink, skipping: $name"
  else
    echo "Not found: $name"
  fi
}

restore_backup "$CLAUDE_DIR/commands/gsd" "commands/gsd"
restore_backup "$CLAUDE_DIR/get-shit-done" "get-shit-done"
restore_backup "$CLAUDE_DIR/agents" "agents"

echo ""
echo "Development teardown complete!"
echo ""
echo "To reinstall GSD normally, run: npx get-shit-done-reflect-cc --global"
echo ""
```

Make both scripts executable:
```bash
chmod +x scripts/dev-setup.sh scripts/dev-teardown.sh
```
  </action>
  <verify>
Verify dev scripts:
1. `ls -la scripts/dev-*.sh` shows both scripts with execute permission
2. `grep "ln -sfn" scripts/dev-setup.sh` confirms symlink creation
3. `grep "rm " scripts/dev-teardown.sh` confirms symlink removal
4. Test setup script (optional): `scripts/dev-setup.sh` runs without error
  </verify>
  <done>Development scripts enable hot reload workflow for local development.</done>
</task>

</tasks>

<verification>
After all tasks complete:
1. Verify CI workflow: `cat .github/workflows/ci.yml | head -20`
2. Verify publish workflow: `cat .github/workflows/publish.yml | head -20`
3. Verify dev scripts are executable: `ls -la scripts/dev-*.sh`
4. Verify workflow YAML is valid (no syntax errors): `python3 -c "import yaml; yaml.safe_load(open('.github/workflows/ci.yml'))"` (if python available)
</verification>

<success_criteria>
- CI workflow triggers on push/PR and runs npm test
- Publish workflow triggers on release and publishes to npm
- Dev setup script creates symlinks for hot reload
- Dev teardown script cleans up and restores backups
- All scripts are executable
</success_criteria>

<output>
After completion, create `.planning/phases/00-deployment-infrastructure/00-03-SUMMARY.md`
</output>
