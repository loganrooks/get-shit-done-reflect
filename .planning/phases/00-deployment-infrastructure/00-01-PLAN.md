---
phase: 00-deployment-infrastructure
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - vitest.config.js
  - tests/helpers/tmpdir.js
  - tests/helpers/setup.js
autonomous: true

must_haves:
  truths:
    - "npm test runs without error"
    - "Vitest discovers and can execute test files"
    - "Temp directory fixture creates isolated directories per test"
    - "Package is named get-shit-done-reflect-cc"
  artifacts:
    - path: "package.json"
      provides: "Fork package identity and test scripts"
      contains: "get-shit-done-reflect-cc"
    - path: "vitest.config.js"
      provides: "Test framework configuration"
      contains: "defineConfig"
    - path: "tests/helpers/tmpdir.js"
      provides: "Temp directory test fixture"
      exports: ["tmpdirTest"]
    - path: "tests/helpers/setup.js"
      provides: "Global test setup"
  key_links:
    - from: "package.json"
      to: "vitest.config.js"
      via: "npm test script"
      pattern: "vitest"
    - from: "vitest.config.js"
      to: "tests/helpers/setup.js"
      via: "setupFiles config"
      pattern: "setupFiles.*setup\\.js"
---

<objective>
Set up the test infrastructure foundation for the GSD Reflect fork. This establishes the package identity, installs Vitest, and creates reusable test helpers.

Purpose: Enable all subsequent testing work by providing the framework, configuration, and helper fixtures needed to write isolated, deterministic tests.
Output: Configured Vitest with temp directory fixture pattern ready for writing tests.
</objective>

<execution_context>
@/Users/rookslog/.claude/get-shit-done/workflows/execute-plan.md
@/Users/rookslog/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/00-deployment-infrastructure/00-CONTEXT.md
@.planning/phases/00-deployment-infrastructure/00-RESEARCH.md
@package.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update package.json for fork identity</name>
  <files>package.json</files>
  <action>
Update package.json to establish the fork's identity:

1. Change `name` from "get-shit-done-cc" to "get-shit-done-reflect-cc"
2. Change `bin` key from "get-shit-done-cc" to "get-shit-done-reflect-cc"
3. Update `repository.url` to the fork's GitHub URL (keep as placeholder if URL unknown)
4. Update `homepage` and `bugs.url` similarly
5. Add test scripts:
   - "test": "vitest run"
   - "test:watch": "vitest"
   - "test:coverage": "vitest run --coverage"
6. Add vitest and @vitest/coverage-v8 to devDependencies:
   - "vitest": "^3.0.0"
   - "@vitest/coverage-v8": "^3.0.0"

Keep all other fields unchanged (version, description, files, keywords, etc.).
  </action>
  <verify>
Run `cat package.json | grep -E "(name|test|vitest)"` and verify:
- name is "get-shit-done-reflect-cc"
- test scripts exist
- vitest is in devDependencies
  </verify>
  <done>Package.json identifies the fork and includes test scripts.</done>
</task>

<task type="auto">
  <name>Task 2: Create Vitest configuration</name>
  <files>vitest.config.js</files>
  <action>
Create vitest.config.js at project root with configuration for Node.js CLI testing:

```javascript
import { defineConfig } from 'vitest/config'

export default defineConfig({
  test: {
    environment: 'node',
    globals: false,
    testTimeout: 30000,
    hookTimeout: 30000,
    coverage: {
      provider: 'v8',
      reporter: ['text', 'lcov'],
      exclude: ['**/node_modules/**', '**/tests/**', '**/hooks/dist/**']
    },
    include: ['tests/**/*.test.js'],
    setupFiles: ['./tests/helpers/setup.js']
  }
})
```

Key settings:
- environment: 'node' - Testing CLI tools, not browser code
- globals: false - Explicit imports for clarity
- testTimeout: 30000 - Allow time for file operations
- coverage excludes tests and dist files
- include pattern finds all test files in tests/
- setupFiles runs global setup before tests
  </action>
  <verify>
Run `cat vitest.config.js` and verify it contains:
- defineConfig import
- environment: 'node'
- setupFiles pointing to tests/helpers/setup.js
  </verify>
  <done>Vitest is configured for Node.js CLI testing with coverage.</done>
</task>

<task type="auto">
  <name>Task 3: Create test helpers</name>
  <files>tests/helpers/tmpdir.js, tests/helpers/setup.js</files>
  <action>
Create the tests/helpers/ directory and two helper files:

**tests/helpers/tmpdir.js** - Temp directory test fixture:
```javascript
// Temp directory fixture for test isolation
// Source: https://sdorra.dev/posts/2024-02-12-vitest-tmpdir
import { test } from 'vitest'
import os from 'node:os'
import fs from 'node:fs/promises'
import path from 'node:path'

/**
 * Extended test that provides an isolated temp directory
 * Usage: tmpdirTest('test name', async ({ tmpdir }) => { ... })
 * The directory is automatically cleaned up after the test
 */
export const tmpdirTest = test.extend({
  tmpdir: async ({}, use) => {
    const directory = await fs.mkdtemp(path.join(os.tmpdir(), 'gsd-test-'))
    await use(directory)
    await fs.rm(directory, { recursive: true })
  }
})

/**
 * Create a mock home directory structure for testing install
 * @param {string} tmpdir - Base temp directory
 * @returns {Promise<string>} Path to mock home directory
 */
export async function createMockHome(tmpdir) {
  const mockHome = path.join(tmpdir, 'home')
  await fs.mkdir(path.join(mockHome, '.claude'), { recursive: true })
  return mockHome
}

/**
 * Create a mock .planning directory structure for testing
 * @param {string} baseDir - Directory to create .planning in
 * @returns {Promise<string>} Path to .planning directory
 */
export async function createMockPlanning(baseDir) {
  const planningDir = path.join(baseDir, '.planning')
  await fs.mkdir(path.join(planningDir, 'phases'), { recursive: true })
  return planningDir
}
```

**tests/helpers/setup.js** - Global test setup:
```javascript
// Global test setup
// Runs before all tests via vitest.config.js setupFiles

import { beforeAll, afterAll } from 'vitest'

// Store original environment
const originalEnv = { ...process.env }

beforeAll(() => {
  // Ensure consistent test environment
  // Unset any user-specific paths that might affect tests
  delete process.env.CLAUDE_CONFIG_DIR
  delete process.env.OPENCODE_CONFIG_DIR
  delete process.env.GEMINI_CONFIG_DIR
})

afterAll(() => {
  // Restore original environment
  process.env = originalEnv
})
```
  </action>
  <verify>
Run these checks:
1. `ls tests/helpers/` shows tmpdir.js and setup.js
2. `grep "tmpdirTest" tests/helpers/tmpdir.js` shows the export
3. `grep "beforeAll" tests/helpers/setup.js` shows the setup hook
  </verify>
  <done>Test helpers provide temp directory isolation and consistent test environment.</done>
</task>

</tasks>

<verification>
After all tasks complete:
1. Run `npm install` to install vitest
2. Run `npm test` - should complete (may show "no tests" which is expected)
3. Verify package name: `node -p "require('./package.json').name"` returns "get-shit-done-reflect-cc"
</verification>

<success_criteria>
- Package.json has fork name and test scripts
- Vitest configuration exists and is valid
- Test helpers are in place for subsequent test writing
- npm test command executes without error
</success_criteria>

<output>
After completion, create `.planning/phases/00-deployment-infrastructure/00-01-SUMMARY.md`
</output>
