---
phase: 00-deployment-infrastructure
task: e2e-smoke-testing
status: completed_pending_deployment_hardening
last_updated: 2026-02-07T18:35:00Z
---

<current_state>
Three-tier smoke testing is implemented and passing (27 Tier 1 Vitest tests, 33/33 Tier 2+3 smoke tests on full tier). The next step is deployment pipeline hardening: branch protection on main, CI integration of install testing, and release workflow improvements.
</current_state>

<completed_work>

- Smoke test fixtures with planted deviations (tests/smoke/fixtures/.planning/)
- verify-kb.sh helper script for KB state assertions
- kb-infrastructure.test.js: 14 Vitest tests exercising kb-create-dirs.sh and kb-rebuild-index.sh
- wiring-validation.test.js: 13 Vitest tests validating @-references, subagent_type mappings, KB templates
- run-smoke.sh: Tier 2+3 orchestrator (quick/standard/full tiers) with unique project names for KB isolation
- package.json: test:infra, test:smoke, test:smoke:quick, test:smoke:full scripts
- All tests verified passing: 42/42 Vitest, 33/33 smoke (full tier)
- Committed as 9dca238
</completed_work>

<remaining_work>

- Branch protection on main (currently wide open to direct pushes, no PR requirement)
- CI integration: add test:infra to ci.yml (zero cost, should gate PRs)
- CI integration: install test (run bin/install.js in isolated env, verify output)
- Smoke test in CI: needs ANTHROPIC_API_KEY secret or Claude Max auth strategy
- Release workflow improvements: automated release notes from CHANGELOG
- Package name alignment: gsd-check-update.js queries "get-shit-done-cc" not "get-shit-done-reflect-cc"
</remaining_work>

<decisions_made>

- Dropped HOME override for smoke tests — breaks Claude CLI auth (uses macOS Keychain tied to HOME)
- Used unique project names (smoke-{pid}-{timestamp}) for KB isolation instead
- Added defensive kb-rebuild-index.sh call after signal collection (agent doesn't always rebuild)
- Used --dangerously-skip-permissions and --no-session-persistence for smoke test claude invocations
- Explicit "Do NOT run slash commands" in prompts since -p mode may not process /gsd: syntax
</decisions_made>

<blockers>
- Smoke tests (Tier 2+3) require authenticated claude CLI — can't run in standard CI without Claude API key or Max auth
- Package name mismatch: update hooks reference "get-shit-done-cc" not the reflect fork name
</blockers>

<context>
The repo has NO branch protection on main. Anyone with push access can commit directly. CI runs on push AND PR but is advisory only — nothing blocks merge. The publish workflow triggers on GitHub Release creation (manual) and verifies version matches tag. The full deployment hardening plan needs to address: requiring PRs for main, making CI status checks required, adding install integration testing, and deciding how to handle smoke tests in CI (API key cost vs. coverage).
</context>

<next_action>
Enter plan mode to design deployment hardening: branch protection rules, CI pipeline additions (install test + Tier 1 gate), release workflow, and the package name alignment issue.
</next_action>
