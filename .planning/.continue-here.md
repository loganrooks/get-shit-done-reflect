---
phase: between-milestones
task: installer-patch-detection-improvement
status: in_progress
last_updated: 2026-02-26T15:38:19.578Z
---

<current_state>
Quick-9 (pruneRedundantPatches) shipped in v1.15.4. It handles the most common false positive (patch identical to newly installed file). But 7 false positives remain from a second category the pruning can't catch. Deep diagnosis completed, solutions evaluated, ready to implement.
</current_state>

<completed_work>

- Quick-9: Added `pruneRedundantPatches()` to `bin/install.js` (commit b979680). After install writes new files + manifest, compares each backed-up patch against newly installed file. If hash matches, removes the patch. Cleans up entire `gsd-local-patches/` dir when no real patches remain.
- Released v1.15.4 (tag reflect-v1.15.4, commit 255577e)
- Updated to v1.15.4 via npx — observed 7 remaining false-positive patches
- Completed thorough root cause analysis (see diagnosis below)
- Signal logged: delegate-exploration-to-subagents (context management convention)
</completed_work>

<remaining_work>

Fix the remaining 7 false-positive patches. Three separate issues identified:

1. **Issue 1 (root cause): Untracked manifest desynchronizes from git-tracked files**
   - `gsd-file-manifest.json` is never committed to git
   - `.claude/` agent/command files ARE tracked (29 files in this repo)
   - `git checkout -- .claude/` (or git pull/merge) restores tracked files but leaves manifest stale
   - `saveLocalPatches()` then sees every file as "modified" because hashes don't match stale manifest
   - Affects: any repo that git-tracks `.claude/` files, team settings with `git pull`

2. **Issue 2 (correctness bug): `replacePathsInContent()` corrupts documentation text**
   - Regex `~\/\.claude\/(?!gsd-knowledge)` replaces ALL `~/.claude/` with `./.claude/` for local installs
   - Doesn't distinguish functional path refs (SHOULD replace) from documentation/example text (should NOT)
   - Example: `dual-installation.md` line 29 installed as "discovers commands from both `./.claude/commands/` and `./.claude/commands/`" — both paths identical, global path corrupted
   - Example: agent specs line 145 "Detect from installed path prefix (./.claude/ = claude-code)" — should say `~/.claude/`
   - Affects: every local install. Installed documentation is semantically wrong.
   - Files affected: gsd-reflector.md, gsd-signal-collector.md, gsd-spike-runner.md, dual-installation.md

3. **Issue 3: Version/scope injection creates unavoidable diffs across updates**
   - `injectVersionScope()` adds `(v1.15.4 local)` to command descriptions
   - Manifest records hash WITH suffix; if files have different/no suffix, flagged as modified
   - Files affected: commands/gsd/reflect.md, commands/gsd/spike.md

The 7th file (gsd-tools.js) is a real diff — `detectDualInstall()` was added to .claude/ during v1.15.2 dev work but isn't in upstream gsd-tools.js. This is a legitimate detection, not a false positive.
</remaining_work>

<decisions_made>

- Quick-9 `pruneRedundantPatches()` approach: post-install hash comparison. Simple, handles the most common case (file already at target version). Shipped as v1.15.4.
- Diagnosis methodology: traced full code flow through `saveLocalPatches()` -> install -> `writeManifest()` -> `pruneRedundantPatches()` -> `reportLocalPatches()`. Discovered manifest is untracked (key insight).
- Evaluated 6 solution approaches (A through F) — see below.
</decisions_made>

<blockers>

- Need user input on which solution approach to pursue (evaluation completed, awaiting decision)
- User also raised design question about update workflow: should local vs global command selection matter? Currently the workflow auto-detects scope regardless of which command was selected from autocomplete.
</blockers>

<context>

## Solution Options Evaluated

### Option A: Track manifest in git
- Pro: Fixes root cause (Issues 1+3). No code changes to detection logic.
- Con: Every install dirties working tree. Clutters git history.
- Eliminates: 6/7 false positives

### Option B: Regenerate manifest when stale
- Pro: Handles staleness automatically
- Con: Defeats the safety net — if user legit modified files AND manifest is stale, misses their modifications
- Assessment: Not viable

### Option C: Fix replacePathsInContent() (addresses Issue 2)
- Pro: Installed files become semantically correct. 4 false positives eliminated as side effect.
- Con: Regex heuristics are fragile
- Eliminates: 4/7

### Option D: Marker/escape in source files for paths that shouldn't be replaced
- Pro: Explicit, zero ambiguity
- Con: Changes source file format
- Eliminates: 4/7 (same as C)

### Option E: Git hook to regenerate manifest
- Pro: Keeps manifest in sync after git ops
- Con: Requires hook setup, not always enabled

### Option F: Smarter pruning (normalize before comparing)
- Pro: Minimal change, backward compatible
- Con: Treats symptoms. Fragile coupling (pruning must "undo" installer transformations)
- Eliminates: 6/7

### Recommended approach (pre-user-input):
Fix Issue 2 (replacePathsInContent correctness bug) as primary fix — it's a real bug regardless of patching. Then assess if remaining false positives (2 from version injection) warrant additional fixes.

## Key Code Locations

- `bin/install.js:1108` — `replacePathsInContent()` function
- `bin/install.js:1146` — `injectVersionScope()` function
- `bin/install.js:1812` — `fileHash()` function
- `bin/install.js:1840` — `writeManifest()` function
- `bin/install.js:1872` — `saveLocalPatches()` function (runs BEFORE install, line 2047)
- `bin/install.js:1912` — `pruneRedundantPatches()` function (runs AFTER writeManifest)
- `bin/install.js:1972` — `reportLocalPatches()` function
- `bin/install.js:2015` — `pathPrefix` computation (local=`./.claude/`, global=full path)

## Committed .claude/ State

The committed `.claude/` files are a hybrid:
- Functional path refs have `./.claude/` (from local install)
- Example/documentation text has `~/.claude/` (from npm source or direct edits)
- No version/scope suffix in command frontmatter (committed from source, not installer output)
- gsd-tools.js has `detectDualInstall()` (added in .claude/ during v1.15.2 dev, not in upstream)

## User's Open Design Question

When dual-installed (local + global), both versions appear in autocomplete. Currently the update workflow ALWAYS auto-detects scope (checks local first). User asked: should selecting the global command update global, and local command update local? Or should the workflow ask? This is tracked as a pending todo in STATE.md.
</context>

<next_action>
Resume from: installer patch detection improvement. Next step: decide on solution approach for the 3 remaining issues. Delegate investigation to subagents to avoid context bloat (per signal sig-2026-02-26-delegate-exploration-to-subagents). After deciding approach, implement as a quick task or small phase depending on scope.
</next_action>
